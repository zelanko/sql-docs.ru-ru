---
title: Пулы подключений диспетчера драйверов | Документация Майкрософт
ms.custom: ''
ms.date: 01/19/2017
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
helpviewer_keywords:
- connection pooling [ODBC]
- pooled connections [ODBC]
- connecting to driver [ODBC], connection pooling
- connecting to data source [ODBC], connection pooling
ms.assetid: ee95ffdb-5aa1-49a3-beb2-7695b27c3df9
author: MightyPen
ms.author: genemi
ms.openlocfilehash: 92aab28274d3709047e46c55192b437449e252ac
ms.sourcegitcommit: b87d36c46b39af8b929ad94ec707dee8800950f5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2020
ms.locfileid: "68047009"
---
# <a name="driver-manager-connection-pooling"></a>Организация пулов соединений диспетчера драйверов
Пул соединений позволяет приложению использовать подключение из пула подключений, которые не нужно повторно устанавливать для каждого использования. После создания подключения и помещения его в пул приложение может повторно использовать это подключение, не выполняя полный процесс подключения.  
  
 Использование соединения в составе пула может привести к значительному повышению производительности, так как приложения могут сэкономить издержки, связанные с установлением соединения. Это может быть особенно значительным для приложений среднего уровня, которые подключаются по сети или для приложений, которые постоянно подключаются и отключаются, например Интернет-приложения.  
  
 В дополнение к повышению производительности архитектура пулов соединений позволяет использовать среду и связанные с ней соединения в нескольких компонентах в одном процессе. Это означает, что изолированные компоненты в одном процессе могут взаимодействовать друг с другом, не отвлекаясь друг на друга. Подключение в пуле соединений может многократно использоваться несколькими компонентами.  
  
> [!NOTE]
>  Использование пулов соединений может быть использовано приложением ODBC, которое ведет к ODBC 2. поведение по *оси x* , если приложение может вызвать *SQLSetEnvAttr*. При использовании пулов соединений приложение не должно выполнять инструкции SQL, которые изменяют базу данных или контекст базы данных, например изменение \< *имени базы данных*>, которое изменяет каталог, используемый источником данных.  


 Драйвер ODBC должен быть полностью потокобезопасным, а соединения не должны иметь сходство потоков для поддержки пулов соединений. Это означает, что драйвер может выполнять вызов в любом потоке в любое время и может подключаться к одному потоку, использовать соединение в другом потоке и отключать в третьем потоке.  
  
 Пул соединений поддерживается диспетчером драйверов. Соединения выводятся из пула, когда приложение вызывает **SQLConnect** или **SQLDriverConnect** и возвращается в пул, когда приложение вызывает **SQLDisconnect**. Размер пула растет динамически в зависимости от запрошенных выделений ресурсов. Он сжимается в зависимости от времени ожидания бездействия: Если подключение неактивно в течение определенного периода времени (оно не использовалось в соединении), оно удаляется из пула. Размер пула ограничен только ограничениями памяти и ограничениями на сервере.  
  
 Диспетчер драйверов определяет, следует ли использовать конкретное соединение в пуле в соответствии с аргументами, передаваемыми в **SQLConnect** или **SQLDriverConnect**, и в соответствии с атрибутами соединения, заданными после выделения соединения.  
  
 Когда диспетчер драйверов подключается к пулу, ему необходимо определить, работает ли соединение, прежде чем передать его. В противном случае диспетчер драйверов сохраняет неработающее подключение к приложению при возникновении временной ошибки в сети. В ODBC 3 *. x*был определен новый атрибут connection: SQL_ATTR_CONNECTION_DEAD. Это атрибут подключения только для чтения, который возвращает либо SQL_CD_TRUE, либо SQL_CD_FALSE. Значение SQL_CD_TRUE означает, что соединение было потеряно, а значение SQL_CD_FALSE означает, что соединение все еще активно. (Драйверы, которые соответствует более ранним версиям ODBC, также могут поддерживать этот атрибут.)  
  
 Драйвер должен эффективно реализовывать этот параметр, иначе он будет нарушать производительность пула подключений. В частности, вызов для получения этого атрибута соединения не должен вызывать циклического обращения к серверу. Вместо этого драйвер должен просто возвращать Последнее известное состояние соединения. Соединение не работает, если Последнее обращение к серверу завершилось сбоем и не было завершено успешно.  
  
## <a name="remarks"></a>Remarks  
 Если соединение потеряно (сообщается через SQL_ATTR_CONNECTION_DEAD), диспетчер драйверов ODBC уничтожит это подключение, вызвав SQLDisconnect в драйвере. Новые запросы на подключение могут не найти пригодное для использования подключение в пуле. В конечном итоге диспетчер драйверов может создать новое соединение, предполагая, что пул пуст.  
  
 Чтобы использовать пул подключений, приложение выполняет следующие действия.  
  
1.  Включает создание пулов соединений путем вызова **SQLSetEnvAttr** для задания SQL_CP_ONE_PER_DRIVER или SQL_CP_ONE_PER_HENV атрибута среды SQL_ATTR_CONNECTION_POOLING. Этот вызов необходимо выполнить до того, как приложение выделит общую среду, для которой будет включен пул соединений. Обработчику среды в вызове **SQLSetEnvAttr** должно быть присвоено значение null, что делает SQL_ATTR_CONNECTION_POOLING атрибутом уровня процесса. Если атрибут имеет значение SQL_CP_ONE_PER_DRIVER, то для каждого драйвера поддерживается один пул соединений. Если приложение работает с множеством драйверов и несколькими средами, это может быть более эффективным, так как может потребоваться меньшее число сравнений. Если задано значение SQL_CP_ONE_PER_HENV, для каждой среды поддерживается один пул подключений. Если приложение работает со многими средами и несколькими драйверами, это может оказаться более эффективным, так как может потребоваться меньшее число сравнений. Пулы соединений отключены путем установки SQL_ATTR_CONNECTION_POOLING в значение SQL_CP_OFF.  
  
2.  Выделяет окружение путем вызова **функцию SQLAllocHandle** с аргументом *параметром handletype* , для которого задано значение SQL_HANDLE_ENV. Среда, выделенная этим вызовом, будет неявной общей средой, так как включена поддержка пулов соединений. Однако используемая среда не определена, пока в этой среде не будет вызван **функцию SQLAllocHandle** с *параметром handletype* SQL_HANDLE_DBC.  
  
3.  Выделяет соединение, вызывая **функцию SQLAllocHandle** с параметром *инпусандле* , для которого задано значение SQL_HANDLE_DBC, а *инпусандле* — обработчику среды, выделенному для пула соединений. Диспетчер драйверов пытается найти существующую среду, соответствующую атрибутам среды, заданным приложением. Если такой среды не существует, создается одна из них со счетчиком ссылок (поддерживаемым диспетчером драйверов), равным 1. Если найдена соответствующая общая среда, среда возвращается приложению, а значение счетчика ссылок увеличивается. (Фактическое подключение, которое должно использоваться, не определяется диспетчером драйверов, пока не будет вызван **SQLConnect** или **SQLDriverConnect** .)  
  
4.  Вызывает **SQLConnect** или **SQLDriverConnect** для создания соединения. Диспетчер драйверов использует параметры соединения в вызове **SQLConnect** (или ключевые слова подключения в вызове **SQLDriverConnect**) и атрибуты соединения, заданные после выделения соединения, чтобы определить, какое подключение в пуле следует использовать.  
  
    > [!NOTE]  
    >  Способ сопоставления запрошенного соединения с подключением в составе пула определяется атрибутом среды SQL_ATTR_CP_MATCH. Дополнительные сведения см. в разделе [SQLSetEnvAttr](../../../odbc/reference/syntax/sqlsetenvattr-function.md).  
  
     Приложения ODBC, использующие пулы подключений, должны вызывать [CoInitializeEx](https://go.microsoft.com/fwlink/?LinkID=116307) во время инициализации приложения и [CoUninitialize](https://go.microsoft.com/fwlink/?LinkId=116310) при закрытии приложения.  
  
5.  Вызывает **SQLDisconnect** при завершении соединения. Подключение возвращается в пул соединений и становится доступным для повторного использования.  
  
 Подробное обсуждение см. в разделе [объединение компонентов доступа к данным Microsoft](https://go.microsoft.com/fwlink/?LinkId=120776).  
  
## <a name="connection-pooling-considerations"></a>Рекомендации по пулам подключений  
 Выполнение любого из следующих действий с помощью команды SQL (а не через API ODBC) может повлиять на состояние соединения и привести к непредвиденным проблемам при активации пула соединений:  
  
-   Открытие соединения и изменение базы данных по умолчанию.  
  
-   Использование инструкции SET для изменения любых настраиваемых параметров (включая SET ROWCOUNT, ANSI_NULL, IMPLICIT_TRANSACTIONS, SHOWPLAN, STATISTICS, TEXTSIZE и DATEFORMAT).  
  
-   Создание временных таблиц и хранимых процедур.  
  
 Если какое-либо из этих действий выполняется за пределами ODBC API, следующий пользователь, использующий подключение, автоматически наследует предыдущие параметры, таблицы или процедуры.  
  
> [!NOTE]  
>  Не забудьте, чтобы некоторые параметры присутствовали в состоянии соединения. Необходимо всегда задавать состояние подключения в приложении и гарантировать, что приложение удаляет все неиспользуемые параметры пула соединений.  
  
## <a name="driver-aware-connection-pooling"></a>Организация пулов соединений с учетом драйвера  
 Начиная с Windows 8, драйвер ODBC может более эффективно использовать подключения в пуле. Дополнительные сведения см. в статье [Организация пулов соединений с учетом драйверов](../../../odbc/reference/develop-app/driver-aware-connection-pooling.md).  
  
## <a name="see-also"></a>См. также:  
 [Подключение к источнику данных или драйверу](../../../odbc/reference/develop-app/connecting-to-a-data-source-or-driver.md)   
 [Разработка драйвера ODBC](../../../odbc/reference/develop-driver/developing-an-odbc-driver.md)   
 [Использование пулов в компонентах доступа к данным Microsoft](https://go.microsoft.com/fwlink/?LinkId=120776)
