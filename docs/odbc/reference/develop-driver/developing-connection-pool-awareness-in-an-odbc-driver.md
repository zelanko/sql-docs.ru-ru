---
description: Разработка драйвера ODBC с поддержкой пула подключений
title: Разработка осведомленности о пуле подключений в драйвере ODBC | Документация Майкрософт
ms.custom: ''
ms.date: 01/19/2017
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
ms.assetid: c63d5cae-24fc-4fee-89a9-ad0367cddc3e
author: David-Engel
ms.author: v-daenge
ms.openlocfilehash: 519a2b64f6a5330b8c8fde458323c6c900941025
ms.sourcegitcommit: e700497f962e4c2274df16d9e651059b42ff1a10
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "88476276"
---
# <a name="developing-connection-pool-awareness-in-an-odbc-driver"></a>Разработка драйвера ODBC с поддержкой пула подключений
В этом разделе обсуждаются сведения о разработке драйвера ODBC, который содержит сведения о том, как драйвер должен предоставлять службы пулов подключений.  
  
## <a name="enabling-driver-aware-connection-pooling"></a>Включение пулов соединений с учетом драйверов  
 Драйвер должен реализовывать следующие функции интерфейса поставщика служб ODBC (SPI):  
  
-   склсетконнектаттрфордбЦинфо  
  
-   склсетконнектинфо  
  
-   склсетдриверконнектинфо  
  
-   склжетпулид  
  
-   склратеконнектион  
  
-   склпулконнект  
  
-   склклеанупконнектионпулид  
  
 Дополнительные сведения см. в [справочнике по интерфейсу поставщика служб ODBC (SPI)](../../../odbc/reference/syntax/odbc-service-provider-interface-spi-reference.md) .  
  
 Драйвер также должен реализовывать следующие существующие функции, чтобы можно было включить поддержку пулов с поддержкой драйверов.  
  
|Функция|Добавлена функциональность|  
|--------------|-------------------------|  
|[Функцию SQLAllocHandle](../../../odbc/reference/syntax/sqlallochandle-function.md)<br /><br /> [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md)<br /><br /> [SQLGetDiagField](../../../odbc/reference/syntax/sqlgetdiagfield-function.md)<br /><br /> [Функции SQLGetDiagRec](../../../odbc/reference/syntax/sqlgetdiagrec-function.md)|Поддержка нового типа обработчика: SQL_HANDLE_DBC_INFO_TOKEN (см. описание ниже).|  
|[SQLSetConnectAttr](../../../odbc/reference/syntax/sqlsetconnectattr-function.md)|Поддержка нового атрибута подключения только для установки: SQL_ATTR_DBC_INFO_TOKEN для сброса подключения (см. описание ниже).|  
  
> [!NOTE]  
>  Устаревшие функции, такие как **SqlError** и **SQLSetConnectOption** , не поддерживаются для пулов соединений с учетом драйверов.  
  
## <a name="the-pool-id"></a>Идентификатор пула  
 Идентификатор пула — это идентификатор, зависящий от драйвера длины указателя, для представления определенной группы соединений, которые могут использоваться взаимозаменяемыми. При наличии набора сведений о соединении драйвер должен быстро вывести соответствующий идентификатор пула.  
  
 Например, идентификатор пула должен кодировать имя сервера и учетные данные. Однако имя базы данных не требуется, так как драйвер может повторно использовать подключение, а затем изменить базу данных меньше времени, чем создание нового соединения.  
  
 Драйвер должен определять набор ключевых атрибутов, который будет состоять из идентификатора пула. Значения этих ключевых атрибутов могут поступать из атрибутов соединения, строки подключения и имени DSN. В случае возникновения конфликтов в этих источниках для обеспечения обратной совместимости следует использовать существующую политику разрешения для конкретного драйвера.  
  
 Диспетчер драйверов будет использовать другой пул для разных идентификаторов пула. Все подключения в одном пуле можно использовать повторно. Диспетчер драйверов никогда не будет повторно использовать подключение с другим ИДЕНТИФИКАТОРом пула.  
  
 Поэтому драйверы должны назначить уникальный идентификатор пула для каждой группы соединений с тем же значением в определенных ключевых атрибутах. Если драйвер использует один и тот же идентификатор пула для двух соединений с разными значениями в их ключевых атрибутах, диспетчер драйверов по-прежнему будет размещать их в одном пуле (диспетчер драйверов не знает о ключевых атрибутах, связанных с драйвером). Это означает, что драйверу потребуется сообщить диспетчеру драйверов, что подключение с другим набором ключевых атрибутов не может быть использовано повторно внутри [функции склратеконнектион](../../../odbc/reference/syntax/sqlrateconnection-function.md). Это может снизить производительность, и это не рекомендуется.  
  
 Диспетчер драйверов не будет повторно использовать подключение, выделенное из другой среды драйвера, даже если все сведения о соединении совпадают. Диспетчер драйверов будет использовать другой пул для различных сред, даже если у подключений один и тот же идентификатор пула. Таким образом, идентификатор пула является локальным для своей среды драйвера.  
  
 Функция получения идентификатора пула из драйвера является [Склжетпулид функцией](../../../odbc/reference/syntax/sqlgetpoolid-function.md).  
  
## <a name="the-connection-rating"></a>Оценка подключения  
 По сравнению с установкой нового подключения можно повысить производительность, переустановив некоторые сведения о соединении (например, базу данных) в соединении в составе пула. Поэтому может потребоваться, чтобы имя базы данных не настроилось в наборе ключевых атрибутов. В противном случае у вас может быть отдельный пул для каждой базы данных, который может быть неприемлемым в приложениях среднего уровня, где клиенты используют разные строки подключения.  
  
 При повторном использовании соединения с несоответствием атрибутов следует сбросить несовпадающие атрибуты на основе нового запроса приложения, чтобы возвращаемое соединение совпадало с запросом приложения (см. обсуждение атрибута SQL_ATTR_DBC_INFO_TOKEN в [функции SQLSetConnectAttr](https://go.microsoft.com/fwlink/?LinkId=59368)). Однако сброс этих атрибутов может привести к снижению производительности. Например, для сброса базы данных требуется сетевой вызов сервера. Поэтому повторно используйте подключение, которое вполне соответствует, если оно доступно.  
  
 Функция оценки в драйвере может оценить существующее соединение с новым запросом на соединение. Например, функция оценки драйвера может определить:  
  
-   Значение, если существующее соединение вполне соответствует запросу.  
  
-   При наличии только некоторых несущественных несовпадений, таких как время ожидания соединения, для сброса которых не требуется обмен данными с сервером.  
  
-   Если имеется несколько несовпадающих атрибутов, требующих подключения к серверу для сброса, но при этом производительность по-прежнему будет выше, чем при установлении нового соединения.  
  
-   В случае несоответствия для атрибута, который требует слишком много времени на сброс (разработчик драйвера может рассмотреть возможность добавления этого атрибута в набор ключевых атрибутов, который используется для создания идентификатора пула).  
  
 Возможна оценка от 0 до 100, где 0 означает, что не следует повторно использовать, а 100 означает, что они вполне соответствуют друг другу. [Склратеконнектион](../../../odbc/reference/syntax/sqlrateconnection-function.md) — это функция оценки соединения.  
  
## <a name="new-odbc-handle---sql_handle_dbc_info_token"></a>Новый обработчик ODBC-SQL_HANDLE_DBC_INFO_TOKEN  
 Для поддержки пулов соединений с учетом драйверов драйверу требуются сведения о подключении для вычислить идентификатор пула. Драйверу также требуются сведения о подключении для сравнения новых запросов на соединение с соединениями в пуле.  Если подключение в пуле не может быть использовано повторно, драйверу необходимо установить новое соединение, в связи с чем требуется информация о соединении.  
  
 Так как сведения о соединении могут поступать из нескольких источников (строка подключения, атрибуты соединения и DSN), драйверу может потребоваться выполнить синтаксический анализ строки подключения и устранить конфликт между этими источниками в каждом вызове функции.  
  
 Таким образом, появился новый обработчик ODBC: SQL_HANDLE_DBC_INFO_TOKEN. При использовании SQL_HANDLE_DBC_INFO_TOKEN драйверу не требуется анализировать строку подключения и разрешать конфликты в сведениях о соединении более одного раза. Так как это структура данных, специфичная для драйвера, драйвер может хранить такие данные, как сведения о соединении или идентификатор пула.  
  
 Этот обработчик используется только в качестве интерфейса между диспетчером драйверов и драйвером. Приложение не может напрямую выделить этот обработчик.  
  
 Родительский маркер этого маркера относится к типу SQL_HANDLE_ENV, что означает, что драйвер может получить сведения о среде из маркера ХЕНВ во время разрешения сведений о соединении.  
  
 При получении нового запроса на подключение диспетчер драйверов выделит обработчик типа SQL_HANDLE_DBC_INFO_TOKEN для хранения сведений о соединении после подтверждения того, что драйвер поддерживает сведения о пуле подключений. После завершения использования маркера (но перед возвратом некоторых кодов возврата, отличных от SQL_STILL_EXECUTING из [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) или [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md)), диспетчер драйверов освободит этот обработчик. Таким образом, маркер создается после вызова функцию SQLAllocHandle и уничтожается после вызова SQLFreeHandle. Диспетчер драйверов гарантирует, что дескриптор будет освобожден до освобождения связанного ХЕНВ (когда [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) или [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md) возвращает ошибку).  
  
 Драйвер должен изменить следующие функции, чтобы принять новый тип обработчика SQL_HANDLE_DBC_INFO_TOKEN:  
  
1.  [Функцию SQLAllocHandle](../../../odbc/reference/syntax/sqlallochandle-function.md)  
  
2.  [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md)  
  
3.  [SQLGetDiagField](../../../odbc/reference/syntax/sqlgetdiagfield-function.md)  
  
4.  [Функции SQLGetDiagRec](../../../odbc/reference/syntax/sqlgetdiagrec-function.md)  
  
 Диспетчер драйверов гарантирует, что несколько потоков не будут использовать один и тот же дескриптор SQL_HANDLE_DBC_INFO_TOKEN одновременно. Поэтому модель синхронизации этого маркера может быть очень простой в драйвере. Диспетчер драйверов не будет выполнять блокировку среды перед выделением и освобождением SQL_HANDLE_DBC_INFO_TOKEN.  
  
 **Функцию SQLAllocHandle** и **SQLFreeHandle** диспетчера драйверов не будут принимать этот новый тип обработчика.  
  
 SQL_HANDLE_DBC_INFO_TOKEN может содержать конфиденциальные сведения, такие как учетные данные. Поэтому драйвер должен безопасно очищать буфер памяти (с помощью [секурезеромемори](https://msdn.microsoft.com/library/windows/desktop/aa366877\(v=vs.85\).aspx)), содержащий конфиденциальные сведения, перед освобождением этого маркера с помощью **SQLFreeHandle**. При закрытии обработчика среды приложения все связанные с ним пулы соединений будут закрыты.  
  
## <a name="driver-manager-connection-pool-rating-algorithm"></a>Алгоритм оценки пула подключений диспетчера драйверов  
 В этом разделе обсуждается алгоритм оценки для пулов подключений диспетчера драйверов. Разработчики драйверов могут реализовать один и тот же алгоритм для обеспечения обратной совместимости. Этот алгоритм может быть не лучшим. Необходимо уточнить этот алгоритм на основе реализации (в противном случае нет причин реализации этой функции).  
  
 Диспетчер драйверов вернет целочисленную оценку от 0 до 100 для каждого подключения из пула. 0 означает, что соединение не может быть использовано повторно, а 100 означает идеальное соответствие. Предположим, что запрос на подключение называется Хрекуест, а существующее соединение из пула имеет имя Хкандидате. Если одно из следующих условий имеет значение false, Хкандидате подключения к пулу нельзя использовать повторно для Хрекуест (диспетчер драйверов присвоит Рейтинг 0).  
  
-   Хкандидате и Хрекуест поступают из любого из API Юникода (например, SQLDriverConnectW) или API ANSI (например, SQLDriverConnectA). (Драйверы Юникода могут повлиять на поведение API ANSI и API Юникода (см. атрибут Connection SQL_ATTR_ANSI_APP).)  
  
-   Хкандидате и Хрекуест создаются одной и той же функцией. либо SQLDriverConnect, либо SQLConnect.  
  
-   Строка подключения, используемая для открытия Хкандидате, должна быть той же, что и Хрекуест, при использовании SQLDriverConnect.  
  
-   Имя сервера (или DSN), имена пользователей и пароли, используемые для открытия Хкандидате, должны быть теми же, которые используются для открытия Хрекуест при использовании SQLConnect.  
  
-   Идентификатор безопасности (SID) текущего потока должен быть таким же, как и идентификатор SID, используемый для открытия Хкандидате.  
  
-   Для драйвера, требующего много ресурсов для включения и открепления (см. обсуждение SQL_DTC_TRANSITION_COST в [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md)), повторное использование *хрекуест* не должно требовать дополнительного зачисления или открепления.  
  
 В следующей таблице показано назначение оценки для различных сценариев.  
  
|Сравнение атрибутов соединения между соединением в составе пула и запросом|Нет зачислений и отчислений прикрепления|Требовать дополнительного зачисления/открепления|  
|---------------------------------------------------------------------------------------|-----------------------------------|----------------------------------------------|  
|Каталог (SQL_ATTR_CURRENT_CATALOG) отличается|60|50|  
|Некоторые атрибуты соединения различаются, но каталог одинаков|90|70|  
|Все атрибуты соединения вполне соответствуют|100|80|  
  
## <a name="sequence-diagram"></a>Диаграмма последовательностей  
 На этой схеме последовательностей показан базовый механизм пулов, описанный в этом разделе. Он показывает только использование [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) , но регистр [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md) аналогичен.  
  
 ![Схема последовательностей](../../../odbc/reference/develop-driver/media/odbc_seq_dia.gif "odbc_seq_dia")  
  
## <a name="state-diagram"></a>Диаграмма состояния  
 На этой схеме состояния показан объект маркера сведений о соединении, описанный в этом разделе. На схеме показан только [SQLDriverConnect](../../../odbc/reference/syntax/sqldriverconnect-function.md) , но регистр [SQLConnect](../../../odbc/reference/syntax/sqlconnect-function.md) похож. Поскольку диспетчеру драйверов может потребоваться выполнить обработку ошибок в любое время, диспетчер драйверов может вызвать [SQLFreeHandle](../../../odbc/reference/syntax/sqlfreehandle-function.md) для любого состояния.  
  
 ![Диаграмма состояний](../../../odbc/reference/develop-driver/media/odbc_state_diagram.gif "odbc_state_diagram")  
  
## <a name="see-also"></a>См. также  
 [Организация пулов соединений с учетом драйверов](../../../odbc/reference/develop-app/driver-aware-connection-pooling.md)   
 [Справочник по интерфейсу службы доступа (SPI) ODBC](../../../odbc/reference/syntax/odbc-service-provider-interface-spi-reference.md)
