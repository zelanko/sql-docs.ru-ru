---
title: Реализация динамической безопасности с помощью фильтров строк | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: analysis-services
ms.topic: conceptual
ms.assetid: 8bf03c45-caf5-4eda-9314-e4f8f24a159f
author: minewiskan
ms.author: owend
manager: kfile
ms.openlocfilehash: 49a62fb647b7b1a1579103f96907d0635ecc635f
ms.sourcegitcommit: a1adc6906ccc0a57d187e1ce35ab7a7a951ebff8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/09/2019
ms.locfileid: "68893604"
---
# <a name="implement-dynamic-security-by-using-row-filters"></a>Реализация динамической безопасности с помощью фильтров строк
  На этом дополнительном занятии будет создана дополнительная роль, реализующая динамическую безопасность. Динамическая безопасность позволяет определять защиту на уровне строк с учетом имени или идентификатор входа пользователя, который находится в системе в данный момент. Дополнительные сведения см. в разделе [Роли (табличные службы SSAS)](https://docs.microsoft.com/analysis-services/tabular-models/roles-ssas-tabular).  
  
 Для реализации динамической безопасности необходимо добавить в модель таблицу, содержащую имена тех пользователей, которые могут создавать соединения с моделью как с источником данных и просматривать объекты и данные модели. Модель, которая будет создана на этом занятии, находится в контексте Adventure Works Corp. Но в целях данного занятия добавим таблицу, содержащую пользователей из собственного домена пользователя. Для добавляемых имен пользователей пароли не потребуются. Для создания таблицы «Безопасность сотрудников» с небольшой выборкой пользователей из собственного домена пользователя будет использована функция вставки данных из электронной таблицы Excel. В реальном сценарии таблица, содержащая добавляемые в модель имена, будет использовать таблицу из фактической базы данных в качестве источника данных — например, реальную таблицу dimEmployee.  
  
 Чтобы реализовать динамическую безопасность, вы будете использовать две новые функции DAX: [USERNAME функция &#40;DAX&#41; ](/dax/username-function-dax) и [функция &#40;LOOKUPVALUE DAX&#41;](/dax/lookupvalue-function-dax). Эти функции, примененные к формуле фильтра строк, определяются в новой роли. Функция LOOKUPVALUE получает значение из таблицы «Безопасность сотрудников» и передает его функции USERNAME, которая указывает имя вошедшего в систему пользователя, относящегося к этой роли. Затем пользователь может просматривать только данные, указанные фильтрами строк роли. В этом сценарии нужно будет указать, что сотрудники отдела продаж могут просматривать только те данные интернет-продаж, которые относятся к их региону.  
  
 Во время выполнения этого дополнительного занятия нужно будет выполнить ряд заданий. Эти задачи являются уникальными для сценария табличной модели Adventure Works, но они не могут иметь прямого отношения к реальному сценарию. Каждое задание включает дополнительные сведения, описывающие цель задания.  
  
 Предполагаемое время выполнения этого занятия: **30 минут**  
  
## <a name="prerequisites"></a>предварительные требования  
 Это дополнительное занятие является частью учебника по табличному моделированию, который необходимо изучать по порядку. Прежде чем выполнять задания в этом дополнительном занятии, необходимо завершить все предыдущие занятия.  
  
## <a name="add-the-dimsalesterritory-table-to-the-aw-internet-sales-tabular-model-project"></a>Добавление таблицы dimSalesTerritory в проект табличной модели интернет-продаж AW  
 Чтобы реализовать динамическую безопасность для этого сценария Adventure Works, необходимо добавить в модель две дополнительные таблицы. Первая таблица, которая будет добавлена, называется dimSalesTerritory (т. е. территория продаж) из той же базы данных AdventureWorksDW. После этого к таблице «Территория продаж» будет применен фильтр строк, определяющий данные, которые может просматривать вошедший в систему пользователь.  
  
#### <a name="to-add-the-dimsalesterritory-table"></a>Добавление таблицы dimSalesTerritory  
  
1.  В среде [!INCLUDE[ssBIDevStudio](../includes/ssbidevstudio-md.md)]выберите в меню **Модель** пункт **Существующие соединения**.  
  
2.  Убедитесь в том, что в диалоговом окне **Существующие соединения** выбрано соединение с источником данных **База данных Adventure Works из SQL** , и нажмите кнопку **Открыть**.  
  
     Если появится диалоговое окно учетные данные олицетворения, введите учетные данные олицетворения, которые использовались на занятии 2. Добавление данных.  
  
3.  Убедитесь в том, что на странице **Выбор способа импорта данных** выбран пункт **Выбрать из списка таблиц и представлений, чтобы определить данные для импорта** , и нажмите кнопку **Далее**.  
  
4.  На странице **Выбор таблиц и представлений** выберите таблицу **DimSalesTerritory**.  
  
5.  В столбце "Понятное имя" введите **Территория продаж**.  
  
6.  Нажмите кнопку **Просмотр и применение фильтра**.  
  
7.  Снимите выделение со столбца **SalesTerritoryAlternateKey** и нажмите кнопку **ОК**.  
  
8.  На странице **Выбор таблиц и представлений** нажмите кнопку **Готово**.  
  
     Новая таблица будет добавлена в рабочую область модели. Объекты и данные из исходной таблицы dimSalesTerritory будут импортированы в новую таблицу «Территория продаж» в табличной модели Интернет-продаж AW.  
  
9. После импорта таблицы нажмите кнопку **Закрыть**.  
  
## <a name="give-the-columns-friendly-names"></a>Присвоение понятных имен  
 В этом задании нужно будет переименовать столбцы в таблице «Территория продаж» и присвоить им понятные имена. Не всегда обязательно назначать таблицам или столбцам понятные имена, но такой прием упрощает перемещения по проекту модели в конструкторе моделей, а также для пользователей, просматривающих объекты модели и данные в списке полей клиентского приложения.  
  
#### <a name="to-rename-columns-in-the-sales-territory-table"></a>Переименование столбцов в таблице «Территория продаж»  
  
-   В конструкторе моделей переименуйте столбцы в таблице **Территория продаж** .  
  
     **Территория продаж**  
  
    |Имя источника|Понятное имя|  
    |-----------------|-------------------|  
    |SalesTerritoryKey|Идентификатор территории продаж|  
    |SalesTerritoryRegion|Регион территории продаж|  
    |SalesTerritoryCountry|Страна территории продаж|  
    |SalesTerritoryGroup|Группа территории продаж|  
  
## <a name="add-a-table-with-user-name-data"></a>Добавление таблицы с именами пользователей  
 Поскольку таблица dimEmployee в образце базы данных AdventureWorksDW содержит пользователей из домена AdventureWorks и эти имена пользователей не существуют в текущей среде, необходимо создать таблицу в модели, содержащей небольшую выборку (дерево) фактических пользователей из организации. После этого нужно добавить этих пользователей как членов в новую роль. Для выборки имен пользователей пароли не требуются, однако нужны имена реальных пользователей Windows из домена.  
  
#### <a name="to-add-an-employee-security-table"></a>Добавление таблицы «Безопасность сотрудников»  
  
1.  Откройте Microsoft Excel и создайте новую электронную таблицу.  
  
2.  Скопируйте следующую таблицу, включая строку заголовка, и вставьте ее в электронную таблицу.  
  
    |Идентификатор сотрудника|Идентификатор территории продаж|First Name|Last Name|Идентификатор имени входа|  
    |-----------------|------------------------|----------------|---------------|--------------|  
    |1|2|\<имя пользователя >|\<Фамилия пользователя >|\<домен \ имя_пользователя >|  
    |1|3|\<имя пользователя >|\<Фамилия пользователя >|\<домен \ имя_пользователя >|  
    |2|4|\<имя пользователя >|\<Фамилия пользователя >|\<домен \ имя_пользователя >|  
    |3|5|\<имя пользователя >|\<Фамилия пользователя >|\<домен \ имя_пользователя >|  
  
3.  В новой электронной таблице замените имя, фамилию и домен или имя пользователя именами и идентификаторами имен входа трех пользователей из организации. Вставьте одного и того же пользователя в первые две строки для столбца «Идентификатор сотрудника 1». Это означает, что пользователь относится к более чем одной территории продаж. Не изменяйте поля «Идентификатор сотрудника» и «Идентификатор территории продаж».  
  
4.  Сохраните лист как `Sample Employee`.  
  
5.  На листе выделите все ячейки с данными по сотрудникам, включая заголовки, щелкните правой кнопкой мыши выделенные данные и выберите пункт **Копировать**.  
  
6.  В среде [!INCLUDE[ssBIDevStudio](../includes/ssbidevstudio-md.md)] выберите в меню **Правка** команду **Вставить**.  
  
     Если команда "Вставить" неактивна, щелкните любой столбец в любой таблице в окне конструктора моделей, а затем повторно выберите в меню **Правка** команду **Вставить**.  
  
7.  В диалоговом окне **Просмотр вставки** в поле **имя таблицы**введите `Employee Security`.  
  
8.  Убедитесь в том, что в поле **Вставляемые данные**данные включают все сведения о пользователях и заголовки из листа "Выборка сотрудников".  
  
9. Убедитесь в том, что установлен флажок **Использовать первую строку в качестве заголовков столбцов** , и нажмите кнопку **ОК**.  
  
     Будет создана новая таблица «Безопасность сотрудников» с данными о сотрудниках, скопированными из электронной таблицы «Выборка сотрудников».  
  
## <a name="create-relationships-between-internet-sales-geography-and-sales-territory-table"></a>Создание связей между Интернет-продажами, географическим положением и территорией продаж  
 Все таблицы «Интернет-продажи», «География» и «Территория продаж» имеют общий столбец «Идентификатор территории продаж». Столбец «Идентификатор территории продаж» в таблице «Территория продаж» содержит значения и разный идентификатор для каждой территории продаж.  
  
#### <a name="to-create-relationships-between-the-internet-sales-geography-and-the-sales-territory-table"></a>Создать связи между Интернет-продажами, географическим положением и территорией продаж  
  
1.  В конструкторе моделей в представлении диаграммы в таблице **География** щелкните и удерживайте нажатым столбец **Идентификатор территории продаж** , а затем перетащите курсор в столбец **Идентификатор территории продаж** в таблице **Территория продаж** и отпустите кнопку мыши.  
  
2.  В таблице **Интернет-продажи** щелкните и удерживайте нажатым столбец **Идентификатор территории продаж** , а затем перетащите курсор в столбец **Идентификатор территории продаж** в таблице **Территория продаж** и отпустите кнопку мыши.  
  
     Обратите внимание, что свойство «Активный» для этого связи имеет значение False, то есть оно неактивно. Это происходит потому, что таблица «Интернет-продажи» уже содержит другую активную связь, используемую в мерах.  
  
## <a name="hide-the-employee-security-table-from-client-applications"></a>Скрытие таблицы «Безопасность сотрудников» от клиентских приложений  
 В этой задаче будет скрыта таблица «безопасность сотрудников», которая останется в списке полей клиентского приложения. Помните, что скрытие таблицы не обеспечивает ее безопасность. Пользователи по-прежнему смогут отправлять запросы на получение данных из таблицы «Безопасность сотрудников», если они знают, как это сделать. Чтобы обезопасить данные таблицы «Безопасность сотрудников» и запретить пользователям отправлять запросы на получение данных из нее, в одном из следующих заданий будет применен фильтр.  
  
#### <a name="to-hide-the-employee-table-from-client-applications"></a>Скрытие таблицы «Сотрудники» от клиентских приложений  
  
-   В конструкторе моделей в представлении диаграммы щелкните правой кнопкой мыши заголовок таблицы **Сотрудник** и выберите команду **Скрыть из набора клиентских средств**.  
  
## <a name="create-a-sales-employees-by-territory-user-role"></a>Создание пользовательской роли «Сотрудники отдела продаж по территории»  
 На этом занятии будет создана новая пользовательская роль. Эта роль будет включать фильтр строк, определяющий, какие строки из таблицы «Территории продаж» видимы пользователям. После этого фильтр будет применен в направлении «один-ко-многим» ко всем остальным таблицам, связанным с территорией продаж. Будет также применен простой фильтр, обеспечивающий безопасность всей таблицы «Безопасность сотрудников» так, чтобы пользователи-члены роли не могли направлять к ней запросы.  
  
> [!NOTE]  
>  Роль «Сотрудники отдела продаж по территории», создаваемая на этом занятии, ограничивает возможность членов, просматривающих данные продаж, территорией, к которой они относятся. При добавлении пользователя в качестве члена роли «сотрудники отдела продаж по территориям», которая также существует как участник в роли, созданной [в занятии 12: Создайте роли](https://docs.microsoft.com/analysis-services/lesson-11-create-roles), вы получите сочетание разрешений. Когда пользователь является членом нескольких ролей, он обладает всеми разрешениями, определенными для каждой из них. Это означает, что пользователь будет иметь больше разрешений, определяемых сочетанием ролей.  
  
#### <a name="to-create-a-sales-employees-by-territory-user-role"></a>Создание пользовательской роли «Сотрудники отдела продаж по территории»  
  
1.  В среде [!INCLUDE[ssBIDevStudio](../includes/ssbidevstudio-md.md)] в меню **Модель** выберите пункт **Роли**.  
  
2.  В диалоговом окне **Диспетчер ролей** выберите **Создать**.  
  
     В список будет добавлена новая роль с разрешением «Нет».  
  
3.  Щелкните новую роль, а затем в столбце **имя** переименуйте роль в `Sales Employees by Territory`.  
  
4.  В столбце **Разрешения** щелкните раскрывающийся список и выберите разрешение **Чтение** .  
  
5.  Перейдите на вкладку **Члены** и выберите команду **Добавить**.  
  
6.  В диалоговом окне **Выбор пользователя или группы** введите в поле **Введите имя объекта**первое имя из выборки пользователей, которое было использовано при создании таблицы "Безопасность сотрудников". Щелкните **Проверить имена**, чтобы убедиться в том, что имя является действительным, и нажмите кнопку **ОК**.  
  
     Повторите этот шаг, добавляя другие имена из выборки пользователей, которая была создана в момент создания таблицы «Безопасность сотрудников».  
  
7.  Откройте вкладку **Фильтры строк** .  
  
8.  Для таблицы в столбце **Фильтр DAX** введите следующую формулу. `Employee Security`  
  
     `=FALSE()`  
  
     Завершив построение формулы, нажмите клавишу ВВОД.  
  
     Эта формула указывает, что все столбцы решаются по логическому условию со значением false. Таким образом, член пользовательской роли «Сотрудники отдела продаж по территории» не сможет отправлять запросы на получение данных из таблицы «Безопасность сотрудников».  
  
9. Для таблицы **Территория продаж** введите следующую формулу:  
  
     `='Sales Territory'[Sales Territory Id]=LOOKUPVALUE('Employee Security'[Sales Territory Id], 'Employee Security'[Login Id], USERNAME(), 'Employee Security'[Sales Territory Id], 'Sales Territory'[Sales Territory Id])`  
  
     Завершив построение формулы, нажмите клавишу ВВОД.  
  
     В этой формуле функция LOOKUPVALUE возвращает все значения для столбца «Безопасность сотрудников[Идентификатор территории продаж]», где «Безопасность сотрудников[Идентификатор имени входа]» не отличается от текущего имени входа пользователя Windows, а «Безопасность сотрудников[Идентификатор территории продаж]» — от «Территория продаж[Идентификатор территории продаж]».  
  
     Набор идентификаторов территории продаж, возвращаемый функцией LOOKUPVALUE, используется для ограничения строк, отображаемых в таблице «Территория продаж». В результате будут отображены только те строки, для которых идентификатор территории продаж для строки входит в набор идентификаторов, возвращенных функцией LOOKUPVALUE.  
  
10. В диалоговом окне "Диспетчер ролей" нажмите кнопку **ОК**.  
  
## <a name="test-the-sales-employees-by-territory-user-role"></a>Тестирование пользовательской роли «Сотрудники отдела продаж по территории»  
 В этом задании для проверки пользовательской роли «Сотрудники отдела продаж по территории» будет использована функция анализа в Excel в среде [!INCLUDE[ssBIDevStudio](../includes/ssbidevstudio-md.md)]. Будет указано одно из имен пользователей, добавленных в таблицу «Безопасность сотрудников» и в качестве члена роли. Это имя пользователя будет затем использовано как имя реального пользователя для соединения, установленного между Excel и моделью.  
  
#### <a name="to-test-the-sales-employees-by-territory-user-role"></a>Тестирование пользовательской роли «Сотрудники отдела продаж по территории»  
  
1.  В среде [!INCLUDE[ssBIDevStudio](../includes/ssbidevstudio-md.md)]щелкните меню **Модель** и выберите пункт **Анализ в Excel**.  
  
2.  В диалоговом окне **Анализ в Excel** в поле **Укажите имя пользователя или роль для подключения к модели**выберите вариант **Другой пользователь Windows**и нажмите кнопку **Обзор**.  
  
3.  В диалоговом окне **Выбор пользователя или группы** введите одно из имен пользователей, добавленных в таблицу "Сотрудник", в поле **Введите имя объекта**и нажмите кнопку **Проверить имена**.  
  
4.  Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Выбор пользователя или группы**, а затем кнопку **ОК**, чтобы закрыть диалоговое окно **Анализ в Excel**.  
  
     Excel откроет новую книгу. Сводная таблица будет создана автоматически. Список полей сводной таблицы включает большинство полей данных, доступных в новой модели.  
  
     Обратите внимание, что таблица «Безопасность сотрудников», не видна в списке полей сводной таблицы. Это происходит потому, что эта таблица была скрыта от клиентских средств в предыдущем задании.  
  
5.  В списке **Поле сводной таблицы** в поле **∑ интернет-продаж** (меры) выберите меру **Всего продано в Интернете** . Мера будет указана в полях **Значения**.  
  
6.  В списке **Поле сводной таблицы** выберите столбец **Идентификатор территории продаж** из таблицы **Территория продаж** . Столбец будет введен в поля **Метки строк**.  
  
     Обратите внимание, что цифры продаж появятся только для того региона, к которому относится имя пользователя. Если выбрать другой столбец, например «Город» из таблицы «География» в качестве поля «Метка строки», то будут отображены города только для той территории продаж, к которой относится пользователь.  
  
     Этот пользователь не может просматривать или отправлять запросы для получения данных Интернет-продаж для других территорий, к которым он не относится, поскольку фильтр строк, определенный для таблицы «Территория продаж» в пользовательской роли «Сотрудники отдела продаж по территории», надежно защищает все данные, связанные с другими территориями продаж.  
  
## <a name="see-also"></a>См. также  
 [ИМЯ пользователя &#40;функция DAX&#41;](/dax/username-function-dax)   
 [LOOKUPVALUE, &#40;функция DAX&#41;](/dax/lookupvalue-function-dax)   
 [CUSTOMDATA, &#40;функция DAX&#41;](/dax/customdata-function-dax)  
  
  
