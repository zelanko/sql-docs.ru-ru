---
title: Аварийное восстановление WSFC через принудительный кворум (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.suite: ''
ms.technology: high-availability
ms.tgt_pltfrm: ''
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], WSFC clusters
- quorum [SQL Server], AlwaysOn and WSFC quorum
- failover clustering [SQL Server], AlwaysOn Availability Groups
ms.assetid: 6cefdc18-899e-410c-9ae4-d6080f724046
caps.latest.revision: 20
author: MashaMSFT
ms.author: mathoma
manager: craigg
ms.openlocfilehash: 4be22e7a2e81ff8c5eeac83d25c7361cc1833078
ms.sourcegitcommit: c18fadce27f330e1d4f36549414e5c84ba2f46c2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2018
ms.locfileid: "37161765"
---
# <a name="wsfc-disaster-recovery-through-forced-quorum-sql-server"></a>Аварийное восстановление WSFC через принудительный кворум (SQL Server)
  Обычно сбой кворума бывает вызван системной аварией, постоянным сбоем связи или ошибкой конфигурации, затрагивающей несколько узлов в кластере WSFC.  Для восстановления после сбоя кворума требуется участие пользователя.  
  
-   **Before you start:**  [Prerequisites](#Prerequisites), [Security](#Security)  
  
-   **Аварийное восстановление WSFC с помощью процедуры принудительного кворума** [Аварийное восстановление WSFC с помощью процедуры принудительного кворума](#Main)  
  
-   [Связанные задачи](#RelatedTasks)  
  
-   [См. также](#RelatedContent)  
  
##  <a name="BeforeYouBegin"></a> Перед началом работы  
  
###  <a name="Prerequisites"></a> Предварительные требования  
 В процедуре принудительного кворума предполагается, что перед сбоем кворума кворум был работоспособен.  
  
> [!WARNING]  
>  Пользователь должен хорошо представлять основные понятия и принципы взаимодействия кластера WSFC, моделей кворума WSFC, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]и конфигурации развертывания, зависящей от среды.  
>   
>  Дополнительные сведения см. в следующих статьях:  [Отказоустойчивая кластеризация Windows Server (WSFC) с SQL Server](http://msdn.microsoft.com/library/hh270278\(v=SQL.110\).aspx), [Режим кворума и участвующая в голосовании конфигурация WSFC (SQL Server)](http://msdn.microsoft.com/library/hh270280\(v=SQL.110\).aspx)  
  
###  <a name="Security"></a> безопасность  
 Пользователь должен входить в учетную запись домена, которая является членом локальной группы администраторов, на каждом узле кластера WSFC.  
  
##  <a name="Main"></a> Аварийное восстановление WSFC с помощью процедуры принудительного кворума  
 Помните, что сбой кворума приведет к переходу в режим «вне сети» всех служб, поддерживающих работу в кластере, экземпляров SQL Server, [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]и групп доступности в кластере WSFC, поскольку настроенный таким образом кластер не сможет гарантировать отказоустойчивость на уровне узлов.  Сбой кворума означает, что исправные голосующие узлы в кластере WSFC более не удовлетворяют модели кворума. Некоторые узлы, возможно, полностью вышли из строя, на других могла просто отключиться служба WSFC, а в остальном они работают исправно, за исключением потери возможности взаимодействовать с кворумом.  
  
 Чтобы вернуть кластер WSFC в режим в сети, следует исправить главную причину сбоя кворума при существующей конфигурации, восстановить, как требуется, затронутые базы данных и провести повторную настройку оставшихся узлов в кластере WSFC, чтобы они отражали сложившуюся топологию кластера.  
  
 Можно использовать процедуру *принудительного кворума* на узле кластера WSFC, чтобы переопределить управляющие параметры безопасности, которые привели к переходу кластера в режим «вне сети».  Она предписывает кластеру приостановить проверки голосования кворума, и позволяет привести ресурсы кластера WSFC и SQL Server обратно в режим «в сети» на любом из узлов кластера.  
  
 Этот тип процесса аварийного восстановления после аварий должен включать следующие этапы.  
  
#### <a name="to-recover-from-quorum-failure"></a>Для восстановления после сбоя кворума:  
  
1.  **Определите область сбоя.** Определите, какие группы доступности или экземпляры SQL Server не отвечают, какие узлы кластера работают в сети и доступны для использования после аварии, изучите журналы событий Windows и системные журналы SQL Server.  Там, где это практически возможно, следует сохранить аналитические данные и системные журналы для последующего анализа.  
  
    > [!TIP]  
    >  На главном экземпляре [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)]можно получить сведения о работоспособности групп доступности, которые имеют реплику доступности на экземпляре локального сервера, выполнив запрос к динамическому административному представлению (DMV) [sys.dm_hadr_availability_group_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-availability-group-states-transact-sql) .  
  
2.  **Запустите кластер WSFC с помощью принудительного кворума на одном узле.** Определите узел с минимальным количеством сбоев компонентов, отличный от того, на котором служба кластеров WSFC была закрыта.  Убедитесь, что этот узел может взаимодействовать с большинством других узлов.  
  
     На этом узле вручную запустите работу кластера с помощью процедуры принудительного кворума кластера.  Чтобы свести к минимуму потенциальную потерю данных, выберите последний узел, на котором размещалась группа доступности первичной реплики.  
  
     Дополнительные сведения см. в статье  [Принудительный запуск кластера WSFC без кворума](http://msdn.microsoft.com/library/hh270275\(v=SQL.110\).aspx)  
  
    > [!NOTE]  
    >  Принудительная настройка кворума действует в пределах всего кластера, блокируя проверки кворума до тех пор, пока логический кластер WSFC не получит большинство голосов и автоматически не перейдет в регулярный режим работы кворума.  
  
3.  **Запустите службу WSFC обычным образом на каждом узле, исправном во всех остальных отношениях, по одному за раз.** Не нужно указывать параметр принудительного кворума при запуске службы кластеров на других узлах.  
  
     Поскольку служба WSFC на каждом узле возвращается в состояние «в сети», она взаимодействует с другими исправными узлами, чтобы синхронизировать новое состояние конфигурации кластера.  Помните, что необходимо проводить это по одному узлу на раз, чтобы предотвратить потенциальные условия соперничества в кластере при разрешении последнего известного состояния кластера.  
  
    > [!WARNING]  
    >  Убедитесь, что каждый узел, который вы запускаете, может общаться с другими узлами, недавно перешедшими в состояние «в сети».  Рекомендуется отключить службу WSFC на других узлах.  В противном случае вы рискуете создать несколько наборов узлов кворума. Этот сценарий может привести к дроблению. Если на шаге 1 получены точные результаты, этого не должно произойти.  
  
4.  **Примените новый режим кворума и конфигурацию голосования для узла.** Если принудительное выполнение кворума успешно перезагрузило все узлы в кластере и главная причина сбоя кворума была исправлена, то не требуется внесение изменений в исходный режим и конфигурацию голосования кворума узла.  
  
     В противном случае следует оценить вновь восстановленный узел кластера и топологию доступности реплики и требуемым образом изменить назначения кворума узла и голосования для каждого узла. Невосстановленные узлы следует перевести в режим «вне сети» или установить их голоса на нуль.  
  
    > [!TIP]  
    >  В этой точке узлы и экземпляры SQL Server в кластере могут оказаться восстановленными в режим нормального функционирования.  Однако исправного кворума может до сих пор не быть.  Убедитесь, что кворум восстановлен, в диспетчере отказоустойчивости кластеров, на панели мониторинга AlwaysOn в среде SQL Server Management Studio или в соответствующих динамических административных представлениях.  
  
5.  **При необходимости восстановите реплики баз данных групп доступности.** Базы данных, не относящиеся к группам доступности, должны сами восстановиться и вернуться в состояние «в сети» в процессе обычного запуска SQL Server.  
  
     Можно сократить потенциальные потери данных и время восстановления для реплик групп восстановления путем их восстановления в следующем порядке: первичная реплика, синхронные вторичные реплики, асинхронные вторичные реплики.  
  
6.  **Ремонт или замена неисправных компонентов и перепроверка кластера.** Теперь, выполнив восстановление после первоначальной аварии и сбоя кворума, исправьте или замените отказавшие узлы и соответствующим образом настройте конфигурации смежных связанных узлов WSFC и AlwaysOn.  Это может предполагать удаление реплик групп доступности, удаление узлов из кластера либо сведение и переустановку программного обеспечения на узле.  
  
     Необходимо восстановить или удалить все неисправные реплики доступности.  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не будет усекать журнал транзакций за последней известной точкой самой последней реплики доступности.   Если отказавшая реплика не подлежит восстановлению или удалена из группы доступности, журналы транзакций будут расти с риском превышения пределов объема журналов в других репликах.  
  
    > [!NOTE]  
    >  Если при запуске мастера WSFC по проверке конфигурации в кластере WSFC имеется прослушиватель группы доступности, то мастер выдает следующее предупреждающее сообщение.  
    >   
    >  "Свойство RegisterAllProviderIP для сетевого имени "Name:<имя_сети>" имеет значение 1, для текущей конфигурации кластера данное свойство должно иметь значение 0".  
    >   
    >  Не обращайте внимания на это сообщение.  
  
7.  **Повторите шаг 4 при необходимости.** Цель заключается в повторном восстановлении соответствующего уровня отказоустойчивости и высокого уровня доступности для исправных операций.  
  
8.  **Анализ RPO/RTO.** Следует проанализировать системные журналы SQL Server, метки времени баз данных, журналы событий Windows, чтобы выявить главную причину аварии и задокументировать реальные значения точки восстановления и времени восстановления.  
  
##  <a name="RelatedTasks"></a> Связанные задачи  
  
-   [Принудительный запуск кластера WSFC без кворума](force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
-   [Выполнение принудительного перехода на другой ресурс вручную для группы доступности (SQL Server)](../../../database-engine/availability-groups/windows/perform-a-forced-manual-failover-of-an-availability-group-sql-server.md)  
  
-   [Просмотр параметров NodeWeight для кворума кластера](view-cluster-quorum-nodeweight-settings.md)  
  
-   [Настройка параметров NodeWeight кворума кластера](configure-cluster-quorum-nodeweight-settings.md)  
  
-   [Использование панели мониторинга AlwaysOn (среда SQL Server Management Studio)](../../../database-engine/availability-groups/windows/use-the-always-on-dashboard-sql-server-management-studio.md) 
  
##  <a name="RelatedContent"></a> См. также  
  
-   [Просмотр событий и журналов для отказоустойчивого кластера](http://technet.microsoft.com/library/cc772342\(WS.10\).aspx)  
  
-   [Командлет Get-ClusterLog отказоустойчивого кластера](http://technet.microsoft.com/library/ee461045.aspx)  
  
## <a name="see-also"></a>См. также  
 [Отказоустойчивая кластеризация Windows Server (WSFC) с SQL Server](windows-server-failover-clustering-wsfc-with-sql-server.md)  
  
  
