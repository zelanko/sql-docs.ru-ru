---
title: Журнал транзакций (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 01/04/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- transaction logs [SQL Server], about
- databases [SQL Server], transaction logs
- logs [SQL Server], transaction logs
ms.assetid: d7be5ac5-4c8e-4d0a-b114-939eb97dac4d
author: MashaMSFT
ms.author: mathoma
manager: craigg
ms.openlocfilehash: 1b4a175ad850ccbb0711a0997c3658cf01497686
ms.sourcegitcommit: f7fced330b64d6616aeb8766747295807c92dd41
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "63144620"
---
# <a name="the-transaction-log-sql-server"></a>Журнал транзакций (SQL Server)
  Каждая база данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имеет журнал транзакций, в котором фиксируются все изменения данных, произведенные в каждой из транзакций. Журнал транзакций необходимо регулярно усекать, чтобы избежать его переполнения. Но при этом по ряду причин его усечение может быть отложено, поэтому очень важно следить за размером журнала. Некоторые операции можно выполнять с минимальным протоколированием, чтобы сократить их вклад в размер журнала транзакций.  
  
 Журнал транзакций является критическим компонентом базы данных и в случае системного сбоя может потребоваться для приведения базы данных в согласованное состояние. Журнал транзакций нельзя ни удалять, ни изменять, если только не известны возможные последствия.  
  
> [!NOTE]  
>  Известные рабочие точки, от которых следует начинать применение журналов транзакций при восстановлении базы данных, создаются контрольными точками. Дополнительные сведения см. в разделе [Контрольные точки базы данных (SQL Server)](database-checkpoints-sql-server.md).  
  
 **В этом разделе.**  
  
-   [Преимущества: Операции, поддерживаемые журналом транзакций](#Benefits)  
  
-   [Усечение журнала транзакций](#Truncation)  
  
-   [Факторы, которые могут задержать усечение журнала](#FactorsThatDelayTruncation)  
  
-   [Операции, которые можно применять минимальное протоколирование](#MinimallyLogged)  
  
-   [Связанные задачи](#RelatedTasks)  
  
##  <a name="Benefits"></a> Преимущества: Операции, поддерживаемые журналом транзакций  
 Журнал транзакций поддерживает следующие операции:  
  
-   восстановление отдельных транзакций;  
  
-   восстановление всех незавершенных транзакций при запуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ;  
  
-   накат восстановленной базы данных, файла, файловой группы или страницы до момента сбоя;  
  
-   поддержка репликации транзакций;  
  
-   Поддержка решений высокой уровня доступности и аварийного восстановления: [!INCLUDE[ssHADR](../../includes/sshadr-md.md)], зеркальное отображение базы данных и доставка журналов.  
  
##  <a name="Truncation"></a> Усечение журнала транзакций  
 Процесс усечения журнала освобождает место в файле журнала для повторного использования журналом транзакций. Усечение журнала необходимо для предотвращения переполнения журнала. При усечении журнала удаляются неактивные виртуальные файлы журнала из логического журнала транзакций базы данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , что приводит к освобождению пространства в логическом журнале для повторного использования физическим журналом транзакций. Если усечение журнала транзакций не выполняется, со временем он заполняет все доступное место на диске, отведенное для файлов физического журнала.  
  
 В целях предотвращения этой проблемы усечение журнала выполняется автоматически после следующих событий, за исключением тех случаев, когда оно по каким-то причинам задерживается.  
  
-   В простой модели восстановления — после достижения контрольной точки.  
  
-   Для моделей полного восстановления и моделей восстановления с неполным протоколированием, если контрольная точка была создана после предыдущего резервного копирования, усечение происходит после резервного копирования журнала (если только это не резервная копия журнала только для копирования).  
  
 Дополнительные сведения см. в подразделе [Факторы, которые могут вызвать задержку усечения журнала](#FactorsThatDelayTruncation)ниже в этом разделе.  
  
> [!NOTE]  
>  Усечение журнала не приводит к уменьшению размера физического файла журнала. Для уменьшения реального размера физического файла журнала необходимо выполнить его сжатие. Сведения о сжатии физического файла журнала см. в разделе [Управление размером файла журнала транзакций](manage-the-size-of-the-transaction-log-file.md).  
  
##  <a name="FactorsThatDelayTruncation"></a> Факторы, которые могут задержать усечение журнала  
 Когда записи журнала остаются активными длительное время, усечение журнала транзакций откладывается и возникает вероятность переполнения журнала транзакций.  
  
> [!IMPORTANT]  
>  Дополнительные сведения о том, что нужно делать при переполнении журнала транзакций, см. в разделе [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](troubleshoot-a-full-transaction-log-sql-server-error-9002.md).  
  
 Усечение журнала может быть задержано из-за множества факторов. Чтобы определить причину, препятствующую усечению журнала транзакций в конкретном случае, выполните запрос по столбцам **log_reuse_wait** и **log_reuse_wait_desc** представления каталога [sys.database](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql) . В следующей таблице описаны значения этих столбцов.  
  
|Значение столбца log_reuse_wait|Значение столбца log_reuse_wait_desc|Описание|  
|----------------------------|----------------------------------|-----------------|  
|0|NOTHING;|В данный момент существует один или более виртуальных файлов журнала, доступных для повторного использования.|  
|1|CHECKPOINT|С момента последнего усечения журнала не было новых контрольных точек, либо заголовок журнала не перемещался за пределы виртуального файла журнала. (Все модели восстановления)<br /><br /> Это широко распространенная причина задержки усечения журнала. Дополнительные сведения см. в разделе [Database Checkpoints &#40;SQL Server&#41;](database-checkpoints-sql-server.md).|  
|2|LOG_BACKUP|Требуется выполнить резервное копирование журналов, поскольку лишь после этого журнал транзакций может быть усечен. (Только для моделей полного восстановления и моделей восстановления с неполным протоколированием)<br /><br /> После завершения создания следующей резервной копии журнала некоторое пространство журнала может освободиться для повторного использования.|  
|3|ACTIVE_BACKUP_OR_RESTORE|Выполняется резервное копирование или восстановление данных (для всех моделей восстановления).<br /><br /> Если усечению журнала препятствует резервное копирование данных, то проблему может решить отмена операции резервного копирования.|  
|4|ACTIVE_TRANSACTION|Активна одна из транзакций (для всех моделей восстановления).<br /><br /> Во время начала создания резервной копии журнала может существовать длительная транзакция. В этом случае, чтобы освободить пространство, может потребоваться создание другой резервной копии журнала. Обратите внимание на то, что длительные транзакции предотвратить усечение журнала во всех моделях восстановления, включая простой модели восстановления, в которой журнал транзакций обычно усекается на каждой автоматической контрольной точке.<br /><br /> Транзакция отложена. *Отложенная транзакция* — это активная транзакция, откат которой был заблокирован по причине недоступности какого-либо ресурса. Дополнительные сведения о причинах, вызывающих появление отложенных транзакций, и о том, как их можно вывести из такого состояния, см. в статье [Отложенные транзакции (SQL Server)](../backup-restore/deferred-transactions-sql-server.md). <br /><br />Длительные транзакции также могут переполнить журнал транзакций базы данных tempdb. Пользовательские транзакции неявно используют базу данных tempdb для внутренних объектов, например для сортировки рабочих таблиц, хэширования рабочих файлов, перемещения рабочих таблиц и управления версиями строк. Даже если пользовательская транзакция включает в себя только считывает данные (запросы SELECT), внутренние объекты могут быть созданы и использованы в пользовательских транзакциях. В результате журнал транзакций базы данных tempdb может быть заполнен.|  
|5|DATABASE_MIRRORING|Зеркальное отображение базы данных приостановлено или в режиме высокой производительности зеркальная база данных намного отстает от основной. (Только для модели полного восстановления)<br /><br /> Дополнительные сведения см. в статье [Зеркальное отображение базы данных (SQL Server)](../../database-engine/database-mirroring/database-mirroring-sql-server.md).|  
|6|REPLICATION|Во время репликации транзакций в базу данных распространителя не доставляются транзакции, имеющие отношение к публикациям. (Только для модели полного восстановления)<br /><br /> Дополнительные сведения о репликации транзакций см. в разделе [SQL Server Replication](../../relational-databases/replication/sql-server-replication.md).|  
|7|DATABASE_SNAPSHOT_CREATION|Создается моментальный снимок базы данных. (Все модели восстановления)<br /><br /> Это очень распространенная (и обычно кратковременная) причина задержки усечения журнала транзакций.|  
|8|LOG_SCAN|Производится просмотр журнала. (Все модели восстановления)<br /><br /> Это очень распространенная (и обычно кратковременная) причина задержки усечения журнала транзакций.|  
|9|AVAILABILITY_REPLICA|Вторичная реплика группы доступности применяет записи журнала транзакций этой базы данных к соответствующей базе данных-получателю. (Модель полного восстановления)<br /><br /> Дополнительные сведения см. в разделе [Обзор групп доступности AlwaysOn &#40;SQL Server&#41;](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md).|  
|10|-|Только для внутреннего применения|  
|11|-|Только для внутреннего применения|  
|12|-|Только для внутреннего применения|  
|13|OLDEST_PAGE|Если база данных настроена для использования косвенных контрольных точек, самая старая страница в базе данных может быть старше контрольной точки с номером LSN. В этом случае самая старая страница может задержать усечение журнала. (Все модели восстановления)<br /><br /> Сведения о косвенных контрольных точках см. в статье [Database Checkpoints &#40;SQL Server&#41;](database-checkpoints-sql-server.md).|  
|14|OTHER_TRANSIENT|Эта значение сейчас не используется.|  
|16|XTP_CHECKPOINT|Если база данных имеет оптимизированную для памяти файловую группу, журнал транзакций может не усекаться до срабатывания автоматической контрольной точки [!INCLUDE[hek_2](../../includes/hek-2-md.md)] (что происходит при росте размера журнала на каждые 512 МБ).<br /><br /> Примечание. Для усечения журнала транзакций до 512 МБ размер, запускать команду Checkpoint вручную в базе данных в вопросе.|  
  
##  <a name="MinimallyLogged"></a> Операции, которые можно применять минимальное протоколирование  
 *Минимальное протоколирование* — это протоколирование только информации, необходимой для восстановления транзакции без поддержки восстановления на момент времени. В этом разделе определяются операции, которые подлежат минимальному протоколированию в модели восстановления с неполным протоколированием (как и в простой модели восстановления, кроме случаев, когда выполняется резервное копирование).  
  
> [!NOTE]  
>  Минимальное протоколирование не поддерживается для оптимизированных для памяти таблиц.  
  
> [!NOTE]  
>  В модели полного восстановления все массовые операции полностью протоколируются. Однако для набора массовых операций можно использовать минимальное протоколирование, временно переключив базу данных на модель восстановления с неполным протоколированием во время массовых операций. Минимальное протоколирование более эффективно, чем полное, и снижает вероятность того, что во время массовой операции большого объема будет заполнено все доступное пространство журнала транзакций. Однако, если при включенном минимальном протоколировании база данных будет повреждена или потеряна, ее нельзя будет восстановить до точки сбоя.  
  
 Следующие операции, выполняемые с полным протоколированием в модели полного восстановления, осуществляются с минимальным протоколированием в простой модели восстановления и модели восстановления с неполным протоколированием:  
  
-   Операции массового импорта ([bcp](../../tools/bcp-utility.md), [BULK INSERT](/sql/t-sql/statements/bulk-insert-transact-sql) и [INSERT... SELECT](/sql/t-sql/statements/insert-transact-sql)). Дополнительные сведения о том, когда массовый импорт в таблицу подлежит минимальному протоколированию, см. в разделе [Prerequisites for Minimal Logging in Bulk Import](../import-export/prerequisites-for-minimal-logging-in-bulk-import.md).  
  
    > [!NOTE]  
    >  Если включена репликация транзакций, операции BULK INSERT полностью протоколируются даже в модели с неполным протоколированием.  
  
-   Операции SELECT [INTO](/sql/t-sql/queries/select-into-clause-transact-sql) .  
  
    > [!NOTE]  
    >  Если включена репликация транзакций, операции SELECT INTO полностью протоколируются даже в модели восстановления с неполным протоколированием.  
  
-   Частичные обновления типов данных с большими значениями с помощью предложений .WRITE инструкции [UPDATE](/sql/t-sql/queries/update-transact-sql) при вставке или добавлении новых данных. Обратите внимание, что минимальное протоколирование не используется при обновлении существующих значений. Дополнительные сведения о больших типах-значениях см. в статье [Типы данных (Transact-SQL)](/sql/t-sql/data-types/data-types-transact-sql).  
  
-   [WRITETEXT](/sql/t-sql/queries/writetext-transact-sql) и [UPDATETEXT](/sql/t-sql/queries/updatetext-transact-sql) при вставке или добавлении новых данных в `text`, `ntext`, и `image` столбцы с типом данных. Обратите внимание, что минимальное протоколирование не используется при обновлении существующих значений.  
  
    > [!NOTE]  
    >  Инструкции WRITETEXT и UPDATETEXT являются устаревшими, поэтому следует избегать их использования в новых приложениях.  
  
-   Если в базе данных используется простая модель восстановления или модель восстановления с неполным протоколированием, некоторые DDL-операции с индексом протоколируются в минимальном объеме при их выполнении как режиме «вне сети», так и в режиме «в сети». Минимально протоколируются следующие операции с индексами.  
  
    -   Операции[CREATE INDEX](/sql/t-sql/statements/create-index-transact-sql) (включая индексированные представления).  
  
    -   Операции[ALTER INDEX](/sql/t-sql/statements/alter-index-transact-sql) REBUILD или DBCC DBREINDEX.  
  
        > [!NOTE]  
        >  Инструкция DBCC DBREINDEX является устаревшей, поэтому следует избегать ее использования в новых приложениях.  
  
    -   Перестроение новой кучи DROP INDEX (если применимо).  
  
        > [!NOTE]  
        >  Освобождение страниц индекса в ходе выполнения операции [DROP INDEX](/sql/t-sql/statements/drop-index-transact-sql) всегда протоколируется полностью.  
  
##  <a name="RelatedTasks"></a> Связанные задачи  
 `Managing the transaction log`  
  
-   [Управление размером файла журнала транзакций](manage-the-size-of-the-transaction-log-file.md)  
  
-   [Устранение неполадок при переполнении журнала транзакций (ошибка SQL Server 9002)](troubleshoot-a-full-transaction-log-sql-server-error-9002.md)  
  
 **Резервное копирование журнала транзакций (модель полного восстановления)**  
  
-   [Создание резервной копии журнала транзакций &#40;SQL Server&#41;](../backup-restore/back-up-a-transaction-log-sql-server.md)  
  
 **Восстановление журнала транзакций (модель полного восстановления)**  
  
-  [Восстановление резервной копии журнала транзакций](../backup-restore/restore-a-transaction-log-backup-sql-server.md)   
  
## <a name="see-also"></a>См. также  
 [Управление устойчивостью транзакций](control-transaction-durability.md)   
 [Предварительные условия для минимального протоколирования массового импорта данных](../import-export/prerequisites-for-minimal-logging-in-bulk-import.md)   
 [Резервное копирование и восстановление баз данных SQL Server](../backup-restore/back-up-and-restore-of-sql-server-databases.md)   
 [Контрольные точки базы данных &#40;SQL Server&#41;](database-checkpoints-sql-server.md)   
 [Просмотр или изменение свойств базы данных](../databases/view-or-change-the-properties-of-a-database.md)   
 [Модели восстановления &#40;SQL Server&#41;](../backup-restore/recovery-models-sql-server.md)  
  
  
