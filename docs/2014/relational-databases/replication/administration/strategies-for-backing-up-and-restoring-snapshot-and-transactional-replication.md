---
title: Стратегии резервного копирования и восстановления из копии репликации моментальных снимков и репликации транзакций | Документация Майкрософт
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.suite: ''
ms.technology:
- replication
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- backups [SQL Server replication], snapshot replication
- restoring [SQL Server replication], transactional replication
- snapshot replication [SQL Server], backup and restore
- restoring [SQL Server replication], snapshot replication
- recovery [SQL Server replication], transactional replication
- transactional replication, backup and restore
- recovery [SQL Server replication], snapshot replication
- sync with backup [SQL Server replication]
- backups [SQL Server replication], transactional replication
ms.assetid: a8afcdbc-55db-4916-a219-19454f561f9e
caps.latest.revision: 58
author: craigg-msft
ms.author: craigg
manager: jhubbard
ms.openlocfilehash: 49ab065d1f6f60102a730660ffa84ee21629f28b
ms.sourcegitcommit: 5dd5cad0c1bbd308471d6c885f516948ad67dfcf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2018
ms.locfileid: "36195568"
---
# <a name="strategies-for-backing-up-and-restoring-snapshot-and-transactional-replication"></a>Стратегии резервного копирования и восстановления из копии репликации моментальных снимков и репликации транзакций
  При разработке стратегии резервного копирования и восстановления для репликации моментальных снимков и репликации транзакций необходимо учитывать три аспекта.  
  
-   Какие базы данных будут подвергаться резервному копированию.  
  
-   Настройки резервного копирования для репликации транзакций.  
  
-   Шаги, необходимые для восстановления базы данных. Они зависят от типа репликации и выбранных параметров.  
  
 Эта тема охватывает данные группы вопросов в следующих трех разделах. Сведения о резервном копировании и восстановлении для публикации Oracle см. в статье [Резервное копирование и восстановление для издателей Oracle](../non-sql/backup-and-restore-for-oracle-publishers.md).  
  
## <a name="backing-up-databases"></a>Резервное копирование баз данных  
 Для репликации моментальных снимков и репликации транзакций необходимо регулярно выполнять резервное копирование следующих баз данных:  
  
-   База данных публикации на издателе.  
  
-   База данных распространителя на распространителе.  
  
-   База данных подписки на подписчике.  
  
-   Системные базы данных **master** и **msdb** на издателе, распространителе и на всех подписчиках. Резервные копии этих баз данных и копия соответствующей базы данных репликации должны быть сделаны одновременно. Например, создайте резервную копию баз данных **master** и **msdb** на издателе одновременно с резервной копией базы данных публикации. Если база данных публикации восстановлена, убедитесь, что базы данных **master** и **msdb** согласованы с базой данных публикации по параметрам и конфигурации репликации.  
  
 Если резервное копирование журналов выполняется регулярно, любые изменения, касающиеся репликации, будут заноситься в резервные копии журнала. Если не выполняется резервное копирование журналов, то необходимо выполнить это резервное копирование при каждом изменении настройки, относящейся к репликации. Дополнительные сведения см. в статье [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).  
  
## <a name="backup-settings-for-transactional-replication"></a>Настройки резервного копирования для репликации транзакций  
 Репликация транзакций включает параметр **sync with backup** , который может быть установлен для базы данных распространителя и для базы данных публикации.  
  
-   Рекомендуется устанавливать этот параметр в базе данных распространителя.  
  
     Установка этого параметра для базы данных распространителя гарантирует, что транзакции в журнале базы данных публикации не будут усечены до тех пор, пока не будет создана их резервная копия в базе данных распространителя. Базу данных распространителя можно восстановить до последней резервной копии, а все потерянные транзакции будут доставлены из базы данных публикации в базу данных распространителя. Репликация не затрагивается.  
  
     Установка этого параметра для базы данных распространителя не влияет на задержку репликации. Тем не менее этот параметр откладывает усечение журнала в базе данных публикации до того момента, пока не завершится резервное копирование соответствующих транзакций в базе данных распространителя. (Это может привести к увеличению размера журнала транзакций в базе данных публикации.)  
  
-   Рекомендуется установить этот параметр для базы данных публикации, если приложение допускает дополнительную задержку.  
  
     Установка этого параметра для базы данных публикации гарантирует, что транзакции не будут доставлены в базу данных распространителя до тех пор, пока не будет создана их резервная копия в базе данных публикации. Последняя резервная копия базы данных публикации может быть затем восстановлена на издателе, при этом в базе данных распространителя не будет транзакций, которых нет в восстановленной базе данных публикации.  
  
     Задержка и пропускная способность изменяются, так как транзакции не могут быть доставлены в базу данных распространителя до тех пор, пока не будут созданы их резервные копии на издателе. Например, если резервная копия журнала транзакций создается каждые пять минут, потребуются дополнительные пять минут задержки между фиксацией транзакции на издателе и доставкой транзакции сначала в базу данных распространителя, а затем подписчику.  
  
    > [!NOTE]  
    >  Параметр **sync with backup** обеспечивает согласованность базы данных публикации и базы данных распространителя, но он не гарантирует отсутствия потерь данных. Например, если журнал транзакций потерян, транзакции, зафиксированные после последнего резервного копирования журнала транзакций, не будут доступны в базе данных публикации или базе данных распространителя. Точно так же ведет себя нереплицируемая база данных.  
  
 **Установка параметра «sync with backup»**  
  
-   Программирование репликации на языке [!INCLUDE[tsql](../../../includes/tsql-md.md)]: [Включение скоординированного резервного копирования для репликации транзакций](enable-coordinated-backups-for-transactional-replication.md).  
  
## <a name="restoring-databases-involved-in-replication"></a>Восстановление баз данных, участвующих в репликации  
 Если имеются последние резервные копии и выполнены соответствующие шаги, можно восстановить все базы данных в топологии репликации. Действия по восстановлению базы данных публикации зависят от типа репликации и от используемых параметров, однако действия по восстановлению всех других баз данных не зависят от типа репликации и параметров.  
  
 Служба репликации поддерживает восстановление реплицированной базы данных на том же сервере и в той же базе данных, где была создана ее резервная копия. Если восстановить резервную копию реплицированной базы данных на другом сервере или в другой базе данных, то станет невозможным сохранение настроек репликации. В этом случае после восстановления из резервной копии потребуется повторно создать все публикации и подписки.  
  
### <a name="publisher"></a>Издатель  
 Последовательность шагов по восстановлению предлагается для следующих типов репликации:  
  
-   репликация моментальных снимков;  
  
-   репликация транзакций, доступная только для чтения;  
  
-   репликация транзакций с обновляемыми подписками;  
  
-   одноранговая репликация транзакций.  
  
 Восстановление баз данных **msdb** и **master** , о котором также рассказывается в этом разделе, одинаково для всех четырех типов репликации.  
  
#### <a name="publication-database-snapshot-replication"></a>База данных публикации: репликация моментальных снимков  
  
1.  Восстановите последнюю резервную копию базы данных публикации. Перейдите к шагу 2.  
  
2.  Содержит ли резервная копия базы данных публикации последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. Восстановление завершено.  
  
     Дополнительные сведения об удалении репликации см. в статье [sp_removedbreplication (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).  
  
#### <a name="publication-database-read-only-transactional-replication"></a>База данных публикации: репликация транзакций, доступная только для чтения  
  
1.  Восстановите последнюю резервную копию базы данных публикации. Перейдите к шагу 2.  
  
2.  Был ли перед сбоем включен параметр **sync with backup** для базы данных публикации? Если да, перейдите к шагу 3, если нет — к шагу 5.  
  
     Если параметр включен, запрос `SELECT DATABASEPROPERTYEX('<PublicationDatabaseName>', 'IsSyncWithBackup')` возвращает '1'.  
  
3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 4.  
  
4.  Сведения о конфигурации восстановленной базы данных публикации устарели. Необходимо убедиться, что у подписчиков имеются все команды, ожидающие выполнения в базе данных распространителя, а затем удалить и повторно создать конфигурацию репликации.  
  
    1.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Убедитесь в том, что все команды доставлены подписчикам. Для этого используйте вкладку **Нераспространенные команды** в мониторе репликации либо запросите представление [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) в базе данных распространителя. Перейдите к шагу b.  
  
         Дополнительные сведения о запуске агента распространителя см. в статьях [Запуск и остановка агента репликации (среда SQL Server Management Studio)](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../concepts/replication-agent-executables-concepts.md).  
  
         Дополнительные сведения о проверке команд см. в статьях [Просмотр реплицированных команд и другой информации в базе данных распространителя (программирование репликации на языке Transact-SQL)](../monitor/view-replicated-commands-and-information-in-distribution-database.md) и [Просмотр сведений и выполнение задач для агентов, связанных с подпиской (монитор репликации)](../monitor/view-information-and-perform-tasks-for-subscription-agents.md).  
  
    2.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
         Дополнительные сведения об удалении репликации см. в статье [sp_removedbreplication (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные, см. в разделе [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).  
  
5.  Параметр **sync with backup** не установлен в базе данных публикации. Следовательно, транзакции, не включенные в восстановленную резервную копию, могли быть переданы распространителю и подписчикам. Необходимо убедиться, что в базе данных распространителя у подписчиков есть все команды, ожидающие обработки, затем вручную применить к базе данных публикации все транзакции, отсутствующие в восстановленной резервной копии.  
  
    > [!IMPORTANT]  
    >  В результате этих действий опубликованные таблицы могут быть восстановлены до более современных версий, чем версии неопубликованных таблиц, восстановленных из резервной копии.  
  
    1.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Убедитесь в том, что все команды доставлены подписчикам. Для этого используйте вкладку **Нераспространенные команды** в мониторе репликации либо запросите представление [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) в базе данных распространителя. Перейдите к шагу b.  
  
         Дополнительные сведения о запуске агента распространителя см. в статьях [Запуск и остановка агента репликации (среда SQL Server Management Studio)](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../concepts/replication-agent-executables-concepts.md).  
  
         Дополнительные сведения о проверке команд см. в статьях [Просмотр реплицированных команд и другой информации в базе данных распространителя (программирование репликации на языке Transact-SQL)](../monitor/view-replicated-commands-and-information-in-distribution-database.md) и [Просмотр сведений и выполнение задач для агентов, связанных с подпиской (монитор репликации)](../monitor/view-information-and-perform-tasks-for-subscription-agents.md).  
  
    2.  Для ручной синхронизации издателя с подписчиками используется [программа tablediff](../../../tools/tablediff-utility.md) или другое средство. Это позволяет восстанавливать данные из базы данных подписчика, которая не содержалась в резервной копии базы данных публикации. Перейдите к шагу c.  
  
         Дополнительные сведения об использовании служебной программы **tablediff** см. в статье [Сравнение реплицируемых таблиц на предмет различий (программирование репликации)](compare-replicated-tables-for-differences-replication-programming.md).  
  
    3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, синхронизируйте повторно метаданные издателя и распространителя с помощью хранимой процедуры [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) . Восстановление завершено. Если нет, перейдите к шагу d.  
  
    4.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
         Дополнительные сведения об удалении репликации см. в статье [sp_removedbreplication (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные, см. в разделе [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).  
  
#### <a name="publication-database-transactional-replication-with-updating-subscriptions"></a>База данных публикации: репликация транзакций с обновлением подписок  
  
1.  Восстановите последнюю резервную копию базы данных публикации. Перейдите к шагу 2.  
  
2.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Убедитесь в том, что все команды доставлены подписчикам. Для этого используйте вкладку **Нераспространенные команды** в мониторе репликации либо запросите представление [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) в базе данных распространителя. Перейдите к шагу 3.  
  
     Дополнительные сведения о запуске агента распространителя см. в статьях [Запуск и остановка агента репликации (среда SQL Server Management Studio)](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../concepts/replication-agent-executables-concepts.md).  
  
     Дополнительные сведения о проверке команд см. в статьях [Просмотр реплицированных команд и другой информации в базе данных распространителя (программирование репликации на языке Transact-SQL)](../monitor/view-replicated-commands-and-information-in-distribution-database.md) и [Просмотр сведений и выполнение задач для агентов, связанных с подпиской (монитор репликации)](../monitor/view-information-and-perform-tasks-for-subscription-agents.md).  
  
3.  Если используются обновляемые посредством очередей подписки, подключитесь к каждому подписчику и удалите все строки из таблицы [MSreplication_queue (Transact-SQL)](/sql/relational-databases/system-tables/msreplication-queue-transact-sql) в базе данных подписки. Перейдите к шагу 4.  
  
    > [!NOTE]  
    >  Если используются обновляемые посредством очередей подписки и какие-либо таблицы содержат столбцы идентификаторов, следует убедиться, что после восстановления назначены правильные диапазоны идентификаторов. Дополнительные сведения см. в статье [Репликация столбцов идентификаторов](../publish/replicate-identity-columns.md).  
  
4.  Необходимо убедиться, что в базе данных распространителя у подписчиков есть все команды, ожидающие обработки, затем вручную применить к базе данных публикации все транзакции, отсутствующие в восстановленной резервной копии.  
  
    > [!IMPORTANT]  
    >  В результате этих действий опубликованные таблицы могут быть восстановлены до более современных версий, чем версии неопубликованных таблиц, восстановленных из резервной копии.  
  
    1.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Используя монитор репликации или запросив представление [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) в базе данных распространителя, убедитесь, что все команды доставлены подписчикам. Перейдите к шагу b.  
  
    2.  Для ручной синхронизации издателя с подписчиками используется [tablediff Utility](../../../tools/tablediff-utility.md) или другое средство. Это позволяет восстанавливать данные из базы данных подписчика, которая не содержалась в резервной копии базы данных публикации. Перейдите к шагу c.  
  
         Дополнительные сведения об использовании служебной программы **tablediff** см. в статье [Сравнение реплицируемых таблиц на предмет различий (программирование репликации)](compare-replicated-tables-for-differences-replication-programming.md).  
  
    3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, синхронизируйте повторно метаданные издателя и распространителя с помощью хранимой процедуры [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) . Восстановление завершено. Если нет, перейдите к шагу d.  
  
    4.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
         Дополнительные сведения об удалении репликации см. в статье [sp_removedbreplication (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные, см. в разделе [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).  
  
#### <a name="publication-database-peer-to-peer-transactional-replication"></a>База данных публикации: одноранговая репликация транзакций  
 В следующих шагах базы данных публикаций **A**, **B**и **C** находятся в топологии одноранговой репликации транзакций. Базы данных **A** и **C** находятся в режиме  «в сети» и функционируют правильно; база данных **B** — восстанавливаемая база данных. Описанные здесь действия, особенно шаги 7, 10 и 11, очень похожи на процесс добавления узла к одноранговой топологии. Самый простой путь выполнения этих шагов — использование мастера настройки одноранговой топологии, однако можно использовать и хранимые процедуры.  
  
1.  Запустите агент распространителя для синхронизации подписок в базах данных **A** и **C**. Перейдите к шагу 2.  
  
     Дополнительные сведения о запуске агента распространителя см. в статьях [Запуск и остановка агента репликации (среда SQL Server Management Studio)](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../concepts/replication-agent-executables-concepts.md).  
  
2.  Если база данных распространителя, которую использует база данных **B**, все еще доступна, запустите агенты распространителя для синхронизации подписок между базами данных **B** и **A**, а также между базами данных B и **C**. Перейдите к шагу 3.  
  
3.  Удалите метаданные из базы данных распространителя, которую использует база данных **B**, выполнив хранимую процедуру [sp_removedistpublisherdbreplication](/sql/relational-databases/system-stored-procedures/sp-removedistpublisherdbreplication-transact-sql) в базе данных распространителя для базы данных **B**. Перейдите к шагу 4.  
  
4.  В базах данных **A** и **C** удалите подписки на публикации из базы данных **B**. Перейдите к шагу 5.  
  
     Дополнительные сведения об удалении подписок см. в разделе [Subscribe to Publications](../subscribe-to-publications.md).  
  
5.  Выполните резервное копирование журналов или полное резервное копирование базы данных **A**. Перейдите к шагу 6.  
  
6.  Восстановите резервную копию базы данных **A** в базе данных **B**. Теперь в базе данных **B** имеются данные из базы данных **A**, но отсутствует конфигурация репликации. При восстановлении резервной копии на другом сервере репликация удаляется, поэтому репликация была удалена из базы данных **B**. Перейдите к шагу 7.  
  
7.  Вновь создайте публикацию в базе данных **B** и подписки между базами данных **A** и **B**. (Подписки, затрагивающие базу данных **C**, будут обработаны позже.)  
  
    1.  Заново создайте публикацию в базе данных **B**. Перейдите к шагу b.  
  
    2.  Создайте заново подписку в базе данных **B** на публикацию в базе данных **A**, указав, что подписка должна быть инициализирована с резервной копией (значение **initialize with backup** для параметра **@sync_type** хранимой процедуры [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)). Перейдите к шагу c.  
  
    3.  Создайте заново подписку в базе данных **A** на публикацию в базе данных **B**, указав, что подписчик уже содержит данные (значение **replication support only** для параметра **@sync_type** хранимой процедуры [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)). Перейдите к шагу 8.  
  
8.  Запустите агент распространителя для синхронизации подписок в базах данных **A** и **B**. Если в публикуемых таблицах имеются столбцы идентификаторов, перейдите к шагу 9. Если нет, перейдите к шагу 10.  
  
9. После восстановления диапазон идентификаторов, присвоенный каждой таблице в базе данных **A**, будет также использоваться в базе данных **B**. Убедитесь, что восстановленная база данных **B** получила все изменения из поврежденной базы данных **B**, которые были переданы в базы данных **A** и **C**, затем обновите начальные значения диапазона идентификаторов для каждой таблицы.  
  
    1.  Выполните процедуру [sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql) в базе данных **B** и получите выходной параметр **@request_id**. Перейдите к шагу b.  
  
    2.  По умолчанию агент распространителя работает непрерывно, поэтому токены отправляются на все узлы автоматически. Если агент распространителя не выполняется в непрерывном режиме, запустите его. Дополнительные сведения см. в разделах [Основные понятия исполняемых файлов агента репликации](../concepts/replication-agent-executables-concepts.md) и [Запуск и остановка агента репликации (среда SQL Server Management Studio)](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md). Перейдите к шагу c.  
  
    3.  Выполните процедуру [sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql), указав значение **@request_id** , полученное на шаге b. Подождите, пока все узлы сообщат о получении однорангового запроса. Перейдите к шагу d.  
  
    4.  Выполните инструкцию [DBCC CHECKIDENT](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) для обновления начальных значений каждой таблицы в базе данных **B** , чтобы убедиться, что используется соответствующий диапазон. Перейдите к шагу 10.  
  
     Дополнительные сведения об управлении диапазонами идентификаторов см. в подразделе "Назначение диапазонов для ручного управления диапазонами идентификаторов" статьи [Репликация столбцов идентификаторов](../publish/replicate-identity-columns.md).  
  
10. В этот момент базы данных **B** и **C** не связаны напрямую, но они будут получать изменения через базу данных **A**. Если топология содержит узлы, на которых выполняется [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], перейдите к шагу 11, в противном случае перейдите к шагу 12.  
  
11. Приостановите систему и заново создайте подписки между базами данных **B** и **C**. Приостановка системы подразумевает остановку действий в опубликованных таблицах на всех узлах и проверку получения изменений на каждом узле.  
  
    1.  Остановите все действия в опубликованных таблицах в одноранговой топологии. Перейдите к шагу b.  
  
    2.  Выполните процедуру [sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql) в базе данных **B** и получите выходной параметр **@request_id**. Перейдите к шагу c.  
  
    3.  По умолчанию агент распространителя работает непрерывно, поэтому токены отправляются на все узлы автоматически. Если агент распространителя не выполняется в непрерывном режиме, запустите его. Перейдите к шагу d.  
  
    4.  Выполните процедуру [sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql), указав значение **@request_id** , полученное на шаге b. Подождите, пока все узлы сообщат о получении однорангового запроса. Перейдите к шагу e.  
  
    5.  Создайте заново подписку в базе данных **B** на публикацию в базе данных **C**, указав, что подписчик уже содержит данные. Перейдите к шагу b.  
  
    6.  Создайте заново подписку в базе данных **C** на публикацию в базе данных **B**, указав, что подписчик уже содержит данные. Перейдите к шагу 13.  
  
12. Создайте заново подписку между базами данных **B** и **C**.  
  
    1.  В базе данных **B**выполните запрос к таблице [MSpeer_lsns](/sql/relational-databases/system-tables/mspeer-lsns-transact-sql) , чтобы получить номер LSN последней транзакции, которая была передана в базу данных **B** из базы данных **C**.  
  
    2.  Создайте заново подписку в базе данных **B** на публикацию в базе данных **C**, указав, что подписка должна быть инициализирована на основе номера LSN (значение **initialize from lsn** для параметра **@sync_type** хранимой процедуры [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)). Перейдите к шагу b.  
  
    3.  Создайте заново подписку в базе данных **C** на публикацию в базе данных **B**, указав, что подписчик уже содержит данные. Перейдите к шагу 13.  
  
13. Запустите агент распространителя для синхронизации подписок в базах данных **B** и **C**. Восстановление завершено.  
  
#### <a name="msdb-database-publisher"></a>База данных msdb (Издатель)  
  
1.  Восстановите последнюю резервную копию базы данных **msdb** .  
  
2.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Создайте заново задание очистки подписки из скриптов репликации. Восстановление завершено.  
  
#### <a name="master-database-publisher"></a>База данных master (Издатель)  
  
1.  Восстановите последнюю резервную копию базы данных **master** .  
  
2.  Убедитесь, что база данных согласована с базой данных публикации по конфигурации и параметрам репликации.  
  
### <a name="databases-at-the-distributor"></a>Базы данных на распространителе  
  
#### <a name="distribution-database"></a>База данных распространителя  
  
1.  Восстановите последнюю резервную копию базы данных распространителя.  
  
2.  Был ли перед сбоем включен параметр **sync with backup** для базы данных распространителя? Если да, перейдите к шагу 3, если нет — к шагу 4.  
  
     Если параметр включен, запрос `SELECT DATABASEPROPERTYEX('<DistributionDatabaseName>', 'IsSyncWithBackup')` возвращает '1'.  
  
3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 4.  
  
4.  Либо сведения о конфигурации в восстановленной базе данных распространителя устарели, либо в базе данных распространителя не был установлен параметр **sync with backup** . (После восстановления в базе данных распространителя могут иметься потерянные транзакции, зафиксированные на издателе, но не переданные подписчикам.) Удалите и создайте заново репликацию, а затем выполните проверку.  
  
    1.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Перейдите к шагу b.  
  
         Дополнительные сведения об удалении репликации см. в статье [sp_removedbreplication (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные, см. в разделе [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).  
  
    2.  Отметьте все публикации для проверки. Повторно инициализируйте все подписки, не прошедшие проверку. Восстановление завершено.  
  
         Дополнительные сведения о проверке см. в разделе [Validate Replicated Data](../validate-replicated-data.md). Дополнительные сведения о повторной инициализации см. в статье [Повторная инициализация подписок](../reinitialize-subscriptions.md).  
  
#### <a name="msdb-database-distributor"></a>База данных msdb (Распространитель)  
  
1.  Восстановите последнюю резервную копию базы данных **msdb** .  
  
2.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Перейдите к шагу 4.  
  
     Дополнительные сведения об удалении репликации см. в статье [sp_removedbreplication (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).  
  
     Дополнительные сведения о том, как указать, что у подписчика уже есть данные, см. в разделе [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).  
  
4.  Отметьте все публикации для проверки. Повторно инициализируйте все подписки, не прошедшие проверку. Восстановление завершено.  
  
     Дополнительные сведения о проверке см. в разделе [Validate Replicated Data](../validate-replicated-data.md). Дополнительные сведения о повторной инициализации см. в статье [Повторная инициализация подписок](../reinitialize-subscriptions.md).  
  
#### <a name="master-database-distributor"></a>База данных master (Распространитель)  
  
1.  Восстановите последнюю резервную копию базы данных **master** .  
  
2.  Убедитесь, что база данных согласована с базой данных публикации по конфигурации и параметрам репликации.  
  
### <a name="databases-at-the-subscriber"></a>Базы данных на подписчике  
  
#### <a name="subscription-database"></a>База данных подписки  
  
1.  Является ли последняя резервная копия базы данных подписки более поздней, чем значение параметра минимального срока хранения распространения в базе данных распространителя? (Этим определяется, имеются ли у распространителя все команды, необходимые для обновления подписчика.) Если да, перейдите к шагу 2. Если нет, выполните повторную инициализацию подписки. Восстановление завершено.  
  
     Чтобы определить значение параметра срока хранения распространителя, выполните хранимую процедуру [sp_helpdistributiondb](/sql/relational-databases/system-stored-procedures/sp-helpdistributiondb-transact-sql) и получите значение из столбца **max_distretention** (значение в часах).  
  
     Дополнительные сведения о повторной инициализации подписки см. в разделе [Reinitialize a Subscription](../reinitialize-a-subscription.md).  
  
2.  Восстановите последнюю резервную копию базы данных подписки. Перейдите к шагу 3.  
  
3.  Если база данных подписки содержит только принудительные подписки, перейдите к шагу 4. Если база данных подписки содержит какие-либо подписки по запросу, задайте следующие вопросы. Актуальны ли сведения о подписке? Включает ли база данных все таблицы и параметры, которые были установлены на момент сбоя. Если да, перейдите к шагу 4. Если нет, выполните повторную инициализацию подписки. Восстановление завершено.  
  
4.  Для синхронизации подписчика запустите агент распространителя. Восстановление завершено.  
  
     Дополнительные сведения о запуске агента распространителя см. в статьях [Запуск и остановка агента репликации (среда SQL Server Management Studio)](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../concepts/replication-agent-executables-concepts.md).  
  
#### <a name="msdb-database-subscriber"></a>База данных msdb (Подписчик)  
  
1.  Восстановите последнюю резервную копию базы данных **msdb** . Используются ли на этом подписчике подписки по запросу? Если нет, восстановление завершено. Если да, перейдите к шагу 2.  
  
2.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех подписок по запросу? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Удалите и создайте заново подписки по запросу. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
     Дополнительные сведения об удалении подписок см. в разделе [Subscribe to Publications](../subscribe-to-publications.md).  
  
     Дополнительные сведения о том, как указать, что у подписчика уже есть данные, см. в разделе [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).  
  
#### <a name="master-database-subscriber"></a>База данных master (Подписчик)  
  
1.  Восстановите последнюю резервную копию базы данных **master** .  
  
2.  Убедитесь, что база данных согласована с базой данных публикации по конфигурации и параметрам репликации.  
  
## <a name="see-also"></a>См. также  
 [Резервное копирование и восстановление баз данных SQL Server](../../backup-restore/back-up-and-restore-of-sql-server-databases.md)   
 [Создание резервных копий реплицируемых баз данных и восстановление из них](back-up-and-restore-replicated-databases.md)   
 [Настройка распространения](../configure-distribution.md)   
 [Публикация данных и объектов базы данных](../publish/publish-data-and-database-objects.md)   
 [Subscribe to Publications](../subscribe-to-publications.md)   
 [Инициализация подписки](../initialize-a-subscription.md)   
 [Синхронизация данных](../synchronize-data.md)  
  
  
