---
title: Агент моментальных снимков репликации | Документация Майкрософт
ms.custom: ''
ms.date: 10/29/2018
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- Snapshot Agent, executables
- agents [SQL Server replication], Snapshot Agent
- command prompt [SQL Server replication]
- Snapshot Agent, parameter reference
ms.assetid: 2028ba45-4436-47ed-bf79-7c957766ea04
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: a26aca7b33a7355500350572ea5e8ed21bddeacb
ms.sourcegitcommit: 57f1d15c67113bbadd40861b886d6929aacd3467
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/18/2020
ms.locfileid: "85068723"
---
# <a name="replication-snapshot-agent"></a>Агент моментальных снимков репликации
  Агент моментальных снимков репликации — это исполняемый файл, который подготавливает файлы моментальных снимков, содержащие схему, данные опубликованных таблиц и объекты базы данных, сохраняет их в папке моментальных снимков и регистрирует задания синхронизации в базе данных распространителя.  
  
> [!NOTE]  
>  Параметры можно указывать в любом порядке.  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
      snapshot [ -?]   
-Publisherserver_name[\instance_name]   
-Publication publication_name   
[-70Subscribers]   
[-BcpBatchSizebcp_batch_size]  
[-DefinitionFiledef_path_and_file_name]  
[-Distributorserver_name[\instance_name]]  
[-DistributorDeadlockPriority [-1|0|1] ]  
[-DistributorLogindistributor_login]  
[-DistributorPassworddistributor_password]  
[-DistributorSecurityMode [0|1] ]  
[-DynamicFilterHostNamedynamic_filter_host_name]  
[-DynamicFilterLogindynamic_filter_login]  
[-DynamicSnapshotLocationdynamic_snapshot_location]   
[-EncryptionLevel [0|1|2]]  
[-FieldDelimiterfield_delimiter]  
[-HistoryVerboseLevel [0|1|2|3] ]  
[-HRBcpBlocksnumber_of_blocks ]  
[-HRBcpBlockSizeblock_size ]  
[-HRBcpDynamicBlocks ]  
[-KeepAliveMessageIntervalkeep_alive_interval]  
[-LoginTimeOutlogin_time_out_seconds]  
[-MaxBcpThreadsnumber_of_threads ]  
[-MaxNetworkOptimization [0|1]]  
[-Outputoutput_path_and_file_name]  
[-OutputVerboseLevel [0|1|2] ]  
[-PacketSizepacket_size]
[-PrefetchTables [0|1] ]  
[-ProfileNameprofile_name]  
[-PublisherDBpublisher_database]  
[-PublisherDeadlockPriority [-1|0|1] ]  
[-PublisherFailoverPartnerserver_name[\instance_name] ]  
[-PublisherLoginpublisher_login]  
[-PublisherPasswordpublisher_password]   
[-PublisherSecurityMode [0|1] ]  
[-QueryTimeOutquery_time_out_seconds]  
[-ReplicationType [1|2] ]  
[-RowDelimiterrow_delimiter]  
[-StartQueueTimeoutstart_queue_timeout_seconds]  
[-UsePerArticleContentsViewuse_per_article_contents_view]  
```  
  
## <a name="arguments"></a>Аргументы  
 **-?**  
 Выводит список всех доступных параметров.  
  
 **-Publisher** _имя_сервера_[ **\\** _имя_экземпляра_]  
 Имя издателя. Укажите "имя_сервера", чтобы использовать экземпляр сервера [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] по умолчанию. Укажите _имя_сервера_ **\\** _имя_экземпляра_ для именованного экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на этом сервере.  
  
 **-Publication** _публикация_  
 Имя публикации. Этот параметр допустим только в том случае, если в данной публикации моментальный снимок всегда доступен для новых или повторно инициализированных подписок.  
  
 **-70Subscribers**  
 Указание обязательно в том случае, если существуют подписчики, работающие на платформе [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] версии 7.0.  
  
 **-BcpBatchSize** _размер_\_ *пакета*\_ *bcp*  
 Число строк для отправки при операции массового копирования. При выполнении операции **bcp in** размер пакета равен числу строк для отправки на сервер в одной транзакции, а также числу строк, которые необходимо отправить до того, как агент распространителя зарегистрирует сообщение о ходе выполнения от программы **bcp** . При выполнении операции **bcp out** используются пакеты фиксированного размера (1000). Значение 0 указывает на отсутствие регистрации сообщений.  
  
 **-DefinitionFile** _путь_и_имя_файла_определения_  
 Путь к файлу определения агента. Файл определения агента содержит параметры командной строки для данного агента. Содержимое файла анализируется как для исполняемого файла. Для указания значений параметров, содержащих произвольные символы, используются двойные кавычки (").  
  
 **-Distributor** _имя_сервера_[ **\\** _имя_экземпляра_]  
 Имя распространителя. Укажите *server_name* , чтобы использовать экземпляр сервера [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] по умолчанию. Укажите _имя_сервера_ **\\** _имя_экземпляра_ для именованного экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на этом сервере.  
  
 **-DistributorDeadlockPriority** [ **-1**|**0**|**1**]  
 Приоритет соединения агента моментальных снимков с распространителем при возникновении взаимоблокировки. Этот параметр указывается для разрешения взаимоблокировок, которые могут возникать между агентом моментальных снимков и пользовательскими приложениями при создании моментальных снимков.  
  
|DistributorDeadlockPriority|Описание|  
|---------------------------------------|-----------------|  
|**-1**|При возникновении взаимоблокировки на распространителе агент моментальных снимков имеет меньший приоритет, чем другие приложения.|  
|**0** (по умолчанию)|Приоритет не назначается.|  
|**1**|При возникновении взаимоблокировки на распространителе агент моментальных снимков имеет больший приоритет.|  
  
 **-DistributorLogin** _имя_входа_распространителя_  
 Имя входа, используемое при соединении с распространителем с проверкой подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
 **-DistributorPassword** _пароль_распространителя_  
 Пароль, используемый при соединении с распространителем с проверкой подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . .  
  
 **-DistributorSecurityMode** [ **0**| **1**]  
 Указывает режим безопасности распространителя. Значение **0** означает проверку подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (по умолчанию), а значение **1** — проверку подлинности Windows.  
  
 **-DynamicFilterHostName** _имя_узла_динамического_фильтра_  
 Позволяет указать значение [HOST_NAME (Transact-SQL)](/sql/t-sql/functions/host-name-transact-sql) для фильтра, который создает динамический моментальный снимок. Так, если для какой-либо статьи указано предложение фильтра подмножества `rep_id = HOST_NAME()` и перед вызовом агента слияния свойство **DynamicFilterHostName** устанавливается в значение «FBJones», в столбце **rep_id** будет производиться репликация только тех строк, которые содержат значение «FBJones».  
  
 **-DynamicFilterLogin** _имя_входа_динамического_фильтра_  
 Позволяет указать значение [SUSER_SNAME (Transact-SQL)](/sql/t-sql/functions/suser-sname-transact-sql) для фильтра, который создает динамический моментальный снимок. Так, если для какой-либо статьи указано предложение фильтра подмножества `user_id = SUSER_SNAME()` и перед вызовом метода **Run** объекта **SQLSnapshot** установить свойство **DynamicFilterLogin** в значение «rsmith», в моментальный снимок будут включены только те строки, в которых столбец **user_id** содержит значение «rsmith».  
  
 **-DynamicSnapshotLocation** _расположение_динамического_моментального_снимка_  
 Папка, в которой должен быть создан динамический моментальный снимок.  
  
 **-EncryptionLevel** [ **0** | **1** | **2** ]  
 Уровень шифрования по протоколу SSL, используемый агентом моментальных снимков при установлении соединений.  
  
|Значение EncryptionLevel|Описание|  
|---------------------------|-----------------|  
|**0**|Указывает, что SSL не используется.|  
|**1**|Указывает, что SSL используется, но агент не проверяет, подписан ли сертификат сервера SSL надежным издателем.|  
|**2**|Указывает, что SSL используется и сертификат подтвержден.|  

 > [!NOTE]  
 >  Допустимый SSL-сертификат задается с полным доменным именем SQL Server. Если параметр -EncryptionLevel имеет значение 2, то для подключения агента создайте псевдоним на локальном сервере SQL Server. Для параметра Alias Name (Имя псевдонима) должно быть указано имя сервера, а для параметра Server (Сервер) — полное доменное имя SQL Server.
  
 Дополнительные сведения см. в разделе [репликация SQL Server Security](../security/view-and-modify-replication-security-settings.md).  
  
 **-FieldDelimiter** _разделитель_полей_  
 Символ или последовательность символов, обозначающая конец поля в файле данных массового копирования [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Значение по умолчанию — \n \<x$3> \н.  
  
 **-HistoryVerboseLevel** [ **1**| **2**| **3**]  
 Указывает объем данных, регистрируемых в журнале при выполнении моментального снимка. Выбрав значение **1**, можно свести к минимуму влияние ведения журнала на производительность.  
  
|Значение HistoryVerboseLevel|Описание|  
|-------------------------------|-----------------|  
|**0**|Сообщения о ходе работы записываются либо в консоль, либо в выходной файл. Записи журнала не регистрируются в базе данных распространителя.|  
|**1**|Всегда обновлять предыдущее сообщение журнала с таким же состоянием (запуск, выполнение, успех и т. д.). Если предыдущих сообщений с таким состоянием нет, то вставить новую запись.|  
|**2** (по умолчанию)|Если есть сообщения о таких событиях, как состояние простоя или долго выполняемое задание, то обновить предыдущие записи, в противном случае вставить новые записи журнала.|  
|**3**|Если сообщения не о состоянии простоя, то всегда вставлять новые записи.|  
  
 **-HRBcpBlocks** _число_блоков_  
 Число блоков данных **bcp** , составляющих очередь между потоками модуля записи и модуля чтения. Значение по умолчанию: 50. Параметр**HRBcpBlocks** используется только с публикациями Oracle.  
  
> [!NOTE]  
>  Этот параметр используется для настройки производительности операции **bcp** из издателя Oracle.  
  
 -**Хрбкпблокксизе**_block_size_  
 Размер каждого блока данных программы **bcp** (в килобайтах). Значение по умолчанию — 64 КБ. Параметр**HRBcpBlocks** используется только с публикациями Oracle.  
  
> [!NOTE]  
>  Этот параметр используется для настройки производительности операции **bcp** из издателя Oracle.  
  
 **-HRBcpDynamicBlocks**  
 Указывает, возможно ли динамическое увеличение размера блоков данных **bcp** . Параметр**HRBcpBlocks** используется только с публикациями Oracle.  
  
> [!NOTE]  
>  Этот параметр используется для настройки производительности операции **bcp** из издателя Oracle.  
  
 **-KeepAliveMessageInterval** _интервал_keep_alive_  
 Период ожидания в секундах, после которого агент моментальных снимков регистрирует в таблице [MSsnapshot_history](/sql/relational-databases/system-tables/mssnapshot-history-transact-sql) запись об ожидании сообщения от сервера. Значение по умолчанию — 300 секунд.  
  
 **-LoginTimeOut** _время_ожидания_входа_в_секундах_  
 Время ожидания входа в секундах. Значение по умолчанию составляет **15** секунд.  
  
 **-MaxBcpThreads** _число_потоков_  
 Указывает число операций массового копирования, которые можно проводить параллельно. Максимальное число потоков и соединений ODBC, которые существуют одновременно, равно меньшему из **MaxBcpThreads** и числа запросов на массовое копирование, которые появляются в транзакции синхронизации в базе данных распространителя. Значение**MaxBcpThreads** должно быть больше **0** и не имеет жестко запрограммированного максимума. Значение по умолчанию — **1**.  
  
 \- **MaxNetworkOptimization** [ **0**| **1**]  
 Указывает, направляются ли подписчику операции удаления, которые не имеют к нему отношения. Это направляемые подписчикам инструкции DELETE, которые относятся к строкам, не входящим в секцию соответствующего подписчика. Такие команды не влияют на целостность и конвергенцию данных, однако они могут вызвать нежелательный сетевой трафик. По умолчанию параметр **MaxNetworkOptimization** имеет значение **0**. Если задать параметру **MaxNetworkOptimization** значение **1** , то вероятность не относящихся к нему удалений будет сведена к минимуму, что позволит сократить объем сетевого трафика и оптимизировать работу сети. Однако при установке этого параметра в значение **1** может возрасти объем хранимых метаданных и снизиться производительность на издателе, если используется несколько уровней фильтров соединений и сложных фильтров подмножеств. Устанавливать значение параметра **MaxNetworkOptimization** в значение **1** следует после тщательного рассмотрения топологии репликации и только в тех случаях, когда объем трафика, инициируемого неправильными командами удаления, является неприемлемым.  
  
> [!NOTE]
>  Установка этого параметра равным **1** полезна только в том случае, если параметру оптимизации синхронизации публикации слиянием присвоено **значение true** ( **@keep_partition_changes** параметр [sp_addmergepublication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql)).  
  
 **-Output** _путь_и_имя_выходного_файла_  
 Путь к выходному файлу агента. Если имя файла не указано, данные выводятся на консоль. Если указанный файл существует, то выходные данные добавляются в конец файла.  
  
 **-OutputVerboseLevel** [ **0**| **1**| **2**]  
 Указывает, должны ли выводимые данные быть подробными.  
  
|Значение OutputVerboseLevel|Описание|  
|------------------------------|-----------------|  
|**0**|Выводятся только сообщения об ошибках.|  
|**1** (по умолчанию)|Выводятся все сообщения отчета о состоянии (значение по умолчанию).|  
|**2**|Выводятся все сообщения об ошибках, а также сообщения отчета о состоянии, что может оказаться при отладке.|  

 **-PrefetchTables** [ **0**| **1**]  
 Необязательный параметр, который указывает, нужно ли выполнять упреждающую выборку и кэширование объектов таблицы.  По умолчанию упреждающая выборка выполняется для некоторых свойств таблицы с помощью компонента SMO на основе внутренних вычислений.  Этот параметр будет полезен в сценариях, где для операции предварительной выборки SMO требуется много времени. Если этот параметр не используется, решение принимается во время выполнения. При этом учитывается процент таблиц, которые добавляются в публикацию в качестве статей.  
  
|Значение OutputVerboseLevel|Описание|  
|------------------------------|-----------------|  
|**0**|Вызовы к методу Prefetch компонента SMO запрещены.|  
|**1**|Агент моментальных снимков может вызывать метод Prefetch, чтобы кэшировать некоторые свойства таблицы с помощью объектов SMO.|  
  
 **-PacketSize** _размер_пакета_  
 Размер пакета (в байтах) агента моментальных снимков при соединении с [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Значение по умолчанию — 8192 байт.  
  
> [!NOTE]  
>  Не изменяйте размер пакета, если нет уверенности в том, что это повысит производительность. Для большинства приложений оптимальным является размер пакета, установленный по умолчанию.  
  
 **-ProfileName** _имя_профиля_  
 Указывает профиль агента, из которого берутся параметры агента. Если **ProfileName** имеет значение NULL, профиль агента отключен. Если значение **ProfileName** не указано, используется профиль по умолчанию для агентов этого типа. Дополнительные сведения см. в статье [Профили агента репликации](replication-agent-profiles.md).  
  
 **-PublisherDB** _база_данных_издателя_  
 Имя базы данных публикации. *Этот параметр не поддерживается для издателей Oracle*.  
  
 **-PublisherDeadlockPriority** [ **-1**|**0**|**1**]  
 Приоритет соединения агента моментальных снимков с издателем при возникновении взаимоблокировки. Этот параметр указывается для разрешения взаимоблокировок, которые могут возникать между агентом моментальных снимков и пользовательскими приложениями при создании моментальных снимков.  
  
|Значение PublisherDeadlockPriority|Описание|  
|-------------------------------------|-----------------|  
|**-1**|При возникновении взаимоблокировки на издателе агент моментальных снимков имеет меньший приоритет, чем другие приложения.|  
|**0** (по умолчанию)|Приоритет не назначается.|  
|**1**|При возникновении взаимоблокировки на издателе агент моментальных снимков имеет больший приоритет.|  
  
 **-PublisherFailoverPartner** _имя_сервера_[ **\\** _имя_экземпляра_]  
 Указывает партнера по обеспечению отработки отказа служб [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , участвующего в сеансе зеркального отображения базы данных с базой данных публикации. Дополнительные сведения см. в статье [Зеркальное отображение и репликация баз данных (SQL Server)](../../../database-engine/database-mirroring/database-mirroring-and-replication-sql-server.md).  
  
 **-PublisherLogin** _имя_входа_на_издателе_  
 Имя входа при соединении с издателем с проверкой подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
 **-PublisherPassword** _пароль_на_издателе_  
 Пароль, используемый при соединении с издателем с проверкой подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . .  
  
 **-PublisherSecurityMode** [ **0**| **1**]  
 Указывает режим безопасности издателя. Значение **0** означает проверку подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (по умолчанию), а значение **1** — проверку подлинности Windows.  
  
 **-QueryTimeOut** _время_ожидания_запроса_в_секундах_  
 Время ожидания запроса в секундах. Значение по умолчанию — 1800 секунд.  
  
 **-ReplicationType** [ **1**| **2**]  
 Указывает тип репликации. Значение **1** указывает на репликацию транзакций, а значение **2** — на репликацию слиянием.  
  
 **-RowDelimiter** _разделитель_строк_  
 Символ или последовательность символов, обозначающая конец строки в файле данных массового копирования [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Значение по умолчанию — \n \<,@g> \н.  
  
 **-StartQueueTimeout** _время_ожидания_начала_очереди_  
 Максимальное количество секунд, в течение которых агент моментальных снимков ожидает, когда количество параллельных процессов динамических моментальных снимков превышено на предельное значение, заданное **@max_concurrent_dynamic_snapshots** свойством [Sp_addmergepublication &#40;TRANSACT-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql). Если по истечении этого времени агент моментальных снимков все еще находится в процессе ожидания, то его работа будет завершена. Значение 0 означает, что агент ждет неопределенно долгое время, хотя его выполнение может быть отменено.  
  
 \- **UsePerArticleContentsView** _использование_на_просмотр_содержимого_статьи_  
 Этот параметр устарел и поддерживается только для обеспечения обратной совместимости.  
  
## <a name="remarks"></a>Remarks  
  
> [!IMPORTANT]  
>  Если агент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] установлен для запуска от учетной записи пользователя не домена (по умолчанию), а локальной системы, то служба имеет доступ только к локальному компьютеру. Если агент моментальных снимков, запускаемый агентом [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , настроен для входа в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]с проверкой подлинности Windows, то работа агента моментальных снимков завершится ошибкой. Значением по умолчанию является проверка подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
 Чтобы запустить агент моментальных снимков, из командной строки выполните файл **snapshot.exe** . Дополнительные сведения см. в разделе [Исполняемые объекты агента репликации](../concepts/replication-agent-executables-concepts.md).  
  
## <a name="see-also"></a>См. также:  
 [Администрирование агента репликации](replication-agent-administration.md)  
  
  
