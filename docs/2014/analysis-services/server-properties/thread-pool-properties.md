---
title: Свойства пула потоков | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: analysis-services
ms.topic: conceptual
helpviewer_keywords:
- PriorityRatio property
- threads [Analysis Services]
- MinThreads property
- NumThreads property
- MaxThreads property
- Concurrency property
ms.assetid: e2697bb6-6d3f-4621-b9fd-575ac39c2185
author: minewiskan
ms.author: owend
manager: craigg
ms.openlocfilehash: 1fe324da14460d69d6930bf9d398a50e816f676f
ms.sourcegitcommit: b87d36c46b39af8b929ad94ec707dee8800950f5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2020
ms.locfileid: "66068838"
---
# <a name="thread-pool-properties"></a>Свойства пула потоков
  
  [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] использует многопоточность во многих операциях, повышая общую производительность сервера за счет параллельного выполнения нескольких заданий. Чтобы эффективнее управлять потоками, [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] использует пулы потоков для предварительного выделения ресурсов и обеспечения доступности потоков для последующих заданий.  
  
 Каждый экземпляр [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] поддерживает собственный набор пулов потоков. Имеются важные различия между тем, как табличные и многомерные экземпляры используют пулы потоков. Самое важное отличие заключается в том, что только в `IOProcess` многомерных решениях используется пул потоков. Таким образом, свойство `PerNumaNode`, описанное в этом разделе, для табличных экземпляров не задействуется.  
  
 Этот раздел состоит из следующих подразделов.  
  
-   [Управление потоками в Analysis Services](#bkmk_threadarch)  
  
-   [Справочник по свойствам пула потоков](#bkmk_propref)  
  
-   [Присвоить GroupAffinity потокам привязать процессоров в группе процессоров](#bkmk_groupaffinity)  
  
-   [Установка для PerNumaNode потоков ввода-вывода привязать на процессоры в узле NUMA](#bkmk_pernumanode)  
  
-   [Определение текущих параметров пула потоков](#bkmk_currentsettings)  
  
-   [Зависимые или связанные свойства](#bkmk_related)  
  
-   [О команде MSMDSRV. ССЫЛКИ](#bkmk_msmdrsrvini)  
  
> [!NOTE]  
>  Табличное развертывание в системах NUMA в данном разделе не освещается. Табличные решения можно успешно развертывать в системах NUMA, но производительность хранимых в памяти баз данных, используемых в табличных моделях, может быть ограничена на сильно масштабируемых архитектурах. Дополнительные сведения см. в статьях [Практический пример использования служб Analysis Services. Использование табличных моделей в крупномасштабных коммерческих решениях](https://msdn.microsoft.com/library/dn751533.aspx) и [Подбор оборудования для табличного решения](https://go.microsoft.com/fwlink/?LinkId=330359).  
  
##  <a name="bkmk_threadarch"></a>Управление потоками в Analysis Services  
 
  [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] применяет многопоточность, используя преимущества доступных ресурсов процессора путем увеличения количества параллельно выполняемых задач. Подсистема хранилища является многопоточной. Примеры многопоточных заданий, выполняемых в подсистеме хранилища: параллельная обработка объектов или обработка отдельных запросов, которые передаются в подсистему хранилища, а также возврат запрошенных данных. Модуль формул из-за особенностей последовательных вычислений выполняется в одном потоке. Каждый запрос в основном выполняется в одном потоке, который запрашивает и ожидает данные от подсистемы хранилища. Потоки выполнения запроса выполняются дольше и завершаются только после выполнения всего запроса.  
  
 По умолчанию в версиях [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] и более поздних [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] будет использовать все доступные логические процессоры, до 640 в тех системах, которые выполняются на выпусках Windows и SQL Server с более широкими возможностями. При запуске процесс msmdsrv.exe будет назначен определенной группе процессоров, но со временем потоки могут быть назначены на любой логический процессор, в любой группе.  
  
 Одним из побочных эффектов использования большого количества процессоров является то, что иногда может возникать снижение производительности из-за распределения нагрузок от запросов и обработки по большому количеству процессоров и увеличения состязания за общие структуры данных. Это, в частности, может произойти не только в высокопроизводительных системах, использующих архитектуру NUMA, но и в системах, отличных от NUMA, в которых выполняется много приложений, обрабатывающих большой объем данных, на том же оборудовании.  
  
 Чтобы устранить эту проблему, можно установить соответствие между типами операций [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] и определенным набором логических процессоров. Свойство `GroupAffinity` позволяет создавать пользовательские маски сходства, указывающие системный ресурс для каждого из типов пулов потоков, управление которыми осуществляют службы [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)].  
  
 Пользовательское сходство может быть задано для любого из пяти пулов потоков, используемых для различных рабочих нагрузок [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] .  
  
-   **Синтаксический анализ \ Short** является пулом анализа для коротких запросов. Запросы, которые умещаются в одном сетевом сообщении, считаются короткими.  
  
-   **Анализ \ Long** — это пул анализа для всех остальных запросов, которые не помещаются в одном сетевом сообщении.  
  
    > [!NOTE]  
    >  Поток из любого пула синтаксического анализа можно использовать для выполнения запроса. Запросы, которые могут быть выполнены быстро, такие как запросы Discover или Cancel, иногда выполняются сразу же, а не ставятся в очередь запросов пула потоков.  
  
-   `Query`— Это пул потоков, выполняющий все запросы, которые не обрабатываются пулом потоков анализа. Потоки в этом пуле выполняют операции всех типов, например команды поиска, MDX, DAX, DMX и DDL.  
  
-   `IOProcess`используется для заданий ввода-вывода, связанных с запросами подсистемы хранилища в многомерном модуле. Ожидается, что задания, выполняемые этими потоками, не имеют зависимостей от других потоков. Эти потоки обычно просматривают один сегмент секции и выполняют фильтрацию и статистическую обработку данных сегмента. `IOProcess`потоки особенно чувствительны к конфигурациям оборудования NUMA. Таким образом, этот пул потоков имеет свойство `PerNumaNode` конфигурации, которое можно использовать для настройки производительности при необходимости.  
  
-   `Process`параметр предназначен для более длинных заданий подсистемы хранилища, включая операции агрегирования, индексирования и фиксации. Режим хранилища ROLAP также использует потоки из пула потоков Processing.  
  
> [!NOTE]  
>  Несмотря на то, что msmdsrv. ini содержит параметры `VertiPaq` пула потоков `VertiPaq` \\ `ThreadPool` \\ `GroupAffinity` в `ThreadPool` \\ `CPUs` разделе, и они предназначены для недокументированных документов. Эти свойства в настоящий момент недействительны и зарезервированы для использования в будущем.  
  
 Для выполнения обработки запросов [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] может превысить предел пула потоков, запросив дополнительные потоки, если они необходимы для работы. Однако если поток завершает выполнение своей задачи, притом что текущее количество потоков превышает максимальный предел, то поток просто завершается, а не возвращается в пул потоков.  
  
> [!NOTE]  
>  Превышение максимального числа потоков пула является защитным механизмом, который вызывается только в случае возникновения определенных состояний взаимоблокировки. Для предотвращения выхода количества создаваемых потоков за максимально допустимое значение по достижении максимального предела потоки создаются не сразу, а после короткой задержки. Превышение максимального числа потоков может привести к замедлению выполнения задач. Если счетчики производительности указывают на то, что число потоков регулярно превышает максимальный размер пула потоков, это можно считать признаком того, что размер пула потоков слишком мал для той степени параллелизма, которая требуется системе.  
  
 По умолчанию размер пула потоков определяется [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]и основывается на числе ядер. Используемые значения по умолчанию можно посмотреть в файле msmdsrv.log после запуска сервера. В ходе настройки производительности можно увеличить размер пула потоков, а также другие свойства, чтобы повысить производительность запросов и обработки.  
  
##  <a name="bkmk_propref"></a>Справочник по свойствам пула потоков  
 В этом разделе описываются свойства пула потоков из файла msmdsrv.ini каждого экземпляра [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] . Подмножество этих свойств также доступно в SQL Server Management Studio.  
  
 Свойства перечисляются в алфавитном порядке.  
  
|Имя|Тип|Description|По умолчанию|Руководство|  
|----------|----------|-----------------|-------------|--------------|  
|`IOProcess` \ `Concurrency`|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](https://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .<br /><br /> Применяется только в многомерных моделях.|  
|`IOProcess` \ `GroupAffinity`|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков в пуле потоков IOProcess логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .<br /><br /> Применяется только в многомерных моделях.|  
|`IOProcess` \ `MaxThreads`|INT|32-разрядное целое число со знаком, определяющее максимальное количество потоков для включения в пул потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию сервер устанавливает это значение как 64 или как умноженное на 10 число логических процессоров в зависимости от того, какое из чисел выше. Например, в системе с 4 ядрами с технологией Hyper-Threading максимум пула потоков будет равен 80.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству MaxThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](https://msdn.microsoft.com/library/hh226085.aspx).<br /><br /> Применяется только в многомерных моделях.|  
|`IOProcess` \ `MinThreads`|INT|32-разрядное целое число со знаком, определяющее минимальное количество потоков, предварительно выделяемых для пула потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. Минимальное значение по умолчанию равно 1.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](https://msdn.microsoft.com/library/hh226085.aspx).<br /><br /> Применяется только в многомерных моделях.|  
|`IOProcess` \ `PerNumaNode`|INT|32-разрядное целое число со знаком, определяющее количество пулов потоков, создаваемых для процесса msmdsrv.|-1|Допустимые значения: -1, 0, 1, 2.<br /><br /> -1 = сервер выбирает другую стратегию пула потоков ввода-вывода на основе числа узлов NUMA. В системах, где число узлов NUMA меньше 4, поведение сервера такое же, как и для значения 0 (для системы создается один пул потоков IOProcess). В системах, где количество узлов составляет четыре или больше, поведение такое же, как и для значения 1 (для каждого узла создаются пулы потоков IOProcess).<br /><br /> 0 = отключает пулы потоков для каждого узла NUMA, так что присутствует только один пул потоков IOProcess, используемый msmdsrv.exe.<br /><br /> 1 = включает один пул потоков IOProcess на каждый узел NUMA.<br /><br /> 2 = один пул потоков IOProcess на каждый логический процессор. Потоки в каждом пуле потоков привязываются к узлам NUMA логического процессора, где наиболее подходящий процессор приравнен к логическому процессору.<br /><br /> См. подробности в разделе [Задайте параметр PerNumaNode, чтобы привязать потоки ввода-вывода к процессорам в узле NUMA.](#bkmk_pernumanode) .<br /><br /> Применяется только в многомерных моделях.|  
|`IOProcess` \ `PriorityRatio`|INT|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|2|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Применяется только в многомерных моделях.|  
|`IOProcess` \ `StackSizeKB`|INT|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Применяется только в многомерных моделях.|  
|**Синтаксический анализ**  \ `Long` \ `Concurrency`|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](https://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|**Синтаксический анализ**  \ `Long` \ `GroupAffinity`|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков анализа логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|**Синтаксический анализ**  \ `Long` \ `NumThreads`|INT|Свойство с 32-разрядным целочисленным значением со знаком, определяющее количество потоков, которое можно создать для длинных команд.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию параметру `NumThreads` задается абсолютное значение 4 или умноженное на 2 число логических процессоров в зависимости от того, какое значение выше.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству NumThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.|  
|**Синтаксический анализ**  \ `Long` \ `PriorityRatio`|INT|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Синтаксический анализ**  \ `Long` \ `StackSizeKB`|INT|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Синтаксический анализ**  \ `Short` \ `Concurrency`|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](https://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|**Синтаксический анализ**  \ `Short` \ `GroupAffinity`|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков анализа логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|**Синтаксический анализ**  \ `Short` \ `NumThreads`|INT|Свойство с 32-разрядным целочисленным значением со знаком, определяющее количество потоков, которое можно создать для коротких команд.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию параметру `NumThreads` задается абсолютное значение 4 или умноженное на 2 число логических процессоров в зависимости от того, какое значение выше.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству NumThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.|  
|**Синтаксический анализ**  \ `Short` \ `PriorityRatio`|INT|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|**Синтаксический анализ**  \ `Short` \ `StackSizeKB`|INT|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|64 * число логических процессоров|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|`Process` \ `Concurrency`|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](https://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|`Process` \ `GroupAffinity`|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков обработки логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|`Process` \ `MaxThreads`|INT|32-разрядное целое число со знаком, определяющее максимальное количество потоков для включения в пул потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию сервер задает этому свойству абсолютное значение 64 или значение, равное числу логических процессоров, в зависимости от того, какое выше. Например, в системе с 64 ядрами и с включенной функцией технологии Hyper-Threading (что в результате дает 128 логических процессора), максимум для пула потоков будет равен 128.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству MaxThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](https://msdn.microsoft.com/library/hh226085.aspx).|  
|`Process` \ `MinThreads`|INT|32-разрядное целое число со знаком, определяющее минимальное количество потоков, предварительно выделяемых для пула потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. Минимальное значение по умолчанию равно 1.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](https://msdn.microsoft.com/library/hh226085.aspx).|  
|`Process` \ `PriorityRatio`|INT|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|2|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|`Process` \ `StackSizeKB`|INT|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|`Query`  \ `Concurrency`|double|Значение с плавающей запятой двойной точности, определяющее алгоритм для установки целевого количества потоков, которые могут быть одновременно поставлены в очередь.|2.0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .<br /><br /> Параллелизм используется для инициализации пулов потоков, которые в Windows реализуются с помощью портов завершения операций ввода-вывода. Дополнительные сведения см. в разделе [Порты завершения ввода-вывода](https://msdn.microsoft.com/library/windows/desktop/aa365198\(v=vs.85\).aspx) .|  
|`Query` \ `GroupAffinity`|строка|Массив шестнадцатеричных значений, который соответствует группам процессоров в системе, используемой для задания сходства потоков обработки логическим процессорам в каждой группе процессоров.|none|С помощью этого свойства можно создавать пользовательские сходства. По умолчанию это свойство пусто.<br /><br /> См. подробности в разделе [Задание параметра GroupAffinity для привязки потоков к процессорам или группе процессоров](#bkmk_groupaffinity) .|  
|`Query`  \ `MaxThreads`|INT|32-разрядное целое число со знаком, определяющее максимальное количество потоков для включения в пул потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. По умолчанию сервер задает этому свойству абсолютное значение 10 или значение, равное числу логических процессоров умноженное на 2, в зависимости от того, какое из них выше. Например, в системе с 4 ядрами с технологией Hyper-Threading максимальное число потоков равно 16.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров. Например, если значение равно -10, на сервере с 32 логическими процессорами максимум будет составлять 320 потоков.<br /><br /> Максимальное значение зависит от числа процессоров, доступных для пользовательских масок сходства, определенных вами ранее. Например, если уже была задана схожесть пула потоков на использование 8 из 32 процессоров, при задании свойству MaxThreads значения -10 верхняя граница пула потоков будет равна 10*8, то есть 80 потокам.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](https://msdn.microsoft.com/library/hh226085.aspx).|  
|`Query` \ `MinThreads`|INT|32-разрядное целое число со знаком, определяющее минимальное количество потоков, предварительно выделяемых для пула потоков.|0|0 указывает, что сервер сам определяет значения по умолчанию. Минимальное значение по умолчанию равно 1.<br /><br /> Если значение задано как отрицательное, сервер умножит это число на количество логических процессоров.<br /><br /> Фактические значения для этого свойства пула потоков заносятся в файл журнала msmdsrv после запуска службы.<br /><br /> Дополнительные сведения о настройке параметров пула потоков можно найти в [руководстве по операциям служб Analysis Services](https://msdn.microsoft.com/library/hh226085.aspx).|  
|`Query` \ `PriorityRatio`|INT|32-разрядное целое число со знаком, которое используется в том случае, если требуется, чтобы иногда выполнялись потоки с более низким приоритетом, даже если очередь с более высоким приоритетом не пуста.|2|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
|`Query`  \ `StackSizeKB`|INT|32-разрядное целое число со знаком, которое можно использовать для настройки выделения памяти во время выполнения потоков.|0|Дополнительное свойство, которое следует изменять только под руководством службы поддержки [!INCLUDE[msCoName](../../includes/msconame-md.md)] .|  
  
##  <a name="bkmk_groupaffinity"></a>Присвоить GroupAffinity потокам привязать процессоров в группе процессоров  
 Значение `GroupAffinity` предоставляется для дополнительной настройки. Свойство `GroupAffinity` можно использовать, чтобы установить соответствие между пулами потоков [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] и некоторыми процессорами. Однако для большинства установок [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] работает лучше, если можно использовать все доступные логические процессоры. Таким образом, по умолчанию соответствие группы не задано.  
  
 Если эксплуатационное тестирование показывает необходимость оптимизации использования ЦП, то, возможно, стоит рассмотреть подход более высокого уровня, например использование диспетчера ресурсов Windows Server для указания сходства между логическими процессорами и процессом сервера. Такой подход может оказаться проще в реализации и управлении, чем определение пользовательских соответствий для отдельных пулов потоков.  
  
 Если этого окажется недостаточно для решения задачи, то большей точности можно добиться, определив пользовательские соответствия для пулов потоков. Настройка параметров сходства чаще всего рекомендуется в больших многоядерных системах (как с NUMA, так и без этой технологии), испытывающих снижение производительности из-за распределения пулов потоков по слишком большому числу процессоров. Свойство `GroupAffinity` можно задать и в системах, где число логических процессоров меньше 64, но выигрыш от этого будет незначительным, или даже произойдет падение производительности.  
  
> [!NOTE]  
>  
  `GroupAffinity` ограничивается выпусками, которые лимитируют количество ядер, используемых [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]. При запуске [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] использует сведения о выпуске и свойства `GroupAffinity` в целях вычисления масок сходства для каждого из 5 пулов потоков, управляемых службами [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]. В стандартном выпуске могут использоваться самое большее 16 ядер. Если стандартный выпуск служб [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] устанавливается в большой многоядерной системе, имеющей больше 16 ядер, то в [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] используются только 16 из них. При обновлении экземпляра Enterprise более ранней версии ограничение составляет 20 ядер. Дополнительные сведения о выпусках и лицензировании см. в разделе [Общие сведения о лицензировании SQL Server 2012](https://go.microsoft.com/fwlink/?LinkId=246061).  
  
### <a name="syntax"></a>Синтаксис  
 Шестнадцатеричное значение для каждой группы процессоров, представляющее логические процессоры, которые [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] пытается использовать при выделении потоков из определенного пула.  
  
 **Битовая маска для логических процессоров**  
  
 Можно указать до 64 логических процессоров в пределах одной группы. Битовая маска равна 1 (или 0) для каждого логического процессора в группе, используемого (или не используемого) пулом потоков. После вычисления битовой маски следует вычислить шестнадцатеричное значение в качестве значения для `GroupAffinity`параметра.  
  
 **Несколько групп процессоров**  
  
 Группы процессоров определяются во время запуска системы. `GroupAffinity`принимает шестнадцатеричные значения для каждой группы процессоров в списке, разделенном запятыми. При наличии нескольких групп процессоров (до 10 на мощных системах) можно пропустить отдельные группы, указав 0x0. Например, в системе с четырьмя группами процессоров (0, 1, 2, 3) можно исключить группы 0 и 2, введя 0x0 для первого и третьего значения.  
  
 `<GroupAffinity>0x0, 0xFF, 0x0, 0xFF</GroupAffinity>`  
  
### <a name="steps-for-computing-the-processor-affinity-mask"></a>Действия при вычислении маски соответствия процессоров  
 Можно задать `GroupAffinity` в файле msmdsrv. ini или на страницах свойств сервера в SQL Server Management Studio.  
  
1.  **Определение количества процессоров и групп процессоров**  
  
     Можно загрузить [программу Coreinfo из winsysinternals](https://technet.microsoft.com/sysinternals/cc835722.aspx).  
  
     Запустите **coreinfo** для получения этих сведений из раздела «Сопоставление логических процессоров с группой». Формируется отдельная строка для каждого логического процессора.  
  
2.  Последовательность процессоров справа налево: `7654 3210`  
  
     Пример показывает только 8 процессоров (от 0 до 7), но группа процессоров может иметь максимум 64 логических процессора. На сервере Windows уровня предприятия может быть до 10 групп процессоров.  
  
3.  **Вычисление битовой маски для групп процессоров, которые вы хотите использовать**  
  
     `7654 3210`  
  
     Замените цифру на 0 или 1 в зависимости от того, нужно включить или исключить логический процессор. В системе с 8 процессорами выбранное вычисление может выглядеть следующим образом, если для служб Analysis Services решено использовать процессоры 7, 6, 5, 4 и 1:  
  
     `1111 0010`  
  
4.  **Преобразование двоичного числа в шестнадцатеричное**  
  
     Преобразуйте двоичное значение в шестнадцатеричное с помощью калькулятора или средства преобразования. В нашем примере `1111 0010` преобразуется в `0xF2`.  
  
5.  **Введите шестнадцатеричное значение в свойстве GroupAffinity**  
  
     В файле msmdsrv. ini или на странице свойств сервера в Management Studio задайте `GroupAffinity` значение, вычисленное на шаге 4.  
  
> [!IMPORTANT]  
>  Задание `GroupAffinity` — это ручная задача, охватывающая несколько шагов. При вычислениях `GroupAffinity`тщательно проверяйте свои вычисления. Хотя [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] возвращает ошибку, если некорректна вся маска, сочетание допустимых и недопустимых параметров приводит к тому, что [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] игнорирует это свойство. Например, если битовая маска включает дополнительные значения, то [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] пропустит этот параметр и будут использоваться все ЦП в системе. Нет ошибки или предупреждения, которое сообщило бы об этом. Но вы можете проверить файл msmdsrv.log, чтобы узнать, как на самом деле заданы критерии сходства.  
  
##  <a name="bkmk_pernumanode"></a>Установка для PerNumaNode потоков ввода-вывода привязать на процессоры в узле NUMA  
 Для многомерных Analysis Services экземпляров можно задать `PerNumaNode` в пуле `IOProcess` потоков, чтобы дополнительно оптимизировать планирование и выполнение потоков. В то `GroupAffinity` время как определяет, какой набор логических процессоров следует использовать для данного пула `PerNumaNode` потоков, переходит на один шаг дальше, указывая, нужно ли создавать несколько пулов потоков, дополнительно привязаны к какому-либо подмножеству разрешенных логических процессоров.  
  
> [!NOTE]  
>  Чтобы узнать число узлов NUMA в Windows Server 2012, используйте диспетчер задач. В диспетчере задач на вкладке "Производительность" выберите **ЦП** , а затем щелкните правой кнопкой мыши область диаграммы для просмотра узлов NUMA. Или же [загрузите](https://technet.microsoft.com/sysinternals/cc835722.aspx) программу Coreinfo из Windows Sysinternals и запустите `coreinfo -n` , что позволит узнать число узлов NUMA и количество логических процессоров в каждом узле.  
  
 Допустимыми значениями `PerNumaNode` для являются-1, 0, 1, 2, как описано в разделе [Справочник по свойствам пула потоков](#bkmk_propref) в этой статье.  
  
### <a name="default-recommended"></a>По умолчанию (рекомендуется)  
 В системах, где есть узлы NUMA, рекомендуется использовать PerNumaNode=-1. Это позволяет [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] подстраивать количество пулов потоков и их соответствие на основе количества узлов. Если в системе меньше 4 узлов, [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] реализует поведение, описанное в `PerNumaNode`= 0, тогда как `PerNumaNode`= 1 используется в системах с 4 или более узлами.  
  
### <a name="choosing-a-value"></a>Выбор значения  
 Можно также переопределить значение по умолчанию и использовать другое допустимое значение.  
  
 **Параметр PerNumaNode = 0**  
  
 Узлы NUMA не учитываются. Будет присутствовать только один пул потоков IOProcess, и все потоки в этом пуле будут привязаны ко всем логическим процессорам. Это значение будет использоваться по умолчанию (при PerNumaNode=-1), если компьютер имеет менее 4 узлов NUMA.  
  
 ![Соответствие NUMA, процессора и пула потоков](../media/ssas-threadpool-numaex0.PNG "Соответствие NUMA, процессора и пула потоков")  
  
 **Параметр PerNumaNode = 1**  
  
 Пулы потоков IOProcess создаются для каждого узла NUMA. Наличие отдельных пулов потоков способствует улучшению координируемого доступа к локальным ресурсам, например к локальному кэшу на узле NUMA.  
  
 ![Соответствие NUMA, процессора и пула потоков](../media/ssas-threadpool-numaex1.PNG "Соответствие NUMA, процессора и пула потоков")  
  
 **Параметр PerNumaNode = 2**  
  
 Это значение для очень мощных систем, где выполняются интенсивные рабочие нагрузки [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] . Это свойство задает привязку пула потоков IOProcess на самом детальном уровне, создавая и привязывая пулы на уровне логических процессоров.  
  
 В следующем примере в системе с 4 узлами NUMA и 32 логическими процессорами значение `PerNumaNode` 2 приведет к тому, что IOProcess пулы потоков 32. Потоки в первых 8 пулах будут привязаны ко всем логическим процессорам в узле 0, но идеальный процессор будет назначен для 0, 1, 2... до 7. Следующие 8 пулов потоков будут привязаны ко всем логическим процессорам в узле 1 NUMA, идеальный процессор будет назначен для 8, 9, 10... до 15 и т. д.  
  
 ![Соответствие NUMA, процессора и пула потоков](../media/ssas-threadpool-numaex2.PNG "Соответствие NUMA, процессора и пула потоков")  
  
 На этом уровне соответствия планировщик всегда сначала пытается использовать идеально подходящий логический процессор в предпочитаемом узле NUMA. Если логический процессор недоступен, то планировщик выбирает один процессор в том же узле или в той же группе процессоров, если другие потоки недоступны. Дополнительные сведения и примеры см. в статье [Параметры конфигурации служб Analysis Services 2012 (блог Wordpress)](https://go.microsoft.com/fwlink/?LinkId=330387).  
  
###  <a name="bkmk_workdistrib"></a>Распределение работы между потоками IOProcess  
 При принятии решения о том, следует `PerNumaNode` ли задавать свойство, `IOProcess` знание того, как потоки используются, может помочь принять более обоснованное решение.  
  
 Помните, `IOProcess` что используется для заданий ввода-вывода, связанных с запросами подсистемы хранилища в многомерном модуле.  
  
 При сканировании сегмента модуль определяет секцию, к которой принадлежит сегмент, и пытается поместить задание сегмента в пул потоков, используемый этой секцией. Как правило, все сегменты, принадлежащие секции, ставят свои задачи в один и тот же пул потоков. В системах NUMA это особенно удобно, поскольку все операции сканирования секции используют память в кэше файловой системы, локально выделенном для этого узла NUMA.  
  
 В следующих сценариях предлагаются корректировки, которые иногда могут увеличить производительность запросов в системах NUMA.  
  
-   Для групп мер, которые недостаточно разделены (например, при использовании одной секции), увеличьте число секций. При использовании только одной секции модуль всегда помещает задачи в один пул потоков (нулевой). Добавление нескольких секций позволяет модулю использовать дополнительные пулы потоков.  
  
     Кроме того, если не удается создать дополнительные разделы, попробуйте `PerNumaNode`задать значение = 0, чтобы увеличить число потоков, доступных пулу потоков 0.  
  
-   Для баз данных, в которых проверка сегмента равномерно распределяется по нескольким секциям `PerNumaNode` , установка значения 1 или 2 может повысить производительность запросов, так как она увеличивает `IOProcess` общее число пулов потоков, используемых системой.  
  
-   Для решений, имеющих несколько разделов, но только один сканируется, попробуйте задать значение `PerNumaNode`= 0, чтобы узнать, улучшается ли производительность.  
  
 Хотя при сканировании секций и измерений `IOProcess` используется пул потоков, Просмотры измерений используют только пул потоков 0. Это может привести к слегка неравномерной загрузке данного пула потоков, но дисбаланс должен быть временным, так как операции сканирования измерений применяются редко и выполняются очень быстро.  
  
> [!NOTE]  
>  При изменении свойства сервера следует помнить, что параметр конфигурации применяется ко всем базам данных в текущем экземпляре. Выберите параметры, дающие выигрыш для наиболее важных баз данных или большего числа баз данных. Нельзя установить привязку процессоров на уровне базы данных, нельзя также задать соответствия между отдельными секциями и некоторыми процессорами.  
  
 Дополнительные сведения об архитектуре заданий см. в подразделе 2.2 [руководства по повышению производительности служб SQL Server 2008 Analysis Services](https://www.microsoft.com/download/details.aspx?id=17303).  
  
##  <a name="bkmk_related"></a>Зависимые или связанные свойства  
 Как описано в разделе 2,4 [Analysis Services руководстве по операциям](https://msdn.microsoft.com/library/hh226085.aspx), при увеличении пула потоков обработки следует убедиться, что `CoordinatorExecutionMode` параметры, а также `CoordinatorQueryMaxThreads` параметры, имеют значения, позволяющие полностью использовать увеличенный размер пула потоков.  
  
 Службы Analysis Services используют координирующий поток для сбора данных, необходимых для завершения обработки или выполнения запроса. Координатор сначала ставит в очередь одно задание для каждой секции, которое необходимо обработать. Каждое из этих заданий затем ставит в очередь другие задания в зависимости от общего числа сегментов, которые необходимо просмотреть в секции.  
  
 Значение по умолчанию для `CoordinatorExecutionMode` равно -4, что ставит предел в 4 параллельных заданиях на ядро и ограничивает общее количество заданий координатора, которые могут параллельно выполняться запросом вложенного куба в подсистеме хранилища.  
  
 Значение по умолчанию для `CoordinatorQueryMaxThreads` равно 16, что ограничивает число сегментов заданий, которые могут выполняться параллельно для каждой секции.  
  
##  <a name="bkmk_currentsettings"></a>Определение текущих параметров пула потоков  
 При каждом запуске службы [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] выводит текущие параметры пула потоков в файл msmdsrv.log, включая минимальное и максимальное число потоков, маску соответствия процессоров и степень параллелизма.  
  
 В следующем примере дан отрывок из файла журнала, где показываются параметры по умолчанию для пула потоков Query (MinThread=0, MaxThread=0, Concurrency=2) в 4-ядерной системе с включенной функцией управления потоками. Маска сходства — 0xFF, что означает 8 логических процессоров. Обратите внимание, что к маске добавлены нули в начале. Не обращайте на них внимание.  
  
 `"10/28/2013 9:20:52 AM) Message: The Query thread pool now has 1 minimum threads, 16 maximum threads, and a concurrency of 16.  Its thread pool affinity mask is 0x00000000000000ff. (Source: \\?\C:\Program Files\Microsoft SQL Server\MSAS11.MSSQLSERVER\OLAP\Log\msmdsrv.log, Type: 1, Category: 289, Event ID: 0x4121000A)"`  
  
 Помните, что алгоритм для установки параметра **MinThread** и **MaxThread** опирается на системную конфигурацию, в частности на число процессоров. Вычисление значения описывается в записи блога [Параметры конфигурации служб Analysis Services 2012 (блог Wordpress)](https://go.microsoft.com/fwlink/?LinkId=330387). Обратите внимание, что эти параметры и стратегии могут быть изменены в последующих выпусках.  
  
 В следующем списке показаны примеры других масок сходства для различных сочетаний процессоров:  
  
-   Соответствие для процессоров 3-2-1-0 в 8-ядерной системе в этой битовой маске: 00001111 и шестнадцатеричное значение: 0xF  
  
-   Соответствие для процессоров 7-6-5-4 в 8-ядерной системе в этой битовой маске: 11110000 и шестнадцатеричное значение: 0xF0  
  
-   Соответствие для процессоров 5-4-3-2 в 8-ядерной системе в этой битовой маске: 00111100 и шестнадцатеричное значение: 0x3C  
  
-   Соответствие для процессоров 7-6-1-0 в 8-ядерной системе в этой битовой маске: 11000011 и шестнадцатеричное значение: 0xC3  
  
 Помните, что в системах, имеющих несколько групп процессов, для каждой группы формируется отдельная маска сходства в виде списка с разделением запятыми.  
  
##  <a name="bkmk_msmdrsrvini"></a>О команде MSMDSRV. ССЫЛКИ  
 Файл msmdsrv.ini содержит параметры конфигурации для экземпляра [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] , влияющие на все базы данных, запущенные на данном экземпляре. Нельзя использовать свойства конфигурации сервера для оптимизации производительности только одной базы данных за счет других. Однако можно установить несколько экземпляров служб [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)] и настроить эти экземпляры на использование свойств, которые дадут выигрыш для баз данных, использующих одинаковые характеристики или рабочие нагрузки.  
  
 Все свойства конфигурации сервера содержатся в файле msmdsrv.ini. Подмножества этих свойств, которые изменяются чаще всего, доступны также в средствах управления, таких как среда SSMS.  
  
 Содержимое файла msmdsrv.ini одинаково как для многомерных, так и для табличных экземпляров [!INCLUDE[ssASnoversion](../../includes/ssasnoversion-md.md)]. Однако некоторые параметры применяются только в одном из этих режимов. Различия в поведении, зависящие от режима сервера, указаны в справочной документации свойства.  
  
> [!NOTE]  
>  Инструкции по заданию этих свойств см. в разделе [Configure Server Properties in Analysis Services](server-properties-in-analysis-services.md).  
  
## <a name="see-also"></a>См. также:  
 [О процессах и потоках](/windows/desktop/ProcThread/about-processes-and-threads)   
 [Несколько процессоров](/windows/desktop/ProcThread/multiple-processors)   
 [Группы процессоров](/windows/desktop/ProcThread/processor-groups)   
 [Analysis Services изменений пула потоков в SQL Server 2012](https://blogs.msdn.com/b/psssql/archive/2012/01/31/analysis-services-thread-pool-changes-in-sql-server-2012.aspx)   
 [Параметры конфигурации Analysis Services 2012 (блог WordPress)](https://go.microsoft.com/fwlink/?LinkId=330387)   
 [Поддержка систем с более чем 64 процессорами](https://msdn.microsoft.com/library/windows/hardware/gg463349.aspx)   
 [Руководство по работе с SQL Server 2008 R2 Analysis Services](https://go.microsoft.com/fwlink/?LinkID=225539)  
  
  
