---
title: Устранение неполадок SQL Server управляемое резервное копирование в Windows Azure | Документация Майкрософт
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: a34d35b0-48eb-4ed1-9f19-ea14754650da
author: mashamsft
ms.author: mathoma
manager: craigg
ms.openlocfilehash: fd68f6f8bcb83bfbc980be0809e12141403e4012
ms.sourcegitcommit: 2429fbcdb751211313bd655a4825ffb33354bda3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2018
ms.locfileid: "52522537"
---
# <a name="troubleshooting-sql-server-managed--backup-to-windows-azure"></a>Устранение неполадок управляемого резервного копирования SQL Server в Microsoft Azure
  В этом разделе описываются задачи и средства, позволяющие устранять ошибки, которые могут возникнуть при выполнении операций [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
## <a name="overview"></a>Обзор  
 В [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] есть встроенные проверки и процедуры устранения неполадок, поэтому во многих случаях внутренними сбоями занимается сам процесс [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
 Примером такого случая является удаление файла резервной копии, в результате разрыва журнала цепочку влияющего на возможность восстановления - [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] определит разрыв в цепочке журналов и запланировать резервное копирование, которые должны выполняться немедленно. Однако рекомендуется отслеживать состояние и устранять все ошибки, требующие вмешательства пользователя.  
  
 В журналы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] записываются события и ошибки с использованием системных хранимых процедур, системных представлений и расширенных событий. Системные представления и хранимые процедуры предоставляют данные конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], состояние запланированных операций резервного копирования, а также ошибки, зарегистрированные расширенными событиями. [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] использует расширенные события для регистрации событий и последующего устранения неполадок. Помимо регистрации событий политики SQL Server Smart Admin предоставляют состояние работоспособности, используемое заданием уведомления по электронной почте для отправки уведомлений об ошибках и проблемах. Дополнительные сведения см. в разделе [монитора SQL Server Managed Backup to Windows Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).  
  
 Службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] используют то же журналирование, что и при ручном создании резервных копий в хранилище Windows Azure (резервное копирование SQL Server на URL-адрес). Дополнительные сведения о резервном копировании на URL-адрес, соответствующие проблемы, см. раздел по устранению неполадок в [SQL Server Backup to URL Best Practices and Troubleshooting](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)  
  
### <a name="general-troubleshooting-steps"></a>Основные шаги диагностики  
  
1.  Включите уведомление по электронной почте, чтобы получать сообщения с ошибками и предупреждениями.  
  
     Кроме того, можно периодически выполнять `smart_admin.fn_get_health_status` для проверки статистических ошибок и счетчиков. Например, `number_of_invalid_credential_errors` указывает, сколько раз резервное копирование Smart Backup завершилось с ошибкой из-за неверных учетных данных. `Number_of_backup_loops` и `number_of_retention_loops` не являются ошибками, но указывают, сколько раз поток резервного копирования и поток хранения сканировали список баз данных. Как правило, когда @begin_time и @end_time еще не указан, функция отображает сведения за последние 30 минут, затем отображаться ненулевые значения для этих двух столбцов. Если они равны нулю, это означает, что система перегружена или даже не отвечает. Дополнительные сведения см. в разделе **проблемы системы диагностики** подразделе данного раздела.  
  
2.  Изучите журналы расширенных событий, чтобы получить дополнительные сведения об ошибках и связанных событиях.  
  
3.  Данные в журналах помогут устранить проблему.  В случае системной проблемы или ошибки, возможно, придется перезапустить службу или агент SQL Server.  
  
### <a name="common-causes-of-errors"></a>Распространенные причины появления ошибок  
 Далее представлен список распространенных причин, приводящих к сбоям.  
  
1.  **Изменение учетных данных SQL:** Если имя учетных данных, используемых [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], изменяется или удаляется, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не сможет создавать резервные копии. Изменение должно быть применено к параметрам конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
2.  **Изменения в значения ключей доступа хранилища.** Если значения ключей доступа к хранилищу для учетной записи Windows Azure меняются, а значения в учетных данных SQL не меняются на новые, то в [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] возникнет ошибка при проверке подлинности в хранилище и для баз данных, использующих эту учетную запись, не удастся создать резервные копии.  
  
3.  **Изменения в учетной записи хранения Azure для Windows.** Удаление или переименование учетной записи хранения без соответствующих изменений учетных данных SQL вызовет ошибку [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], а резервные копии не будут созданы. При удалении учетной записи хранения убедитесь, что в настройки баз данных будут внесены сведения о действительной учетной записи хранения. Если учетная запись хранения переименована или меняются значения ключей, убедитесь в том, что эти изменения отражены в учетных данных SQL, используемых [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
4.  **Изменение свойств базы данных:** Изменение моделей восстановления или имени может вызвать ошибки резервного копирования.  
  
5.  **Изменение модели восстановления:** Если модель восстановления базы данных меняется с простой на модель полного восстановления или восстановления с неполным протоколированием, резервное копирование прекратится, а [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] будет пропускать эти базы данных. Дополнительные сведения см. в разделе [SQL Server Managed Backup to Windows Azure: Взаимодействие и совместная работа](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-interoperability-and-coexistence.md)  
  
### <a name="most-common-error-messages-and-solutions"></a>Самые распространенные сообщения об ошибках и способы их устранения  
  
1.  **Ошибки при включении или настройке [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]:**  
  
     Ошибка. " Не удалось получить доступ к URL-АДРЕСУ хранилища... Укажите допустимые учетные данные SQL...»: Это и аналогичные сообщения об ошибке могут быть вызваны учетными данными SQL.  В таких случаях изучите имя предоставленных учетных данных SQL, а также сведений, хранящихся в учетных данных SQL — имя учетной записи хранения и ключ доступа к хранилищу и убедитесь, что они указаны допустимые.  
  
     Ошибка: «... не удается настроить базу данных... Поскольку это системная база данных»: Это сообщение отображается, если попытаться включить [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для системной базы данных.  [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не поддерживает резервные копии для системных баз данных.  Чтобы настроить резервное копирование для системных баз данных, используйте другие технологии резервного копирования SQL Server, например планы обслуживания.  
  
     Ошибка:»... Задайте срок хранения …»: Сообщения об ошибках, связанные со сроком хранения, могут отображаться, если вы не указали срок хранения базы данных или экземпляра при первоначальной настройке этих значений. Ошибка также может возникнуть в том случае, если указано значение, не входящее в диапазон от 1 до 30. Допустимые значения срока хранения — число от 1 до 30.  
  
2.  **Сообщения с уведомлениями по электронной почте**  
  
     Ошибка. «Компонент database Mail не включен...» — Это сообщение отображается, если включить уведомления по электронной почте, но на экземпляре компонента Database Mail не настроен. Необходимо настроить компонент Database Mail в экземпляре, чтобы получать уведомление о состоянии работоспособности [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]. Сведения о том, как включить компонент database mail, см. в разделе [настроить компонент Database Mail](../relational-databases/database-mail/configure-database-mail.md). Чтобы использовать Database Mail для уведомлений, также необходимо включить агент SQL Server. Дополнительные сведения см. в разделе [перед началом работы](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md#BeforeYouBegin).  
  
     Ниже приведен список кодов возможных ошибок, связанных с уведомлениями по электронной почте.  
  
    -   Номер ошибки: 45209  
  
    -   Номер ошибки: 45210  
  
    -   Номер ошибки: 45211  
  
3.  **Ошибки подключения:**  
  
    -   **Ошибки, связанные с подключениями SQL:** Эти ошибки возникают, когда есть проблемы при подключении к экземпляру SQL Server. Расширенные события предоставляют тип ошибок в канале администратора. Далее приведены два расширенных события, которые можно видеть в связи с возникновением ошибок подключения.  
  
         FileRetentionAdminXEvent with event_type = SqlError. Сведения о данной ошибке см. в параметрах error_code, error_message и stack_trace данного события. Значение error_code — это номер ошибки SqlException.  
  
         SmartBackupAdminXevent со следующими префиксами сообщения:  
  
         *«Произошла внутренняя ошибка при настройке SQL Server Managed Backup в Windows Azure параметры по умолчанию для экземпляра. Ошибка может быть временной.»*  
  
         *«Вероятные проблемы с подключением с SQL Server. «Пропуск базы данных в текущей итерации.»*  
  
         *«Запрос на получение сведений об использовании журнала не удалось. Сбой может быть временным. «Пропуск базы данных в текущей итерации.»*  
  
         *«Обнаружено SQL-исключение при загрузке метаданных агента SSMBackup2WA. Сбой может быть временным. Операция будет повторена.»*  
  
         *«Агент SSMBackup2WA обнаружил SQL-исключение при... "*  
  
    -   **Ошибки при подключении к учетной записи хранения:**  
  
         Исключения хранилища в событии FileRetentionAdminXEvent с event_type = XstoreError. Сведения о данной ошибке см. в параметрах error_message и stack_trace данного события.  
  
         В управляемом резервном копировании SQL Server используется нижележащий компонент «Резервное копирование на URL-адрес», поэтому ошибки, связанные с подключением к хранилищу, относятся к обоим компонентам. Дополнительные сведения о действия по устранению неполадок см. в разделе **разделе об устранении неполадок** из [SQL Server Backup to URL Best Practices and Troubleshooting](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md) статьи.  
  
### <a name="troubleshooting-system-issues"></a>Проблемы системы диагностики  
 Ниже приведены некоторые сценарии, описывающие проблему с системой (SQL Server, агент SQL Server) и ее влияние на [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
-   **Sqlservr.exe перестает отвечать на запросы или останавливает работу, когда [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] выполняется:** Если SQL Server прекращает работу, агент SQL Server выполняет правильное завершение работы, службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] также останавливаются, а события записываются в файл SQL Agent.out.  
  
     Если SQL Server прекращает отвечать, события записываются в канал администратора.  Пример журнала событий.  
  
     *Ошибка SQL (модуль не отвечает или возвращает sqlException: SqlException:*   
     *код ошибки, сообщение и трассировка стека будет отображаться в канале администратора xevent, вместе с некоторыми дополнительными сведениями, например:*   
    *«Вероятные проблемы с подключением с SQL Server. Пропуск базы данных в текущей итерации»*  
  
-   **Агент SQL перестает отвечать на запросы или останавливает работу, когда [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] выполняется:**  
  
     Если агент SQL Server прекращает работу, то службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] также останавливаются, а события записываются в канал администратора. Это аналогично сценариям, когда SQL Server прекращает отвечать.  
  
     Если агент SQL Server прекращает отвечать, то службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не смогут продолжать операции резервного копирования, а события будут записаны в канал администратора. Пример журнала событий.  
  
     *Зависания заданий: см. в разделе канал администратора xevents*   
    *«Обновления хода выполнения, которые не были получены от SQL Server в более чем "+ Constants.DBBackupInfoMsgMaxWaitTime + «ч для резервного копирования базы данных.   Резервное копирование SSM в облаке продолжит ожидание.»*  
  
 Если вы включили уведомления по электронной почте, вы получите уведомление, которое включает в себя **число циклов резервного копирования** и **количество циклов сохранения**. Если значения, возвращенные в уведомлении для одного или обоих этих столбцов, равны нулю, это может указывать на то, что система не отвечает.  
  
> [!WARNING]  
>  Внутренние процессы, которые формируют результаты для отчета, предполагают, что журналы диагностики ядра находятся в одном расположении с журналом ошибок агента SQL, который по умолчанию находится в той же папке, что и журналы ошибок экземпляра SQL Server. Если в журналах диагностики ядра перемещаются в каталог, который отличается от места хранения журнала ошибок агента SQL Server, то система не может найти журналы диагностики интеллектуального резервного копирования, что в свою очередь ведет к тому, что отчет, приведенный в отправляемом по электронной почте уведомлении, может быть неправильным. Например, может появиться значение **0** во всех полях отчета, включая количество циклов резервного копирования и количества циклов хранения. В этом случае, когда журналы диагностики перемещены в другое расположение, это может означать не то, что система не отвечает, а то, что система не может найти журналы. Прежде всего убедитесь в том, что журналы диагностики и журналы ошибок агента SQL Server находятся в одном расположении. Для проверки текущего расположения журналов диагностических данных, можно использовать [sys.dm_os_server_diagnostics_log_configurations](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-server-diagnostics-log-configurations). `path` Столбец возвращает текущее расположение подсистемы обработки журналов диагностики.  Это должен быть в той же папке, что и журналы ошибок агента SQL Server. Получить путь к журналам ошибок агента SQL Server можно с помощью хранимой процедуры `dbo.sp_get_sqlagent_properties`.  
  
 Проверьте журналы расширенных событий, чтобы просмотреть подробные сведения об ошибках. исправьте ошибки или перезапустите агент SQL Server, чтобы исправить ситуацию.  
  
  
