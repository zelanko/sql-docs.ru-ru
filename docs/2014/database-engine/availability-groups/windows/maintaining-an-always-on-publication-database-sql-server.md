---
title: Обслуживание базы данных публикации AlwaysOn (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], interoperability
- replication [SQL Server], AlwaysOn Availability Groups
ms.assetid: 55b345fe-2eb9-4b04-a900-63d858eec360
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: cfe3ca671dd333db50d232cd07dda86ffdd6d9fc
ms.sourcegitcommit: 9ee72c507ab447ac69014a7eea4e43523a0a3ec4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2020
ms.locfileid: "84936755"
---
# <a name="maintaining-an-alwayson-publication-database-sql-server"></a>Обслуживание базы данных публикации AlwaysOn (SQL Server)
  В этом разделе рассматриваются специальные рекомендации в отношении обслуживания базы данных публикации при использовании групп доступности AlwaysOn.  
  
 
  
##  <a name="maintaining-a-published-database-in-an-availability-group"></a><a name="MaintainPublDb"></a>Обслуживание опубликованной базы данных в группе доступности  
 Обслуживание опубликованной базы данных AlwaysOn существенно не отличается от обслуживания стандартной базы данных публикации со следующими оговорками.  
  
-   Администрирование выполняется на узле первичной реплики. В среде [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]публикации появляются в папке **Локальные публикации** для узла первичной реплики и для вторичных реплик, доступных для чтения. После отработки отказа может потребоваться обновление [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] вручную для отражения изменений, если вторичная реплика, ставшая первичной, была недоступна для чтения.  
  
-   Монитор репликации всегда отображает сведения публикации для первоначального издателя. Однако эти сведения можно просмотреть в мониторе репликации из любой реплики, добавив первоначального издателя в качестве сервера.  
  
-   Если для администрирования репликации на текущей первичной реплике используются хранимые процедуры или объекты RMO, то для случаев, когда указывается имя издателя, необходимо указать имя экземпляра, на котором база данных активирована для репликации (первоначальный издатель). Чтобы определить соответствующее имя, воспользуйтесь функцией `PUBLISHINGSERVERNAME`. Если публикуемая база данных присоединяется к группе доступности, метаданные репликации, хранимые в репликах базы данных-получателя, идентичны метаданным в первичной базе данных. Поэтому для баз данных публикации, активированных для репликации в первичной базе данных, имя экземпляра издателя, хранимое в системных таблицах во вторичной базе данных, является именем первичной, а не вторичной базы данных. Это отрицательно повлияет на настройку и обслуживание репликации, если в результате сбоя база данных публикации перейдет на вторичный сервер. Например, если вы настраиваете репликацию с хранимыми процедурами на вторичном этапе после отработки отказа и хотите получить подписку по запросу на базу данных публикации, которая была включена на другой реплике, необходимо указать имя исходного издателя вместо текущего издателя в качестве *@publisher* параметра `sp_addpullsubscription` или `sp_addmergepulllsubscription` . Тем не менее, если база данных публикации после отработки отказа включена, именем экземпляра издателя, которое хранится в системных таблицах, является имя текущего первичного узла. В этом случае для параметра будет использоваться имя узла текущей первичной реплики *@publisher* .  
  
    > [!NOTE]  
    >  Для некоторых процедур, таких как `sp_addpublication` , *@publisher* параметр поддерживается только для издателей, которые не являются экземплярами [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . в таких случаях это не относится к [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] AlwaysOn.  
  
-   Для синхронизации подписки в среде [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] после отработки отказа необходимо синхронизировать подписки по запросу от подписчика и синхронизировать принудительные подписки от активного издателя.  
  
##  <a name="removing-a-published-database-from-an-availability-group"></a><a name="RemovePublDb"></a> Удаление опубликованной базы данных из группы доступности  
 При удалении опубликованной базы данных из группы доступности или удалении группы доступности, содержащей опубликованную базу данных, необходимо учитывать следующее.  
  
-   Если база данных публикации на исходном издателе удаляется из первичной реплики группы доступности, необходимо запустить `sp_redirect_publisher` без указания значения для параметра, *@redirected_publisher* чтобы удалить перенаправление для пары "издатель — база данных".  
  
    ```  
    EXEC sys.sp_redirect_publisher   
        @original_publisher = 'MyPublisher',  
        @published_database = 'MyPublishedDB';  
    ```  
  
     База данных останется в состоянии восстановления по журналу на первичном сервере и должна быть восстановлена. После этого репликация должна работать без изменений для первоначального издателя.  
  
-   Если база данных публикации переходит после отказа с первоначального издателя на реплику и база данных удаляется из первичной реплики группы доступности, воспользуйтесь хранимой процедурой `sp_redirect_publisher` для явного перенаправления первоначального издателя к новому издателю. База данных останется в состоянии восстановления по журналу и подлежит восстановлению. После этого репликация должна продолжить работу так же, как это было в группе доступности.  
  
    ```  
    EXEC sys.sp_redirect_publisher   
        @original_publisher = 'MyPublisher',  
        @published_database = 'MyPublishedDB',  
        @redirected_publisher = 'MyNewPublisher';  
    ```  
  
     Не удаляйте удаленный сервер первоначального издателя из распространителя, даже если уже нет доступа к серверу. Метаданные сервера первоначального издателя нужны распространителю для обработки запросов к метаданным публикации.  
  
-   Если удаляется вся группа доступности, поведение в отношении реплицированной базы данных-члена остается таким же, как и при удалении опубликованной базы данных из группы доступности. Репликацию можно возобновить с последнего первичного сервера, как только база данных будет восстановлена, а перенаправление изменено. Если база данных восстанавливается для первоначального издателя, перенаправление должно быть удалено. Если база данных восстанавливается на другой узел, необходимо явным образом осуществить перенаправление на новый узел.  
  
    > [!NOTE]  
    >  Если удаляется группа доступности, содержащая опубликованные базы данных, или если опубликованная база данных удаляется из группы доступности, все копии опубликованных баз данных остаются в состоянии восстановления. После восстановления каждая база данных становится опубликованной. Только одна копия может быть сохранена с метаданными публикации. Чтобы отключить репликацию для копии опубликованной базы данных, сначала удалите все подписки и публикации из базы данных.  
  
     Выполните `sp_dropsubscription`, чтобы удалить подписки на публикацию. Убедитесь, что для параметра задано значение *@ignore_distributributor* 1, чтобы сохранить метаданные для активной базы данных публикации на распространителе.  
  
    ```  
    USE MyDBName;  
    GO  
  
    EXEC sys.sp_dropsubscription   
        @subscriber = 'MySubscriber',  
        @publication = 'MyPublication',  
        @article = 'all',  
        @ignore_distributor = 1;  
    ```  
  
     Выполните `sp_droppublication`, чтобы удалить все публикации. Опять же, присвойте параметру значение *@ignore_distributor* 1, чтобы сохранить метаданные для активной базы данных публикации на распространителе.  
  
    ```  
    EXEC sys.sp_droppublication   
        @publication = 'MyPublication',  
        @ignore_distributor = 1;  
    ```  
  
     Выполните `sp_replicationdboption`, чтобы отключить репликацию для базы данных.  
  
    ```  
    EXEC sys.sp_replicationdboption  
        @dbname = 'MyDBName',  
        @optname = 'publish',  
        @value = 'false';  
    ```  
  
     На этом этапе копию опубликованной базы данных можно сохранить или удалить.  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
  
-   [Настройка репликации для групп доступности AlwaysOn (SQL Server)](always-on-availability-groups-sql-server.md)  
  
-   [Репликация, Отслеживание изменений, система отслеживания измененных данных и группы доступности AlwaysOn &#40;SQL Server&#41;](replicate-track-change-data-capture-always-on-availability.md)  
  
-   [Вопросы и ответы об администрировании репликации](../../../relational-databases/replication/administration/frequently-asked-questions-for-replication-administrators.md)  
  
-   [Подписчики репликации и группы доступности AlwaysOn &#40;SQL Server&#41;](replication-subscribers-and-always-on-availability-groups-sql-server.md)  
  
## <a name="see-also"></a>См. также:  
 [Предварительные требования, ограничения и рекомендации для группы доступности AlwaysOn &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md)   
 [Общие сведения о группы доступности AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md)   
 [Группы доступности AlwaysOn: взаимодействие (SQL Server)](always-on-availability-groups-interoperability-sql-server.md)   
 [Репликация SQL Server](../../../relational-databases/replication/sql-server-replication.md)  
  
  
