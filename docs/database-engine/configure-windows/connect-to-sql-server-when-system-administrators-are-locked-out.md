---
title: Подключение к SQL Server в случае, если доступ системных администраторов заблокирован | Документация Майкрософт
description: Узнайте, как восстановить доступ к SQL Server в качестве системного администратора, если доступ был заблокирован по ошибке.
ms.custom: contperfq4
ms.date: 05/20/2020
ms.prod: sql
ms.prod_service: high-availability
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- sa account
- connecting when locked out [SQL Server]
- locked out [SQL Server]
ms.assetid: c0c0082e-b867-480f-a54b-79f2a94ceb67
author: markingmyname
ms.author: maghan
ms.openlocfilehash: 801602c78193f9fc3fa9cdab40b98c3dc3dd42e0
ms.sourcegitcommit: 291ae8f6b72fd355f8f24ce5300339306293ea7e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2020
ms.locfileid: "88512320"
---
# <a name="connect-to-sql-server-when-system-administrators-are-locked-out"></a>Подключение к SQL Server в случае, если доступ системных администраторов заблокирован 
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
  
В этой статье описывается, как восстановить доступ к [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] в качестве системного администратора, если доступ был заблокирован.  Системный администратор может утратить доступ к экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] по одной из следующих причин:  
  
-   по ошибке удалены все члены предопределенной роли сервера sysadmin;  
  
-   по ошибке удалены все группы Windows, которые являлись членами предопределенной роли сервера sysadmin;  
  
-   имена входа, являющиеся членами предопределенной роли сервера sysadmin, принадлежат лицам, которые покинули компанию или недоступны;  
  
-   учетная запись sa отключена, или никто не знает ее пароля.  
  
## <a name="resolution"></a>Решение

Чтобы устранить проблему доступа, рекомендуется запустить экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в однопользовательском режиме. Этот режим не позволит устанавливать другие подключений при попытке восстановить доступ. Вы можете подключиться к экземпляру SQL Server и добавить имя входа в роль сервера **sysadmin**. Подробные инструкции по решению этой проблемы приведены в [этом разделе](#step-by-step-instructions).


Можно запустить экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в однопользовательском режиме с параметрами `-m` или `-f` из командной строки. Затем любой член локальной группы администраторов на компьютере может подключиться к экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в качестве члена предопределенной роли сервера **sysadmin**.  

При запуске экземпляра в однопользовательском режиме сначала нужно остановить службу "Агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]". В противном случае агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] может установить соединение первым, заняв единственное доступное подключение к серверу и заблокировав возможность входа.

Кроме того, неизвестное клиентское приложение может воспользоваться единственным доступным подключением, прежде чем вы сможете выполнить вход. Чтобы исключить возникновение этой ситуации, используйте параметр `-m`, за которым следует имя приложения, что позволит ограничить подключения одним подключением из определенного приложения. Например, запуск [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] с помощью `-mSQLCMD` разрешает только одно соединение, которое должно идентифицироваться как клиентская программа **sqlcmd**. Для подключения через редактор запросов в [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] используйте `-m"Microsoft SQL Server Management Studio - Query"`.  


> [!IMPORTANT]  
> Не используйте `-m` с именем приложения в качестве средства безопасности. Клиентские приложения предоставляют имя приложения в параметрах строки подключения и могут легко указать ложное имя.

В следующей таблице приведены различные способы запуска экземпляра в однопользовательском режиме в командной строке.

| Параметр | Описание | Назначение |
|:---|:---|:---|
|`-m` | Ограничение подключений одним подключением | Если другие пользователи не пытаются подключиться к экземпляру или вы не знаете имя приложения, которое используется для подключения к экземпляру. |
|`-mSQLCMD`| Разрешает только одно соединение, которое должно идентифицироваться как клиентская программа **sqlcmd**.| Если вы планируете подключиться к экземпляру с помощью **sqlcmd** и хотите запретить другим приложениям использовать единственное доступное подключение. |
|`-m"Microsoft SQL Server Management Studio - Query"`| Разрешает только одно соединение, которое должно идентифицироваться как приложение **Microsoft SQL Server приложении Management Studio — Query**.| Если вы планируете подключиться к экземпляру с помощью редактора запросов в [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] и хотите запретить другим приложениям использовать единственное доступное подключение. |
|`-f`| Разрешает только одно соединение и запускает экземпляр в минимальной конфигурации. | Когда запуску препятствует какая-либо другая конфигурация. |
| &nbsp; | &nbsp; | &nbsp; |
  
Пошаговые инструкции по запуску [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в однопользовательском режиме см. в статье [Запуск SQL Server в однопользовательском режиме](../../database-engine/configure-windows/start-sql-server-in-single-user-mode.md).

## <a name="step-by-step-instructions"></a>Пошаговые инструкции

Далее приводятся пошаговые инструкции по предоставлению системному администратору, доступ которого было по ошибке заблокирован, разрешений для входа в SQL Server.

Предварительные требования

* [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] запущен в Windows 8 или более поздней версии. Небольшие изменения для предыдущих версий SQL Server или Windows приведены там, где применимо.

* На компьютере установлена среда [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].  

Следуйте этим инструкциям, выполнив вход в систему Windows в качестве члена локальной группы администраторов.

1.  В меню "Пуск" Windows правой кнопкой мыши щелкните значок диспетчера конфигурации [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и выберите пункт **Запуск от имени администратора**, чтобы передать учетные данные администратора в диспетчер конфигурации.  
  
2.  На левой панели диспетчера конфигурации [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выберите **Службы SQL Server**. На панели справа найдите свой экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. (Экземпляр по умолчанию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] включает **(MSSQLSERVER)** после имени компьютера. Именованные экземпляры появляются в верхнем регистре с тем же названием, что и в списке «зарегистрированные серверы»). Щелкните правой кнопкой мыши экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], а затем выберите пункт **Свойства**.  
  
3.  На вкладке **Параметры запуска** в поле **Укажите параметр запуска** введите параметр `-m` и нажмите кнопку **Добавить**. (Это дефис, затем буква «m» в нижнем регистре.)  
  
    > [!NOTE]  
    >  В некоторых предыдущих версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] нет вкладки **Параметры запуска** . В этом случае на вкладке **Дополнительно** дважды щелкните **Параметры запуска**. Параметры открываются в очень маленьком окне. Не изменяйте существующие параметры. В самом конце добавьте новый параметр `;-m` и нажмите кнопку **ОК**. (Это точка с запятой, затем дефис, затем буква «m» в нижнем регистре.)  
  
4.  Нажмите кнопку **ОК**, а после сообщения о перезагрузке щелкните правой кнопкой мыши имя сервера и выберите пункт **Перезапустить**.  
  
5.  После перезагрузки [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ваш сервер находится в однопользовательском режиме. Убедитесь, что агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не выполняется. Если он был запущен, то он займет ваше единственное соединение.  
  
6.  В меню "Пуск" Windows щелкните правой кнопкой мыши значок [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] и выберите пункт **Запуск от имени администратора**. Учетные данные администратора будут переданы в SSMS.
  
    > [!NOTE]  
    >  В более ранних версиях Windows параметр **Запуск от имени администратора** появляется в виде подменю.  
  
     В некоторых конфигурациях SSMS попытается установить несколько подключений. Многочисленные соединения приведут к ошибке, поскольку [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] находится в однопользовательском режиме. Выполните одно из следующих действий, соответствующее вашему сценарию.  
  
    1.  Подключитесь с помощью обозревателя объектов, используя проверку подлинности Windows (которая включает учетные данные администратора). Разверните **Безопасность**, затем **Имена входа**и дважды щелкните имя входа. На странице **Роли сервера** выберите **sysadmin**и нажмите **ОК**.  
  
    2.  Вместо соединения с помощью обозревателя объектов подключитесь с помощью окна запросов, используя проверку подлинности Windows (которая включает учетные данные администратора). (Подключиться подобным образом можно только в том случае, если подключение не выполнено с помощью обозревателя объектов.) Выполните следующий код, чтобы добавить новое имя входа для проверки подлинности Windows, которое является членом предопределенной роли сервера **sysadmin** . В следующем примере создается пользователь с именем `CONTOSO\PatK`.  
  
        ```  
        CREATE LOGIN [CONTOSO\PatK] FROM WINDOWS;  
        ALTER SERVER ROLE sysadmin ADD MEMBER [CONTOSO\PatK];  
        ```  
  
    3.  Если экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] работает в режиме смешанной проверки подлинности, подключитесь к окну запросов при помощи проверки подлинности Windows (которая включает учетные данные администратора). Выполните следующий код, чтобы создать новое имя входа для проверки подлинности в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], которое является членом предопределенной роли сервера **sysadmin**.  
  
        ```  
        CREATE LOGIN TempLogin WITH PASSWORD = '************';  
        ALTER SERVER ROLE sysadmin ADD MEMBER TempLogin;  
        ```  
  
        > [!WARNING]  
        >  Замените ************ надежным паролем.  
  
    4.  Если экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] работает в режиме смешанной проверки подлинности и требуется изменить пароль для учетной записи **sa** , подключитесь к окну запросов с использованием проверки подлинности Windows (которая включает учетные данные администратора). Измените пароль учетной записи **sa** с помощью следующей команды.  
  
        ```  
        ALTER LOGIN sa WITH PASSWORD = '************';  
        ```  
  
        > [!WARNING]  
        >  Замените ************ надежным паролем.  

7. Закройте среду [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)].  
  
8. Следующие действия позволят переключить SQL Server в многопользовательский режим. На левой панели диспетчера конфигурации [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выберите **Службы SQL Server**.

9. На правой панели щелкните экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]правой кнопкой мыши и выберите пункт **Свойства**.  
  
10. На вкладке **Параметры запуска** в поле **Существующие параметры** выберите `-m` и нажмите кнопку **Удалить**.  
  
    > [!NOTE]  
    >  В некоторых предыдущих версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] нет вкладки **Параметры запуска** . В этом случае на вкладке **Дополнительно** дважды щелкните **Параметры запуска**. Параметры открываются в очень маленьком окне. Удалите `;-m` , добавленный ранее, и нажмите **ОК**.  
  
11. Щелкните правой кнопкой мыши имя сервера и выберите пункт **Перезапустить**. Не забудьте запустить агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] еще раз, если он был остановлен перед запуском [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в однопользовательском режиме.
  
Теперь можно подключиться к одной из учетных записей, которая является членом предопределенной роли сервера **sysadmin** .  
  
## <a name="see-also"></a>См. также:  

* [Настройка параметров запуска сервера](../../database-engine/configure-windows/scm-services-configure-server-startup-options.md)
* [Параметры запуска службы Database Engine](../../database-engine/configure-windows/database-engine-service-startup-options.md)  
