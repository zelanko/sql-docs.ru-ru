---
title: Включение зашифрованных соединений | Документация Майкрософт
ms.custom: contperfq4
ms.date: 08/29/2019
ms.prod: sql
ms.prod_service: security
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
description: Шифрование данных, передаваемых по коммуникационным каналам. Включение зашифрованных соединений для экземпляра ядра СУБД SQL Server с помощью диспетчера конфигурации SQL Server.
helpviewer_keywords:
- connections [SQL Server], encrypted
- SSL [SQL Server]
- Secure Sockets Layer (SSL)
- TLS [SQL Server]
- Transport Layer Security (TLS)
- encryption [SQL Server], connections
- cryptography [SQL Server], connections
- certificates [SQL Server], installing
- requesting encrypted connections
- installing certificates
- security [SQL Server], encryption
- TLS certificates
ms.assetid: e1e55519-97ec-4404-81ef-881da3b42006
author: VanMSFT
ms.author: vanto
ms.openlocfilehash: d147177be88db5bba50955711a8585ff11d872d9
ms.sourcegitcommit: 2f868a77903c1f1c4cecf4ea1c181deee12d5b15
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/02/2020
ms.locfileid: "91670977"
---
# <a name="enable-encrypted-connections-to-the-database-engine"></a>Включение зашифрованных соединений для ядра СУБД

 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

  Сведения о том, как включить шифрование данных, передаваемых по коммуникационным каналам.  Вы включаете зашифрованные соединения для экземпляра [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] и затем с помощью диспетчера конфигурации [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] указываете сертификат.
 
 Для компьютера сервера должен быть подготовлен сертификат. Чтобы подготовить сертификат на сервере, его необходимо [импортировать в Windows](#single-server). Для клиентского компьютера необходимо настроить [доверие корневому центру сертификата](#about).  
  
> [!IMPORTANT]
> Начиная с [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] протокол SSL больше не поддерживается. Используйте вместо него протокол TLS.

## <a name="transport-layer-security-tls"></a>Протокол TLS

[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] может использовать протокол TLS для шифрования данных, передаваемых по сети между экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и клиентским приложением. Шифрование TLS выполняется на уровне протокола и доступно всем поддерживаемым клиентам [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].

Протокол TLS можно использовать для проверки сервера, если для соединения клиента требуется шифрование. Если экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] запущен на компьютере, которому выдан сертификат общего центра сертификации, то идентификатор компьютера и экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] подтверждается цепочкой сертификатов, ведущей к доверенному корневому центру сертификации. Для выполнения такой проверки необходимо, чтобы компьютер, на котором запущено клиентское приложение, был настроен для доверия корневому центру сертификации, который использует сервер. 

Допускается шифрование с использованием самозаверяющих сертификатов (см. следующий раздел), однако такие сертификаты обеспечивают ограниченную защиту.
Уровень шифрования, который используется протоколом TLS (40- или 128-разрядное), зависит от версии операционной системы Microsoft Windows, установленной на компьютерах клиента и базы данных.

> [!WARNING]
> Использование 40-разрядного шифрования считается небезопасным.

> [!WARNING]
> Соединения TLS, зашифрованные с помощью самозаверяющего сертификата, не обеспечивают надежную защиту. Они уязвимы для атак "злоумышленник в середине". Не следует надеяться на защиту TLS с самозаверяющими сертификатами в рабочей среде или на серверах, подключенных к Интернету.

Шифрование TLS повышает защищенность обмена данными по сети между экземплярами [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и приложениями. Однако если между [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и клиентским приложением с помощью TLS шифруется весь трафик, то требуется указанная ниже дополнительная обработка.
-  Во время подключения требуется дополнительный цикл обращений по сети.
-  Пакеты, передаваемые от приложения экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], должны шифроваться клиентским стеком TLS и расшифровываться серверным стеком TLS.
-  Пакеты, передаваемые от экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] приложению, должны шифроваться серверным стеком TLS и расшифровываться клиентским стеком TLS.

## <a name="about-certificates"></a><a name="about"></a> Сведения о сертификатах

 Сертификат должен быть включен для **проверки подлинности сервера**. Имя сертификата должно быть полным доменным именем (FQDN) компьютера.  
  
 Сертификаты хранятся локально на пользовательских компьютерах. Чтобы установить сертификат для использования в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], необходимо запустить [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Configuration Manager с помощью учетной записи, обладающей правами локального администратора.

 Клиент должен уметь проверить принадлежность сертификата, используемого сервером. Если у клиента есть сертификат открытого ключа центра сертификации, который подписал сертификат сервера, то дальнейшее конфигурирование не требуется. [!INCLUDE[msCoName](../../includes/msconame-md.md)] Windows включает сертификаты открытого ключа нескольких центров сертификации. Если сертификат сервера был подписан общедоступным или частным центром сертификации, для которого у клиента нет сертификата открытого ключа, необходимо установить сертификат открытого ключа того центра сертификации, который подписал сертификат сервера.  
  
> [!NOTE]  
> Чтобы использовать шифрование в отказоустойчивом кластере, необходимо установить сертификат сервера с полным именем DNS виртуального сервера на все узлы отказоустойчивого кластера. Например, для кластера, имеющего два узла с именами ***test1.\*\<your company>\*.com*** и ***test2.\*\<your company>\*.com***, и виртуального сервера ***virtsql*** необходимо установить сертификат для ***virtsql.\*\<your company>\*.com*** на оба узла. Для параметра **ForceEncryption** в поле свойства **Протоколы для virtsql** в окне **Сетевая конфигурация SQL Server** можно выбрать значение **Да**.

> [!NOTE]
> При создании зашифрованного подключения для индексатора Поиска Azure к [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в виртуальной машине Azure см. раздел [Настройка подключения индексатора Поиска Azure к SQL Server в виртуальной машине Azure](/azure/search/search-howto-connecting-azure-sql-iaas-to-azure-search-using-indexers). 

## <a name="certificate-requirements"></a>Требования к сертификатам

Для загрузки TLS-сертификата в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] сертификат должен удовлетворять указанным ниже условиям.

- Сертификат должен находиться в хранилище сертификатов локального компьютера или текущего пользователя.

- Учетная запись службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] должна иметь соответствующее разрешение на доступ к TLS-сертификату.

- Текущее системное время должно превышать значение свойства сертификата **Действителен с** и не превышать значение свойства **Действителен до**.

- Сертификат должен быть предназначен для проверки подлинности сервера. Для этого требуется задать свойству сертификата **Улучшенный ключ** значение **Проверка подлинности сервера (1.3.6.1.5.5.7.3.1)** .

- Сертификат должен быть создан с помощью параметра **KeySpec** свойства **AT_KEYEXCHANGE**. Обычно в свойстве применения ключа сертификата (**KEY_USAGE**) также предусмотрено шифрование ключа (**CERT_KEY_ENCIPHERMENT_KEY_USAGE**).

- Свойство **Субъект** сертификата должно указывать, что общее имя (CN) совпадает с именем узла или полным доменным именем (FQDN) сервера. При использовании имени узла в сертификате должен быть указан DNS-суффикс. Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняется в отказоустойчивом кластере, то общее имя должно совпадать с именем узла или полным доменным именем виртуального сервера, а сертификаты должны быть подготовлены во всех узлах отказоустойчивого кластера.

- [!INCLUDE[ssKilimanjaro](../../includes/ssKilimanjaro-md.md)] и [!INCLUDE[ssKilimanjaro](../../includes/ssKilimanjaro-md.md)] Native Client поддерживают групповые сертификаты. Интерфейс SNAC устарел и был заменен [Microsoft OLE DB Driver for SQL Server](../../connect/oledb/oledb-driver-for-sql-server.md) и [Microsoft ODBC Driver for SQL Server](../../connect/odbc/microsoft-odbc-driver-for-sql-server.md). Другие клиенты могут их не поддерживать. Дополнительные сведения см. в документации клиента и статье базы знаний [KB 258858](https://support.microsoft.com/kb/258858).       
  Групповые сертификаты невозможно выбрать с помощью диспетчера конфигурации SQL Server. Чтобы использовать групповой сертификат, нужно изменить раздел реестра `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQLServer\SuperSocketNetLib` и ввести отпечаток сертификата без пробелов в качестве значения **Сертификат**.  

  > [!WARNING]  
  > [!INCLUDE[ssnoteregistry_md](../../includes/ssnoteregistry-md.md)]  

## <a name="install-on-single-server"></a><a name="single-server"></a>Установка на одном сервере.

В [!INCLUDE[sql-server-2019](../../includes/sssqlv15-md.md)] управление сертификатами интегрировано в диспетчер конфигурации SQL Server. Диспетчер конфигурации SQL Server для [!INCLUDE[sql-server-2019](../../includes/sssqlv15-md.md)] можно использовать с более ранними версиями [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Сведения о добавлении сертификата в одном экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] см. в статье [Управление сертификатами (диспетчер конфигурации SQL Server)](../../database-engine/configure-windows/manage-certificates.md).

Если вы используете версию от [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] до [!INCLUDE[ssSQL17](../../includes/sssql17-md.md)] и диспетчер конфигурации SQL Server для [!INCLUDE[sql-server-2019](../../includes/sssqlv15-md.md)] недоступен, выполните указанные ниже действия.

1. В меню **Пуск** выберите команду **Выполнить**, в окне **Открыть** введите **MMC** и нажмите кнопку **ОК**.  
  
2. В консоли MMC в меню **Файл** выберите **Добавить или удалить оснастку**.  
  
3. В диалоговом окне **Добавление или удаление оснастки** нажмите кнопку **Добавить**.  
  
4. В диалоговом окне **Добавление изолированной оснастки** выберите **Сертификаты**и нажмите кнопку **Добавить**.  
  
5. В диалоговом окне **Оснастка диспетчера сертификатов** выберите **Учетная запись компьютера**и нажмите кнопку **Готово**.  
  
6. В диалоговом окне **Добавить изолированную оснастку** нажмите кнопку **Закрыть**.  
  
7. В диалоговом окне **Добавление или удаление оснастки** нажмите кнопку **ОК**.  
  
8. В оснастке **Сертификаты** последовательно разверните узлы **Сертификаты**и **Личное**, а затем правой кнопкой мыши щелкните **Сертификаты**, выберите **Все задачи**и нажмите кнопку **Импорт**.  

9. Щелкните правой кнопкой мыши импортированный сертификат, выберите пункт **Все задачи**, а затем нажмите кнопку **Управление закрытыми ключами**. В диалоговом окне **Безопасность** добавьте разрешение на чтение для учетной записи пользователя, используемой учетной записью службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
10. Чтобы добавить сертификат на компьютер, выполните **Мастер импорта сертификатов**и закройте консоль MMC. Дополнительные сведения о добавлении сертификатов на компьютер см. в документации по Windows.  

> [!IMPORTANT]
> В рабочей среде рекомендуется получить доверенный сертификат из центра сертификации.    
> В целях тестирования можно использовать самозаверяющие сертификаты. Чтобы создать самозаверяющий сертификат, см. раздел о [командлете Powershell New-SelfSignedCertificate](/powershell/module/pkiclient/new-selfsignedcertificate) или [команде certreq](/windows-server/administration/windows-commands/certreq_1).
  
## <a name="install-across-multiple-servers"></a>Установка на нескольких серверах

В [!INCLUDE[sql-server-2019](../../includes/sssqlv15-md.md)] управление сертификатами интегрировано в диспетчер конфигурации SQL Server. Диспетчер конфигурации SQL Server для [!INCLUDE[sql-server-2019](../../includes/sssqlv15-md.md)] можно использовать с более ранними версиями [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Сведения о добавлении сертификата в конфигурации отказоустойчивого кластера или группы доступности см. в статье [Управление сертификатами (диспетчер конфигурации SQL Server)](../../database-engine/configure-windows/manage-certificates.md).

Если вы используете версию от [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] до [!INCLUDE[ssSQL17](../../includes/sssql17-md.md)] и диспетчер конфигурации SQL Server для [!INCLUDE[sql-server-2019](../../includes/sssqlv15-md.md)] недоступен, выполните действия, описанные в разделе [Подготовка (установка) сертификата на одном сервере](#single-server), для каждого сервера.

## <a name="export-server-certificate"></a>Экспорт сертификата сервера  
  
1. В оснастке **Сертификаты** найдите сертификат в папке **Сертификаты** / **Личное** , правой кнопкой мыши щелкните **Сертификат**, выберите **Все задачи**и нажмите **Экспорт**.  
  
2. Чтобы сохранить файл сертификата в удобном расположении, выполните **мастер экспорта сертификатов**.  
  
## <a name="configure-server"></a>Настройка сервера

Настройте принудительное использование зашифрованных соединений на сервере.

> [!IMPORTANT]
> Учетная запись службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] должна иметь разрешения на чтение для сертификата принудительного шифрования в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Для непривилегированной учетной записи службы разрешения на чтение необходимо добавить в сертификат. Несоблюдение этого требования может привести к сбою перезапуска службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].
  
1. В окне **Диспетчер конфигурации SQL Server** разверните узел **Сетевая конфигурация SQL Server**, щелкните правой кнопкой мыши элемент **Протоколы для** _\<server instance>_ , затем выберите пункт **Свойства**.  
  
2. В диалоговом окне **Протоколы для** _\<instance name>_ окна **Свойства** на вкладке **Сертификат** выберите необходимый сертификат из раскрывающегося списка **Сертификат** и нажмите кнопку **ОК**.  
  
3. На вкладке **Флаги** в поле **ForceEncryption** выберите **Да**, затем нажмите кнопку **ОК** , чтобы закрыть диалоговое окно.  
  
4. Перезапустите службу [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .  

> [!NOTE]
> Чтобы обеспечить безопасный обмен данными между клиентом и сервером, настройте клиент так, чтобы он запрашивал зашифрованные соединения. Дополнительные сведения приводятся [далее в этой статье](#configure-client).

## <a name="configure-client"></a><a name="configure-client"></a>Настройка клиента

Настройте клиент для запроса зашифрованных соединений.

1. Скопируйте на компьютер клиента исходный сертификат или экспортированный файл сертификата.  
  
2. Чтобы установить корневой сертификат или экспортированный файл сертификата на клиентском компьютере, используйте оснастку **Сертификаты** .  
  
3. В диспетчере конфигурации SQL Server щелкните правой кнопкой мыши узел **Конфигурация SQL Server Native Client** и выберите пункт **Свойства**.  
  
4. На странице **Флаги** в диалоговом окне **Принудительное шифрование протокола** выберите **Да**.  
  
## <a name="use-sql-server-management-studio"></a>Использование среды SQL Server Management Studio
  
Чтобы зашифровать подключение из [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]:  

1. На панели инструментов обозревателя объектов нажмите кнопку **Соединить**и выберите **Компонент Database Engine**.  
  
2. В диалоговом окне **Соединение с сервером** введите все данные, необходимые для подключения, а затем нажмите **Параметры**.  
  
3. На вкладке **Свойства соединения** щелкните **Шифровать соединение**.  

## <a name="internet-protocol-security-ipsec"></a>Протокол IPSec
Данные [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] можно шифровать во время передачи с помощью протокола IPSec. Протокол IPSec поддерживается операционными системами клиента и сервера. Дополнительная настройка [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не требуется. Дополнительные сведения о протоколе IPSec см. в документации по Windows или сетевым протоколам.

## <a name="next-steps"></a>Дальнейшие действия

+ [Поддержка TLS 1.2 для Microsoft SQL Server](https://support.microsoft.com/kb/3135244)     
+ [Настройка брандмауэра Windows для разрешения доступа к SQL Server](../../sql-server/install/configure-the-windows-firewall-to-allow-sql-server-access.md)     
+ [Командлет Powershell New-SelfSignedCertificate](/powershell/module/pkiclient/new-selfsignedcertificate)