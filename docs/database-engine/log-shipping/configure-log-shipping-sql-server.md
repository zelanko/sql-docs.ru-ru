---
title: Настройка доставки журналов (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], enabling
- log shipping [SQL Server], configuring
ms.assetid: c42aa04a-4945-4417-b4c7-50589d727e9c
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 4a262ba4daf1a54e4a57a71baa0b97308d473720
ms.sourcegitcommit: 58158eda0aa0d7f87f9d958ae349a14c0ba8a209
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2020
ms.locfileid: "68057889"
---
# <a name="configure-log-shipping-sql-server"></a>Настройка доставки журналов (SQL Server)
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]
  В данном разделе описывается настройка доставки журналов в [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] с помощью среды [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] или [!INCLUDE[tsql](../../includes/tsql-md.md)].  
  
> [!NOTE]  
>  [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)] и более поздние версии поддерживают сжатие резервных копий. При создании конфигурации доставки журналов можно управлять поведением сжатия резервных копий журналов. Дополнительные сведения см. в разделе [Сжатие резервных копий (SQL Server)](../../relational-databases/backup-restore/backup-compression-sql-server.md).  
  
 **В этом разделе**  
  
-   **Перед началом работы**  
  
     [Предварительные требования](#Prerequisites)  
  
     [Безопасность](#Security)  
  
-   **Настройка доставки журналов с помощью:**  
  
     [Среда SQL Server Management Studio](#SSMSProcedure)  
  
     [Transact-SQL](#TsqlProcedure)  
  
-   [Связанные задачи](#RelatedTasks)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> Предварительные требования  
  
-   База данных-источник должна использовать модель полного восстановления или восстановления с неполным протоколированием; переключение базы данных на использование модели простого восстановления приведет к прекращению доставки журналов.  
  
-   Перед настройкой доставки журналов необходимо создать общую папку, чтобы сделать резервные копии журнала транзакций доступными серверу-получателю. Именно в каталоге с открытым доступом будут формироваться резервные копии журналов транзакций. Например, если создание резервных копий журналов транзакций производится в каталог "c:\data\tlogs\\", то для открытого доступа к этому каталогу можно создать каталог " \\\\*primaryserver*\tlogs".  
  
###  <a name="security"></a><a name="Security"></a> безопасность  
  
####  <a name="permissions"></a><a name="Permissions"></a> Permissions  
 Для вызова хранимых процедур доставки журналов необходимо членство в предопределенной роли сервера **sysadmin** .  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> Использование среды SQL Server Management Studio  
  
#### <a name="to-configure-log-shipping"></a>Настройка доставки журналов  
  
1.  Щелкните правой кнопкой мыши имя базы данных, которая станет базой данных-источником в конфигурации доставки журналов, затем выберите пункт **Свойства**.  
  
2.  В области **Выбор страницы**щелкните **Доставка журналов транзакций**.  
  
3.  Установите флажок **Включить эту базу данных в качестве источника в конфигурацию доставки журналов** .  
  
4.  В разделе **Резервные копии журналов транзакций**нажмите кнопку **Параметры копирования**.  
  
5.  В поле **Сетевой путь к папке резервного копирования** введите сетевой путь к общему ресурсу, который создан для папки резервного копирования журнала транзакций.  
  
6.  Поле **Если папка резервного копирования находится на сервере-источнике, укажите локальный путь к папке**. (Если папка резервного копирования находится не на сервере-источнике, можно оставить это поле пустым.)  
  
    > [!IMPORTANT]  
    >  Если учетная запись служб [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] на сервере-источнике выполняется с правами учетной записи «Локальная система», надо создать папку резервного копирования на сервере-источнике и указать локальный путь к ней.  
  
7.  Настройте параметры **Удалить файлы, созданные ранее** и **Предупредить, если резервное копирование не произошло в течение** .  
  
8.  Обратите внимание на расписание в поле **Расписание** в разделе **Задание резервного копирования**. Если нужно изменить расписание, нажмите кнопку **Расписание** и задайте расписание для агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] по своему усмотрению.  
  
9. [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] поддерживает [сжатие резервных копий](../../relational-databases/backup-restore/backup-compression-sql-server.md). При создании конфигурации доставки журналов можно управлять поведением сжатия резервных копий журналов, выбрав один из следующих параметров: **Использовать параметр сервера по умолчанию**, **Сжимать резервные копии**или **Не сжимать резервные копии**. Дополнительные сведения см. в статье [Log Shipping Transaction Log Backup Settings](../../relational-databases/databases/log-shipping-transaction-log-backup-settings.md).  
  
10. Нажмите кнопку **ОК**.  
  
11. В разделе **Экземпляры сервера-получателя и базы данных**нажмите кнопку **Добавить**.  
  
12. Нажмите **Соединить** и соединитесь с экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , который нужно использовать в качестве сервера-получателя.  
  
13. В поле **База данных-получатель** выберите базу данных из списка или введите имя базы данных, которую нужно создать.  
  
14. На вкладке **Инициализация базы данных-получателя** выберите параметр, который нужно использовать для инициализации базы данных-получателя.  
  
    > [!NOTE]  
    >  Если выбрана инициализация базы данных-получателя из резервной копии базы данных с помощью среды [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] , то данные и файлы журналов базы данных-получателя будут находиться в том же расположении, что данные и файлы журналов базы данных **master** . Это расположение, вероятно, будет отличаться от расположения файлов данных и файлов журнала базы данных-источника.  
  
15. На вкладке **Копирование файлов** в поле **Папка назначения для копирования файлов** введите путь папки, в которую должны копироваться резервные копии журналов транзакций. Эта папка часто находится на сервере-получателе.  
  
16. Обратите внимание на расписание копирования в поле **Расписание** в разделе **Задание копирования**. Если необходимо изменить расписание, нажмите кнопку **Расписание** и задайте расписание для агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] по своему усмотрению. Это расписание должно быть максимально приближено к расписанию резервного копирования.  
  
17. На вкладке **Восстановление журнала транзакций** в разделе **Состояние базы данных во время восстановления резервных копий**выберите пункт **Без режима восстановления** или **Режим ожидания** .  
    > [!IMPORTANT]  
    > **Режим ожидания** доступен, только если версии сервера-источника и сервера-получателя совпадают. Если основной номер версии сервера-получателя выше, чем сервера-источника, разрешен только **режим без восстановления**.
  
18. Если выбран параметр **Режим ожидания** , то нужно указать, следует ли отключать пользователей от базы данных-получателя, пока идет процесс восстановления.  
  
19. Если нужно отложить процесс восстановления на сервере-получателе, укажите время задержки в поле **Отложить восстановление резервных копий по крайней мере на**.  
  
20. Выберите пороговое значение для предупреждения в поле **Предупреждение, если восстановление не выполнено в течение**.  
  
21. Обратите внимание на расписание восстановления в поле **Расписание** раздела **Задание восстановления**. Если необходимо изменить расписание, нажмите кнопку **Расписание** и задайте расписание для агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] по своему усмотрению. Это расписание должно быть максимально приближено к расписанию резервного копирования.  
  
22. Нажмите кнопку **ОК**.  
  
23. В разделе **Экземпляр сервера мониторинга**выберите флажок **Использовать экземпляр сервера мониторинга** и затем нажмите кнопку **Настройки**.  
  
    > [!IMPORTANT]  
    >  Для отслеживания данной конфигурации доставки журналов необходимо добавить сервер мониторинга сейчас. Чтобы добавить сервер мониторинга позже, потребуется удалить данную конфигурацию доставки журналов, а затем заменить ее новой конфигурацией, включающей сервер мониторинга.  
  
24. Нажмите кнопку **Соединить** и соединитесь с экземпляром компонента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , который нужно использовать в качестве сервера мониторинга.  
  
25. В разделе **Соединения с сервером мониторинга**выберите метод подключения, который используется заданиями резервного копирования, обычного копирования и восстановления для соединения с сервером мониторинга.  
  
26. В разделе **Хранение журнала**выберите отрезок времени, в течение которого нужно хранить записи об отправке журналов.  
  
27. Нажмите кнопку **ОК**.  
  
28. В диалоговом окне **Свойства базы данных** нажмите кнопку **ОК** , чтобы начать процесс настройки.  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> Использование Transact-SQL  
  
#### <a name="to-configure-log-shipping"></a>Настройка доставки журналов  
  
1.  Инициализируйте базу данных-получатель путем восстановления полной резервной копии базы данных-источника на сервере-получателе.  
  
2.  Для добавления базы данных-источника на сервер-источник выполните процедуру [sp_add_log_shipping_secondary_database](../../relational-databases/system-stored-procedures/sp-add-log-shipping-primary-database-transact-sql.md) . Хранимая процедура возвращает идентификатор задания резервирования и первичный идентификатор.  
  
3.  Для установки расписания заданий копирования и восстановления выполните процедуру [sp_add_jobschedule](../../relational-databases/system-stored-procedures/sp-add-jobschedule-transact-sql.md) на сервере-источнике.  
  
4.  Для добавления задания предупреждения выполните процедуру [sp_add_log_shipping_secondary_database](../../relational-databases/system-stored-procedures/sp-add-log-shipping-alert-job-transact-sql.md) на сервере мониторинга.  
  
5.  Включите задание копирования на сервере-источнике.  
  
6.  На сервере-получателе выполните процедуру [sp_add_log_shipping_secondary_primary](../../relational-databases/system-stored-procedures/sp-add-log-shipping-secondary-primary-transact-sql.md) для обеспечения подробных характеристик сервера-источника и базы данных. Данная хранимая процедура возвращает идентификатор получателя, а также идентификаторы заданий копирования и восстановления.  
  
7.  На сервере-получателе выполните процедуру [sp_add_jobschedule](../../relational-databases/system-stored-procedures/sp-add-jobschedule-transact-sql.md) для настройки расписания заданий копирования и восстановления.  
  
8.  На сервере-получателе выполните процедуру [sp_add_log_shipping_secondary_database](../../relational-databases/system-stored-procedures/sp-add-log-shipping-secondary-database-transact-sql.md) для добавления базы данных-получателя.  
  
9. На сервере-источнике выполните процедуру [sp_add_log_shipping_primary_secondary](../../relational-databases/system-stored-procedures/sp-add-log-shipping-primary-secondary-transact-sql.md) для добавления на сервер-источник необходимых сведений о новой базе данных-получателе.  
  
10. На сервере-получателе включите задания копирования и восстановления. Дополнительные сведения см. в статье [Disable or Enable a Job](../../ssms/agent/disable-or-enable-a-job.md).  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
  
-   [Обновление доставки журналов до SQL Server 2016 (Transact-SQL)](../../database-engine/log-shipping/upgrading-log-shipping-to-sql-server-2016-transact-sql.md)  
  
-   [Добавление базы данных-получателя в конфигурацию доставки журналов (SQL Server)](../../database-engine/log-shipping/add-a-secondary-database-to-a-log-shipping-configuration-sql-server.md)  
  
-   [Удаление базы данных-получателя из конфигурации доставки журналов (SQL Server)](../../database-engine/log-shipping/remove-a-secondary-database-from-a-log-shipping-configuration-sql-server.md)  
  
-   [Удаление доставки журналов (SQL Server)](../../database-engine/log-shipping/remove-log-shipping-sql-server.md)  
  
-   [Просмотр отчета о доставке журналов (среда SQL Server Management Studio)](../../database-engine/log-shipping/view-the-log-shipping-report-sql-server-management-studio.md)  
  
-   [Наблюдение за доставкой журналов (Transact-SQL)](../../database-engine/log-shipping/monitor-log-shipping-transact-sql.md)  
  
-   [Переход на вторичный сервер доставки журналов (SQL Server)](../../database-engine/log-shipping/fail-over-to-a-log-shipping-secondary-sql-server.md)  
  
## <a name="see-also"></a>См. также:  
 [Сведения о доставке журналов (SQL Server)](../../database-engine/log-shipping/about-log-shipping-sql-server.md)   
 [Таблицы доставки журналов и хранимые процедуры](../../database-engine/log-shipping/log-shipping-tables-and-stored-procedures.md)  
  
  
