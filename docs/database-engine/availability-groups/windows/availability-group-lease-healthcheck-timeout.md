---
title: Механика измерения времени ожидания проверки работоспособности для аренды группы доступности
description: Механика и рекомендации для аренды, кластера, а также времени проверки работоспособности для групп доступности Always On.
ms.custom: seodec18
ms.date: 05/02/2018
ms.prod: sql
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
ms.assetid: ''
author: MashaMSFT
ms.author: mathoma
manager: jroth
ms.openlocfilehash: b4093a3629278f6bd733abdd3d14a006d2b73a75
ms.sourcegitcommit: 0343cdf903ca968c6722d09f017df4a2a4c7fd6b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2019
ms.locfileid: "67166400"
---
# <a name="mechanics-and-guidelines-of-lease-cluster-and-health-check-timeouts-for-always-on-availability-groups"></a>Механика и рекомендации для аренды, кластера, а также времени ожидания проверки работоспособности для групп доступности Always On 

Различия в оборудовании, программном обеспечении и конфигурации кластеров, а также различные требования ко времени бесперебойной работы и производительности приложений обуславливают различные значения времени ожидания для аренды, кластера и проверки работоспособности. Для определенных приложений и рабочих нагрузок требуется более интенсивный мониторинг с целью снижения времени простоя после серьезных сбоев. Другие приложения и рабочие нагрузки менее чувствительны ко временным неполадкам в сети и простоям из-за интенсивного использования ресурсов, и для них приемлем более медленный переход на другой ресурс. 

Для выявления сбоев на каждом узле работает несколько служб. Служба кластеров может определять потери кворума, библиотека ресурсов может обнаруживать проблемы, выявленные путем определения работоспособности AlwaysOn; кроме того, прямо на первичном экземпляре можно запустить переход на другой ресурс вручную. Служба кластеров, узел ресурса и экземпляр SQL Server синхронизируются друг с другом через удаленный вызов процедур, общую память и T-SQL. В большинстве случаев эти службы успешно взаимодействуют друг с другом, однако такая связь даже между службами на одном и том же компьютере не является полностью надежной. Кроме того, группы доступности должны правильно реагировать на события на уровне системы, такие как сбои сети и дисков, которые могут приводить к прекращению обмена данными или к прерыванию работы определенных функций. Из-за разнообразия вариантов сбоев и отсутствия надежного способа взаимодействия между службами группа доступности использует различные механизмы обнаружения перехода на другой ресурс, способные определять сбои и реагировать на них независимо друг от друга, таким образом, состояние кластера всегда является согласованным для всех узлов.  

## <a name="cluster-node-and-resource-detection"></a>Определение узлов кластера и ресурсов 

На каждом узле кластера работает один экземпляр службы кластеров, которая управляет отказоустойчивостью кластера и отслеживает все ресурсы кластера. Узел ресурса работает как отдельный процесс и является интерфейсом между службой кластеров и ресурсами кластера. Узел ресурса вызывается службой кластеров и выполняет операции с ресурсами кластера. Кластерные приложения, такие как SQL Server, предоставляют пользовательские интерфейсы для монитора ресурсов с использованием библиотек ресурсов. Библиотека ресурсов реализует сетевые и автономные операции и мониторинг работоспособности для пользовательских ресурсов. Узел ресурса — это дочерний процесс службы кластеров. При завершении работы службы кластеров процесс узла ресурсов также завершается. 

Для SQL Server библиотека ресурсов группы доступности определяет работоспособность группы доступности на основе механизма аренды группы доступности и определения работоспособности AlwaysOn. Библиотека ресурсов группы доступности предоставляет сведения о работоспособности ресурсов с помощью операции `IsAlive`. Монитор ресурсов опрашивает `IsAlive` с интервалом подтверждения соединения кластера, который устанавливается на уровне кластера с помощью параметров `CrossSubnetDelay` и `SameSubnetDelay`. На основном узле служба кластеров инициирует переход на другой ресурс каждый раз, когда при вызове библиотеки ресурсов со стороны `IsAlive` определяется, что группа доступности неработоспособна. 

Служба кластеров отправляет пакеты пульса другим узлам в кластере и подтверждает пакеты пульса, получаемые от них. Если после серии неподтвержденных пакетов пульса узел определяет сбой, он отправляет широковещательное сообщение, при получении которого все доступные узлы согласуют состояние работоспособности узла кластера друг с другом. Это событие, которое называется *событием перегруппирования*, поддерживает согласованное состояние кластера для всех узлов. Если после перегруппирования происходит потеря кворума, то все ресурсы кластера, включая группы доступности в этой секции, переходят в автономный режим. Все узлы в этой секции переводятся в состояние разрешения. Если секция с кворумом существует, то группа доступности будет назначена одному узлу в секции и станет первичной репликой, а все остальные узлы станут вторичными репликами. 

## <a name="always-on-health-detection"></a>Определение работоспособности AlwaysOn 

Библиотека ресурсов AlwaysOn отслеживает состояние внутренних компонентов SQL Server. `sp_server_diagnostics` передает сведения о работоспособности этих компонентов SQL Server с интервалом, определяемым `HealthCheckTimeout`. `sp_server_diagnostics` передает сведения о состоянии работоспособности из пяти компонентов уровня экземпляра: система, ресурс, обработка запросов, подсистема ввода-вывода и события. Он также передает сведения о работоспособности для каждой группы доступности. После каждого изменения библиотека ресурсов обновляет состояние работоспособности ресурса группы доступности на основе уровня сбоя группы доступности. В данных, которые возвращаются `sp_server_diagnostics`, отображается состояние каждого компонента (нормальное, предупреждение, ошибка или неизвестное), а также определенные XML-данные, описывающие состояние компонента. При определении работоспособности библиотека ресурсов выполняет действие только в том случае, если компонент находится в состоянии ошибки. 

Если при определении работоспособности не удалось отправить сведения в библиотеку ресурсов в течение нескольких интервалов, то группа доступности считается неработоспособной и будет сообщать о сбое при вызовах `IsAlive`. 

## <a name="lease-mechanism"></a>Механизм аренды  

В отличие от остальных механизмов перехода на другой ресурс, в работе механизма аренды активную роль играет экземпляр SQL Server. Механизм аренды используется в качестве проверки активности между узлом кластерных ресурсов и процессом SQL Server. Механизм проверяет, что обе стороны (служба кластеров и служба SQL Server) часто взаимодействуют, проверяют состояние друг друга и предотвращают сценарий с дроблением.  При переводе группы доступности в рабочий режим в качестве первичной реплики экземпляр SQL Server создает специализированный рабочий поток аренды для группы доступности. Рабочий поток аренды и узел ресурса совместно используют небольшую область памяти. Эта область памяти содержит события продления аренды и прекращения аренды. Рабочий поток аренды и узел ресурса работают друг с другом поочередно, отправляя событие продления аренды, переходя в спящий режим и ожидая, пока другая сторона отправит свое событие продления аренды или событие прекращения аренды. Как у узла ресурса, так и у рабочего потока аренды SQL Server есть срок жизни. Значение срока жизни изменяется каждый раз, когда поток выходит из спящего режима, получив сигнал от другого потока. Если срок жизни достигнут во время ожидания сигнала, аренда прекращается, и реплика этой группы доступности переходит в состояние разрешения. При отправке события прекращения аренды реплика переходит в роль разрешения. 

![image](media/availability-group-lease-healthcheck-timeout/image1.png) 

Механизм аренды использует принудительную синхронизацию между SQL Server и отказоустойчивым кластером Windows Server. При отправке команды перехода на другой ресурс служба кластеров совершает автономный вызов библиотеки ресурсов текущей первичной реплики. Библиотека ресурсов сначала пытается перевести группу доступности в автономный режим с помощью хранимой процедуры. Если эта хранимая процедура завершает работу со сбоем или с превышением времени ожидания, то сведения о сбое отправляются службе кластеров, которая выдает команду завершения работы. Команда завершения работы еще раз пробует выполнить ту же хранимую процедуру, но на этот раз кластер не ожидает, пока библиотека ресурсов сообщит об успешном или неудачном завершении операции, перед переносом группы доступности на новую реплику. Если второй вызов процедуры завершается сбоем, то узел ресурсов использует механизм аренды, чтобы перевести экземпляр в автономный режим. При вызове библиотеки ресурсов для перевода группы доступности в автономный режим библиотека ресурсов отправляет событие прекращения аренды, которое выводит рабочий поток аренды SQL Server из спящего режима, и он переводит группу доступности в автономный режим. Даже если это событие прекращения аренды не будет отправлено, срок аренды истечет, и реплика перейдет в состояние разрешения. 

Аренда в основном является механизмом синхронизации между основным экземпляром и кластером, но она также может создавать условия сбоя тогда, когда переход на другой ресурс по другим причинам не требовался. Например, высокая загрузка ЦП, нехватка памяти (нехватка виртуальной памяти, разбивка процессов), процесс SQL, не реагирующий при создании дампа памяти, зависание всей системы, отключение кластера WSFC (например, из-за потери кворума) могут препятствовать продлению аренды в экземпляре SQL и вызвать перезапуск или отработку отказа. 

## <a name="guidelines-for-cluster-timeout-values"></a>Рекомендации по установке значений времени ожидания кластера 

Тщательно проанализируйте компромиссы и последствия при использовании менее интенсивного мониторинга вашего кластера SQL Server. Увеличение значений времени ожидания кластера понизит чувствительность к временным проблемам в сети, но приведет к замедлению реакции на серьезные сбои. Увеличение времени ожидания для борьбы с нехваткой ресурсов или с большими географическими задержками также приведет к увеличению времени восстановления после серьезных или неустранимых сбоев. Такое решение приемлемо во многих ситуациях, но не является идеальным во всех случаях. 

Параметры по умолчанию оптимизированы для быстрой реакции на симптомы серьезных сбоев и сокращения времен простоя, но эти параметры также могут быть слишком агрессивными для некоторых рабочих нагрузок и конфигураций. Не рекомендуется уменьшать параметры `LeaseTimeout`, `CrossSubnetDelay`, `CrossSubnetThreshold`, `SameSubnetDelay`, `SameSubnetThreshold` и `HealthCheckTimeout` ниже значений по умолчанию. Оптимальные параметры для каждого развертывания различаются, и их вероятнее всего придется подбирать в течение длительного времени. При внесении изменений в любые из этих параметров делайте это постепенно, с учетом связей и зависимостей между этими параметрами. 

### <a name="relationship-between-cluster-timeout-and-lease-timeout"></a>Связь между временем ожидания кластера и временем ожидания аренды 

Основная задача механизма аренды — перевести ресурс SQL Server в автономный режим, когда службе кластеров не удается связаться с экземпляром при переходе на другой узел. Когда кластер выполняет операцию на ресурсе кластера группы доступности в автономном режиме, служба кластеров совершает удаленный вызов к файлу rhs.exe, чтобы перевести ресурс в автономный режим. Для перевода группы доступности в автономный режим библиотека ресурсов использует хранимые процедуры, но эти хранимые процедуры могут завершиться сбоем или исчерпать время ожидания. Во время автономного вызова узел ресурса также останавливает собственный рабочий поток продления аренды. В худшем случае SQL Server приведет к тому, что срок аренды истечет через интервал времени, равный ½ \* LeaseTimeout, и экземпляр перейдет в состояние разрешения. Переход на другой ресурс может быть запущен различными участниками процесса, но жизненно важно сделать так, чтобы информация о состоянии кластера была согласованной во всем кластере, а также между экземплярами SQL Server. Например, представьте себе ситуацию, в которой основной экземпляр теряет соединение с остальной частью кластера. Все узлы кластера определят сбой примерно в одно и то же время благодаря заданным значениям времени ожидания кластера, но только основной узел может взаимодействовать с основным экземпляром SQL Server, чтобы этот экземпляр мог передать ему первичную роль. 

С точки зрения основного узла служба кластеров потеряет кворум, после чего служба начнет завершать работу. Служба кластеров отправит удаленный вызов на узел ресурсов, чтобы завершить процесс. Этот вызов функции завершения переведет группу доступности на экземпляре SQL Server в автономный режим. Этот автономный вызов выполняется через T-SQL, но он не может гарантировать, что соединение между SQL и библиотекой ресурсов будет установлено успешно. 

С точки зрения остальной части кластера первичной реплики в кластере сейчас нет, и остальные узлы в кластере проведут голосование, чтобы выбрать новую первичную реплику. Если хранимая процедура, которая вызывалась библиотекой ресурсов, завершается сбоем или истечением времени ожидания, кластер может стать уязвимым для сценария с разделением вычислительных мощностей. 

Время ожидания аренды позволяет избежать сценария с разделением вычислительных мощностей в случае ошибок связи. Даже при полном нарушении обмена данными процесс библиотеки ресурсов будет завершен и не сможет обновить аренду. После истечения срока аренды группа доступности самостоятельно перейдет в автономный режим. Перед тем как кластер установит новую первичную реплику, экземпляр SQL Server должен знать, что на нем больше не размещается первичная реплика. Так как остальная часть кластера, которая отвечает за выбор новой первичной реплики, не может координировать свои действия с текущей первичной репликой, заданные значения времени ожидания позволяют гарантировать, что новая первичная реплика не будет выбрана до того, как текущая первичная реплика самостоятельно перейдет в автономный режим. 

Когда кластер переходит на другой ресурс, экземпляр SQL Server, на котором размещена предыдущая первичная реплика, должен перейти в состояние разрешения до того, как новая первичная реплика перейдет в оперативный режим. У рабочего потока аренды SQL Server в любой момент остается срок жизни, равный ½ \* LeaseTimeout, так как каждый раз при продлении аренды новый срок аренды получает значение `LeaseInterval` или ½ \* LeaseTimeout. Если служба кластеров или узел ресурса зависают или прекращают работу без отправки события прекращения аренды, кластер объявит основной узел неработоспособным по прошествии `SameSubnetThreshold`\ `SameSubnetDelay` мс. В течение этого времени срок аренды должен завершиться, чтобы первичная реплика гарантированно находилась в автономном режиме. Так как максимальный срок жизни для времени ожидания аренды составляет ½ \* `LeaseTimeout`, то ½ \* `LeaseTimeout` должно быть меньше `SameSubnetThreshold` \* `SameSubnetDelay`. 

Условия `SameSubnetThreshold \<= CrossSubnetThreshold` и `SameSubnetDelay \<= CrossSubnetDelay` должны быть справедливы для всех кластеров SQL Server. 

### <a name="health-check-timeout-operation"></a>Время ожидания проверки работоспособности 

Время ожидания проверки работоспособности является более гибким, так как другие механизмы перехода на другой ресурс не зависят от него напрямую. При использовании значения по умолчанию (30 секунд) интервал `sp_server_diagnostics` устанавливается как 10 секунд. Минимальное значение времени ожидания — 15 секунд с интервалом 5 секунд. В общем случае интервал обновления `sp_server_diagnositcs` всегда равен 1/3 \* `HealthCheckTimeout`. Если библиотека ресурсов DLL не получает новый набор данных работоспособности с указанным интервалом, она продолжит использовать данные из предыдущего интервала для определения текущей работоспособности группы доступности и экземпляра. Увеличение времени ожидания проверки работоспособности сделает основной узел более устойчивым к повышению нагрузки на ЦП, что может привести к тому, что `sp_server_diagnostics` не сможет предоставлять новые данные с указанным интервалом, однако при этом основной узел будет дольше использовать устаревшие результаты проверки работоспособности. Независимо от значения времени ожидания, после получения данных, свидетельствующих о том, что реплика неработоспособна, следующий вызов `IsAlive` возвратит информацию о том, что экземпляр неработоспособен, и служба кластеров начнет переход на другой ресурс. 

Уровень состояния ошибки для группы работоспособности влияет на состояния ошибки для проверки работоспособности. Если `sp_server_diagnostics` считает элемент группы доступности неработоспособным при любом уровне ошибки, то проверка работоспособности завершается с ошибкой. Каждый уровень наследует все состояния ошибок для уровней, расположенных ниже. 


| Level | Условие, при котором экземпляр считается неработоспособным
|:---|---
| 1: OnServerDown | Проверка работоспособности не предпринимает никаких действий при возникновении сбоя в других ресурсах за исключением группы доступности. Данные группы доступности не были получены в течение 5 интервалов или 5/3 \* HealthCheckTimeout
| 2: OnServerUnresponsive | Данные от `sp_server_diagnostics` не были получены в течение HealthCheckTimeout
| 3: OnCriticalServerError | Компонент системы сообщает об ошибке (по умолчанию)
| 4: OnModerateServerError | Компонент ресурса сообщает об ошибке 
| 5:  OnAnyQualifiedFailureConitions |  Компонент обработки запроса сообщает об ошибке

## <a name="updating-cluster-and-always-on-timeout-values"></a>Обновление параметров времени ожидания кластера и Always On 

### <a name="cluster-values"></a>Параметры кластера 

Существуют четыре параметра конфигурации WSFC, которые отвечают за определение значений времени ожидания кластера 

  - SameSubnetDelay 
  - SameSubnetThreshold 
  - CrossSubnetDelay 
  - CrossSubnetThreshold 

Значения задержки определяют время ожидания между пакетами пульса от службы кластеров, а пороговые значения задают максимальное количество пакетов пульса, для которых может быть не получено подтверждение приема от целевого узла или узла. При превышении максимального количества пакетов кластер признает объект неработоспособным. Если за `SameSubnetDelay \* SameSubnetThreshold` мс между узлами в одной подсети не было передано ни одного пакета пульса, узел считается неработоспособным. То же самое справедливо для взаимодействия между подсетями с использованием времени задержки между подсетями. 

Чтобы перечислить все текущие параметры кластера, на любом узле в целевом кластере откройте консоль PowerShell с повышенными привилегиями. Выполните следующую команду:

```PowerShell
 Get-Cluster | fl \
``` 

Чтобы изменить любой из этих параметров, выполните следующую команду в консоли PowerShell с повышенными привилегиями:

```PowerShell
(Get-Cluster).<ValueName> = <NewValue>
```

При увеличении произведения "Задержка \* Пороговое значение" с целью повысить устойчивость кластера следует сначала увеличивать значение задержки, и только потом — пороговое значение. При увеличении задержки увеличивается интервал между пакетами пульса. Увеличение времени между пакетами пульса позволяет увеличить интервал времени для возможных временных неполадок в сети и снизить загруженность сети из-за уменьшения количества пакетов пульса, отправляемых за определенный интервал времени. 

### <a name="lease-timeout"></a>Время ожидания аренды 

Механизмом аренды управляет один параметр, определяемый для каждой группы доступности в кластере WSFC. Чтобы перейти к этому параметру в диспетчере отказоустойчивости кластеров, выполните следующие действия:

1. На вкладке "Роли" найдите целевую роль группы доступности. Щелкните целевую роль группы доступности. 
2. Щелкните правой кнопкой мыши ресурс группы доступности в нижней части окна и выберите **Свойства**. 

   ![Диспетчер отказоустойчивости кластеров](media/availability-group-lease-healthcheck-timeout/image2.png) 

3. Во всплывающем окне перейдите на вкладку "Свойства". Откроется список параметров этой группы доступности. Щелкните значение параметра LeaseTimeout, чтобы изменить его. 

   ![Свойства](media/availability-group-lease-healthcheck-timeout/image3.png) 


   В зависимости от конфигурации группы доступности могут быть указаны дополнительные ресурсы для прослушивателей, общих дисков, общих папок и т. д. Эти ресурсы не требуют дополнительной настройки. 

   
### <a name="health-check-values"></a>Параметры проверки работоспособности 

Два значения элемента управляют проверкой работоспособности Always On: FailureConditionLevel и HealthCheckTimeout. FailureConditionLevel указывает на уровень устойчивости к определенным условиям ошибок, о которых сообщает `sp_server_diagnostics`, а параметр HealthCheckTimeout задает время, в течение которого библиотека ресурсов может работать без получения обновлений от `sp_server_diagnostics`. Интервал обновления `sp_server_diagnostics` всегда равен HealthCheckTimeout / 3. 

Чтобы настроить уровень состояния для перехода на другой ресурс, используйте параметр `FAILURE_CONDITION_LEVEL = <n>` инструкции `CREATE` или `ALTER` `AVAILABILITY GROUP`, где `<n>` является целым числом от 1 до 5. Следующая команда устанавливает уровень состояния ошибки в 1 для группы доступности AG1: 

```sql
ALTER AVAILABILITY GROUP AG1 SET (FAILURE_CONDITION_LEVEL = 1); 
```

Чтобы настроить время ожидания проверки работоспособности, используйте параметр `HEALTH_CHECK_TIMEOUT` инструкции `CREATE` или `ALTER` `AVAILABILITY GROUP`. Следующая команда устанавливает время ожидания проверки работоспособности в 60 000 миллисекунд для группы доступности AG1: 


```sql
ALTER AVAILABILITY GROUP AG1 SET (HEALTH_CHECK_TIMEOUT =60000);
```

## <a name="summary-of-timeout-guidelines"></a>Общие рекомендации по установке времени ожидания 

  - Не рекомендуется уменьшать параметры времени ожидания ниже значений по умолчанию 

  - Интервал аренды (½ \* LeaseTimeout) должен быть короче SameSubnetThreshold \* SameSubnetDelay 

  - SameSubnetThreshold \<= CrossSubnetThreshold 

  - SameSubnetDelay \<= CrossSubnetDelay 
  
 | Параметр времени ожидания | Назначение | Между | Области применения | IsAlive и LooksAlive | Причины | Результат 
 | :-------------- | :------ | :------ | :--- | :------------------- | :----- | :------ |
 | Время ожидания аренды </br> **По умолчанию: 20 000** | Предотвращение разделенности | С первичной реплики на кластер </br> (HADR) | [Объекты событий Windows](/windows/desktop/Sync/event-objects)| Используется в обоих случаях | Зависание ОС, нехватка виртуальной памяти, интенсивная подкачка рабочего набора памяти, формирование дампа, чрезмерная нагрузка ЦП, сбой WSFC (потеря кворума) | Подключение-отключение ресурса группы доступности, отработка отказа |  
 | Время ожидания сеанса </br> **По умолчанию: 10 000** | Информирование о проблеме взаимодействия между первичной и вторичной репликами | С вторичной реплики на первичную </br> (HADR) | [Сокеты TCP (сообщения, отправленные через конечную точку зеркального отображения базы данных)](/windows/desktop/WinSock/windows-sockets-start-page-2) | Ни в одном случае | Сетевое взаимодействие, </br> проблемы на вторичной реплике: отключение, зависание ОС, конфликт ресурсов | Отключение вторичной реплики | 
 |Время ожидания проверки работоспособности  </br> **По умолчанию: 30 000** | Указание времени ожидания при попытке определения работоспособности первичной реплики | С кластера на первичную реплику </br> (FCI и HADR) | T-SQL [sp_server_diagnostics](../../../relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql.md) | Используется в обоих случаях | Срабатывание условий сбоя, зависание ОС, нехватка виртуальной памяти, усечение рабочего набора, формирование дампа, WSFC (потеря кворума), проблемы планировщиков (взаимоблокировка)| Включение-отключение или отработка отказа ресурса группы доступности, перезапуск или отработка отказа экземпляра отказоустойчивого кластера |  
  | &nbsp; | &nbsp; | &nbsp; | &nbsp; | &nbsp;| &nbsp; | &nbsp; | &nbsp; |

## <a name="see-also"></a>См. также:    

[Активные вторичные реплики: резервное копирование во вторичных репликах (группы доступности Always On)](active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).

[ALTER AVAILABILITY GROUP (Transact-SQL)](../../../t-sql/statements/alter-availability-group-transact-sql.md)         

