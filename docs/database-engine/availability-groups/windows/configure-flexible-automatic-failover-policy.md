---
title: Настройка гибкой политики автоматического перехода на другой ресурс для группы доступности
description: Описывается, как настроить гибкую политику отработки отказа для группы доступности Always On с помощью Transact-SQL (T-SQL), PowerShell или SQL Server Management Studio.
ms.date: 11/05/2019
ms.prod: sql
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], flexible failover policy
- Availability Groups [SQL Server], failover
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 1ed564b4-9835-4245-ae35-9ba67419a4ce
author: MashaMSFT
ms.author: mathoma
monikerRange: '>=sql-server-2016||=sqlallproducts-allversions'
ms.custom: seo-lt-2019
ms.openlocfilehash: a273b97e5c8ce50cb82991491bbea0b5366d5665
ms.sourcegitcommit: 7035d9471876c70b99c58bf9b46af5cce6e9c66c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2020
ms.locfileid: "87522378"
---
# <a name="configure-a-flexible-automatic-failover-policy-for-an-always-on-availability-group"></a>Настройка гибкой политики автоматического перехода на другой ресурс для группы доступности Always On

[!INCLUDE[sql windows only](../../../includes/applies-to-version/sql-windows-only.md)]

  В данном разделе описывается настройка гибкой политики отработки отказа в группе доступности AlwaysOn при помощи [!INCLUDE[tsql](../../../includes/tsql-md.md)] или PowerShell в SQL Server. Гибкая политика отработки отказа предоставляет гранулярное управление условиями, которые могут вызвать [автоматический переход на другой ресурс](../../../database-engine/availability-groups/windows/failover-and-failover-modes-always-on-availability-groups.md) для группы доступности. Изменяя условия отказа, которые инициируют автоматический переход на другой ресурс, и частоту проверки исправности, вы можете увеличить или уменьшить вероятность автоматического перехода на другой ресурс и добиться высокого уровня доступности соглашения об уровне обслуживания.  

   Гибкая политика отработки отказа группы доступности определяется уровнем условий сбоя и пороговым значением времени ожидания проверки работоспособности. При обнаружении, что группа доступности превысила уровень условий сбоя или пороговое значение проверки времени ожидания работоспособности, DLL-ресурс группы доступности ответит WSFC-кластеру. После этого WSFC-кластер инициирует автоматический переход на вторичную реплику.  
 
  > [!NOTE]  
  > Гибкая политика отработки отказа для группы доступности не может быть настроена при помощи среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)].  
  
 
## <a name="limitations-on-automatic-failovers"></a><a name="Limitations"></a> Ограничения автоматического перехода на другой ресурс  
  
-   Для автоматического перехода на другой ресурс текущая первичная реплика и одна вторичная реплика должны быть настроены в режиме доступности синхронной фиксации с автоматическим переходом на другой ресурс, а вторичная реплика должна быть синхронизирована с первичной.  
  
-   Только три реплики поддерживаются для автоматического перехода на другой ресурс.  
  
-   Если в группе доступности превышен порог сбоя WSFC, то кластер WSFC не выполняет автоматический переход на другой ресурс для этой группы доступности. Более того, группа ресурсов WSFC для группы доступности остается в состоянии сбоя, пока администратор кластера вручную не переведет сбойную группу ресурсов в режим «в сети» или пока администратор базы данных вручную не выполнит переход группы доступности на другой ресурс. *Порог сбоя WSFC* определяется как максимальное число сбоев, которые могут произойти в группе доступности за заданный период времени. По умолчанию используется период в шесть часов, а максимальное число сбоев за этот период по умолчанию равно *n*-1, где *n* — число узлов WSFC. Чтобы изменить пороговые значения сбоя для заданной группы доступности, используйте консоль диспетчера отработки отказа WSFC.  
  
##  <a name="prerequisites"></a><a name="Prerequisites"></a> Предварительные требования  
  
-   Необходимо подключиться к экземпляру сервера, на котором размещена первичная реплика.  
   
##  <a name="permissions"></a><a name="Permissions"></a> Permissions  
  
|Задача|Разрешения|  
|----------|-----------------|  
|Настройка гибкой политики отработки отказа для новой группы доступности|Требуется членство в фиксированной роли сервера **sysadmin** и одно из разрешений: CREATE AVAILABILITY GROUP, ALTER ANY AVAILABILITY GROUP или CONTROL SERVER.|  
|Изменение политики существующей группы доступности|Необходимо разрешение ALTER AVAILABILITY GROUP для группы доступности, разрешение CONTROL AVAILABILITY GROUP, разрешение ALTER ANY AVAILABILITY GROUP или разрешение CONTROL SERVER.|  

##  <a name="health-check-timeout-threshold"></a><a name="HCtimeout"></a> Пороговое значение времени ожидания проверки работоспособности  
 Библиотека ресурсов группы доступности в WSFC-кластере выполняет *проверку исправности* первичной реплики путем вызова хранимой процедуры [sp_server_diagnostics](../../../relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql.md) для экземпляра SQL Server, на котором располагается первичная реплика. **sp_server_diagnostics** возвращает результаты с интервалом, равным 1/3 порогового значения времени ожидания при проверке работоспособности для группы доступности. Пороговое значение времени ожидания при проверке работоспособности по умолчанию составляет 30 секунд, то есть **sp_server_diagnostics** возвращает сведения с интервалом в 10 секунд. Если **sp_server_diagnostics** работает медленно или не возвращает сведения, библиотека ресурсов ожидает, пока истечет полный интервал для описанного порогового значения, и только затем определяет, что первичная реплика не отвечает. Если первичная реплика не отвечает, инициируется автоматический переход на другой ресурс, если она поддерживается.  
  
> [!IMPORTANT]  
>  **sp_server_diagnostics** не выполняет проверку работоспособности на уровне базы данных.  
  
##  <a name="failure-condition-level"></a><a name="FClevel"></a> Уровень условий сбоя  
 Уровень условий сбоя для группы доступности определяет, обеспечат ли диагностические данные и сведения о работоспособности, возвращенные командой **sp_server_diagnostics** , автоматический переход на другой ресурс. *Уровень условия сбоя* определяет, какие условия сбоя инициируют автоматический переход на другой ресурс. Существует пять уровней условий сбоя, которые варьируются от наименее ограничительного (уровень 1) до наиболее ограничительного (уровень 5). Заданный уровень включает в себя ограничения всех предыдущих уровней. Таким образом, наиболее строгий уровень 5 включает в себя менее строгие уровни ограничений с 1 по 4 и т. д.  
  
> [!IMPORTANT]  
>  Ни на одном из уровней условий сбоя не обнаружено поврежденных и подозрительных баз данных. Следовательно, поврежденная или подозрительная база данных (из-за ошибки оборудования, повреждения данных или по другой причине) никогда не вызывает автоматического перехода на другой ресурс.  
  
 В следующей таблице описываются условия сбоя, которые соответствуют каждому уровню.  
  
|Level|Условия сбоя|[!INCLUDE[tsql](../../../includes/tsql-md.md)] Значение|Значение PowerShell|  
|-----------|-----------------------|------------------------------|----------------------|  
|Один|При остановке работы сервера. Указывает, что автоматический переход на другой ресурс инициируется при возникновении одной из следующих ситуаций:<br /><br /> Служба [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] остановлена.<br /><br /> Аренда группы доступности для подключения к кластеру WSFC истекла, поскольку от экземпляра сервера не было получено сообщение ACK. Дополнительные сведения см. в разделе [Принцип работы. Время ожидания аренды AlwaysOn в SQL Server](https://techcommunity.microsoft.com/t5/sql-server-support/how-it-works-sql-server-alwayson-lease-timeout/ba-p/317268).<br /><br /> <br /><br /> Это наименее ограничительный уровень.|1|**OnServerDown**|  
|Два|При отсутствии ответа от сервера. Указывает, что автоматический переход на другой ресурс инициируется при возникновении одной из следующих ситуаций:<br /><br /> Экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не подключается к кластеру, а определяемый пользователем порог времени ожидания проверки исправности для группы доступности превышен.<br /><br /> Реплика доступности находится в неисправном состоянии.|2|**OnServerUnresponsive**|  
|Три|В случае критической ошибки сервера. Указывает, что автоматический переход на другой ресурс инициируется в случае появления критических внутренних ошибок [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , таких как потерянные спин-блокировки, серьезные нарушения доступа для записи или формирование слишком больших дампов.<br /><br /> Это уровень, заданный по умолчанию.|3|**OnCriticalServerError**|  
|Четыре|В случае ошибки сервера средней значимости. Указывает, что автоматический переход на другой ресурс инициируется в случае появления умеренных внутренних ошибок [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , например устойчивое состояние нехватки памяти в пуле внутренних ресурсов [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .|4|**OnModerateServerError**|  
|Пять|При любых подходящих условиях сбоя. Указывает, что автоматический переход на другой ресурс инициируется при любом удовлетворяющем условиям состоянии сбоя, включая:<br /><br /> Обнаружение взаимоблокировки планировщика.<br /><br /> Обнаружение неразрешимой взаимоблокировки.<br /><br /> <br /><br /> Это наиболее ограничительный уровень.|5|**OnAnyQualifiedFailureConditions**|  
  
> [!NOTE]  
>  Отсутствие ответа экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на клиентские запросы не является существенным для групп доступности.  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> Использование Transact-SQL  
 **Настройка гибкой политики отработки отказа**  
  
1.  Подключитесь к экземпляру сервера, на котором находится первичная реплика.  
  
2.  Для новой группы доступности используйте инструкцию [CREATE AVAILABILITY GROUP](../../../t-sql/statements/create-availability-group-transact-sql.md)[!INCLUDE[tsql](../../../includes/tsql-md.md)] . При добавлении или изменении существующей группы доступности воспользуйтесь инструкцией [ALTER AVAILABILITY GROUP](../../../t-sql/statements/alter-availability-group-transact-sql.md)[!INCLUDE[tsql](../../../includes/tsql-md.md)] .  
  
    -   Чтобы установить уровень условий перехода на другой ресурс, используйте параметр FAILURE_CONDITION_LEVEL = *n* , где *n* — это целое число от 1 до 5.  
  
         Например, следующая инструкция [!INCLUDE[tsql](../../../includes/tsql-md.md)] изменяет уровень условия сбоя для существующей группы доступности `AG1`до уровня 1:  
  
        ```  
  
        ALTER AVAILABILITY GROUP AG1 SET (FAILURE_CONDITION_LEVEL = 1);  
        ```  
  
         Эти целочисленные значения следующим образом соответствуют уровням условий сбоя.  
  
        |[!INCLUDE[tsql](../../../includes/tsql-md.md)] Значение|Level|Автоматическая отработка отказа запускается при...|  
        |------------------------------|-----------|-------------------------------------------|  
        |1|Один|При остановке работы сервера. Служба SQL Server останавливается из-за отработки отказа или перезапуска.|  
        |2|Два|При отсутствии ответа от сервера. Удовлетворяется любое условие более низкого значения, служба SQL Server подключена к кластеру, а пороговое значение ожидания проверки работоспособности превышено, либо текущая первичная реплика находится в неисправном состоянии.|  
        |3|Три|В случае критической ошибки сервера. Удовлетворяется любое условие более низкого значения, или возникает внутренняя критическая ошибка сервера.<br /><br /> Это уровень, заданный по умолчанию.|  
        |4|Четыре|В случае ошибки сервера средней значимости. Удовлетворяется любое условие более низкого значения, или возникает ошибка сервера средней значимости.|  
        |5|Пять|При любых подходящих условиях сбоя. Удовлетворяется любое условие более низкого значения, или возникает подходящее условие сбоя.|  
  
         Дополнительные сведения об уровнях условий перехода на другой ресурс см. в статье [Гибкая политика отработки отказа для автоматического перехода на другой ресурс группы доступности (SQL Server)](../../../database-engine/availability-groups/windows/flexible-automatic-failover-policy-availability-group.md).  
  
    -   Чтобы настроить пороговое значение ожидания проверки работоспособности, используйте параметр HEALTH_CHECK_TIMEOUT = *n*, где *n* является целым числом от 15000 миллисекунд (15 секунд) до 4294967295 миллисекунд. Значение по умолчанию — 30 000 миллисекунд (30 секунд)  
  
         Например, следующая инструкция [!INCLUDE[tsql](../../../includes/tsql-md.md)] изменяет пороговое значение времени ожидания проверки работоспособности существующей группы доступности `AG1`на значение 60 000 миллисекунд (одна минута).  
  
        ```  
  
        ALTER AVAILABILITY GROUP AG1 SET (HEALTH_CHECK_TIMEOUT = 60000);  
        ```  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> Использование PowerShell  
 **Настройка гибкой политики отработки отказа**  
  
1.  Установите значение по умолчанию (**cd**) равным экземпляру сервера, на котором размещена первичная реплика.  
  
2.  При добавлении реплики доступности в группу доступности воспользуйтесь командлетом **New-SqlAvailabilityGroup** . При изменении существующей реплики доступности воспользуйтесь командлетом **Set-SqlAvailabilityGroup** .  
  
    -   Чтобы установить уровень условий отработки отказа, используйте параметр **FailureConditionLevel**_level_ , где *level* принимает одно из следующих значений.  
  
        |Значение|Level|Автоматическая отработка отказа запускается при...|  
        |-----------|-----------|-------------------------------------------|  
        |**OnServerDown**|Один|При остановке работы сервера. Служба SQL Server останавливается из-за отработки отказа или перезапуска.|  
        |**OnServerUnresponsive**|Два|При отсутствии ответа от сервера. Удовлетворяется любое условие более низкого значения, служба SQL Server подключена к кластеру, а пороговое значение ожидания проверки работоспособности превышено, либо текущая первичная реплика находится в неисправном состоянии.|  
        |**OnCriticalServerError**|Три|В случае критической ошибки сервера. Удовлетворяется любое условие более низкого значения, или возникает внутренняя критическая ошибка сервера.<br /><br /> Это уровень, заданный по умолчанию.|  
        |**OnModerateServerError**|Четыре|В случае ошибки сервера средней значимости. Удовлетворяется любое условие более низкого значения, или возникает ошибка сервера средней значимости.|  
        |**OnAnyQualifiedFailureConditions**|Пять|При любых подходящих условиях сбоя. Удовлетворяется любое условие более низкого значения, или возникает подходящее условие сбоя.|  
  
         Дополнительные сведения об уровнях условий перехода на другой ресурс см. в статье [Гибкая политика отработки отказа для автоматического перехода на другой ресурс группы доступности (SQL Server)](../../../database-engine/availability-groups/windows/flexible-automatic-failover-policy-availability-group.md).  
  
         Например, следующая команда изменяет уровень условия сбоя для существующей группы доступности `AG1`до уровня 1.  
  
        ```  
        Set-SqlAvailabilityGroup `   
        -Path SQLSERVER:\Sql\PrimaryServer\InstanceName\AvailabilityGroups\MyAg `   
        -FailureConditionLevel OnServerDown  
        ```  
  
    -   Чтобы установить пороговое значение времени ожидания для проверки работоспособности, используйте параметр **HealthCheckTimeout**_n_ , где *n* является целым числом от 15000 миллисекунд (15 секунд) до 4294967295 миллисекунд. Значение по умолчанию — 30 000 миллисекунд (30 секунд).  
  
         Например, следующая команда изменяет пороговое значение времени ожидания проверки работоспособности существующей группы доступности `AG1`на значение 120 000 миллисекунд (две минуты).  
  
        ```  
        Set-SqlAvailabilityGroup `   
        -Path SQLSERVER:\Sql\PrimaryServer\InstanceName\AvailabilityGroups\MyAG `   
        -HealthCheckTimeout 120000  
        ```  
  
> [!NOTE]  
>  Чтобы просмотреть синтаксис командлета, воспользуйтесь командлетом **Get-Help** в среде PowerShell [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Дополнительные сведения см. в разделе [Get Help SQL Server PowerShell](../../../relational-databases/scripting/get-help-sql-server-powershell.md).  
  
 **Настройка и использование поставщика SQL Server PowerShell**  
  
-   [Поставщик SQL Server PowerShell](../../../relational-databases/scripting/sql-server-powershell-provider.md)  
  
-   [Получение справок по SQL Server PowerShell](../../../relational-databases/scripting/get-help-sql-server-powershell.md)  

##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
 **To configure automatic failover**  
  
-   [Изменение режима доступности реплики доступности (SQL Server)](../../../database-engine/availability-groups/windows/change-the-availability-mode-of-an-availability-replica-sql-server.md) (автоматический переход на другой ресурс требует использовать режим доступности с синхронной фиксацией)  
  
-   [Смена режима отработки отказа для реплики доступности (SQL Server)](../../../database-engine/availability-groups/windows/change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
-   [Настройка гибкой политики отработки отказа для обеспечения контроля над автоматическим переходом на другой ресурс (группы доступности AlwaysOn)](../../../database-engine/availability-groups/windows/configure-flexible-automatic-failover-policy.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> См. также  
  
-   [Принцип работы. Время ожидания аренды AlwaysOn в SQL Server](https://techcommunity.microsoft.com/t5/sql-server-support/how-it-works-sql-server-alwayson-lease-timeout/ba-p/317268)  
  
## <a name="see-also"></a>См. также:  
 [Обзор групп доступности AlwaysOn (SQL Server)](../../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md)   
 [Режимы доступности (группы доступности AlwaysOn)](../../../database-engine/availability-groups/windows/availability-modes-always-on-availability-groups.md)   
 [Отработка отказа и режимы отработки отказа (группы доступности AlwaysOn)](../../../database-engine/availability-groups/windows/failover-and-failover-modes-always-on-availability-groups.md)   
 [Отказоустойчивая кластеризация Windows Server (WSFC) с SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md)   
 [Политика отработки отказа для экземпляров откзоустойчивого кластера](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md)   
 [sp_server_diagnostics (Transact-SQL)](../../../relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql.md)  
  
  
