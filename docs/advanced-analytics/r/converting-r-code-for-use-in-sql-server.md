---
title: Преобразование кода R для хранимых процедур - службы машинного обучения SQL Server
description: Перенос кода R в хранимую процедуру SQL Server для решения развертывания и доступа к данным в реляционных данных на сервере SQL Server.
ms.prod: sql
ms.technology: machine-learning
ms.date: 04/15/2018
ms.topic: conceptual
author: dphansen
ms.author: davidph
manager: cgronlun
ms.openlocfilehash: a3348058b03ff1441256cc8298ddc1b5b2216b0d
ms.sourcegitcommit: 2827d19393c8060eafac18db3155a9bd230df423
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2019
ms.locfileid: "58511261"
---
# <a name="convert-r-code-for-execution-in-sql-server-in-database-instances"></a>Преобразование кода R для выполнения в экземплярах SQL Server (в базе данных)
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этой статье содержатся общие рекомендации о том, как изменить код R в SQL Server. 

При перемещении кода R в R Studio или другую среду SQL Server, чаще всего этот код работает без изменений: например, если код прост, такие как функцию, которая принимает некоторые входные данные и возвращает значение. Это также упрощает порт решений, использующих **RevoScaleR** или **MicrosoftML** пакеты, которые поддерживают выполнение в контекстах различных выполнение с минимальными изменениями.

Тем не менее код может потребовать значительных изменений, если выполняется одно из следующих условий:

+ Использовать библиотеки R, доступ к сети или не может устанавливаться на сервере SQL Server.
+ Код выполняет отдельные вызовы к источникам данных за пределами SQL Server, например листов Excel, файлы на общих ресурсах и других баз данных. 
+ Вы хотите запустить код в *@script* параметр [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) и также задайте параметры для хранимой процедуры.
+ Исходное решение содержит несколько шагов, которые могут быть более эффективным, в рабочей среде при выполнении независимо друг от друга, такие как Подготовка данных или создания функций и модели обучения, оценки или создания отчетов.
+ Чтобы повысить производительность будет оптимизирована путем изменения библиотеки, с помощью параллельного выполнения или разгрузку обработку, чтобы SQL Server. 

## <a name="step-1-plan-requirements-and-resources"></a>Шаг 1. Планирование требований и доступных ресурсов

**Пакеты**

+ Определить, какие пакеты требуются и убедитесь, что они работают на сервере SQL Server.
 
+ Установите пакеты заранее, в библиотеке пакетов по умолчанию, используемых служб машинного обучения. Библиотеках пользователей не поддерживаются.

**Источники данных** 

+ Если вы собираетесь внедрить в коде R [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md), определение источников данных первичный и вторичный. 

    + **Основной** источники данных являются большие наборы данных, например данные для обучения модели или входные данные для прогнозов. Планирование для сопоставления большого набора данных со входным параметром процедуры [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md).

    + **Вторичный** источников данных, обычно небольшие наборы данных, такие как списки факторов или дополнительные переменные группирования. 
    
    В настоящее время sp_execute_external_script поддерживает только один набор данных в качестве входных данных в хранимую процедуру. Тем не менее можно добавить несколько входов скалярные или binary.

    Вызовы хранимых процедур, предшествует EXECUTE нельзя использовать в качестве входных данных для [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md). Можно использовать запросы, представления или любой другой допустимый инструкции SELECT.

+ Определите выходные данные, которые необходимо. При выполнении кода R с помощью процедуры sp_execute_external_script, хранимая процедура может выводить только один кадр данных в результате. Тем не менее можно также выводить несколько скалярных выходных данных, включая графики и моделей в двоичном формате, а также другие скалярные значения производным от кода R или SQL параметры.

**Типы данных**

+ Составьте контрольный список возможных проблем с типами данных.

    Все типы данных R поддерживаются службы машинного обучения SQL Server. Тем не менее [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] поддерживает больше типов данных, чем R. Таким образом, выполняются некоторые неявные преобразования типов данных при отправке [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] данных R и наоборот. Может потребоваться явным образом привести или преобразовать некоторые данные. 

    Значения NULL поддерживаются. Тем не менее, R использует `na` конструкция данных для представления отсутствующее значение, которая напоминает простую со значением null.

+ Рассмотрите возможность удаления зависимости от данных, который не может использоваться R: rowid к примеру, и типы данных GUID из SQL Server не может использоваться в R и выдают сообщения об ошибках.

    Дополнительные сведения см. в разделе [библиотеки R и типы данных](../r/r-libraries-and-data-types.md).

## <a name="step-2-convert-or-repackage-code"></a>Шаг 2. Преобразовать или повторной упаковки кода

Сколько внесения изменений в код зависит от ли собираетесь отправить кода R из удаленного клиента, чтобы выполняться в контексте вычислений SQL Server или планируете развернуть код как часть хранимой процедуры, которая позволяет получить более высокую производительность и безопасность данных. Перенос кода в хранимой процедуре накладывает некоторые дополнительные требования. 

+ Определите основной входные данные как запрос SQL, везде, где это возможно, чтобы избежать перемещения данных.

+ При выполнении кода R в хранимую процедуру, можно передать через несколько **скалярные** входных данных. Для любых параметров, которые вы хотите использовать в выходных данных, добавить **ВЫВОДА** ключевое слово. 

    Например, следующие скалярные входные данные `@model_name` содержит имя модели, который также является выходные данные в собственном столбце, в результатах:

    ```sql
    EXEC sp_execute_external_script @model_name="DefaultModel" OUTPUT, @language=N'R', @script=N'R code here'
    ``` 

+ Все переменные, передаваемые в качестве параметров хранимой процедуры [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) должны быть сопоставлены с переменными в коде R. По умолчанию переменные сопоставляются по имени.

    Все столбцы во входном наборе данных также должны быть сопоставлены с переменными в скрипте R.  Например предположим, что скрипт R содержит следующую формулу:

    ```R
    formula <- ArrDelay ~ CRSDepTime + DayOfWeek + CRSDepHour:DayOfWeek
    ```
    
    Если входной набор данных содержит столбцы с именами ArrDelay, CRSDepTime, DayOfWeek, CRSDepHour и DayOfWeek, возникает ошибка.

+ В некоторых случаях схему выходные данные должны быть определены заранее для результатов.

    Например, чтобы вставить данные в таблицу, необходимо использовать **с РЕЗУЛЬТИРУЮЩЕГО НАБОРА** предложение для указания схемы.

    Схема вывода также является обязательным, если скрипт R использует аргумент `@parallel=1`. Дело в том, что SQL Server может распределить запрос между несколькими параллельными процессами и собирать результаты в конце. Таким образом схема вывода должен быть подготовлен перед созданием параллельных процессов.
    
    В других случаях можно опустить схемы результатов с помощью параметра **WITH RESULT SETS UNDEFINED**. Эта инструкция возвращает набор данных из скрипта R без имен столбцов или указание типов данных SQL.

+ Рассмотрите возможность создания времени или отслеживания данных, с помощью T-SQL, а не R.

    Например можно передать системное время или другие сведения, используемые для аудита и хранения, добавление вызова T-SQL, который передается через результаты, вместо создания схожие данные в R-скрипта. 

**Повышения производительности и безопасности**

+ Избегайте написания прогнозов или промежуточные результаты в файл. Записи прогнозы в таблицу вместо этого, чтобы избежать перемещения данных.

+ Выполните все запросы заранее и просмотрите планы запросов SQL Server для указания задач, которые могут выполняться параллельно.

    Если входной запрос может выполняться параллельно, задайте `@parallel=1` как часть аргументов [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md). 

    Параллельная обработка с использованием этого параметра обычно поддерживается, если SQL Server может работать с секционированными таблицами или распределять запрос между несколькими процессами и выполнять статистическую обработку результатов в конце. Параллельная обработка с использованием этого параметра обычно не поддерживается, если для обучения моделей применяются алгоритмы, требующие считывания всех данных, или если требуется создать агрегаты.

+ Определите, нет ли в коде R действий, которые можно выполнять отдельно или более эффективно с помощью вызова отдельной хранимой процедуры. Например можно получить более высокую производительность, выполнив признаков или извлечения признаков отдельно и сохранение значений в таблице.

+ Искать способы использования T-SQL, а не в коде R для вычислений на основе наборов.

    Например это решение R показывает, каким образом пользовательские функции T-SQL и R можно выполнять же задаче разработки компонента: [Пошаговое руководство по End-to-End обработки и анализа данных](../tutorials/walkthrough-data-science-end-to-end-walkthrough.md).

+ Если это возможно, замените обычные функции R функциями с **ScaleR** функции, поддерживающие распределенное выполнение. Дополнительные сведения см. в разделе [сравнения Base R и масштабируйте функции R](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/revoscaler-compared-to-base-r).

+ Обратитесь к разработчику базы данных определяет способы повышения производительности с помощью функции SQL Server, таких как [оптимизированные для памяти таблицы](https://docs.microsoft.com/sql/relational-databases/in-memory-oltp/introduction-to-memory-optimized-tables), или, если вы используете выпуск Enterprise, [регулятора ресурсов](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor)).

    Дополнительные сведения см. в разделе [SQL Server оптимизации советы и рекомендации для служб аналитики](https://gallery.cortanaintelligence.com/Tutorial/SQL-Server-Optimization-Tips-and-Tricks-for-Analytics-Services)

### <a name="step-3-prepare-for-deployment"></a>Шаг 3. Подготовка к развертыванию

+ Обратитесь к администратору, чтобы установить и протестировать пакеты до развертывания кода. 

    В среде разработки может быть допустимо устанавливать пакеты как часть кода, но это рекомендуется делать в рабочей среде. 

    Библиотеках пользователей не поддерживаются, независимо от того с помощью хранимой процедуры или выполнение кода R в контексте вычислений SQL Server.

**Упакуйте код R в хранимой процедуре**

+ Если ваш код приложения относительно прост, можно внедрить в пользовательской функции T-SQL без изменения, как описано в этих примерах:

    + [Создание функции R, которая выполняется в rxExec](../tutorials/deepdive-create-a-simple-simulation.md)
    + [Проектирование признаков с помощью T-SQL и R](../tutorials/sqldev-create-data-features-using-t-sql.md)

+ Если код является более сложным, используйте пакет R **sqlrutils** для преобразования кода. Этот пакет предназначен для опытных пользователей R писать код хорошо хранимой процедуры. 

    Первым делом переписывать код R в виде одной функции четких входными и выходными данными.

    Затем с помощью **sqlrutils** пакета для создания входных и выходных данных в правильном формате. **Sqlrutils** пакета создается код завершения хранимой процедуры и может зарегистрировать хранимую процедуру в базе данных. 

    Дополнительные сведения и примеры см. в разделе [sqlrutils (SQL)](ref-r-sqlrutils.md).

**Интеграция с другими рабочими процессами**

+ Используйте средства T-SQL и процессы ETL. Выполняйте проектирование признаков, извлечением компонентов и заранее Очистка данных как часть рабочие процессы данных.

    При работе в изолированной среде разработки R например [!INCLUDE[rsql_rtvs_md](../../includes/rsql-rtvs-md.md)] или RStudio, может извлечь данные на компьютер, анализировать данные, пользуясь и затем записать и отображения результатов. 
    
    Тем не менее при переносе кода R на SQL Server, большая часть этого процесса можно упростить или делегировать другим средствам SQL Server. 

+ Используйте стратегии безопасного асинхронной визуальное представление.

    Часто пользователи SQL Server нет доступа к файлам на сервере и клиентских средств SQL обычно не поддерживают графическое устройство R. При создании графиков или другие графические как часть решения, рассмотрите возможность экспорта графики как двоичные данные и сохранение в таблице или записи.

+ Wrap прогнозирования и оценки функций в хранимых процедурах для прямого доступа приложениями.

### <a name="other-resources"></a>Другие ресурсы

Чтобы просмотреть примеры развертывания решения R в SQL Server, см. в этих примерах:

+ [Создание прогнозной модели для бизнеса ski аренды, с помощью R и SQL Server](https://microsoft.github.io/sql-ml-tutorials/R/rentalprediction/)

+ [Аналитика в базе данных для разработчиков SQL](../tutorials/sqldev-in-database-r-for-sql-developers.md) показано, как сделать кода R модульной, если поместить его в хранимых процедурах

+ [End-to-End и анализу данных](../tutorials/walkthrough-data-science-end-to-end-walkthrough.md) приведено сравнение формирования признаков в R и T-SQL
