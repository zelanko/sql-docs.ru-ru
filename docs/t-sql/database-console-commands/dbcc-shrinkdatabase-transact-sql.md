---
description: DBCC SHRINKDATABASE (Transact-SQL)
title: DBCC SHRINKDATABASE (Transact-SQL) | Документы Майкрософт
ms.custom: ''
ms.date: 07/17/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: t-sql
ms.topic: language-reference
f1_keywords:
- DBCC_SHRINKDATABASE_TSQL
- DBCC SHRINKDATABASE
- SHRINKDATABASE_TSQL
- SHRINKDATABASE
dev_langs:
- TSQL
helpviewer_keywords:
- data shrinking [SQL Server]
- shrinking files
- shrinking databases
- DBCC SHRINKDATABASE statement
- decreasing database size
- file shrinking [SQL Server]
- database shrinking [SQL Server]
- logs [SQL Server], shrinking
- reducing database size
ms.assetid: fc976afd-1edb-4341-bf41-c4a42a69772b
author: pmasl
ms.author: umajay
monikerRange: = azuresqldb-current ||>= sql-server-2016 ||>= sql-server-linux-2017||=azure-sqldw-latest||= sqlallproducts-allversions
ms.openlocfilehash: 48181379c0ad20f5e9d8dc1ac8a9dd304fbc5e81
ms.sourcegitcommit: e700497f962e4c2274df16d9e651059b42ff1a10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "88479821"
---
# <a name="dbcc-shrinkdatabase-transact-sql"></a>DBCC SHRINKDATABASE (Transact-SQL)
[!INCLUDE [sql-asdb-asa.md](../../includes/applies-to-version/sql-asdb-asa.md)]

Сокращает размер файлов данных и файлов журнала в указанной базе данных.
  
![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)
  
## <a name="syntax"></a>Синтаксис  
  
```syntaxsql
DBCC SHRINKDATABASE   
( database_name | database_id | 0   
     [ , target_percent ]   
     [ , { NOTRUNCATE | TRUNCATEONLY } ]   
)  
[ WITH NO_INFOMSGS ]  
```  

```syntaxsql
-- Azure Synapse Analytics (formerly SQL DW)

DBCC SHRINKDATABASE   
( database_name   
     [ , target_percent ]   
)  
[ WITH NO_INFOMSGS ]

```  

[!INCLUDE[sql-server-tsql-previous-offline-documentation](../../includes/sql-server-tsql-previous-offline-documentation.md)]

## <a name="arguments"></a>Аргументы
_имя\_бд_ | _ид\_бд_ | 0  
Имя или идентификатор базы данных, которая должна быть сжата. Если указано значение 0, используется текущая база данных.  
  
_целевой\_процент_  
Процент свободного пространства, которое должно остаться в базе данных после сжатия.  
  
NOTRUNCATE  
Перемещает назначенные страницы с конца файла в неназначенные страницы в начале файла. Это действие сжимает данные в файле. _Целевой\_процент_ является необязательным. Хранилище данных SQL Azure не поддерживает этот параметр. 
  
Свободное место в конце файла не возвращается операционной системе, и физический размер файла не изменяется. Таким образом, база данных физически не уменьшается при указании NOTRUNCATE.  
  
Аргумент NOTRUNCATE применим только к файлам данных. NOTRUNCATE не влияет на файл журнала.  
  
TRUNCATEONLY  
Освобождает все свободное пространство в конце файла и возвращает его операционной системе. Не перемещает какие-либо страницы в файле. Файл данных сжимается только до последнего назначенного экстента. Аргумент _целевой\_процент_ не учитывается, если указан аргумент TRUNCATEONLY. Хранилище данных SQL Azure не поддерживает этот параметр.
  
Аргумент TRUNCATEONLY оказывает влияние на файл журнала. Для усечения только файла данных используйте инструкцию DBCC SHRINKFILE.  
  
WITH NO_INFOMSGS  
Подавляет все информационные сообщения со степенями серьезности от 0 до 10.  
  
## <a name="result-sets"></a>Результирующие наборы  
В следующей таблице отображены столбцы результирующего набора.
  
|Имя столбца|Описание|  
|-----------------|-----------------|  
|**DbId**|Идентификатор базы данных, файл которой компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] пытался сжать.|  
|**FileId**|Идентификатор файла, который компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] пытался сжать.|  
|**CurrentSize**|Количество 8-килобайтных страниц, занятых файлом в настоящее время.|  
|**MinimumSize**|Минимальное количество 8-килобайтных страниц, которое может занимать файл. Это значение соответствует минимальному размеру или размеру файла, указанному при создании.|  
|**UsedPages**|Количество 8-килобайтных страниц, используемых файлом в настоящее время.|  
|**EstimatedPages**|Количество 8-килобайтных страниц, до которого можно было бы сжать файл по оценке компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)].|  
  
>[!NOTE]
> Компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] не отображает строки для файлов, размер которых не был сокращен.  
  
## <a name="remarks"></a>Remarks  

>[!NOTE]
> Выполнение этой команды не рекомендуется, так как она интенсивно использует ввод-вывод и может привести к недоступности вашего хранилища данных. Кроме того, она может потребовать дополнительных затрат на моментальные снимки хранилища данных. 

Чтобы сжать все файлы данных и журналов указанной базы данных, выполните команду DBCC SHRINKDATABASE. Чтобы сжать один файл данных или файл журнала в указанной базе данных, выполните команду [DBCC SHRINKFILE](../../t-sql/database-console-commands/dbcc-shrinkfile-transact-sql.md).
  
Чтобы просмотреть количество свободного (нераспределенного) пространства в базе данных, выполните процедуру [sp_spaceused](../../relational-databases/system-stored-procedures/sp-spaceused-transact-sql.md).
  
Операции DBCC SHRINKDATABASE могут быть остановлены на любом этапе процесса, при этом вся выполненная работа сохраняется.
  
Размер базы данных нельзя сделать меньше минимального настроенного размера базы данных. Минимальный размер указывается при создании базы данных. Также минимальный размер может быть последним размером, явно установленным в операции изменения размера файла. Такие операции, как DBCC SHRINKFILE или ALTER DATABASE, — примеры операций, изменяющих размер файла. 

Предположим, что база данных была создана с размером 10 МБ. Затем она увеличивается до 100 МБ. Наименьший размер базы данных, до которого ее можно сжать, — 10 МБ, даже если все данные в базе данных будут удалены.
  
При выполнении команды DBCC SHRINKDATABASE укажите параметр NOTRUNCATE или TRUNCATEONLY. Если этого не сделать, результат будет таким же, как если бы вы выполнили операцию DBCC SHRINKDATABASE с аргументом NOTRUNCATE и последующим запуском операции DBCC SHRINKDATABASE с аргументом TRUNCATEONLY.
  
База данных не обязана находиться в однопользовательском режиме. Другие пользователи могут работать в базе данных (в том числе системной) при ее сжатии.
  
Невозможно сжать базу данных во время создания ее резервной копии. И наоборот, невозможно создать резервную копию базы данных во время операции сжатия.
  
## <a name="how-dbcc-shrinkdatabase-works"></a>Работа команды DBCC SHRINKDATABASE  
Инструкция DBCC SHRINKDATABASE сжимает файлы данных по одному, а файлы журнала так, как будто все они представляют один непрерывный пул журнала. Сжатие файлов всегда ведется с конца.
  
Предположим, имеется несколько файлов журнала, файл данных и база данных с именем **mydb**. Каждый файл данных и журнала имеет размер 10 МБ, а файл данных содержит 6 МБ данных. Компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] вычисляет целевой размер каждого файла. Это размер, до которого файл должен быть сжат. Если инструкция DBCC SHRINKDATABASE указана с аргументом _целевой\_процент_, то компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] вычисляет целевой размер таким образом, чтобы в файле после сжатия был _целевой\_процент_ свободного пространства. 

Например, если указать _целевой\_процент_ со значением 25 для сжатия базы данных **mydb**, компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] рассчитает целевой размер для файла, равный 8 МБ (6 МБ данных и 2 МБ свободного пространства). Поэтому компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] перемещает все данные из последних 2 МБ файла данных в любое свободное пространство в первых 8 МБ файла данных, а затем сжимает файл.
  
Предположим, что файл данных базы данных **mydb** содержит 7 МБ данных. При задании значения 30 для аргумента _целевой\_процент_ можно сжать этот файл данных до 30 %. Но задание значения 40 для _целевой\_процент_ не позволит сжать файл данных, так как [!INCLUDE[ssDE](../../includes/ssde-md.md)] не может уменьшить файл до размера, меньшего, чем занимают данные сейчас. 

Эту ситуацию можно представить и другим способом: 40 процентов желаемого свободного пространства + 70 процентов от полного файла данных (7 МБ из 10 МБ) больше, чем 100 процентов. Любой _целевой\_процент_ больше 30 не приведет к сжатию файла данных. Сжатия не будет, поскольку сумма освобождаемого процента и текущего процента, занятого в файле данных, превышает 100 процентов.
  
Для файлов журнала [!INCLUDE[ssDE](../../includes/ssde-md.md)] вычисляет целевой размер всего журнала на основе аргумента _целевой\_процент_. Вот почему _целевой\_процент_ — это объем свободного места в журнале после операции сжатия. Целевой размер всего журнала затем пересчитывается в целевой размер каждого файла журнала.
  
Инструкция DBCC SHRINKDATABASE пытается немедленно сжать каждый физический файл журнала до его целевого размера. Предположим, что в виртуальных файлах журнала нет частей логического журнала за пределами целевого размера файла журнала. Тогда файл будет успешно усечен, и инструкция DBCC SHRINKDATABASE завершится без сообщений. Однако если какая-то часть логического журнала хранится в виртуальных журналах за пределами заданного размера, то компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] освобождает как можно больше места, а затем выдает информационное сообщение. Сообщение описывает действия, которые необходимо предпринять, чтобы переместить логический журнал из виртуальных журналов в конец файла. После выполнения всех действий инструкция DBCC SHRINKDATABASE может быть использована для освобождения оставшегося пространства.
  
Файл журнала может быть сжат только до границы виртуального файла журнала. Именно поэтому сжатие файла журнала до размера, меньшего, чем размер виртуального файла журнала, может оказаться невозможным. Это также может быть невозможно, даже если он не используется. Размер виртуального файла журнала динамически выбирается компонентом [!INCLUDE[ssDE](../../includes/ssde-md.md)] при создании или расширении файлов журнала.
  
## <a name="best-practices"></a>Рекомендации  
Обратите внимание на следующие сведения при планировании сжатия базы данных.
-   Наибольший эффект от операции сжатия достигается при ее применении после операции, создающей неиспользуемое пространство, например после усечения таблицы или удаления таблицы.
-   Большинству баз данных требуется некоторое свободное пространство для выполнения обычных ежедневных операций. Можно сжать базу данных несколько раз и заметить, что она снова увеличивается в размерах. Такой рост указывает, что сжатое пространство необходимо для выполнения обычных операций. В таких случаях повторное сжатие базы данных бессмысленно.  
-   Операция сжатия не исключает фрагментацию индексов в базе данных и даже, наоборот, приводит к усилению фрагментации. Это еще одна причина, по которой не стоит выполнять регулярное сжатие базы данных.  
-   Не следует устанавливать параметр базы данных AUTO_SHRINK равным ON без достаточных на то оснований.  
  
## <a name="troubleshooting"></a>Устранение неполадок  
Операции сжатия могут быть блокированы транзакцией, запущенной с [уровнем изоляции, основанным на управлении версиями строк](../../t-sql/statements/set-transaction-isolation-level-transact-sql.md). Например, если выполняется масштабная операция удаления под уровнем изоляции с управлением версиями строк, когда запускается инструкция DBCC SHRINK DATABASE. Когда это происходит, операция сжатия будет ожидать, пока завершится операция удаления, прежде чем приступить к сжатию файлов. При возникновении такого ожидания для операций DBCC SHRINKFILE и DBCC SHRINKDATABASE выводится информационное сообщение (5202 для SHRINKDATABASE и 5203 для SHRINKFILE). Это сообщение выводится в журнал ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] каждые пять минут в течение первого часа, а затем каждый последующий час. Например, журнал ошибок содержит следующее сообщение об ошибке:  
  
```sql
DBCC SHRINKDATABASE for database ID 9 is waiting for the snapshot   
transaction with timestamp 15 and other snapshot transactions linked to   
timestamp 15 or with timestamps older than 109 to finish.  
```  
  
Эта ошибка означает, что транзакции моментальных снимков с отметками времени старше 109 заблокируют операцию сжатия. Такая транзакция — последняя транзакция, завершаемая операцией сжатия. Это также показывает, что столбцы **transaction_sequence_num** или **first_snapshot_sequence_num** в динамическом административном представлении [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql.md) содержат значение 15. Столбцы **transaction_sequence_num** или **first_snapshot_sequence_num** в представлении содержат меньшее число, чем последняя транзакция, выполненная операцией сжатия (109). В этом случае операция сжатия будет ждать завершения этих транзакций.
  
Разрешить эту проблему можно одним из следующих способов.
-   Прервите выполнение транзакции, которая блокирует операцию сжатия.  
-   Прервите операцию сжатия. Вся завершенная работа будет сохранена.  
-   Пока операция сжатия ожидает завершения блокирующей транзакции, ничего делать не нужно.  
  
## <a name="permissions"></a>Разрешения  
Необходимо быть членом предопределенной роли сервера **sysadmin** или предопределенной роли базы данных **db_owner** .  
  
## <a name="examples"></a>Примеры  
  
### <a name="a-shrinking-a-database-and-specifying-a-percentage-of-free-space"></a>A. Сжатие базы данных и определение количества свободного пространства в процентах  
В следующем примере уменьшается размер файлов данных и журнала в пользовательской базе данных `UserDB` с целью освободить 10 процентов свободного пространства в базе данных.  
  
```sql  
DBCC SHRINKDATABASE (UserDB, 10);  
GO  
```  
  
### <a name="b-truncating-a-database"></a>Б. Усечение базы данных  
В следующем примере файлы данных и журнала в образце базы данных `AdventureWorks` сжимаются до последнего выделенного экстента.  
  
```sql  
DBCC SHRINKDATABASE (AdventureWorks2012, TRUNCATEONLY);  
```  
### <a name="c-shrinking-an-azure-synapse-analytics-database"></a>В. Сжатие базы данных Azure Synapse Analytics

```
DBCC SHRINKDATABASE (database_A);
DBCC SHRINKDATABASE (database_B, 10); 

```

## <a name="see-also"></a>См. также раздел  
[ALTER DATABASE (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql.md)  
[DBCC (Transact-SQL)](../../t-sql/database-console-commands/dbcc-transact-sql.md)  
[DBCC SHRINKFILE (Transact-SQL)](../../t-sql/database-console-commands/dbcc-shrinkfile-transact-sql.md)  
[Сжатие базы данных](../../relational-databases/databases/shrink-a-database.md)
  
  
