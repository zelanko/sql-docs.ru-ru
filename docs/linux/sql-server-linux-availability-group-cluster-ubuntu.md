---
title: Настройка кластера Ubuntu для группы доступности SQL Server
titleSuffix: SQL Server
description: Дополнительные сведения о создании кластеров группы доступности для Ubuntu
author: MikeRayMSFT
ms.author: mikeray
manager: craigg
ms.date: 04/30/2018
ms.topic: conceptual
ms.prod: sql
ms.custom: sql-linux, seodec18
ms.technology: linux
ms.assetid: dd0d6fb9-df0a-41b9-9f22-9b558b2b2233
ms.openlocfilehash: b174f21cc0fa15404587f63019b5bcda2eb72534
ms.sourcegitcommit: 706f3a89fdb98e84569973f35a3032f324a92771
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2019
ms.locfileid: "58658108"
---
# <a name="configure-ubuntu-cluster-and-availability-group-resource"></a>Настройка кластера Ubuntu и ресурс группы доступности

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

В этом документе объясняется, как создать кластер с тремя узлами под управлением Ubuntu и добавьте ранее созданную группу доступности в качестве ресурса в кластере. Для обеспечения высокой доступности группы доступности в Linux требует трех узлов — см. в разделе [высокий уровень доступности и защиты данных для конфигураций группы доступности](sql-server-linux-availability-group-ha.md).

> [!NOTE] 
> На этом этапе не является образом связанных с WSFC в Windows, как интеграция с SQL Server с помощью Pacemaker в Linux. Из в SQL, есть нет сведений о наличии кластера и всех оркестрации выходит в службы управляется как отдельный экземпляр Pacemaker. Кроме того относится только к WSFC имя виртуальной сети, не имеет эквивалента в одной и той же в Pacemaker. Always On динамические административные представления, к которым запрос сведений о кластере возвращают пустые строки. По-прежнему можно создать прослушиватель, чтобы использовать его для прозрачного переподключения после отработки отказа, но вам необходимо вручную зарегистрировать имя прослушивателя в DNS-сервер с IP-адрес, используемый для создания виртуальный IP-адрес (как описано в следующих разделах).

Следующие разделы содержат описано, как можно настроить решение отказоустойчивого кластера. 

## <a name="roadmap"></a>Стратегия развития

Шаги по созданию группы доступности на серверах Linux для обеспечения высокой доступности, отличаются от действия, указанные на отказоустойчивый кластер Windows Server. Ниже перечислены основные действия. 

1. [Настройка SQL Server на узлах кластера](sql-server-linux-setup.md).

2. [Создание группы доступности](sql-server-linux-availability-group-configure-ha.md). 

3. Настройте диспетчер кластерных ресурсов, таких как Pacemaker. Эти инструкции приведены в этом документе.
   
   Способ настройки диспетчер ресурсов кластера зависит от конкретного дистрибутива Linux. 

   >[!IMPORTANT]
   >Рабочих средах требуется агент ограждения, например STONITH для обеспечения высокой доступности. Демонстрации в данной документации не имеют агентов ограждения. Демонстрации предназначены для тестирования и проверки только. 
   
   >Кластер Linux использует ограждения для возврата кластера в известное состояние. Способ настройки ограждения зависит от распределения и среды. В настоящее время ограждения недоступна в некоторых облачных средах. См. в разделе [политики поддержки для высокой доступности кластеров RHEL - платформ виртуализации](https://access.redhat.com/articles/29440) Дополнительные сведения.

5.  [Добавить в группу доступности в качестве ресурса кластера](sql-server-linux-availability-group-cluster-ubuntu.md#create-availability-group-resource). 

## <a name="install-and-configure-pacemaker-on-each-cluster-node"></a>Установка и настройка Pacemaker на каждом узле кластера

1. На всех узлах откройте порты брандмауэра. Откройте порт для службы Pacemaker высокого уровня доступности, экземпляр SQL Server и конечной точке группы доступности. TCP-порт по умолчанию для сервера SQL Server — 1433.  

   ```bash
   sudo ufw allow 2224/tcp
   sudo ufw allow 3121/tcp
   sudo ufw allow 21064/tcp
   sudo ufw allow 5405/udp
        
   sudo ufw allow 1433/tcp # Replace with TDS endpoint
   sudo ufw allow 5022/tcp # Replace with DATA_MIRRORING endpoint
        
   sudo ufw reload
   ```
   
   Кроме того можно просто отключить брандмауэр:
        
   ```bash
   sudo ufw disable
   ```

1. Установите пакеты Pacemaker. На всех узлах выполните следующие команды:

   ```bash
   sudo apt-get install pacemaker pcs fence-agents resource-agents
   ```

2. Задайте пароль для пользователя по умолчанию, который создается при установке пакетов Pacemaker и Corosync. Используйте на всех узлах один и тот же пароль. 

   ```bash
   sudo passwd hacluster
   ```

## <a name="enable-and-start-pcsd-service-and-pacemaker"></a>Включите и запустите службу pcsd и Pacemaker

Следующая команда включает и запускает службу pcsd и pacemaker. Выполните на всех узлах. Это позволяет узлов к кластеру после перезагрузки. 

```bash
sudo systemctl enable pcsd
sudo systemctl start pcsd
sudo systemctl enable pacemaker
```
>[!NOTE]
>Команды Enable pacemaker может завершиться с ошибкой «pacemaker по умолчанию-начало содержит не runlevels, прерывание.» Это безвредным, можно продолжить настройку кластера. 

## <a name="create-the-cluster"></a>Создание кластера

1. Удалите все существующие конфигурации кластера со всех узлов. 

   Выполнение «sudo apt-get install компьютеров под управлением» устанавливает ПК, pacemaker и corosync в то же время и запускает выполнение всех 3 служб.  Запуск corosync создает шаблон "/ etc/cluster/corosync.conf" файла.  Для успешного выполнения этот файл дальнейшие действия не должно существовать - Чтобы обойти эту проблему, необходимо остановить pacemaker и corosync и удалите "/ etc/cluster/corosync.conf", а затем выполните следующие шаги. «ПК cluster destroy» делает то же самое, и его можно использовать как этап настройки времени исходного кластера.
   
   Следующая команда удаляет существующие файлы конфигурации кластера и останавливает все службы кластера. Это окончательно уничтожает кластера. Запустите его в качестве первого шага в подготовительной среде. Обратите внимание что «ПК cluster destroy» отключить службу pacemaker и ему нужно повторно включать. Выполните на всех узлах следующую команду.
   
   >[!WARNING]
   >Команда удаляет существующие ресурсы кластера.

   ```bash
   sudo pcs cluster destroy 
   sudo systemctl enable pacemaker
   ```

1. Создайте кластер. 

   >[!WARNING]
   >Связи с известной проблемой кластеризации поставщика, исследование, начиная со следующей ошибкой перехода кластера («ПК кластера start»). Это, так как настроенный файл журнала в /etc/corosync/corosync.conf создается при запуске команды setup кластера, не так. Чтобы обойти эту проблему, измените файл журнала для: /var/log/corosync/corosync.log. В качестве альтернативы можно создать файл /var/log/cluster/corosync.log.
 
   ```Error
   Job for corosync.service failed because the control process exited with error code. 
   See "systemctl status corosync.service" and "journalctl -xe" for details.
   ```
  
Следующая команда создает кластер с тремя узлами. Перед выполнением данного сценария замените значения между `< ... >`. Выполните следующую команду на основном узле. 

   ```bash
   sudo pcs cluster auth <node1> <node2> <node3> -u hacluster -p <password for hacluster>
   sudo pcs cluster setup --name <clusterName> <node1> <node2...> <node3>
   sudo pcs cluster start --all
   sudo pcs cluster enable --all
   ```
   
   >[!NOTE]
   >Если кластер был настроен ранее на тех же узлах, используйте параметр --force при выполнении команды pcs cluster setup. Обратите внимание, что это эквивалентно команде pcs cluster destroy. Службу Pacemaker необходимо включить повторно с помощью команды sudo systemctl enable pacemaker.


## <a name="configure-fencing-stonith"></a>Настройка ограждения (STONITH)

Поставщики кластера pacemaker требуются STONITH включения и ограждения устройства, настроенные для настройки кластера, поддерживаемых. Если диспетчер кластерных ресурсов не может определить состояние узла или ресурса на узле, ограждения используется для ввода кластера в известное состояние еще раз. Ресурс уровня ограждения обеспечивается главным образом наличие повреждений данных в случае сбоя путем настройки ресурса. Можно использовать ограждения уровня ресурсов, например, с DRBD (Distributed реплицированные блочное устройство) для обозначения диска на узле как устаревшие, когда канал связи выходит из строя. Узел уровня ограждения гарантирует, что узел не все ресурсы. Это делается путем сброса параметров узла и его реализация Pacemaker вызывается STONITH (что означает «устранение неисправностей другой узел в заголовке»). Pacemaker поддерживает выполнения разнообразных устройств ограждения, например источник бесперебойного питания или управления карт для серверов. Дополнительные сведения см. в разделе [кластеров Pacemaker с нуля](https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/) и [ограждения и Stonith](https://clusterlabs.org/doc/crm_fencing.html) 

Так как уровень узла ограждения конфигурации во многом зависит от среды, мы отключаем в этом руководстве (его можно настроить позже). Выполните следующий скрипт на основном узле: 

```bash
sudo pcs property set stonith-enabled=false
```

>[!IMPORTANT]
>Отключение STONITH — только для целей тестирования. Если вы планируете использовать Pacemaker в рабочей среде, следует планировать реализацию STONITH в зависимости от среды и оставьте флажок. Обратите внимание, что на этом этапе нет агентов ограждения для облачных сред (в том числе Azure) или Hyper-V. Следовательно кластера поставщика не обеспечивает поддержку для запуска рабочих кластеров в этих средах. 

## <a name="set-cluster-property-cluster-recheck-interval"></a>Установка свойства кластера кластера перепроверка интервала

`cluster-recheck-interval` Указывает интервал опроса, по которому проверяет кластера, для изменения параметров ресурсов, ограничения или другие параметры кластера. Если реплика выходит из строя, кластер пытается выполнить перезапуск реплики с интервалом, привязанного с `failure-timeout` значение и `cluster-recheck-interval` значение. Например если `failure-timeout` составляет 60 секунд и `cluster-recheck-interval` имеет значение 120 секунд, производится попытка перезагрузки с интервалом, превышает 60 секунд, но менее 120 секунд. Рекомендуется задать время ожидания сбоя 60s и кластера перепроверка-значение интервала больше 60 секунд. Установка кластера перепроверка интервала небольшое значение не рекомендуется.

Чтобы обновить значение свойства для `2 minutes` запуска:

```bash
sudo pcs property set cluster-recheck-interval=2min
```

> [!IMPORTANT] 
> Если вас уже есть ресурс группы доступности, под управлением кластера Pacemaker, обратите внимание, что все распределения, использующих последние доступные Pacemaker пакет 1.1.18-11.el7 вносит изменение поведения для начала сбоя — Неустранимая кластера, параметр, если его значение — false. Это изменение затрагивает рабочий процесс отработки отказа. Если первичная реплика, произошел сбой, ожидается кластера отработки отказа в одной из доступных вторичных реплик. Вместо этого пользователи заметят, что кластер сисадмин пытается запустить сбой первичной реплики. Если этой основной никогда не подключается к сети (из-за постоянных сбой), никогда не перехода кластера на другой доступную вторичную реплику. Из-за этого изменения рекомендованные конфигурации для задания начала сбоя — Неустранимая больше не является допустимым и должен вернуть значение по умолчанию `true`. Кроме того, ресурс группы Доступности должен быть обновлен для включения `failover-timeout` свойство. 
>
>Чтобы обновить значение свойства для `true` запуска:
>
>```bash
>sudo pcs property set start-failure-is-fatal=true
>```
>
>Обновить существующие свойства ресурсов группы Доступности `failure-timeout` для `60s` запуска (Замените `ag1` с именем ресурса группы доступности):
>
>```bash
>pcs resource update ag1 meta failure-timeout=60s
>```

## <a name="install-sql-server-resource-agent-for-integration-with-pacemaker"></a>Установите агент ресурсов SQL Server для интеграции с помощью Pacemaker

Выполните следующие команды на всех узлах. 

```bash
sudo apt-get install mssql-server-ha
```

## <a name="create-a-sql-server-login-for-pacemaker"></a>Создание имени входа SQL Server для Pacemaker

[!INCLUDE [SLES-Create-SQL-Login](../includes/ss-linux-cluster-pacemaker-create-login.md)]

## <a name="create-availability-group-resource"></a>Создайте ресурс группы доступности

Чтобы создать ресурс группы доступности, используйте `pcs resource create` команды и задать свойства ресурса. Ниже команда создает `ocf:mssql:ag` тип ресурса для группы доступности с именем, ведущий/ведомый `ag1`. 

```bash
sudo pcs resource create ag_cluster ocf:mssql:ag ag_name=ag1 meta failure-timeout=30s --master meta notify=true

```

[!INCLUDE [required-synchronized-secondaries-default](../includes/ss-linux-cluster-required-synchronized-secondaries-default.md)]

## <a name="create-virtual-ip-resource"></a>Создайте виртуальный IP-адрес

Чтобы создать виртуальный ресурс IP-адреса, выполните следующую команду на одном узле. Используйте доступные статические IP-адресом из сети. Перед выполнением скрипта замените значения между `< ... >` допустимый IP-адрес.

```bash
sudo pcs resource create virtualip ocf:heartbeat:IPaddr2 ip=<10.128.16.240>
```

Отсутствует имя виртуального сервера, эквивалент в Pacemaker. Чтобы использовать строку подключения, указывающую на имя сервера строку и не используйте IP-адрес, зарегистрируйте IP-адрес ресурса и имя нужного виртуального сервера в DNS. Для конфигураций аварийного восстановления Зарегистрируйте имя нужного виртуального сервера и IP-адрес с DNS-серверов на основном сервере и сайт аварийного восстановления.

## <a name="add-colocation-constraint"></a>Добавить ограничение среды для совместной работы

Практически каждое решение в кластере Pacemaker, такие как выбор, где должны запускаться ресурс, выполняется путем сравнения оценок. Вычисления оценки для одного ресурса, и диспетчер кластерных ресурсов выбирает узел с наивысшей оценкой для конкретного ресурса. (Если на узле имеется отрицательной оценки для ресурса, ресурс нельзя запустить на этом узле.) Ограничения можно используйте для настройки решения кластера. Ограничения имеют оценку. Если ограничение имеет показатель ниже, чем БЕСКОНЕЧНОСТИ, это только рекомендация. Оценка бесконечность означает, что он является обязательным. Чтобы убедиться, что первичная реплика и виртуальный IP-адрес ресурса находятся на том же узле, определите ограничение совместного размещения с оценкой бесконечность. Чтобы добавить ограничение среды для совместной работы, выполните следующую команду на одном узле. 

```bash
sudo pcs constraint colocation add virtualip ag_cluster-master INFINITY with-rsc-role=Master
```

## <a name="add-ordering-constraint"></a>Добавление ограничения упорядочивания

Ограничения совместного размещения имеет неявное ограничение упорядочивания. Он перемещает виртуальный IP-адрес до перемещения ресурса группы доступности. По умолчанию является последовательность событий:

1. Пользователь выполняет `pcs resource move` источник группы доступности с узла 1 на узел node2.
1. Виртуальный IP-адрес останавливается на узле node1.
1. Виртуальный IP-адрес начинается на node2.

   >[!NOTE]
   >На этом этапе IP-адрес временно точек на узел node2 а узел2 — по прежнему до отработки отказа вторичной. 
   
1. Группу доступности основной на node1 понижается до вторичной.
1. Группы доступности вторичной базы данных на узел node2 повышается до основного. 

Чтобы предотвратить временно, указывающие на узел с дополнительным до отработки отказа IP-адрес, добавьте ограничения упорядочивания. 

Чтобы добавить ограничения упорядочивания, выполните следующую команду на одном узле:

```bash
sudo pcs constraint order promote ag_cluster-master then start virtualip
```

>[!IMPORTANT]
>После настройки кластера и добавлению группы доступности в качестве ресурса кластера, Transact-SQL нельзя использовать для отработки отказа ресурсов этой группы доступности. Ресурсы кластера SQL Server в Linux не связаны тесно как с операционной системой, как они находятся на кластер отработки отказа Windows Server (WSFC). Службы SQL Server не учитывает наличие кластера. Все согласование осуществляется с помощью средства управления кластером. В RHEL или Ubuntu используйте `pcs`. 

<!---[!INCLUDE [Pacemaker Concepts](..\includes\ss-linux-cluster-pacemaker-concepts.md)]--->

## <a name="next-steps"></a>Следующие шаги

[Работать с высоким уровнем ДОСТУПНОСТИ группы доступности](sql-server-linux-availability-group-failover-ha.md)

