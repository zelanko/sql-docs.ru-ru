---
title: Шаблоны развертывания групп доступности — SQL Server на Linux
description: Узнайте о поддерживаемых конфигурациях развертывания для групп доступности Always On SQL Server на серверах Linux.
ms.custom: seo-lt-2019
ms.date: 04/17/2019
ms.prod: sql
ms.technology: linux
ms.topic: conceptual
ms.assetid: edd75f68-dc62-4479-a596-57ce8ad632e5
author: MikeRayMSFT
ms.author: mikeray
ms.reviewer: vanto
ms.openlocfilehash: 28a9541c1369202b8bd322cc23201e8d531f913e
ms.sourcegitcommit: f7ac1976d4bfa224332edd9ef2f4377a4d55a2c9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85892254"
---
# <a name="high-availability-and-data-protection-for-availability-group-configurations"></a>Высокий уровень доступности и защита данных для конфигураций группы доступности

[!INCLUDE [SQL Server - Linux](../includes/applies-to-version/sql-linux.md)]

Эта статья описывает поддерживаемые конфигурации развертывания для групп доступности Always On SQL Server на серверах Linux. Группа доступности поддерживает высокую доступность и защиту данных. Автоматическое обнаружение сбоев, автоматическая отработка отказа и прозрачное переподключение после отработки отказа обеспечивают высокую доступность. Синхронизированные реплики обеспечивают защиту данных. 

В отказоустойчивом кластере Windows Server (WSFC) для типичной конфигурации высокой доступности используются две синхронные реплики и третий сервер или файловый ресурс-свидетель для обеспечения кворума. Файловый ресурс-свидетель проверяет конфигурацию группы доступности, например состояние синхронизации и роль реплики. Эта конфигурация гарантирует, что вторичная реплика, выбранная в качестве цели отработки отказа, будет иметь актуальные изменения конфигурации группы доступности и данных. 

WSFC синхронизирует метаданные конфигурации для арбитража отработки отказа между репликами группы доступности и файловым ресурсом-свидетелем. Если группа доступности находится не в WSFC, экземпляры SQL Server хранят метаданные конфигурации в базе данных master.

Например, группа доступности в кластере Linux имеет `CLUSTER_TYPE = EXTERNAL`. WSFC для арбитража отработки отказа отсутствует. В этом случае метаданные конфигурации управляются и обслуживаются экземплярами SQL Server. Так как в этом кластере нет следящего сервера, для хранения метаданных состояния конфигурации требуется третий экземпляр SQL Server. Вместе все три экземпляра SQL Server предоставляют распределенное хранилище метаданных для кластера. 

Диспетчер кластеров может запрашивать экземпляры SQL Server в группе доступности и управлять отработкой отказа для обеспечения высокой доступности. В кластере Linux Pacemaker является диспетчером кластеров. 

SQL Server 2017 с накопительным пакетом обновления 1 обеспечивает высокую доступность для группы доступности с `CLUSTER_TYPE = EXTERNAL` для двух синхронных реплик и репликой, поддерживающей только конфигурацию. Реплика, поддерживающая только конфигурацию, может размещаться в любом выпуске SQL Server 2017 с накопительным пакетом обновления 1 или более поздней версии, включая выпуск SQL Server Express. Реплика, поддерживающая только конфигурацию, хранит сведения о конфигурации для группы доступности в базе данных master, но не содержит пользовательские базы данных в группе доступности. 

## <a name="how-the-configuration-affects-default-resource-settings"></a>Влияние конфигурации на параметры ресурсов по умолчанию

SQL Server 2017 представляет параметр ресурса кластера `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`. Этот параметр гарантирует, что указанное число вторичных реплик записывает транзакционные данные в журнал до фиксации каждой транзакции первичной репликой. При использовании внешнего диспетчера кластеров этот параметр влияет как на высокую доступность, так и на защиту данных. Значение по умолчанию для этого параметра зависит от архитектуры на момент создания ресурса кластера. При установке агента ресурсов SQL Server `mssql-server-ha` и создании ресурса кластера для группы доступности диспетчер кластеров определяет конфигурацию группы доступности и задает `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` соответствующим образом. 

Если это поддерживается конфигурацией, параметру `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` агента ресурсов присваивается значение, обеспечивающее высокую доступность и защиту данных. Дополнительные сведения см в статье [Агент ресурсов SQL Server для Pacemaker](#pacemakerNotify).

В следующих разделах описано поведение по умолчанию для ресурса кластера. 

Выберите структуру группы доступности, соответствующую конкретным бизнес-требования по обеспечению высокой доступности, защиты данных и масштабирования для чтения.

Следующие конфигурации описывают конструктивные шаблоны группы доступности и возможности каждого из них. Эти конструктивные шаблоны применяются к группам доступности с `CLUSTER_TYPE = EXTERNAL` для решений высокой доступности. 

- **Три синхронные реплики**
- **Две синхронные реплики**
- **Две синхронные реплики и реплика, поддерживающая только конфигурацию**

<a name="threeSynch"></a>

## <a name="three-synchronous-replicas"></a>Три синхронные реплики

Эта конфигурация состоит из трех синхронных реплик. По умолчанию она обеспечивает высокую доступность и защиту данных. Она также может обеспечить масштабирование для чтения.

![Три реплики][3]

Группа доступности с тремя синхронными репликами может обеспечивать масштабирование для чтения, высокую доступность и защиту данных. В следующей таблице описан режим доступности. 

| |Масштабирование для чтения|Высокая доступность и </br> защита данных | Защита данных|
|:---|---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 |1<sup>\*</sup>|2|
|Сбой первичной реплики |Автоматический переход на другой ресурс. Новая первичная реплика доступна для чтения и записи. |Автоматический переход на другой ресурс. Новая первичная реплика доступна для чтения и записи. |Автоматический переход на другой ресурс. Новая первичная реплика недоступна для пользовательских транзакций до тех пор, пока предыдущая первичная реплика не будет восстановлена и не присоединится к группе доступности в качестве вторичной. |
|Сбой одной вторичной реплики  | Первичная реплика доступна для чтения и записи. Отсутствие автоматической отработки отказа при сбое первичной реплики. |Первичная реплика доступна для чтения и записи. Также отсутствие автоматической отработки отказа при сбое первичной реплики. | Первичная реплика недоступна для пользовательских транзакций. |

<sup>\*</sup> По умолчанию

<a name="twoSynch"></a>

## <a name="two-synchronous-replicas"></a>Две синхронные реплики

Эта конфигурация обеспечивает защиту данных. Как и в других конфигурациях групп доступности, она может включать масштабирование для чтения. Конфигурация из двух синхронных реплик не обеспечивает автоматическую высокую доступность. Конфигурация из двух реплик применима только к SQL Server 2017 RTM и больше не поддерживается в более поздних версиях SQL Server 2017 (с накопительным пакетом обновления 1 и выше).

![Две синхронные реплики][1]

Группа доступности с двумя синхронными репликами обеспечивает масштабирование для чтения и защиту данных. В следующей таблице описан режим доступности. 

| |Масштабирование для чтения |Защита данных|
|:---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>\*</sup>|1|
|Сбой первичной реплики | Переход на другой ресурс вручную. Возможна потеря данных. Новая первичная реплика доступна для чтения и записи.| Автоматический переход на другой ресурс. Новая первичная реплика недоступна для пользовательских транзакций до тех пор, пока предыдущая первичная реплика не будет восстановлена и не присоединится к группе доступности в качестве вторичной.|
|Сбой одной вторичной реплики  |Первичная реплика доступна для чтения и записи и подвержена риску потери данных. |Первичная реплика недоступна для пользовательских транзакций до восстановления вторичной.|

<sup>\*</sup> По умолчанию

<a name = "configOnly"></a>

## <a name="two-synchronous-replicas-and-a-configuration-only-replica"></a>Две синхронные реплики и реплика, поддерживающая только конфигурацию

Группа доступности с двумя (или более) синхронными репликами и репликой, поддерживающей только конфигурацию, обеспечивает защиту данных, а также может обеспечить высокую доступность. Эта архитектура представлена на следующей схеме.

![Группа доступности, поддерживающая только конфигурацию][2]

1. Синхронная репликация пользовательских данных на вторичную реплику. Она также включает метаданные конфигурации группы доступности.
2. Синхронная репликация метаданных конфигурации группы доступности. Она не включает пользовательские данные.

На схеме группы доступности первичная реплика передает данные конфигурации во вторичную реплику и реплику, поддерживающую только конфигурацию. Вторичная реплика также получает пользовательские данные. Реплика, поддерживающая только конфигурацию, не получает пользовательские данные. Вторичная реплика находится в режиме синхронной доступности. Реплика, поддерживающая только конфигурацию, не содержит базы данных в группе — только метаданные о группе доступности. Данные конфигурации на реплике, поддерживающей только конфигурацию, фиксируются синхронно.

> [!NOTE]
> Группа доступности с репликой, поддерживающей только конфигурацию, впервые появилась в SQL Server 2017 с накопительным пакетом обновления 1. Все экземпляры SQL Server в группе доступности должны быть экземплярами SQL Server 2017 с накопительным пакетом обновления 1 или более поздней версии. 

Значение по умолчанию для `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` равно 0. В следующей таблице описан режим доступности. 

| |Высокая доступность и </br> защита данных | Защита данных|
|:---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>\*</sup>|1|
|Сбой первичной реплики | Автоматический переход на другой ресурс. Новая первичная реплика доступна для чтения и записи. | Автоматический переход на другой ресурс. Новая первичная реплика недоступна для пользовательских транзакций. |
|Сбой вторичной реплики | Первичная реплика доступна для чтения и записи и подвержена риску потери данных (если на первой произошел сбой и ее не удается восстановить). Также отсутствие автоматической отработки отказа при сбое первичной реплики. | Первичная реплика недоступна для пользовательских транзакций. Также отсутствие реплики для отработки отказа при сбое первичной реплики. |
|Сбой реплики, поддерживающей только конфигурацию | Первичная реплика доступна для чтения и записи. Также отсутствие автоматической отработки отказа при сбое первичной реплики. | Первичная реплика доступна для чтения и записи. Также отсутствие автоматической отработки отказа при сбое первичной реплики. |
|Синхронный сбой вторичной реплики и реплики, поддерживающей только конфигурацию| Первичная реплика недоступна для пользовательских транзакций. Отсутствие автоматической отработки отказа. | Первичная реплика недоступна для пользовательских транзакций. Также отсутствие реплики для отработки отказа при сбое первичной реплики. |

<sup>\*</sup> По умолчанию

> [!NOTE]
> Экземпляр SQL Server, на котором размещена реплика, поддерживающая только конфигурацию, может также содержать другие базы данных. Он также может использоваться в качестве базы данных, поддерживающей только конфигурацию, для нескольких групп доступности. 

## <a name="requirements"></a>Требования

- Все реплики в группе доступности с репликой, поддерживающей только конфигурацию, должны использовать SQL Server 2017 с накопительным пакетом обновления 1 или более поздней версии.
- Реплика, поддерживающая только конфигурацию, может размещаться в любом выпуске SQL Server, включая SQL Server Express. 
- В дополнение к первичной реплике для группы доступности требуется по меньшей мере одна вторичная реплика.
- Реплики, поддерживающие только конфигурацию, не учитываются при подсчете максимального количества реплик на экземпляр SQL Server. Выпуск SQL Server Standard поддерживает до трех реплик, SQL Server Enterprise — до 9.

## <a name="considerations"></a>Рекомендации

- Не более одной реплики, поддерживающей только конфигурацию, для каждой группы доступности. 
- Реплика, поддерживающая только конфигурацию, не может быть первичной.
- Невозможно изменить режим доступности для реплики, поддерживающей только конфигурацию. Чтобы переключиться с реплики, поддерживающей только конфигурацию, на синхронную или асинхронную вторичную реплику, удалите реплику, поддерживающую только конфигурацию, и добавьте вторичную реплику с требуемым режимом доступности. 
- Реплика, поддерживающая только конфигурацию, синхронна с метаданными группы доступности. Пользовательские данные отсутствуют. 
- Группа доступности с одной первичной репликой и одной репликой, поддерживающей только конфигурацию, но не имеющая вторичной реплики, является недопустимой. 
- Вы не можете создать группу доступности на экземпляре выпуска SQL Server Express. 

<a name="pacemakerNotify"></a>

## <a name="understand-sql-server-resource-agent-for-pacemaker"></a>Агент ресурсов SQL Server для Pacemaker

В SQL Server 2017 CTP 1.4 был добавлен `sequence_number` в `sys.availability_groups`, чтобы Pacemaker мог определить, насколько актуально состояние вторичных реплик относительно первичной. `sequence_number` является монотонно возрастающим значением типа bigint, показывающим, насколько актуальна локальная реплика группы доступности. Pacemaker обновляет `sequence_number` при каждом изменении конфигурации группы доступности. Примерами изменений конфигурации могут быть отработка отказа, добавление или удаление реплики. Сначала значение обновляется на первичной реплике, а затем реплицируется на вторичные. Таким образом вторичная реплика с актуальной конфигурацией имеет тот же порядковый номер, что и первичная. 

Когда появляется необходимость в обновлении реплики до первичной, Pacemaker отправляет уведомления о *предварительном повышении уровня* во все реплики. Реплики возвращают порядковый номер. Затем, когда Pacemaker пытается обновить реплику до первичной, она обновляется, только если ее порядковый номер выше номеров всех остальных реплик. Если ее собственный порядковый номер не соответствует наибольшему порядковому номеру, реплика отклоняет операцию повышения уровня. Таким образом, до первичной реплики может быть обновлена только реплика с наибольшим значением порядкового номера, что позволяет избежать потери данных. 

Для этой процедуры необходимо, чтобы порядковый номер хотя бы одной реплики, доступной для повышения уровня, совпадал с номером прежней первичной реплики. Агент ресурсов Pacemaker по умолчанию настраивает `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` таким образом, чтобы хотя бы одна синхронная вторичная реплика была актуальна и доступна для целевого объекта автоматической отработки отказа. При каждом действии мониторинга значение `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` вычисляется (и, если нужно, обновляется). Значение `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` равно числу синхронных реплик, поделенному на 2. При отработке отказа агент ресурсов требует, чтобы (реплики `total number of replicas` - `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`) отреагировали на уведомление о предварительном повышении уровня. Реплика с самым высоким значение `sequence_number` повышается до первичной. 

Например, группа доступности с тремя синхронными репликами — одной первичной и двумя синхронными вторичными репликами.

- `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` равен 1; (3 / 2 -> 1).

- Количество реплик, которые должны отреагировать на действие предварительного повышения, равно 2; (3 – 1 = 2). 

В этом сценарии для активации отработки отказа отреагировать должны две реплики. Для успешной автоматической отработки отказа после сбоя первичной реплики обе вторичные реплики должны быть актуальны и отреагировать на уведомление о предварительном повышении уровня. Если они работают и синхронны, то имеют одинаковый порядковый номер. Группа доступности повышает уровень одной из них. Если только одна из вторичных реплик реагирует на действие предварительного повышения уровня, агент ресурсов не может гарантировать, что отреагировавшая реплика будет иметь наибольший порядковый номер (sequence_number), и отработка отказа не активируется.

> [!IMPORTANT]
> Нулевое значение `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` создает риск потери данных. Во время сбоя первичной реплики агент ресурсов не запускает отработку отказа автоматически. Можно либо дождаться восстановления первичной реплики, либо выполнить отработку отказа вручную с помощью `FORCE_FAILOVER_ALLOW_DATA_LOSS`.

Вы можете переопределить поведение по умолчанию, запретив ресурсу группы доступности задавать `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` автоматически.

Следующий скрипт задает для `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` значение 0 в группе доступности `<**ag1**>`. Прежде чем выполнять переход, замените `<**ag1**>` на имя группы доступности.

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=0
```

Для возврата к значению по умолчанию в зависимости от конфигурации группы доступности выполните следующую команду.

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=
```

> [!NOTE]
> При выполнении приведенных выше команд первичная реплика временно понижается до уровня вторичной, а затем снова повышается. При обновлении ресурса все реплики останавливаются и перезапускаются. Новое значение для `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` задается не сразу, а только после перезапуска реплик.

## <a name="see-also"></a>См. также раздел

[Группы доступности в Linux](sql-server-linux-availability-group-overview.md)

<!--Image references-->
[1]: ./media/sql-server-linux-availability-group-ha/1-read-scale-out.png
[2]: ./media/sql-server-linux-availability-group-ha/2-configuration-only.png
[3]: ./media/sql-server-linux-availability-group-ha/3-three-replica.png
[4]: ./media/sql-server-linux-availability-group-ha/configuration-only-example.png
