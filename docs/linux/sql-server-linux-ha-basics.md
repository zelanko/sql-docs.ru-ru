---
title: Высокий уровень доступности SQL Server для развертываний Linux
description: Сведения о вариантах обеспечения высокого уровня доступности для SQL Server на Linux, таких как группы доступности Always On, экземпляры отказоустойчивого кластера и доставка журналов.
ms.custom: seo-lt-2019
author: MikeRayMSFT
ms.author: mikeray
ms.reviewer: vanto
ms.date: 11/27/2017
ms.topic: conceptual
ms.prod: sql
ms.technology: linux
ms.openlocfilehash: c7b22e569f17ca7297483d0b5286ecc77a9a14e5
ms.sourcegitcommit: f7ac1976d4bfa224332edd9ef2f4377a4d55a2c9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85895309"
---
# <a name="sql-server-availability-basics-for-linux-deployments"></a>Основные сведения о доступности SQL Server для развертываний Linux

[!INCLUDE [SQL Server - Linux](../includes/applies-to-version/sql-linux.md)]

Начиная с [!INCLUDE[sssql17-md](../includes/sssql17-md.md)][!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] поддерживается и в Linux, и в Windows. Как и развертывания [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Windows, базы данных и экземпляры [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] должны иметь высокий уровень доступности в Linux. В этой статье рассматриваются технические аспекты планирования и развертывания баз данных и экземпляров [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] с высоким уровнем доступности на основе Linux, а также приводятся некоторые отличия от установок на основе Windows. Поскольку специалисты Linux могут быть плохо знакомы с [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], а пользователи [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] могут не иметь опыта работы с Linux, в этой статье иногда встречаются понятия, знакомые одним и незнакомые другим.

## <a name="ssnoversion-md-availability-options-for-linux-deployments"></a>Варианты доступности [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] для развертываний Linux
Помимо резервного копирования и восстановления, в Linux поддерживаются те же три компонента доступности, что и в развертываниях на основе Windows.
-   Группы доступности Always On (AG)
-   Экземпляры отказоустойчивого кластера Always On (FCI)
-   [Доставка журналов](sql-server-linux-use-log-shipping.md)

В Windows экземпляр FCI всегда должен находиться в отказоустойчивом кластере Windows Server (WSFC). В зависимости от сценария развертывания группа доступности обычно должна располагаться в кластере WSFC. Исключением является новый вариант None в [!INCLUDE[sssql17-md](../includes/sssql17-md.md)]. В Linux нет кластера WSFC. Реализация кластеризации в Linux рассматривается в разделе [Pacemaker для групп доступности Always On и экземпляров отказоустойчивых кластеров в Linux](#pacemaker-for-always-on-availability-groups-and-failover-cluster-instances-on-linux).

## <a name="a-quick-linux-primer"></a>Краткое руководство по Linux
Хотя некоторые установки Linux могут быть установлены с интерфейсом, в большинстве из них интерфейс отсутствует, то есть практически все действия на уровне операционной системы выполняются через командную строку. Эта командная строка в среде Linux называется *оболочкой bash*.

В Linux многие команды должны запускаться с повышенными привилегиями, что соответствует выполнению многих задач в Windows Server с правами администратора. Существует два основных метода выполнения задач с повышенными привилегиями.
1. Выполнение в контексте соответствующего пользователя. Чтобы сменить пользователя, используйте команду `su`. Если `su` выполняется в собственном контексте без имени пользователя, при условии, что вам известен пароль, вы будете находиться в оболочке с правами *root*.
   
2. Наиболее распространенным и безопасным способом является предварительное использование `sudo`. Вы увидите `sudo` во многих примерах в этой статье.

Ниже приводятся некоторые распространенные команды, у каждой из которых есть различные параметры, доступные для поиска в Интернете.
-   `cd` — изменение каталога
-   `chmod` — изменение разрешений для файла или каталога
-   `chown` — изменение владельца файла или каталога
-   `ls` — отображение содержимого каталога
-   `mkdir` — создание папки (каталога) на диске
-   `mv` — перемещение файла из одного места в другое
-   `ps` — отображение всех рабочих процессов
-   `rm` — удаление файла локально на сервере
-   `rmdir` — удаление папки (каталога)
-   `systemctl` — запуск, остановка или включение служб
-   Команды текстового редактора. В Linux существуют различные параметры текстового редактора, например vi и emacs.

## <a name="common-tasks-for-availability-configurations-of-ssnoversion-md-on-linux"></a>Типичные задачи для конфигураций доступности [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на Linux
В этом разделе рассматриваются задачи, общие для всех развертываний [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Linux.

### <a name="ensure-that-files-can-be-copied"></a>Возможность копирования файлов
Копирование файлов с одного сервера на другой — это задача, которая должна быть доступна любому пользователю [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на Linux. Она очень важна для конфигураций группы доступности.

И в Linux, и в установках на основе Windows не исключены проблемы с разрешениями. Однако пользователи, которые легко справляются с копированием с сервера на сервер в Windows, могут не знать, как это делается в Linux. Распространенным способом является использование служебной программы командной строки `scp`, которая расшифровывается как "secure copy" (безопасное копирование). В фоновом режиме `scp` использует OpenSSH. SSH означает "secure shell" (безопасная оболочка). В зависимости от дистрибутива Linux сам пакет OpenSSH может не устанавливаться. В этой ситуации необходимо сначала установить OpenSSH. Дополнительные сведения о настройке OpenSSH см. по следующим ссылкам для каждого дистрибутива:
-   [Red Hat Enterprise Linux (RHEL)](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/ch-openssh)
-   [SUSE Linux Enterprise Server (SLES)](https://en.opensuse.org/SDB:Configure_openSSH)
-   [Ubuntu](https://help.ubuntu.com/community/SSH/OpenSSH/Configuring)

При использовании `scp` необходимо указать учетные данные сервера, если он не является исходным или целевым. Например, следующая команда

```bash
scp MyAGCert.cer username@servername:/folder/subfolder
```

копирует файл MyAGCert.cer в папку, указанную на другом сервере. Обратите внимание, что для копирования файла необходимо иметь соответствующие разрешения и, возможно, быть владельцем файла. Поэтому перед копированием также может потребоваться `chown`. Кроме того, на принимающей стороне работать с файлом должен пользователь с надлежащими правами. Например, чтобы восстановить этот файл сертификата, пользователь `mssql` должен иметь к нему доступ.

Создавать общие ресурсы, доступ к которым осуществляется по UNC-путям, таким как `\\SERVERNAME\SHARE`, можно с помощью Samba, который является разновидностью протокола SMB в Linux. Дополнительные сведения о настройке Samba см. по следующим ссылкам для каждого дистрибутива:
-   [RHEL](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Managing_Confined_Services/chap-Managing_Confined_Services-Samba.html)
-   [SLES](https://www.suse.com/documentation/sles11/book_sle_admin/data/cha_samba.html)
-   [Ubuntu](https://help.ubuntu.com/community/Samba)

Также можно использовать общие ресурсы SMB на основе Windows. Общие ресурсы SMB не должны быть основаны на Linux, если клиентская часть Samba правильно настроена на сервере Linux, где размещается [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], и общему ресурсу заданы соответствующие права доступа. Пользователи, работающие в смешанной среде, для развертываний [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Linux могут использовать существующую инфраструктуру.

Важно отметить, что версия развернутого пакета Samba должна быть совместима с SMB 3.0. После добавления поддержки SMB в [!INCLUDE[sssql11-md](../includes/sssql11-md.md)] все общие ресурсы должны поддерживать SMB 3.0. Если в качестве общего ресурса используется Samba, а не Windows Server, то общий ресурс на основе Samba должен поддерживать Samba 4.0 или более позднюю версию, а в идеале — 4.3 или более позднюю версию, которая поддерживает SMB 3.1.1. Сведения об SMB и Linux см. в документе об [SMB3 в Samba](https://events.static.linuxfound.org/sites/events/files/slides/smb3-in-samba.pr__0.pdf).

Кроме того, можно использовать общий ресурс сетевой файловой системы (NFS). NFS не подходит для развертываний [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Windows и может применяться только для развертываний на основе Linux.

### <a name="configure-the-firewall"></a>Настройка брандмауэра
Как и в Windows, дистрибутивы Linux имеют встроенный брандмауэр. Если ваша организация использует для серверов внешний брандмауэр, в Linux допускается отключение брандмауэров. Однако независимо от того, на какой платформе включен брандмауэр, необходимо открыть порты. В следующей таблице приводятся стандартные порты, необходимые для высокодоступных развертываний [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на Linux.

| Номер порта | Тип     | Описание                                                                                                                 |
|-------------|----------|-----------------------------------------------------------------------------------------------------------------------------|
| 111         | TCP/UDP  | NFS — `rpcbind/sunrpc`                                                                                                    |
| 135         | TCP      | Samba (если используется) — сопоставитель конечных точек                                                                                          |
| 137         | UDP      | Samba (если используется) — служба имен NetBIOS                                                                                      |
| 138         | UDP      | Samba (если используется) — датаграмма NetBIOS                                                                                          |
| 139         | TCP      | Samba (если используется) — сеанс NetBIOS                                                                                           |
| 445         | TCP      | Samba (если используется) — SMB по TCP                                                                                              |
| 1433        | TCP      | [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] — порт по умолчанию. При необходимости можно изменить на `mssql-conf set network.tcpport <portnumber>`.                       |
| 2049        | TCP, UDP | NFS (если используется)                                                                                                               |
| 2224        | TCP      | Pacemaker — используется `pcsd`                                                                                                |
| 3121        | TCP      | Pacemaker — требуется при наличии удаленных узлов Pacemaker                                                                    |
| 3260        | TCP      | Инициатор iSCSI (если используется) — может быть изменен в `/etc/iscsi/iscsid.config` (RHEL), но должен соответствовать порту целевого объекта iSCSI. |
| 5022        | TCP      | [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] — порт по умолчанию, используемый для конечной точки группы доступности. Можно изменить при создании конечной точки.                                |
| 5403        | TCP      | Pacemaker                                                                                                                   |
| 5404        | UDP      | Pacemaker — требуется для Corosync при использовании многоадресного протокола UDP                                                                     |
| 5405        | UDP      | Pacemaker — требуется для Corosync                                                                                            |
| 21064       | TCP      | Pacemaker — требуется для ресурсов, использующих DLM                                                                                 |
| Переменная    | TCP      | Порт конечной точки группы доступности, значение по умолчанию — 5022                                                                                           |
| Переменная    | TCP      | NFS — порт для `LOCKD_TCPPORT` (находится в `/etc/sysconfig/nfs` в RHEL)                                              |
| Переменная    | UDP      | NFS — порт для `LOCKD_UDPPORT` (находится в `/etc/sysconfig/nfs` в RHEL)                                              |
| Переменная    | TCP/UDP  | NFS — порт для `MOUNTD_PORT` (находится в `/etc/sysconfig/nfs` в RHEL)                                                |
| Переменная    | TCP/UDP  | NFS — порт для `STATD_PORT` (находится в `/etc/sysconfig/nfs` в RHEL)                                                 |

Перечень дополнительных портов, поддерживаемых Samba, см. на странице [Использование портов Samba](https://wiki.samba.org/index.php/Samba_Port_Usage).

И наоборот, как исключение, вместо порта можно добавить имя службы в Linux. Например, `high-availability` для Pacemaker. Если вы хотите выбрать этот вариант, см. соответствующий дистрибутив. Например, в RHEL используется следующая команда для добавления в Pacemaker:

```bash
sudo firewall-cmd --permanent --add-service=high-availability
```

**Документация по брандмауэру:**
-   [RHEL](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/high_availability_add-on_reference/s1-firewalls-haar)
-   [SLES](https://www.suse.com/documentation/sle-ha-12/singlehtml/book_sleha/book_sleha.html)

### <a name="install-ssnoversion-md-packages-for-availability"></a>Установка пакетов [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] для обеспечения доступности
В установке [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Windows некоторые компоненты устанавливаются даже при базовой установке ядра, а другие — нет. В Linux в ходе установки устанавливается только ядро [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. Все остальные компоненты являются необязательными. Для высокодоступных экземпляров [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] в Linux вместе с [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]должны быть установлены два пакета: агент [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] (*mssql-server-agent*) и пакет высокого уровня доступности (*mssql-server-ha*). Хотя агент [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] является необязательным в техническом плане, он служит планировщиком [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] для заданий и требуется для доставки журналов, поэтому он рекомендуется к установке. В установках [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Windows агент необязателен.

>[!NOTE]
>Для пользователей, не знакомых с [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]: агент [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] является встроенным планировщиком заданий [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. Это распространенное средство, применяемое администраторами баз данных для планирования резервного копирования и других действий по обслуживанию [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. В отличие от установки [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Windows, где агент [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] представляет собой совершенно другую службу, в Linux агент [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]работает в контексте самого [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)].

Группы доступности или экземпляры FCI, настраиваемые в конфигурации на основе Windows, поддерживают кластер. Поддержка кластера означает, что [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] имеет определенные DLL-библиотеки ресурсов (sqagtres.dll и sqsrvres.dll для экземпляров FCI, hadrres.dll для групп доступности), о которых известно WSFC и которые WSFC использует для обеспечения надлежащей работоспособности кластеризованных функций [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. Поскольку кластеризация является внешней не только для [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], но и для самой платформы Linux, корпорации Майкрософт пришлось создать эквивалент DLL-библиотеки ресурсов для развертываний групп доступности и экземпляров FCI на основе Linux. Это пакет *mssql-server-ha*, также известный как агент ресурсов [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] для Pacemaker. Сведения об установке пакета *mssql-server-ha* см. в разделе [Установка пакетов HA и агента SQL Server](sql-server-linux-deploy-pacemaker-cluster.md#install-the-sql-server-ha-and-sql-server-agent-packages).

Другие необязательные пакеты для [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] в Linux — пакет полнотекстового поиска (*mssql-server-fts*) [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] и пакет [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] Integration Services (*mssql-server-is*) — не требуются для обеспечения высокой доступности и экземпляра FCI, и группы доступности.

## <a name="pacemaker-for-always-on-availability-groups-and-failover-cluster-instances-on-linux"></a>Pacemaker для групп доступности Always On и экземпляров отказоустойчивого кластера в Linux
Как отмечалось выше, Pacemaker с Corosync является единственным механизмом кластеризации, поддерживаемым в настоящее время корпорацией Майкрософт для групп доступности и экземпляров FCI. В этом разделе содержатся основные сведения о решении, а также о его планировании и развертывании для конфигураций [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)].

### <a name="ha-add-onextension-basics"></a>Основные сведения о расширении и надстройке для обеспечения высокого уровня доступности
Все поддерживаемые в настоящее время дистрибутивы содержат надстройку или расширение для обеспечения высокого уровня доступности, основанные на стеке кластеризации Pacemaker. Этот стек состоит из двух ключевых компонентов: Pacemaker и Corosync. Все компоненты, входящие в стек:
-   Pacemaker — основной компонент кластеризации, который выполняет такие действия, как координация на кластеризованных компьютерах.
-   Corosync — платформа и набор API-интерфейсов, которые предоставляют такие возможности, как кворум, возможность перезапуска процессов со сбоями и т. д.
-   libQB — предоставляет возможности ведения журналов.
-   Агент ресурсов — предоставляет специальные функциональные возможности для интеграции приложений с Pacemaker.
-   Агент ограждения — предоставляет сценарии и функции для изоляции узлов и работы с ними при возникновении проблем.
    
> [!NOTE]
> В среде Linux стек кластера обычно называют Pacemaker.

Это решение в некоторой степени аналогично развертыванию кластеризованных конфигураций с помощью Windows, однако оно во многом от него отличается. В Windows форма доступности кластеризации, называемая отказоустойчивым кластером Windows Server (WSFC), встроена в операционную систему, а функция, позволяющая создавать кластер WSFC (отказоустойчивая кластеризация), по умолчанию отключена. В Windows группы доступности и экземпляры FCI основаны на WSFC и поддерживают тесную интеграцию благодаря особой DLL-библиотеке ресурсов, предоставляемой [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. Такое решение в целом возможно, так как все компоненты в нем от одного поставщика.

![](./media/sql-server-linux-ha-basics/image1.png)

Хотя Pacemaker доступен во всех поддерживаемых дистрибутивах Linux, каждое из них может настраиваться и иметь незначительно отличающиеся реализации и версии. Некоторые отличия будут показаны в инструкциях, приведенных в этой статье. Уровень кластеризации основан на открытом исходном коде, поэтому, несмотря на то, что он поставляется вместе с дистрибутивами, глубокая интеграция, такая как у WSFC в Windows, отсутствует. Именно поэтому корпорация Майкрософт предоставляет *mssql-server-ha*, чтобы [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] и стек Pacemaker могли обеспечивать для групп доступности и экземпляров FCI степень взаимодействия, практически аналогичную Windows.

Полную документацию по Pacemaker, включая более подробные и полные справочные сведения по RHEL и SLES, см. на следующих ресурсах:
-   [RHEL](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/ch-overview-HAAR.html)
-   [SLES](https://www.suse.com/documentation/sle_ha/book_sleha/data/book_sleha.html)

Руководство по обеспечению доступности в Ubuntu отсутствует.

Дополнительные сведения о полном стеке см. на странице [официальной документации по Pacemaker](https://clusterlabs.org/doc/) на сайте Clusterlabs:

### <a name="pacemaker-concepts-and-terminology"></a>Основные понятия и терминология Pacemaker
В этом разделе описываются общие понятия и терминология для реализации Pacemaker.

#### <a name="node"></a>Узел
Узел — это сервер, входящий в кластер. Кластер Pacemaker изначально поддерживает до 16 узлов. Это число может быть выше, если Corosync не работает на дополнительных узлах, но требуется для [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. Таким образом, в любой конфигурации кластера на основе [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] может быть не более 16 узлов. Это ограничение Pacemaker, которое не связано с максимальными ограничениями для групп доступности или экземпляров FCI, действующим в [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]. 

#### <a name="resource"></a>Ресурс
Кластеры WSFC и Pacemaker поддерживают понятие ресурса. Ресурс — это специальная функциональная возможность, выполняемая в контексте кластера, например диск или IP-адрес. Например, в Pacemaker можно создать и ресурсы FCI, и ресурсы группы доступности. Понятие ресурса в Pacemaker практически аналогично определению ресурса в WSFC, когда при настройке группы доступности вы видите ресурс [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] для экземпляра FCI или группы доступности. Однако это совсем не одно и то же, так как существуют базовые различия в способе интеграции [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] с Pacemaker.

Pacemaker имеет стандартные и клонированные ресурсы. Клонированные ресурсы — это объекты, которые выполняются одновременно на всех узлах. Примером может быть IP-адрес, доступный на нескольких узлах в целях балансировки нагрузки. Любой ресурс, создаваемый для экземпляра FCI, использует стандартный ресурс, так как в определенный момент времени экземпляр FCI может размещаться только на одном узле.

[!INCLUDE [bias-sensitive-term-t](../includes/bias-sensitive-term-t.md)]

Созданной группе доступности требуется особая форма клонированного ресурса, называемая ресурсом с несколькими состояниями. Хотя группа доступности имеет только одну первичную реплику, сама она выполняется на всех узлах, для работы на которых она настроена, и может разрешать, к примеру, доступ только для чтения. Так как это динамическое использование узла, для ресурсов действует принцип двух состояний: главный и подчиненный. Дополнительные сведения см. в статье о [ресурсах, имеющих несколько состояний и режимов](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/s1-multistateresource-HAAR.html).

#### <a name="resource-groupssets"></a>Группы и наборы ресурсов

Подобно ролям в WSFC, кластер Pacemaker поддерживает концепцию группы ресурсов. Группа ресурсов (называемая _набором_ в SLES) представляет собой коллекцию ресурсов, которые работают вместе и могут выполнять отработку отказа с одного узла на другой как единое целое. Группы ресурсов не могут содержать ресурсы, настроенные как главные или подчиненные, поэтому они не используются для групп доступности. Хотя группу ресурсов можно использовать для экземпляра FCI, делать это не рекомендуется.

#### <a name="constraints"></a>Ограничения
Помимо различных параметров для ресурсов, в кластерах WSFC существуют зависимости, которые сообщают WSFC о связи "родители-потомки" между двумя разными ресурсами. Зависимость — это просто правило, указывающее WSFC, какой ресурс должен быть переведен в сетевой режим первым.

В кластере Pacemaker концепция зависимостей отсутствует, но в нем применяются ограничения. Существует три типа ограничений: совместное размещение, расположение и упорядочение.
-   Ограничение на совместное размещение определяет, могут ли два ресурса выполняться на одном узле.
-   Ограничение на расположение указывает кластеру Pacemaker место, где может (или не может) выполняться ресурс.
-   Ограничение на упорядочение указывает кластеру Pacemaker порядок запуска ресурсов.

> [!NOTE]
> Ограничения на совместное размещение не налагаются на ресурсы в группе ресурсов, так как все они считаются единым целым.

#### <a name="quorum-fence-agents-and-stonith"></a>Кворум, агенты ограждения и STONITH
Теоретически кворум в Pacemaker похож на WSFC. Цель механизма кворума кластера заключается в том, чтобы обеспечить работоспособность кластера. В надстройках WSFC и высокого уровня доступности для дистрибутивов Linux реализован принцип голосования, где для определения кворума учитывается каждый узел. Вполне очевидно, что для работы кластера требуется большая часть голосов, в противном случае кластер будет остановлен.

В отличие от WSFC, здесь нет ресурса-свидетеля. Как и в WSFC, требуется получить нечетное число голосов. Для групп доступности и экземпляров FCI используются разные конфигурации кворума.

WSFC отслеживает состояние узлов и обрабатывает их при возникновении проблемы. В более поздних версиях WSFC предлагаются такие функции, как помещение неправильно работающего или недоступного (узел не включен, сеть не работает и т. д.) узла в карантин. На стороне Linux этот тип функционала предоставляется агентом ограждения. Иногда это называется ограждением. Однако агенты ограждений обычно зависят от развертывания, и часто их можно получить у поставщиков оборудования и некоторых поставщиков программного обеспечения, например у тех, кто предлагает гипервизоры. Например, VMware предоставляет агент ограждения, который можно использовать для виртуальных машин Linux, виртуализованных с помощью vSphere.

Кворум и ограждение связаны с другим понятием — STONITH (Shoot the Other Node in the Head). STONITH должен иметь поддерживаемый кластер Pacemaker во всех дистрибутивах Linux. Дополнительные сведения см. в статье об [ограждении в кластере высокой доступности Red Hat](https://access.redhat.com/solutions/15575) (RHEL).

#### <a name="corosyncconf"></a>corosync. conf
Файл `corosync.conf` содержит конфигурацию кластера. Он находится в папке `/etc/corosync`. В ходе обычных повседневных операций этот файл должен всегда оставаться без изменений, если кластер настроен правильно.

#### <a name="cluster-log-location"></a>Расположение журнала кластера
Расположения журналов кластеров Pacemaker зависят от дистрибутива.
-   RHEL и SLES — `/var/log/cluster/corosync.log`
-   Ubuntu — `/var/log/corosync/corosync.log`

Чтобы изменить расположение журнала по умолчанию, измените `corosync.conf`.

## <a name="plan-pacemaker-clusters-for-ssnoversion-md"></a>Планирование кластеров Pacemaker для [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]
В этом разделе рассматриваются важные вопросы планирования для кластера Pacemaker.

### <a name="virtualizing-linux-based-pacemaker-clusters-for-ssnoversion-md"></a>Виртуализация кластеров Pacemaker на основе Linux для [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)]
На использование виртуальных машин для развертываний [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)] на основе Linux для групп доступности и экземпляров FCI распространяются те же правила, что и для их аналогов на основе Windows. Существует базовый набор правил для поддержки виртуализованных развертываний [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], предоставляемых корпорацией Майкрософт и приведенных в [статье базы знаний KB 956893](https://support.microsoft.com/help/956893/support-policy-for-microsoft-sql-server-products-that-are-running-in-a-hardware-virtualization-environment). Различные гипервизоры, такие как Microsoft Hyper-V и VMware ESXi, могут иметь ряд отличий, что связано с отличиями самих платформ.

При виртуализации групп доступности и экземпляров FCI необходимо, чтобы в узлах кластера Pacemaker было настроено удаление сходства. Если конфигурация группы доступности или экземпляра FCI настроена для обеспечения высокого уровня доступности, виртуальные машины, на которых размещается [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)], не должны выполняться на одном узле гипервизора. Например, в развертывании экземпляра FCI с двумя узлами потребуется *по крайней мере* три узла гипервизора, на которые в случае сбоя можно будет перевести одну из виртуальных машин с размещенным узлом (особенно при использовании таких функций, как динамическая миграция или vMotion).

Дополнительные сведения см. в следующих статьях:
-   Документация по Hyper-V — [Использование гостевой кластеризации для обеспечения высокой доступности](https://technet.microsoft.com/library/dn440540(v=ws.11).aspx)
-   Технический документ (написан для развертываний на основе Windows, но большинство понятий можно применять и в этом случае) — [Planning Highly Available, Mission Critical SQL Server Deployments with VMware vSphere](https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/solutions/vmware-vsphere-highly-available-mission-critical-sql-server-deployments.pdf) (Планирование высокодоступных критически важных развертываний SQL Server с помощью VMware vSphere)

### <a name="networking"></a>Сеть
В отличие от WSFC, Pacemaker не требует выделенного имени или хотя бы одного выделенного IP-адреса для самого кластера Pacemaker. Для групп доступности и FCI будут нужны IP-адреса (дополнительные сведения см. в документации), но не имена, так как ресурс сетевого имени отсутствует. SLES позволяет настраивать IP-адреса для административных целей, но, как следует из раздела [Создание кластера Pacemaker](sql-server-linux-deploy-pacemaker-cluster.md#create), делать это не обязательно.

Как и для WSFC, для Pacemaker будет предпочтительной избыточная сеть, в которой разные сетевые карты (NIC или pNIC) имеют разные IP-адреса. С точки зрения конфигурации кластера у каждого IP-адреса будет так называемый собственный круг. Однако, как и в случае с WSFC, многие реализации виртуализованы или находятся в общедоступном облаке, где на самом деле есть только одна виртуализованная сетевая карта (vNIC), доступная на сервере. Если все карты pNIC и vNIC подключены к одному физическому или виртуальному коммутатору, реальная избыточность на уровне сети отсутствует, поэтому настраивать несколько сетевых карт для виртуальной машины нет необходимости. Как правило, избыточность сети является неотъемлемой частью гипервизора для виртуализованных развертываний и, конечно же, общедоступного облака.

Единственное отличие Pacemaker с несколькими сетевыми картами от WSFC заключается в том, что Pacemaker разрешает использовать несколько IP-адресов в одной подсети, а WSFC — нет. Дополнительные сведения о нескольких подсетях и кластерах Linux см. в статье о [настройке нескольких подсетей](sql-server-linux-configure-multiple-subnet.md).

### <a name="quorum-and-stonith"></a>Кворум и STONITH
Конфигурация и требования кворума связаны с развертываниями группы доступности или экземпляра FCI [!INCLUDE[ssnoversion-md](../includes/ssnoversion-md.md)].

STONITH требуется для поддерживаемого кластера Pacemaker. Сведения о настройке STONITH см. в документации по дистрибутиву. Пример для SLES см. в статье об [ограждении на основе хранилища](https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_storage_protect_fencing.html). Для решений на основе ESXI доступен агент STONITH для VMware vCenter. Дополнительные сведения см. в статье [Stonith Plugin Agent for VMWare VM VCenter SOAP Fencing (Unofficial)](https://github.com/olafrv/fence_vmware_soap) (Агент подключаемого модуля Stonith для виртуальной машины VMWare в протоколе SOAP VCenter (неофициально)).

### <a name="interoperability"></a>Совместимость
В этом разделе содержатся сведения о взаимодействии кластера на основе Linux с WSFC или другими дистрибутивами Linux.

#### <a name="wsfc"></a>WSFC
Сейчас WSFC и кластер Pacemaker не могут взаимодействовать напрямую. Это означает, что невозможно создать группу доступности или экземпляр FCI, которые работают в WSFC и Pacemaker. Однако есть два решения для взаимодействия, оба из которых предназначены для групп доступности. Экземпляр FCI может быть задействован в кроссплатформенной конфигурации только в том случае, если он используется в качестве экземпляра в одном из следующих двух сценариев.
-   Группа доступности с типом кластера None. Дополнительные сведения см. в [документации по группам доступности Windows](../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md).
-   Распределенная группа доступности, которая представляет собой особый тип группы, позволяющий настраивать две разные группы доступности в качестве собственной группы доступности. Дополнительные сведения о распределенных группах доступности см. в разделе [Распределенные группы доступности](../database-engine/availability-groups/windows/distributed-availability-groups.md).

#### <a name="other-linux-distributions"></a>Другие дистрибутивы Linux
В Linux все узлы кластера Pacemaker должны находиться в одном дистрибутиве. Это значит, что узел RHEL не может входить в состав кластера Pacemaker, содержащего узел SLES. Основная причина была приведена ранее: дистрибутивы могут иметь разные версии и функциональные возможности, поэтому компоненты и процессы могут работать неправильно. Смешение дистрибутивов, как и сочетание WSFC и Linux, позволяет сделать вывод о необходимости использования групп доступности с типом None или распределенных групп доступности.

## <a name="next-steps"></a>Дальнейшие действия
[Развертывание кластера Pacemaker для SQL Server на Linux](sql-server-linux-deploy-pacemaker-cluster.md)
