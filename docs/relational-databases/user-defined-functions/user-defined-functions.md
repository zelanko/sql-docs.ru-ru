---
title: Определяемые пользователем функции | Документация Майкрософт
ms.custom: ''
ms.date: 08/05/2016
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- user-defined functions [SQL Server], components
- user-defined functions [SQL Server], about user-defined functions
- UDF
- TVF
ms.assetid: d7ddafab-f5a6-44b0-81d5-ba96425aada4
author: rothja
ms.author: jroth
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 8a659583df74cdc2e5100fcc25aa25e90af3bf22
ms.sourcegitcommit: f688a37bb6deac2e5b7730344165bbe2c57f9b9c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73843842"
---
# <a name="user-defined-functions"></a>Определяемые пользователем функции
[!INCLUDE[tsql-appliesto-ss2008-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2008-asdb-xxxx-xxx-md.md)]
  Аналогично функциям в языках программирования,  определяемые пользователем функции [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] представляют собой подпрограммы, которые принимают параметры, выполняют действие, например, сложные вычисления, и возвращают результат этого действия в виде значения. Возвращаемое значение может быть либо единичным скалярным значением, либо результирующим набором.  
   
##  <a name="Benefits"></a> Определяемые пользователем функции  
Зачем нужны определяемые пользователем функции (UDF)? 
  
-   Делают возможным модульное программирование.  
  
     Можно, однажды создав функцию, сохранить ее в базе данных, а затем любое число раз вызывать из своей программы. Определяемые пользователем функции могут быть изменены независимо от исходного кода программы.  
  
-   Позволяют ускорить выполнение.  
  
     Как и хранимые процедуры, определяемые пользователем функции [!INCLUDE[tsql](../../includes/tsql-md.md)] снижают стоимость компиляции кода [!INCLUDE[tsql](../../includes/tsql-md.md)], кэшируя и повторно используя планы выполнения. Это означает, что для определяемых пользователем функций нет необходимости выполнять повторный синтаксический анализ и оптимизацию при каждом вызове, что значительно ускоряет их выполнение.  
  
     Функции CLR дают значительное преимущество в производительности по сравнению с функциями [!INCLUDE[tsql](../../includes/tsql-md.md)] для вычислительных задач, работы со строками и бизнес-логикой. Функции [!INCLUDE[tsql](../../includes/tsql-md.md)] лучше подходят для логики с интенсивным доступом к данным.  
  
-   Позволяют уменьшить сетевой трафик.  
  
     Операция, которая фильтрует данные на основе какого-нибудь сложного ограничения и не может быть выражена одним скалярным выражением, может быть реализована в виде функции. Ее можно вызвать из предложения WHERE, чтобы уменьшить число строк, возвращаемых клиенту.  
  
> [!IMPORTANT]
> Определяемые пользователем функции [!INCLUDE[tsql](../../includes/tsql-md.md)] в запросах могут выполняться только как один поток (план последовательного выполнения). Поэтому использование определяемых пользователем функций запрещает параллельную обработку запросов. Дополнительные сведения о параллельной обработке запросов см. в статье [Руководство по архитектуре обработки запросов](../../relational-databases/query-processing-architecture-guide.md#parallel-query-processing).
  
##  <a name="FunctionTypes"></a> Типы функций  
**Скалярная функция**  
 Пользовательские скалярные функции возвращают одно значение типа данных, заданного в предложении RETURNS. Для встроенной скалярной функции возвращаемое скалярное значение является результатом одной инструкции. Скалярная функция из нескольких инструкций имеет текст может содержать последовательность инструкций [!INCLUDE[tsql](../../includes/tsql-md.md)], возвращающих одно значение. Такие функции могут возвращать любые типы данных, кроме **text**, **ntext**, **image**, **cursor**и **timestamp**. 
 **[Примеры.](../../relational-databases/user-defined-functions/create-user-defined-functions-database-engine.md#Scalar)**
  
**Функции с табличными значениями**  
 Определяемые пользователем функции с табличным значением возвращают данные типа **table**. Встроенная функция с табличным значением не имеет текста, таблица является результирующим набором одной инструкции. **[Примеры.](../../relational-databases/user-defined-functions/create-user-defined-functions-database-engine.md#TVF)**
  
**Системные функции**  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] предоставляет множество системных функций для выполнения различных операций. Их нельзя изменить. Дополнительные сведения см. в разделах [Встроенные функции (Transact-SQL)](~/t-sql/functions/functions.md), [Системные хранимые функции (Transact-SQL)](~/relational-databases/system-functions/system-functions-category-transact-sql.md) и [Динамические административные представления и функции (Transact-SQL)](~/relational-databases/system-dynamic-management-views/system-dynamic-management-views.md).  
  
##  <a name="Guidelines"></a> Рекомендации  
 Ошибки [!INCLUDE[tsql](../../includes/tsql-md.md)], которые вызывают отмену инструкции и продолжение выполнения со следующей инструкции в модуле (например в триггере или хранимой процедуре), внутри функций обрабатываются иначе. В функциях такие ошибки вызывают остановку выполнения функции. Это вызывает отмену инструкции, вызвавшей функцию.  
  
 Инструкции в блоке `BEGIN...END` не могут иметь каких-либо побочных эффектов. Побочными эффектами функций называются любые постоянные изменения состояния ресурса, область которого лежит за пределами функции, например изменение таблицы базы данных. Инструкции внутри функции могут изменять только локальные по отношению к этой функции объекты, например локальные курсоры или переменные. Изменения таблиц баз данных, операции с курсорами, не являющимися локальными для данной функции, отправка электронной почты, попытка изменения каталога, формирование результирующего набора, возвращаемого пользователю — это примеры действий, выполнение которых внутри функции невозможно.  
  
> [!NOTE]
> Если инструкция `CREATE FUNCTION` создает побочные эффекты в отношении ресурсов, которые не существуют во время применения инструкции `CREATE FUNCTION`, то [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняет эту инструкцию. Однако [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не выполняет эту функцию при ее вызове.  
  
 Число раз, когда указанная в запросе функция будет фактически выполнена, может различаться для разных планов выполнения, построенных оптимизатором. Примером является функция, вызываемая вложенным запросом в предложении `WHERE`. Число раз, когда вложенный запрос и его функция будут выполнены, может различаться для разных путей доступа, выбираемых оптимизатором.  
 
> [!IMPORTANT]   
> Дополнительные сведения и рекомендации по производительности для определяемых пользователем функций см. в разделе [Создание определяемых пользователем функций (ядро СУБД)](../../relational-databases/user-defined-functions/create-user-defined-functions-database-engine.md). 
  
##  <a name="ValidStatements"></a> Инструкции, допустимые в функциях  
К типам инструкций, допустимым внутри функций, относятся следующие.  
  
-   Инструкции `DECLARE`, используемые для определения переменных и курсоров, локальных для данной функции.  
  
-   Присвоение значений объектам, локальным для данной функции, например присвоение значений скалярным и табличным локальным переменным с помощью инструкции `SET`.  
  
-   Операции над курсорами, обращающиеся к локальным курсорам и выполняющие их объявление, открытие, закрытие и освобождение внутри функции. Инструкции `FETCH`, возвращающие данные клиенту, запрещены. Разрешены только инструкции FETCH, присваивающие значения локальным переменным с помощью предложения `INTO`.  
  
-   Инструкции управления потоком, за исключением инструкций `TRY...CATCH`.  
  
-   Инструкции `SELECT`, содержащие списки выборки с выражениями, присваивающими значения переменным, локальным для данной функции.  
  
-   Инструкции `UPDATE`, `INSERT` и `DELETE`, изменяющие табличные переменные, локальные для данной функции.  
  
-   Инструкции `EXECUTE`, вызывающие расширенную хранимую процедуру.  
  
### <a name="built-in-system-functions"></a>Встроенные системные функции  
 Следующие недетерминированные встроенные функции могут быть использованы в определяемых пользователем функциях языка Transact-SQL.  
  
|||  
|-|-|  
|CURRENT_TIMESTAMP|@@MAX_CONNECTIONS|  
|GET_TRANSMISSION_STATUS|@@PACK_RECEIVED|  
|GETDATE|@@PACK_SENT|  
|GETUTCDATE|@@PACKET_ERRORS|  
|@@CONNECTIONS|@@TIMETICKS|  
|@@CPU_BUSY|@@TOTAL_ERRORS|  
|@@DBTS|@@TOTAL_READ|  
|@@IDLE|@@TOTAL_WRITE|  
|@@IO_BUSY||  
  
 Следующие недетерминированные встроенные функции **нельзя** использовать в определяемых пользователем функциях [!INCLUDE[tsql](../../includes/tsql-md.md)].  
  
|||  
|-|-|  
|NEWID|RAND|  
|NEWSEQUENTIALID|TEXTPTR|  
  
 Список детерминированных и недетерминированных встроенных системных функций см. в разделе [Детерминированные и недетерминированные функции](../../relational-databases/user-defined-functions/deterministic-and-nondeterministic-functions.md).  
  
##  <a name="SchemaBound"></a> Привязанные к схеме функции  
 Инструкция `CREATE FUNCTION` поддерживает предложение `SCHEMABINDING`, позволяющее привязать функцию к схеме каких-либо объектов, на которые она ссылается, например таблиц, представлений и других пользовательских функций. Попытка изменения или удаления любого объекта, к которому обращается привязанная к схеме функция, приводит к ошибке.  
  
 Перед указанием предложения `SCHEMABINDING` в инструкции [CREATE FUNCTION](../../t-sql/statements/create-function-transact-sql.md) нужно соблюсти перечисленные ниже условия.  
  
-   Все представления и пользовательские функции, к которым обращается функция, должны быть привязаны к схеме.  
  
-   Все объекты, к которым обращается функция, должны находиться в той же базе данных, что и функция. Обращение к объектам должно производиться по однокомпонентным либо двухкомпонентным именам.  
  
-   Для всех объектов (таблиц, представлений и пользовательских функций), к которым обращается функция, должно быть получено разрешение `REFERENCES`.  
  
 Для удаления привязки к схеме можно использовать инструкцию `ALTER FUNCTION`. В инструкции `ALTER FUNCTION` следует переопределить функцию без указания предложения `WITH SCHEMABINDING`.  
  
##  <a name="Parameters"></a> Указание параметров  
 Пользовательская функция может принимать 0 или более входных параметров и возвращать либо скалярное, либо табличное значение. Максимальное число входных параметров для функции равно 1024. Если для параметра функции установлено значение по умолчанию, необходимо указать ключевое слово DEFAULT при вызове функции, чтобы получить установленное по умолчанию значение. Это поведение отличается от использования параметров со значениями по умолчанию в пользовательских хранимых процедурах, в которых пропущенный параметр также принимает значение по умолчанию. В определяемых пользователями функциях не поддерживаются выходные параметры.  
  
##  <a name="Tasks"></a> Дополнительные примеры  
  
|||  
|-|-|  
|**Описание задачи**|**Раздел**|  
|Описывает, как создать определяемую пользователем функцию Transact-SQL.|[Создание определяемых пользователем функций (ядро СУБД)](../../relational-databases/user-defined-functions/create-user-defined-functions-database-engine.md)|  
|Описывает, как создать функции CLR.|[Создание функций CLR](../../relational-databases/user-defined-functions/create-clr-functions.md)|  
|Описывает, как создать определяемую пользователем агрегатную функцию.|[Создание пользовательских агрегатных функций](../../relational-databases/user-defined-functions/create-user-defined-aggregates.md)|  
|Описывает, как изменить определяемую пользователем функцию Transact-SQL.|[Изменение пользовательских функций](../../relational-databases/user-defined-functions/modify-user-defined-functions.md)|  
|Описывает, как удалить определяемую пользователем функцию.|[Удаление пользовательских функций](../../relational-databases/user-defined-functions/delete-user-defined-functions.md)|  
|Описывает, как создать определяемую пользователем функцию выполнения.|[Выполнение пользовательских функций](../../relational-databases/user-defined-functions/execute-user-defined-functions.md)|  
|Описывает, как переименовать определяемую пользователем функцию|[Переименование пользовательских функций](../../relational-databases/user-defined-functions/rename-user-defined-functions.md)|  
|Описывает, как просмотреть определяемую пользователем функцию.|[Просмотр пользовательских функций](../../relational-databases/user-defined-functions/view-user-defined-functions.md)|  
  
  
