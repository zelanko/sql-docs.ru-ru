---
title: Оценка размера кучи | Документация Майкрософт
ms.custom: ''
ms.date: 03/01/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- disk space [SQL Server], indexes
- estimating heap size
- size [SQL Server], heap
- space [SQL Server], indexes
- heaps
ms.assetid: 81fd5ec9-ce0f-4c2c-8ba0-6c483cea6c75
author: stevestein
ms.author: sstein
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: 58d708811825fe42ca64c7e30f7e9ed0d92e62f3
ms.sourcegitcommit: b2e81cb349eecacee91cd3766410ffb3677ad7e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2020
ms.locfileid: "72909048"
---
# <a name="estimate-the-size-of-a-heap"></a>Оценка размера кучи
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]
  Для оценки размера пространства, требуемого для хранения данных в куче, можно использовать следующую процедуру.  
  
1.  Укажите количество строк в новой таблице:  
  
     **_Num_Rows_** = число строк в таблице  
  
2.  Укажите количество столбцов с фиксированной и изменяемой длиной, а также рассчитайте необходимый размер места для их хранения.  
  
     Вычислите размер, занимаемый каждой из этих групп столбцов в строке данных. Размер столбца зависит от типа данных и длины.  
  
     **_Num_Cols_** = общее количество столбцов (фиксированной и переменной ширины)  
  
     **_Fixed_Data_Size_** = общий размер в байтах всех ключевых столбцов фиксированной длины  
  
     **_Num_Variable_Cols_** = количество включенных столбцов переменной длины  
  
     **_Max_Var_Size_** = максимальный общий размер в байтах всех столбцов переменной длины  
  
3.  Часть строки, называемая битовой картой NULL, зарезервирована для управления свойством столбца принимать значение NULL. Вычислите ее размер.  
  
     **_Null_Bitmap_** = 2 + (( **_Num_Cols_** + 7) / 8)  
  
     Следует использовать только целую часть этого выражения и Остаток должен быть отброшен.  
  
4.  Расчет размера данных с переменной длиной:  
  
     Если таблица содержит столбцы с переменной длиной, определите, сколько пространства потребуется для хранения столбцов в строке:  
  
     **_Variable_Data_Size_** = 2 + ( **_Num_Variable_Cols_** x 2) + **_Max_Var_Size_**  
  
     Добавленные к значению **_Max_Var_Size_** байты необходимы для отслеживания каждого столбца переменной длины. Эта формула исходит из предположения, что все столбцы переменной длины заполнены на 100 %. Если предполагается, что будет использовано меньше места для хранения столбца изменяемой длины, можно изменить значение **_Max_Var_Size_** в процентах от общей изменяемой длины для более точного подсчета общего размера таблицы.  
  
    > [!NOTE]  
    >  Можно сочетать столбцы **varchar**, **nvarchar**, **varbinary**или **sql_variant** , в результате чего общая ширина определенной таблицы превысит 8 060 байт. Длина каждого из этих столбцов должна быть в пределах 8000 байт для столбцов типа **varchar**, **nvarchar, varbinary** или **sql_variant**. Тем не менее их общая ширина в таблице может превышать предел в 8 060 байт.  
  
     Если в таблице нет столбцов переменной ширины, присвойте параметру **_Variable_Data_Size_** значение 0.  
  
5.  Вычислите общий размер строк:  
  
     **_Row_Size_**   =  **_Fixed_Data_Size_**  +  **_Variable_Data_Size_**  +  **_Null_Bitmap_** + 4  
  
     Значение 4 в формуле — это служебные данные заголовка строки данных.  
  
6.  Расчет количества строк на странице (8 096 свободных байт на страницу):  
  
     **_Rows_Per_Page_** = 8096 / ( **_Row_Size_** + 2)  
  
     Так как строки не могут разрываться на разные страницы, общее количество строк на страницу необходимо округлить до меньшего целого значения целой строки. Значение 2 в формуле соответствует записи строки в массиве областей памяти страницы.  
  
7.  Вычислите количество страниц, необходимое для хранения всех строк:  
  
     **_Num_Pages_**   =  **_Num_Rows_**  /  **_Rows_Per_Page_**  
  
     Вычисленное количество страниц должно быть округлено в большую сторону до ближайшей целой страницы.  
  
8.  Вычислите размер пространства, требуемого для хранения данных в куче (всего 8192 на страницу):  

     Размер кучи (в байтах) = 8192 x **_Num_Pages_**  
  
 Этот расчет не учитывает следующие факторы.  
  
-   Секционирование  
  
     Размер служебных данных секционирования минимален, но его сложно рассчитать. Он не столь важен, чтобы включать в расчеты.  
  
-   Страницы размещения  
  
     Предусмотрена по меньшей мере одна IAM-страница, используемая для отслеживания страниц, выделенных куче, но размер служебных данных минимален, и алгоритма точного детерминированного вычисления количества используемых IAM-страниц не существует.  
  
-   Значения LOB  
  
     Алгоритм точного определения места, используемого для хранения значений данных типа LOB **varchar(max)** , **varbinary(max)** , **nvarchar(max)** , **text**, **ntextxml**и **image** сложен. Достаточно просто прибавить ожидаемую среднюю величину значений LOB к общему размеру кучи.  
  
-   Сжатие  
  
     Размер сжатой кучи нельзя вычислить заранее.  
  
-   Разреженные столбцы  
  
     Сведения о требованиях разреженных столбцов к месту на диске см. в разделе [Use Sparse Columns](../../relational-databases/tables/use-sparse-columns.md).  
  
## <a name="see-also"></a>См. также:  
 [Кучи (таблицы без кластеризованных индексов)](../../relational-databases/indexes/heaps-tables-without-clustered-indexes.md)   
 [Описания кластеризованных и некластеризованных индексов](../../relational-databases/indexes/clustered-and-nonclustered-indexes-described.md)   
 [Создание кластеризованных индексов](../../relational-databases/indexes/create-clustered-indexes.md)   
 [Создание некластеризованных индексов](../../relational-databases/indexes/create-nonclustered-indexes.md)   
 [Оценка размера таблицы](../../relational-databases/databases/estimate-the-size-of-a-table.md)   
 [Оценка размера кластеризованного индекса](../../relational-databases/databases/estimate-the-size-of-a-clustered-index.md)   
 [Оценка размера некластеризованного индекса](../../relational-databases/databases/estimate-the-size-of-a-nonclustered-index.md)   
 [Оценка размера базы данных](../../relational-databases/databases/estimate-the-size-of-a-database.md)  
  
  
