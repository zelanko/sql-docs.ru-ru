---
title: Передача данных возвращающих табличное значение параметров
ms.custom: ''
ms.date: 04/04/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters (ODBC), binding and data transfer
ms.assetid: 0a2ea462-d613-42b6-870f-c7fa086a6b42
author: markingmyname
ms.author: maghan
monikerRange: '>=aps-pdw-2016||=azuresqldb-current||=azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current'
ms.openlocfilehash: 3b7eecfdac3d42b7a3d8d66ffe1f8ac68652230f
ms.sourcegitcommit: e042272a38fb646df05152c676e5cbeae3f9cd13
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/27/2020
ms.locfileid: "81304505"
---
# <a name="binding-and-data-transfer-of-table-valued-parameters-and-column-values"></a>Привязка и передача данных возвращающих табличное значение параметров и значений столбцов
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

  Возвращающие табличное значение параметры, как и другие параметры, нуждаются в привязке до их передачи на сервер. Приложение привязывает возвращающие табличное значение параметры так же, как привязывает другие параметры: с помощью SQLBindParameter или эквивалентных вызовов SQLSetDescField или SQLSetDescRec. Типом данных на сервере для параметра, возвращающего табличное значение, является SQL_SS_TABLE. Тип C может иметь значение SQL_C_DEFAULT или SQL_C_BINARY.  
  
 В [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] и более поздних версиях возвращающие табличное значение параметры поддерживаются только как входные. Поэтому любая попытка установить для SQL_DESC_PARAMETER_TYPE значение, отличное от SQL_PARAM_INPUT, приведет к возникновению ошибки SQL_ERROR с SQLSTATE = HY105 и появлению сообщения «Недопустимый тип параметра».  
  
 Можно назначать значение по умолчанию для целых столбцов возвращающих табличное значение параметров с помощью атрибута SQL_CA_SS_COL_HAS_DEFAULT_VALUE. Однако отдельные значения столбцов возвращающего табличное значение параметра не могут быть назначены значениями по умолчанию с помощью SQL_DEFAULT_PARAM в *StrLen_or_IndPtr* с SQLBindParameter. Возвращающие табличные значения параметры не могут быть установлены в значение по умолчанию с помощью SQL_DEFAULT_PARAM в *StrLen_or_IndPtr* с SQLBindParameter. Если эти правила не выполняются, SQLExecute или SQLExecDirect возвратит SQL_ERROR. Запись диагностики будет создана с параметром SQLSTATE = 07S01 и сообщением "Недопустимое использование параметра по умолчанию \<для параметра p>" \<, где p> является порядковым номером TVP в инструкции запроса.  
  
 После привязки возвращающего табличное значение параметра приложение должно выполнить привязку каждого столбца параметров, возвращающих табличное значение. Для этого приложение сначала вызывает SQLSetStmtAttr, чтобы задать SQL_SOPT_SS_PARAM_FOCUS порядковому номеру возвращающего табличное значение параметра. Затем приложение привязывает столбцы возвращающего табличное значение параметра с помощью вызовов к следующим подпрограммым: SQLBindParameter, SQLSetDescRec и SQLSetDescField. При установке SQL_SOPT_SS_PARAM_FOCUS в 0 восстанавливается обычный результат SQLBindParameter, SQLSetDescRec и SQLSetDescField в работе с обычными параметрами верхнего уровня.
 
 Примечание. для драйверов ODBC для Linux и Mac с unixODBC 2.3.1 по 2.3.4 при задании имени TVP с помощью SQLSetDescField с полем дескриптора SQL_CA_SS_TYPE_NAME unixODBC не выполняет автоматический переход между строками ANSI и Unicode в зависимости от точно вызванной функции (Склсетдескфиелда/Склсетдескфиелдв). Необходимо либо всегда использовать SQLBindParameter или Склсетдескфиелдв со строкой Юникода (UTF-16), чтобы задать имя TVP.
  
 Для самого возвращающего табличное значение параметра никакие данные не передаются и не принимаются. Передаются и принимаются данные для каждого из столбцов, составляющих этот параметр. Поскольку возвращающий табличное значение параметр является псевдо-столбцом, параметры для SQLBindParameter используются для ссылки на другие атрибуты, отличные от других типов данных, как показано ниже.  
  
|Параметр|Связанный атрибут для типов параметров, не являющихся табличными, включая столбцы|Связанные атрибуты для возвращающих табличное значение параметров|  
|---------------|--------------------------------------------------------------------------------|----------------------------------------------------|  
|*InputOutputType*|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Для столбцов, возвращающих табличное значение параметров, этот атрибут должен совпадать с настройкой для самого возвращающего табличное значение параметра.|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_PARAM_INPUT.|  
|*Внедрен*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.<br /><br /> Это должен быть атрибут SQL_C_DEFAULT или SQL_C_BINARY.|  
|*ParameterType*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_SS_TABLE.|  
|*ColumnSize*|SQL_DESC_LENGTH или SQL_DESC_PRECISION в IPD.<br /><br /> Это зависит от значения *ParameterType*.|SQL_DESC_ARRAY_SIZE<br /><br /> Значение этого атрибута можно задать также с помощью атрибута SQL_ATTR_PARAM_SET_SIZE, когда фокус параметра установлен на возвращающий табличное значение параметр.<br /><br /> Для возвращающего табличное значение параметра эта величина равна количеству строк в буферах столбцов данного параметра.|  
|*DecimalDigits*|SQL_DESC_PRECISION или SQL_DESC_SCALE в IPD.|Не используется. Атрибут должен иметь значение 0.<br /><br /> Если этот параметр не равен 0, SQLBindParameter возвратит SQL_ERROR, и будет создана диагностическая запись с параметром SQLSTATE = HY104 и сообщением "недопустимая точность или масштаб".|  
|*параметервалуептр*|SQL_DESC_DATA_PTR в APD.|SQL_CA_SS_TYPE_NAME.<br /><br /> Необязательный атрибут для вызова хранимых процедур. Если значение не нужно, можно задать NULL. Для инструкций SQL, не являющихся вызовами процедур, атрибут должен быть задан.<br /><br /> Этот параметр также служит уникальным значением, по которому приложение может узнать конкретный возвращающий табличное значение параметр при использовании переменной строковой привязки. Дополнительные сведения см. в подразделе «Переменная строковая привязка возвращающих табличное значение параметров» далее в этом разделе.<br /><br /> Если в вызове SQLBindParameter указано имя типа возвращающего табличное значение параметра, оно должно быть указано в Юникоде даже в приложениях, созданных как приложения ANSI. Значение, используемое для параметра *StrLen_or_IndPtr* , должно быть либо SQL_NTS, либо строковой длины имени, умноженной на sizeof (WChar).|  
|*BufferLength*|SQL_DESC_OCTET_LENGTH в APD.|Длина имени типа возвращающего табличное значение параметра в байтах.<br /><br /> Значение может быть равно SQL_NTS, если имя типа представляет собой строку, завершающуюся нулем, или 0, если имя типа возвращающего табличное значение параметра не требуется.|  
|*StrLen_or_IndPtr*|SQL_DESC_OCTET_LENGTH_PTR в APD.|SQL_DESC_OCTET_LENGTH_PTR в APD.<br /><br /> Для возвращающих табличное значение параметров этот атрибут хранит не длину данных, а количество строк.|  
||||

 Для возвращающих табличное значение параметров поддерживаются два режима передачи данных: фиксированная и переменная привязка строк.  
  
## <a name="fixed-table-valued-parameter-row-binding"></a>Фиксированная привязка строк возвращающего табличное значение параметра  
 Для фиксированной привязки строк приложение выделяет буферы (или буферные массивы), достаточно большие для всех возможных значений входных столбцов. Приложение выполняет следующие действия.  
  
1.  Привязывает все параметры с помощью вызовов SQLBindParameter, SQLSetDescRec или SQLSetDescField.  
  
    1.  Присваивает атрибуту SQL_DESC_ARRAY_SIZE значение максимально возможного числа рядов, которые можно передать для каждого возвращающего табличное значение параметра. Это можно сделать в вызове SQLBindParameter.  
  
2.  Вызывает SQLSetStmtAttr, чтобы задать SQL_SOPT_SS_PARAM_FOCUS порядковому номеру каждого возвращающего табличное значение параметра.  
  
    1.  Для каждого возвращающего табличное значение параметра выполняет привязку столбцов возвращающего табличное значение параметра с помощью вызовов SQLBindParameter, SQLSetDescRec или SQLSetDescField.  
  
    2.  Для каждого столбца возвращающего табличное значение параметра, который должен иметь значения по умолчанию, вызывает SQLSetDescField, чтобы задать SQL_CA_SS_COL_HAS_DEFAULT_VALUE равным 1.  
  
3.  Вызывает SQLSetStmtAttr, чтобы задать SQL_SOPT_SS_PARAM_FOCUS 0. Это необходимо сделать до вызова SQLExecute или SQLExecDirect. В противном случае функция вернет значение SQL_ERROR и будет создана диагностическая запись с параметром SQLSTATE=HY024 и сообщением «Недопустимое значение атрибута SQL_SOPT_SS_PARAM_FOCUS (атрибут должен быть равен нулю во время выполнения)».  
  
4.  Задает *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR SQL_DEFAULT_PARAM для возвращающего табличное значение параметра, не имеющего строк, или числа строк, которые будут переданы при следующем вызове SQLExecute или SQLExecDirect, если возвращающий табличное значение параметр содержит строки. Значения *StrLen_or_IndPtr* и SQL_DESC_OCTET_LENGTH_PTR не могут быть SQL_NULL_DATA для возвращающего табличное значение параметра, так как возвращающие табличное значение параметры не допускают значения NULL (хотя возвращающие табличное значение параметр может допускать значения NULL). Если задано недопустимое значение, SQLExecute или SQLExecDirect возвращает SQL_ERROR, а диагностическая запись создается с параметром SQLSTATE = HY090 и сообщением "Недопустимая строка или длина буфера для параметра \<p>", где p — номер параметра.  
  
5.  Вызывает SQLExecute или SQLExecDirect.  
  
 Входные значения столбца возвращающего табличное значение параметра могут передаваться в части, если для столбца *StrLen_or_IndPtr* задано значение SQL_LEN_DATA_AT_EXEC (*длина*) или SQL_DATA_AT_EXEC. Это похоже на передачу значений по частям при использовании массивов параметров. Как и во всех параметрах данных во время выполнения, метод SQLParamData не указывает, для какой строки массива драйвер запрашивает данные. Это приложение должно позаботиться об этом. Приложение не может делать никаких предположений о порядке, в котором драйвер будет запрашивать данные.  
  
## <a name="variable-table-valued-parameter-row-binding"></a>Переменная привязка строк возвращающего табличное значение параметра  
 Строки при использовании переменной привязки передаются пакетами во время выполнения, и приложение передает их драйверу по требованию. Это похоже на данные времени выполнения для отдельных значений параметров. Для переменной привязки строк приложение выполняет следующие действия.  
  
1.  Привязывает параметры и столбцы возвращающих табличное значение параметров, как описано в шагах с 1 по 3 предыдущего раздела «Фиксированная привязка строк возвращающего табличное значение параметра».  
  
2.  Задает *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR для всех возвращающих табличное значение параметров, которые должны передаваться во время выполнения для SQL_DATA_AT_EXEC. Если ни один из указанных атрибутов не установлен, параметр будет обрабатываться, как описано в предыдущем разделе.  
  
3.  Вызывает SQLExecute или SQLExecDirect. При наличии любых параметров типа SQL_PARAM_INPUT или SQL_PARAM_INPUT_OUTPUT, которые должны быть обработаны как параметры с данными времени выполнения, этот вызов функции вернет значение SQL_NEED_DATA. В этом случае приложение выполняет следующие действия.  
  
    -   Вызывает метод SQLParamData. Он возвращает значение *параметервалуептр* для параметра данных при выполнении и код возврата SQL_NEED_DATA. После передачи всех данных параметров в драйвер метод SQLParamData возвращает SQL_SUCCESS, SQL_SUCCESS_WITH_INFO или SQL_ERROR. Для параметров данных, выполняемых при выполнении, *параметервалуептр*, который совпадает с полем дескриптора SQL_DESC_DATA_PTR, может рассматриваться как маркер для уникальной идентификации параметра, для которого требуется значение. Этот токен передается приложением драйверу во время привязки, а затем передается обратно приложению во время выполнения.  
  
4.  Чтобы отправить данные строки возвращающего табличное значение параметра для возвращающих табличные значения параметров, если параметр с табличным значением не содержит строк, приложение вызывает SQLPutData с *StrLen_Or_Ind* установленным в значение SQL_DEFAULT_PARAM.  
  
     Для возвращающих табличное значение параметров, отличных от NULL, приложение выполняет следующие действия.  
  
    -   Задает *Str_Len_or_Ind* для всех столбцов возвращающих табличное значение параметров соответствующих значений и заполняет буферы данных для столбцов возвращающих табличные значения параметров, которые не являются параметрами данных во время выполнения. Данные времени выполнения можно использовать для столбцов возвращающих табличное значение параметров, подобно тому, как обычные параметры могут передаваться драйверу по частям.  
  
    -   Вызывает SQLPutData с *Str_Len_or_Ind* заданным числом строк, которые будут отправлены на сервер. Любое значение, меньше 0 или больше SQL_DESC_ARRAY_SIZE или SQL_DEFAULT_PARAM, является ошибкой, и в этом случае вызов вернет состояние SQLSTATE HY090 с сообщением «Недопустимая длина строки или буфера». 0 означает, что все строки уже были переданы и в данном возвращающем табличное значение параметре данных больше нет (как указано во втором пункте данного списка). SQL_DEFAULT_PARAM можно использовать только в случае, если драйвер запрашивает данные возвращающего табличное значение параметра впервые (как описано в первом пункте данного списка).  
  
5.  После отправки всех строк вызывает SQLPutData для возвращающего табличное значение параметра с *Str_Len_or_Ind* значением 0, а затем переходит к шагу 3a выше.  
  
6.  Вызывает метод SQLParamData еще раз. Если между столбцами возвращающего табличное значение параметра находятся какие-либо параметры обработки данных, они будут идентифицированы по значению *валуептрптр* , возвращаемому параметром метод SQLParamData. Когда все значения столбцов доступны, метод SQLParamData снова возвращает значение *параметервалуептр* для возвращающего табличное значения параметра, и приложение начинает снова запускаться.  
  
## <a name="see-also"></a>См. также:  
 [Возвращающие табличное значение параметры &#40;ODBC&#41;](../../relational-databases/native-client-odbc-table-valued-parameters/table-valued-parameters-odbc.md)  
  
  
