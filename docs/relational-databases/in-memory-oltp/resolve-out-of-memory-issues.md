---
title: Устранение проблем с нехваткой памяти | Документация Майкрософт
description: Сведения о ситуациях нехватки памяти в выполняющейся в памяти OLTP SQL Server, восстановлении и устранении возможных последствий, устранении ошибок выделения страниц и лучших методиках для этого.
ms.custom: ''
ms.date: 12/21/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: f855e931-7502-44bd-8a8b-b8543645c7f4
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 0db5cb560b4e50d903ceca431556f2bdc18365ad
ms.sourcegitcommit: da88320c474c1c9124574f90d549c50ee3387b4c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2020
ms.locfileid: "85722386"
---
# <a name="resolve-out-of-memory-issues"></a>Устранение проблем нехватки памяти
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

  [!INCLUDE[hek_1](../../includes/hek-1-md.md)] использует больше памяти, чем [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], и делает это по-другому. Возможно, что объем памяти, установленный и выделенный для [!INCLUDE[hek_2](../../includes/hek-2-md.md)] , станет недостаточным для растущих потребностей. В таком случае может возникнуть нехватка памяти. В этом разделе описывается восстановление из ситуации с нехваткой памяти. В статье [Наблюдение и устранение неисправностей при использовании памяти](../../relational-databases/in-memory-oltp/monitor-and-troubleshoot-memory-usage.md) вы найдете рекомендации, которые помогут вам избежать многих ситуаций нехватки памяти.  
  
## <a name="covered-in-this-topic"></a>Темы данного раздела  
  
|Раздел|Обзор|  
|-----------|--------------|  
|[устранить ошибки восстановления базы данных, возникающие из-за нехватки памяти](#bkmk_resolveRecoveryFailures)|Что делать при получении сообщения об ошибке "Операция восстановления базы данных ’ *\<databaseName>* ’ завершилась сбоем из-за нехватки памяти в пуле ресурсов ’ *\<resourcePoolName>* ’."|  
|[устранить влияния нехватки свободной памяти на рабочую нагрузку](#bkmk_recoverFromOOM)|Что следует предпринять, если обнаружится, что недостаток памяти отрицательно влияет на производительность.|  
|[Устранение ошибок выделения страниц, возникших из-за нехватки памяти при наличии достаточных ресурсов памяти](#bkmk_PageAllocFailure)|Что делать, если выдается сообщение об ошибке "Запрет распределения страниц для базы данных ’ *\<databaseName>* ’ из-за нехватки памяти в пуле ресурсов ’ *\<resourcePoolName>* ’." если объема доступной памяти достаточно для выполнения операции.|
|[Рекомендации по использованию выполняющейся в памяти OLTP в среде виртуальных машин](#bkmk_VMs)|Что следует помнить при использовании выполняющейся в памяти OLTP в виртуализированной среде.|
  
##  <a name="resolve-database-restore-failures-due-to-oom"></a><a name="bkmk_resolveRecoveryFailures"></a> устранить ошибки восстановления базы данных, возникающие из-за нехватки памяти  
 При попытке восстановления базы данных можно получить следующее сообщение об ошибке: "Сбой операции восстановления для базы данных ’ *\<databaseName>* ’ из-за нехватки памяти в пуле ресурсов ’ *\<resourcePoolName>* ’." Это означает, что у сервера недостаточно памяти для восстановления базы данных. 
   
Сервер, на который восстанавливается база данных, должен иметь достаточно памяти для оптимизированных для памяти таблиц в резервной копии базы данных, в противном случае база данных не подключится к сети и будет помечена как подозрительная.  
  
Если сервер имеет достаточный объем физической памяти, но по-прежнему возникает данная ошибка, возможно, что другие процессы используют слишком много памяти или операция восстановления не получает достаточный объем памяти из-за проблем с конфигурацией. При подобных проблемах воспользуйтесь следующими мерами, чтобы предоставить операции восстановления дополнительную память. 
  
-   Временно закройте выполняющиеся приложения.   
    Закрыв одно или несколько выполняющихся приложений или остановив ненужные на данный момент службы, можно освободить используемую ими память для операции восстановления. Эти приложения можно будет перезапустить после успешного завершения восстановления.  
  
-   Увеличьте значение MAX_MEMORY_PERCENT.   
    Если база данных, как и рекомендуется, [привязана к пулу ресурсов](../../relational-databases/in-memory-oltp/bind-a-database-with-memory-optimized-tables-to-a-resource-pool.md), то память, доступная для операции восстановления, регулируется параметром MAX_MEMORY_PERCENT. Если значение слишком мало, восстановление завершится со сбоем. В этом фрагменте кода значение параметра MAX_MEMORY_PERCENT для пула ресурсов PoolHk увеличивается до 70 % от установленной памяти.  
  
    > [!IMPORTANT]  
    > Если сервер выполняется на ВМ и не выделен, установите такое же значение MIN_MEMORY_PERCENT, как и MAX_MEMORY_PERCENT.   
    > Дополнительные сведения см. в статье [Рекомендации по использованию выполняющейся в памяти OLTP в среде виртуальных машин](#bkmk_VMs).  
  
    ```sql  
    -- disable resource governor  
    ALTER RESOURCE GOVERNOR DISABLE  
  
    -- change the value of MAX_MEMORY_PERCENT  
    ALTER RESOURCE POOL PoolHk  
    WITH  
         ( MAX_MEMORY_PERCENT = 70 )  
    GO  
  
    -- reconfigure the Resource Governor  
    --    RECONFIGURE enables resource governor  
    ALTER RESOURCE GOVERNOR RECONFIGURE  
    GO  
  
    ```  
  
     Дополнительные сведения о максимальных значениях параметра MAX_MEMORY_PERCENT см в разделе [Процент памяти, доступной для оптимизированных для памяти таблиц и индексов](../../relational-databases/in-memory-oltp/bind-a-database-with-memory-optimized-tables-to-a-resource-pool.md#bkmk_PercentAvailable).  
  
-   Увеличьте значение **max server memory**.  
    Дополнительные сведения о настройке параметра **Макс. памяти сервера** см. в разделе [Параметры конфигурации сервера "Память сервера"](../../database-engine/configure-windows/server-memory-server-configuration-options.md).  
  
##  <a name="resolve-impact-of-low-memory-or-oom-conditions-on-the-workload"></a><a name="bkmk_recoverFromOOM"></a> устранить влияния нехватки свободной памяти на рабочую нагрузку  
 Очевидно, проще всего вообще избегать ситуаций, связанных с нехваткой памяти. Помочь в этом может хорошее планирование и отслеживание. Однако даже самое хорошее планирование не гарантирует стабильной работы, и возникновение нехватки памяти всегда возможно. Для устранения этой ситуации необходимо выполнить два действия.  
  
1.  [Откройте выделенное административное соединение](#bkmk_openDAC)  
  
2.  [Примените действие по исправлению](#bkmk_takeCorrectiveAction)  

###  <a name="open-a-dac-dedicated-administrator-connection"></a><a name="bkmk_openDAC"></a> Откройте выделенное административное соединение  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] предоставляет выделенное административное соединение (DAC). С помощью выделенного административного соединения администратор может обращаться к запущенному экземпляру ядра СУБД SQL Server для устранения неполадок на сервере, даже если сервер не отвечает на другие клиентские соединения. DAC доступны в программе `sqlcmd` и в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].  
  
 Рекомендации по использованию DAC в SSMS или `sqlcmd` см. в разделе [Диагностическое подключение для администраторов баз данных](../../database-engine/configure-windows/diagnostic-connection-for-database-administrators.md).  
  
###  <a name="take-corrective-action"></a><a name="bkmk_takeCorrectiveAction"></a> Примените действие по исправлению  
 Для устранения проблемы с нехваткой памяти необходимо либо освободить имеющуюся память путем сокращения объема ее использования, либо выделить дополнительный объем памяти таблицам в памяти.  
  
#### <a name="free-up-existing-memory"></a>Освобождение имеющейся памяти  
  
##### <a name="delete-non-essential-memory-optimized-table-rows-and-wait-for-garbage-collection"></a>Удаление неважных строк оптимизированных для памяти таблиц и ожидание выполнения сборки мусора  
 Можно удалить неважные строки из оптимизированной для памяти таблицы. Сборщик мусора делает объем памяти, используемый этими строками, доступным. Компонент In-memory OLTP выполняет сбор ненужных строк агрессивно. Однако долго выполняющаяся транзакция может помешать сбору мусора. Например, если имеется транзакция, которая выполняется в течение 5 минут, все версии строк, созданные из-за операций обновления или удаления во время выполнения транзакции, не подпадают под сборку мусора.  
  
##### <a name="move-one-or-more-rows-to-a-disk-based-table"></a>Переместить одну или несколько строк в таблице на диске  
 В следующих статьях TechNet представлены рекомендации по перемещению строк из таблиц, оптимизированных для памяти, в таблицы на диске.  
  
-   [Секционирование уровня приложения](../../relational-databases/in-memory-oltp/application-level-partitioning.md)  
  
-   [Модель приложения для секционирования таблиц, оптимизированных для памяти](../../relational-databases/in-memory-oltp/application-pattern-for-partitioning-memory-optimized-tables.md)  
  
#### <a name="increase-available-memory"></a>Увеличение объема доступной памяти  
  
##### <a name="increase-value-of-max_memory_percent-on-the-resource-pool"></a>Увеличение значения MAX_MEMORY_PERCENT для пула ресурсов  
 Если именованный пул ресурсов для таблиц в памяти еще не создан, то его необходимо создать и привязать к нему базы данных [!INCLUDE[hek_2](../../includes/hek-2-md.md)] . Инструкции по созданию пула ресурсов и привязки к нему баз данных [см. в разделе](../../relational-databases/in-memory-oltp/bind-a-database-with-memory-optimized-tables-to-a-resource-pool.md) Привязка базы данных с таблицами, оптимизированными для памяти, к пулу ресурсов [!INCLUDE[hek_2](../../includes/hek-2-md.md)] .  
  
 Если база данных [!INCLUDE[hek_2](../../includes/hek-2-md.md)] привязана к пулу ресурсов, то пользователь может увеличить процент памяти, доступной для пула. Инструкции по изменению значения MIN_MEMORY_PERCENT и MAX_MEMORY_PERCENT для пула ресурсов см. в подразделе [Изменение параметров MIN_MEMORY_PERCENT и MAX_MEMORY_PERCENT для существующего пула](../../relational-databases/in-memory-oltp/bind-a-database-with-memory-optimized-tables-to-a-resource-pool.md#bkmk_ChangeAllocation) .  
  
 Увеличьте значение MAX_MEMORY_PERCENT.   
В этом фрагменте кода значение параметра MAX_MEMORY_PERCENT для пула ресурсов PoolHk увеличивается до 70 % от установленной памяти.  
  
> [!IMPORTANT]  
>  Если сервер выполняется на ВМ и не выделен, установите такое же значение MIN_MEMORY_PERCENT, как и MAX_MEMORY_PERCENT.   
> Дополнительные сведения см. в статье [Рекомендации по использованию выполняющейся в памяти OLTP в среде виртуальных машин](#bkmk_VMs).  
  
```sql  
-- disable resource governor  
ALTER RESOURCE GOVERNOR DISABLE  
  
-- change the value of MAX_MEMORY_PERCENT  
ALTER RESOURCE POOL PoolHk  
WITH  
     ( MAX_MEMORY_PERCENT = 70 )  
GO  
  
-- reconfigure the Resource Governor to enabled it
ALTER RESOURCE GOVERNOR RECONFIGURE  
GO  
```  
  
 Дополнительные сведения о максимальных значениях параметра MAX_MEMORY_PERCENT см в разделе [Процент памяти, доступной для оптимизированных для памяти таблиц и индексов](../../relational-databases/in-memory-oltp/bind-a-database-with-memory-optimized-tables-to-a-resource-pool.md#bkmk_PercentAvailable).  
  
##### <a name="install-additional-memory"></a>Установка дополнительной памяти  
 В конечном счете наилучшим решением является установка дополнительной памяти. Если выбран этот вариант, то необходимо учитывать, что, скорее всего, также можно будет увеличить значение MAX_MEMORY_PERCENT (см. подраздел [Изменение параметров MIN_MEMORY_PERCENT и MAX_MEMORY_PERCENT для существующего пула](../../relational-databases/in-memory-oltp/bind-a-database-with-memory-optimized-tables-to-a-resource-pool.md#bkmk_ChangeAllocation)), так как [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] вряд ли будет нужно больше памяти, а это позволит выделить большую часть или даже всю установленную новую память пулу ресурсов.  
  
> [!IMPORTANT]  
>  Если сервер выполняется на ВМ и не выделен, установите такое же значение MIN_MEMORY_PERCENT, как и MAX_MEMORY_PERCENT.   
> Дополнительные сведения см. в статье [Рекомендации по использованию выполняющейся в памяти OLTP в среде виртуальных машин](#bkmk_VMs).  
  
##  <a name="resolve-page-allocation-failures-due-to-insufficient-memory-when-sufficient-memory-is-available"></a><a name="bkmk_PageAllocFailure"></a> Устранение ошибок выделения страниц, возникших из-за нехватки памяти при наличии достаточных ресурсов памяти  
 Если в журнале ошибок появилось сообщение об ошибке `Disallowing page allocations for database '*\<databaseName>*' due to insufficient memory in the resource pool '*\<resourcePoolName>*'. See 'https://go.microsoft.com/fwlink/?LinkId=330673' for more information.`, но доступной физической памяти достаточно для выделения страницы, это может быть связано с отключенным Resource Governor. Если регулятор ресурсов отключен, то MEMORYBROKER_FOR_RESERVE вызывает искусственную нагрузку на ресурсы памяти.  
  
 Для устранения этой ошибки необходимо включить регулятор ресурсов.  
  
 См. в разделе [Включение регулятора ресурсов](../../relational-databases/resource-governor/enable-resource-governor.md) дополнительные сведения об ограничениях, а также рекомендации по включению регулятора ресурсов через обозреватель объектов, свойства регулятора ресурсов или Transact-SQL.  
 
## <a name="best-practices-using-in-memory-oltp-in-a-vm-environment"></a><a name="bkmk_VMs"></a> Рекомендации по использованию выполняющейся в памяти OLTP в среде виртуальных машин
Виртуализация серверов позволяет не только снизить расходы на приобретение и эксплуатацию, но и добиться большей эффективности ИТ-процессов благодаря оптимизации подготовки, обслуживания, доступности и операций резервного копирования или восстановления приложений. В результате недавних успехов в развитии технологий стало проще консолидировать сложные рабочие нагрузки базы данных с применением виртуализации. В этой статье приведены рекомендации по использованию выполняющейся в памяти OLTP для SQL Server в виртуализированной среде.

### <a name="memory-pre-allocation"></a>Предварительное выделение памяти
В виртуальной среде важными факторами для памяти являются более высокая производительность и расширенная поддержка. Необходимо иметь возможность как быстро выделять память виртуальным машинам в зависимости от их требований (пиковые и низкие нагрузки), так и исключить бесполезные траты памяти. Компонент Hyper-V Dynamic Memory делает выделение памяти между виртуальными машинами, выполняемыми на узле, и управление ею более гибким.

Некоторые рекомендации по виртуализации и управлению SQL Server необходимо скорректировать при виртуализации базы данных с таблицами, оптимизированными для памяти. При отсутствии оптимизированных для памяти таблиц есть две рекомендации.
-  При использовании параметра "Мин. памяти сервера" рекомендуется назначать только необходимое количество памяти, чтобы осталось достаточно памяти для других процессов (во избежание вытеснения).
-  Не назначайте слишком высокого значения предварительного выделения памяти. В противном случае другие процессы могут не получить достаточной памяти к тому времени, когда она им потребуется, а это приведет к подкачке памяти.

Если следовать указанным выше рекомендациям, когда в базе данных есть оптимизированные для памяти таблицы, может выясниться, что попытка восстановить базу данных приводит к остановке базы данных в состоянии "Ожидание восстановления", даже если доступно достаточно памяти для восстановления базы данных. Причина в том, что при запуске выполняющаяся в памяти OLTP передает данные в память активнее, чем механизм выделения динамической памяти выделяет память базе данных.

### <a name="resolution"></a>Решение
Чтобы смягчить этот эффект, заранее выделите достаточную память, чтобы восстановить или перезапустить базу данных, а не минимальное значение, в расчете на то, что динамическая память выделит дополнительную память при необходимости.
  
## <a name="see-also"></a>См. также:  
 [Управление памятью для компонента In-Memory OLTP](https://msdn.microsoft.com/library/d82f21fa-6be1-4723-a72e-f2526fafd1b6)   
 [Наблюдение и устранение неисправностей при использовании памяти](../../relational-databases/in-memory-oltp/monitor-and-troubleshoot-memory-usage.md)   
 [Привязка базы данных с таблицами, оптимизированными для памяти, к пулу ресурсов](../../relational-databases/in-memory-oltp/bind-a-database-with-memory-optimized-tables-to-a-resource-pool.md)   
 [Руководство по архитектуре управления памятью](../../relational-databases/memory-management-architecture-guide.md)  
 [Параметры конфигурации сервера «Server Memory»](../../database-engine/configure-windows/server-memory-server-configuration-options.md) 
  
