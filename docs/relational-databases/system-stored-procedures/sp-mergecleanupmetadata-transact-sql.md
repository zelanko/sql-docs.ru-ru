---
description: sp_mergecleanupmetadata (Transact-SQL)
title: sp_mergecleanupmetadata (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: replication
ms.topic: language-reference
f1_keywords:
- sp_mergecleanupmetadata_TSQL
- sp_mergecleanupmetadata
helpviewer_keywords:
- sp_mergecleanupmetadata
ms.assetid: 892f8628-4cbe-4cc3-b959-ed45ffc24064
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 356c0aefb862d37d4c87af995e3b8d676a33e8a3
ms.sourcegitcommit: e700497f962e4c2274df16d9e651059b42ff1a10
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "88446950"
---
# <a name="sp_mergecleanupmetadata-transact-sql"></a>sp_mergecleanupmetadata (Transact-SQL)
[!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

  Следует использовать только в топологиях репликации, включающих серверы под управлением версий, [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] предшествовавших [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] пакету обновления 1 (** SP1). sp_mergecleanupmetadata** позволяет администраторам очищать метаданные в **MSmerge_genhistory**, **MSmerge_contents** и **MSmerge_tombstone** системных таблицах. Эта хранимая процедура выполняется на издателе в базе данных публикации.  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
sp_mergecleanupmetadata [ [ @publication = ] 'publication' ]  
    [ , [ @reinitialize_subscriber = ] 'reinitialize_subscriber' ]  
```  
  
## <a name="arguments"></a>Аргументы  
`[ @publication = ] 'publication'` Имя публикации. Аргумент *publication* имеет тип **sysname**и значение по умолчанию **%** , что очищает метаданные для всех публикаций. При явном указании публикации она должна существовать.  
  
`[ @reinitialize_subscriber = ] 'subscriber'` Указывает, следует ли повторно инициализировать подписчик. *Subscriber* имеет тип **nvarchar (5)**, может иметь **значение true** или **false**и значение по умолчанию **true**. Если **значение равно true**, подписки помечены для повторной инициализации. Если **значение равно false**, подписки не отмечены для повторной инициализации.  
  
## <a name="return-code-values"></a>Значения кода возврата  
 **0** (успешное завершение) или **1** (сбой)  
  
## <a name="remarks"></a>Комментарии  
 **sp_mergecleanupmetadata** следует использовать только в топологиях репликации, включающих серверы под управлением более ранних версий, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] чем [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] пакет обновления 1 (SP1). Топологии, включающие только [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] с пакетом обновления 1 (SP1) или более поздние версии, должны использовать очистку метаданных, основанную на сроке хранения. При выполнении этой хранимой процедуры следует помнить о необходимом и, возможно, значительном увеличении файла журнала на компьютере, на котором выполняется хранимая процедура.  
  
> [!CAUTION]
>  После выполнения **sp_mergecleanupmetadata** по умолчанию все подписки на подписчиках публикаций с метаданными, хранящимися в **MSmerge_genhistory**, **MSmerge_contents** и **MSmerge_tombstone** , помечаются для повторной инициализации, все ожидающие изменения на подписчике теряются, а текущий моментальный снимок отмечается как устаревший.  
> 
> [!NOTE]
>  Если в базе данных имеется несколько публикаций, а в любой из этих публикаций используется бесконечный срок хранения публикации (** \@ retention** = **0**), то при выполнении **sp_mergecleanupmetadata** не выполняется очистка метаданных отслеживания изменений репликации слиянием для базы данных. По этой причине, при использовании неограниченного срока хранения публикации необходимо помнить об осторожности.  
  
 При выполнении этой хранимой процедуры можно выбрать, следует ли повторно инициализировать подписчики, присвоив параметру ** \@ Reinitialize_subscriber** **значение true** (по умолчанию) или **false**. Если **sp_mergecleanupmetadata** выполняется с параметром ** \@ reinitialize_subscriber** , для которого установлено **значение true**, моментальный снимок повторно применяется на подписчике, даже если подписка была создана без исходного моментального снимка (например, если данные моментального снимка и схема были вручную применены или уже существовали на подписчике). При задании значения **false** для параметра следует использовать с осторожностью, поскольку если публикация не инициализирована повторно, необходимо убедиться, что данные на издателе и подписчике синхронизированы.  
  
 Независимо от значения ** \@ reinitialize_subscriber** **sp_mergecleanupmetadata** завершается ошибкой, если существуют выполняющиеся процессы слияния, которые пытаются передать изменения издателю или переопубликовать подписчику во время вызова хранимой процедуры.  
  
 **Выполняется sp_mergecleanupmetadata с \@ reinitialize_subscriber = true:**  
  
1.  Рекомендуется (но не является обязательным) остановить все обновления баз данных публикации и подписки. Если обновления будут продолжаться, выполненные обновления на подписчике с момента последнего слияния теряются при повторной инициализации публикации; при этом конвергенция данных сохраняется.  
  
2.  Выполните слияние с помощью агента слияния. При запуске агент слияния рекомендуется использовать параметр командной строки **-Validate** Agent на каждом подписчике. Если выполняется слияние в непрерывном режиме, см. раздел *специальные рекомендации по объединению непрерывного режима* далее в этом разделе.  
  
3.  После завершения всех слияний выполните **sp_mergecleanupmetadata**.  
  
4.  Выполните **sp_reinitmergepullsubscription** для всех подписчиков, использующих именованную или анонимную подписку по запросу для обеспечения конвергенции данных.  
  
5.  Если выполняется слияние в непрерывном режиме, см. раздел *специальные рекомендации по объединению непрерывного режима* далее в этом разделе.  
  
6.  Восстановите файлы моментального снимка для всех публикаций слиянием, используемым на всех уровнях. При попытке слияния без предварительного повторного формирования моментального снимка будет предложено повторно сформировать моментальный снимок.  
  
7.  Выполните резервное копирование базы данных публикации. Невыполнение этого требования может вызвать сбой слияния после восстановления базы данных публикации.  
  
 **При запуске sp_mergecleanupmetadata с \@ reinitialize_subscriber = false:**  
  
1.  Останавливает **все** обновления баз данных публикации и подписки.  
  
2.  Выполните слияние с помощью агента слияния. При запуске агент слияния рекомендуется использовать параметр командной строки **-Validate** Agent на каждом подписчике. Если выполняется слияние в непрерывном режиме, см. раздел *специальные рекомендации по объединению непрерывного режима* далее в этом разделе.  
  
3.  После завершения всех слияний выполните **sp_mergecleanupmetadata**.  
  
4.  Если выполняется слияние в непрерывном режиме, см. раздел *специальные рекомендации по объединению непрерывного режима* далее в этом разделе.  
  
5.  Восстановите файлы моментального снимка для всех публикаций слиянием, используемым на всех уровнях. При попытке слияния без предварительного повторного формирования моментального снимка будет предложено повторно сформировать моментальный снимок.  
  
6.  Выполните резервное копирование базы данных публикации. Невыполнение этого требования может вызвать сбой слияния после восстановления базы данных публикации.  

 **Специальные рассуждения о непрерывном режиме слияния**  
  
 При выполнении слияния в непрерывном режиме необходимо:  
  
-   Завершите агент слияния, а затем выполните еще одно слияние без указанного параметра **-Continuous** .  
  
-   Отключите публикацию с помощью **sp_changemergepublication** , чтобы гарантировать, что все объединенные в непрерывный режим слияния, выполняющие опрос состояния публикации, завершатся ошибкой.  
  
    ```  
    EXEC central..sp_changemergepublication @publication = 'dynpart_pubn', @property = 'status', @value = 'inactive'  
    ```  
  
 После завершения шага 3 выполнения **sp_mergecleanupmetadata**возобновите непрерывный режим слияния в зависимости от того, как вы их остановили. Любое из следующих:  
  
-   Добавьте параметр **-Continuous** обратно для агент слияния.  
  
-   Повторно активируйте публикацию с **sp_changemergepublication.**  
  
    ```  
    EXEC central..sp_changemergepublication @publication = 'dynpart_pubn', @property = 'status', @value = 'active'  
    ```  
  
## <a name="permissions"></a>Разрешения  
 Только члены предопределенной роли сервера **sysadmin** или предопределенной роли базы данных **db_owner** могут выполнять **sp_mergecleanupmetadata**.  
  
 Для использования данной хранимой процедуры на издателе должен использоваться [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)]. Подписчики должны работать под управлением [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] или [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 7,0, с пакетом обновления 2 (SP2).  
  
## <a name="see-also"></a>См. также  
 [MSmerge_genhistory &#40;Transact-SQL&#41;](../../relational-databases/system-tables/msmerge-genhistory-transact-sql.md)   
 [MSmerge_contents &#40;Transact-SQL&#41;](../../relational-databases/system-tables/msmerge-contents-transact-sql.md)   
 [MSmerge_tombstone &#40;Transact-SQL&#41;](../../relational-databases/system-tables/msmerge-tombstone-transact-sql.md)  
  
  
