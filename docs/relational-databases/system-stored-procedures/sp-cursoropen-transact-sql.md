---
title: sp_cursoropen (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: system-objects
ms.topic: language-reference
f1_keywords:
- sp_cursoropen
- sp_cursoropen_TSQL
dev_langs:
- TSQL
helpviewer_keywords:
- sp_cursoropen
ms.assetid: 16462ede-4393-4293-a598-ca88c48ca70b
author: stevestein
ms.author: sstein
manager: craigg
ms.openlocfilehash: 7410371f7d96f9770536a129de3a916b5f297a74
ms.sourcegitcommit: 2429fbcdb751211313bd655a4825ffb33354bda3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2018
ms.locfileid: "52517030"
---
# <a name="spcursoropen-transact-sql"></a>sp_cursoropen (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2008-xxxx-xxxx-xxx-md](../../includes/tsql-appliesto-ss2008-xxxx-xxxx-xxx-md.md)]

  Открывает курсор. sp_cursoropen определяет инструкцию SQL, связанную с курсором и параметрами курсора, а затем заполняет курсор. sp_cursoropen эквивалентно комбинации [!INCLUDE[tsql](../../includes/tsql-md.md)] инструкций DECLARE_CURSOR и OPEN. Для вызова этой процедуры необходимо задать ID =2 в пакете потока табличных данных (TDS).  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
sp_cursoropen cursor OUTPUT, stmt  
    [, scrollopt[ OUTPUT ] [ , ccopt[ OUTPUT ]  
    [ ,rowcount OUTPUT [ ,boundparam][,...n]]] ]]  
```  
  
## <a name="arguments"></a>Аргументы  
 *курсор*  
 Идентификатор курсора, созданный на SQL Server. *курсор* — *обрабатывать* значение, которое должен указываться во всех последующих процедур, использующих курсор, например sp_cursorfetch. *курсор* является обязательным параметром с **int** возвращаемое значение.  
  
 *курсор* позволяет нескольких курсоров активен на подключение к одной базе данных.  
  
 *stmt*  
 Обязательный параметр, который определяет результирующий набор курсора. Любая допустимая строка запроса (синтаксис и привязка) любого типа строки (независимо от Юникода, размер, т. д.) можно использовать в качестве является допустимым *stmt* тип значения.  
  
 *scrollopt*  
 Параметр прокрутки. *scrollopt* является необязательным параметром требует одного из следующих **int** входных значений.  
  
|Значение|Описание|  
|-----------|-----------------|  
|0x0001|KEYSET|  
|0x0002|DYNAMIC|  
|0x0004|FORWARD_ONLY|  
|0x0008|STATIC|  
|0x10|FAST_FORWARD|  
|0x1000|PARAMETERIZED_STMT|  
|0x2000|AUTO_FETCH|  
|0x4000|AUTO_CLOSE|  
|0x8000|CHECK_ACCEPTED_TYPES|  
|0x10000|KEYSET_ACCEPTABLE|  
|0x20000|DYNAMIC_ACCEPTABLE|  
|0x40000|FORWARD_ONLY_ACCEPTABLE|  
|0x80000|STATIC_ACCEPTABLE|  
|0x100000|FAST_FORWARD_ACCEPTABLE|  
  
 Поскольку существует возможность, что запрошенное значение не будет соответствовать курсору, заданному по *stmt*, этот параметр используется как входные и выходные данные. В таких случаях SQL Server присваивает соответствующее значение.  
  
 *ccopt*  
 Параметр управления параллелизмом. *ccopt* является необязательным параметром требует одного из следующих **int** входных значений.  
  
|Значение|Описание|  
|-----------|-----------------|  
|0x0001|READ_ONLY|  
|0x0002|SCROLL_LOCKS (прежнее название — LOCKCC)|  
|0x0004|**ОПТИМИСТИЧНЫЙ** (ранее — OPTCC)|  
|0x0008|OPTIMISTIC (прежнее название — OPTCCVAL)|  
|0x2000|ALLOW_DIRECT|  
|0x4000|UPDT_IN_PLACE|  
|0x8000|CHECK_ACCEPTED_OPTS|  
|0x10000|READ_ONLY_ACCEPTABLE|  
|0x20000|SCROLL_LOCKS_ACCEPTABLE|  
|0x40000|OPTIMISTIC_ACCEPTABLE|  
|0x80000|OPTIMISTIC_ACCEPTABLE|  
  
 Как и в *scrollopt*, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] может переопределить запрошенные *ccopt* значения.  
  
 *количество строк*  
 Количество строк буфера выборки для AUTO_FETCH. Значение по умолчанию составляет 20 строк. *количество строк* ведет себя по-разному, при назначении значение как входное или как возвращаемое.  
  
|Как входное значение|Как возвращаемое значение|  
|--------------------|---------------------|  
|Когда AUTO_FETCH *scrollopt* указано значение *rowcount* представляет число строк, чтобы поместить в буфер выборки.<br /><br /> Примечание: > 0 является допустимым значением, когда AUTO_FETCH, но не учитывается.|Представляет количество строк в результирующем наборе, за исключением случаев *scrollopt* значение AUTO_FETCH.|  
  
-  
  
 *boundparam*  
 Означает использование дополнительных параметров. *boundparam* — необязательный параметр, который следует задавать, если *scrollopt* значение PARAMETERIZED_STMT имеет значение ON.  
  
## <a name="return-code-values"></a>Значения кода возврата  
 Если не возникло ошибок, то процедура sp_cursoropen возвращает одно из следующих значений.  
  
 0  
 Процедура успешно выполнена.  
  
 0x0001  
 Ошибка во время выполнения (незначительная ошибка, недостаточная для того, чтобы создать ошибку операции).  
  
 0x0002  
 Выполняется асинхронная операция.  
  
 0x0002  
 Выполняется операция FETCH.  
  
 Объект  
 Курсор освобожден [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и недоступен.  
  
 Если возникла ошибка, то возвращаемые значения могут быть несогласованными и точность не гарантируется.  
  
 Когда *rowcount* параметр указывается как возвращаемое значение, происходит следующий результирующий набор.  
  
 -1  
 Возвращается, если количество строк неизвестно или неприменимо.  
  
 -n  
 Возвращается, если используется асинхронное заполнение. Представляет число строк, которые были помещены в fetch буфера, когда *scrollopt* значение AUTO_FETCH.  
  
 Если используется RPC, то возвращаются следующие значения.  
  
 0  
 Процедура успешно выполнена.  
  
 1  
 Процедура завершилась ошибкой.  
  
 2  
 Курсор, управляемый набором ключей, формируется асинхронно.  
  
 16  
 Курсор FAST_FORWARD автоматически закрыт.  
  
> [!NOTE]  
>  Если процедура sp_cursoropen выполнена успешно, то отправляются возвращаемые параметры RPC и результирующий набор с информацией в виде столбцов TDS (сообщения 0xa0 и 0xa1). В случае ошибки отправляется одно или несколько сообщений TDS об ошибках. В обоих случаях данные строк не возвращается и *сделать* количество сообщений, будут равны нулю. Если используется версия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ранее 7.0, то возвращаются сообщения 0xa0 и 0xa1 (стандартные для инструкции SELECT) с потоками токенов 0xa5 и 0xa4. Если используется [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] версии 7.0, то возвращается сообщение 0x81 (стандартное для инструкций SELECT) с потоками токенов 0xa5 и 0xa4.  
  
## <a name="remarks"></a>Примечания  
  
## <a name="stmt-parameter"></a>Параметр stmt  
 Если *stmt* задает выполнение хранимой процедуры, входные параметры могут быть определены как константы как часть *stmt* строковое или указан как *boundparam* аргументы. Таким образом, объявленные переменные могут передаваться как связанные параметры.  
  
 Допустимое содержимое *stmt* параметр зависят ли *ccopt* ALLOW_DIRECT возвращают значение связан оператором OR с остальной части *ccopt* значения, т. е.:  
  
-   Если ALLOW_DIRECT не указан, либо [!INCLUDE[tsql](../../includes/tsql-md.md)] SELECT или EXECUTE, инструкция вызова для хранимую процедуру, содержащую одиночной инструкции SELECT должен использоваться. Кроме того инструкция SELECT должна квалифицироваться как курсор; то есть он не может содержать ключевые слова SELECT INTO или FOR BROWSE.  
  
-   Если параметр ALLOW_DIRECT задан, то результатом может быть одна или несколько инструкций [!INCLUDE[tsql](../../includes/tsql-md.md)], включая те, которые в свою очередь выполняют другие хранимые процедуры с большим количеством инструкций. Инструкции, кроме SELECT, а также любая инструкция SELECT с ключевыми словами SELECT INTO или FOR BROWSE будут просто выполнены и не приведут к созданию курсора. Это относится и к любой инструкции SELECT, включенной в пакет из нескольких инструкций. Если инструкция SELECT содержит предложения, относящиеся только к курсорам, то эти предложения пропускаются. Например, если значение *ccopt* равен 0x2002, это запрос для:  
  
    -   курсор с блокированием прокрутки, если только одна инструкция SELECT квалифицируется как курсор, или  
  
    -   прямое выполнение инструкции, если есть несколько инструкций, одна инструкция, не являющаяся инструкцией SELECT, или инструкция SELECT, которая не квалифицируется как курсор.  
  
## <a name="scrollopt-parameter"></a>Параметр scrollopt  
 Первые пять *scrollopt* значения (KEYSEY, DYNAMIC, FORWARD_ONLY, STATIC и FAST_FORWARD) взаимно исключают друг друга.  
  
 PARAMETERIZED_STMT и CHECK_ACCEPTED_TYPES не могут быть связаны ни с одним из пяти первых значений оператором OR.  
  
 AUTO_FETCH и AUTO_CLOSE могут быть связаны оператором OR только с FAST_FORWARD.  
  
 Если CHECK_ACCEPTED_TYPES равен ON, по крайней мере один из последних пяти *scrollopt* значения (KEYSET_ACCEPTABLE`,` DYNAMIC_ACCEPTABLE, FORWARD_ONLY_ACCEPTABLE, STATIC_ACCEPTABLE или FAST_FORWARD_ACCEPTABLE) также должен иметь значение ON.  
  
 Курсоры STATIC всегда открываются только для чтения. Это означает, что обновить базовую таблицу через этот курсор невозможно.  
  
## <a name="ccopt-parameter"></a>Параметр ccopt  
 Первые четыре *ccopt* значения (READ_ONLY, SCROLL_LOCKS и оба значения OPTIMISTIC) взаимно исключают друг друга.  
  
> [!NOTE]  
>  Выбрав один из первых четырех *ccopt* значения определяет, является ли курсор только для чтения или если блокировки или оптимистические методы используются для предотвращения потерь обновлений. Если *ccopt* значение не указано, значение по умолчанию — OPTIMISTIC.  
  
 ALLOW_DIRECT и CHECK_ACCEPTED_TYPES могут быть связаны оператором OR с любым из первых четырех значений.  
  
 Параметр UPDT_IN_PLACE может быть связан оператором OR с READ_ONLY, SCROLL_LOCKS и любым из значений OPTIMISTIC.  
  
 Если CHECK_ACCEPTED_TYPES равен ON, по крайней мере один из последних четырех *ccopt* значения (READ_ONLY_ACCEPTABLE, SCROLL_LOCKS_ACCEPTABLE и любое из значений OPTIMISTIC_ACCEPTABLE) также должен иметь значение ON.  
  
 Позиционированные функции UPDATE и DELETE могут выполняться только в пределах буфера выборки, только если *ccopt* значение равно SCROLL_LOCKS или OPTIMISTIC. Если заданное значение — SCROLL_LOCKS, то операция будет гарантированно выполнена успешно. Если задано значение OPTIMISTIC, то операция закончится ошибкой, если строка изменилась с момента последней выборки.  
  
 Причина ошибки заключается в том, что, если задано значение OPTIMISTIC, выполняется оптимистическая функция управления параллелизмом путем сравнения отметок времени или контрольных сумм, заданных в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Если какие-либо из этих строк не совпадают, то операция завершится ошибкой.  
  
 Если UPDT_IN_PLACE задано в качестве возвращаемого значения, то результаты могут быть следующими.  
  
-   Если параметр не задан во время позиционированного обновления таблицы с уникальным индексом, то курсор удаляет строку из своей рабочей таблицы и вставляет ее в конце списка ключевых столбцов, используемых курсором, т. е. изменяет эти столбцы.  
  
-   Если параметр равен ON, то курсор просто обновит ключевые столбцы в исходной строке рабочей таблицы.  
  
## <a name="boundparam-parameter"></a>Параметр bound_param  
 Имя параметра должно быть *paramdef* при указании PARAMETERIZED_STMT, сообщение об ошибке в коде. Если PARAMETERIZED_STMT не задан, то имя в сообщении об ошибке не указывается.  
  
## <a name="rpc-considerations"></a>Замечания по RPC  
 Входной флажок RPC RETURN_METADATA может быть установлен в 0x0001, чтобы в потоке TDS возвращались метаданные списка выбора курсора.  
  
## <a name="examples"></a>Примеры  
  
### <a name="boundparam-parameter"></a>Параметр bound_param  
 Все параметры после пятого передаются в план инструкции как входные. Первый параметр должен представлять собой строку следующего вида:  
  
 *{Тип данных имени локальной переменной} [,... n].*  
  
 Последующие параметры используются для передачи значений должен быть замещен *имя локальной переменной* в инструкции.  
  
## <a name="see-also"></a>См. также  
 [Хранимая процедура sp_cursorfetch &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-cursorfetch-transact-sql.md)   
 [Системные хранимые процедуры (Transact-SQL)](../../relational-databases/system-stored-procedures/system-stored-procedures-transact-sql.md)  
  
  
