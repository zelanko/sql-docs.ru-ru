---
description: sp_cursoropen (Transact-SQL)
title: sp_cursoropen (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 03/14/2017
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: system-objects
ms.topic: language-reference
f1_keywords:
- sp_cursoropen
- sp_cursoropen_TSQL
dev_langs:
- TSQL
helpviewer_keywords:
- sp_cursoropen
ms.assetid: 16462ede-4393-4293-a598-ca88c48ca70b
author: markingmyname
ms.author: maghan
ms.openlocfilehash: 2942c06e5d63c0be25a05cd34e871447a29e7d6d
ms.sourcegitcommit: dd36d1cbe32cd5a65c6638e8f252b0bd8145e165
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/08/2020
ms.locfileid: "89543596"
---
# <a name="sp_cursoropen-transact-sql"></a>sp_cursoropen (Transact-SQL)
[!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

  Открывает курсор. sp_cursoropen определяет инструкцию SQL, связанную с курсором и параметрами курсора, а затем заполняет курсор. sp_cursoropen эквивалентен сочетанию [!INCLUDE[tsql](../../includes/tsql-md.md)] инструкций, DECLARE_CURSOR и Open. Для вызова этой процедуры необходимо задать ID =2 в пакете потока табличных данных (TDS).  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
sp_cursoropen cursor OUTPUT, stmt  
    [, scrollopt[ OUTPUT ] [ , ccopt[ OUTPUT ]  
    [ ,rowcount OUTPUT [ ,boundparam][,...n]]] ]]  
```  
  
## <a name="arguments"></a>Аргументы  
 *курсор*  
 Идентификатор курсора, созданный на SQL Server. *cursor* — это значение *обработчика* , которое должно быть указано во всех последующих процедурах, включающих курсор, например sp_cursorfetch. *cursor* является обязательным параметром с возвращаемым значением **int** .  
  
 *курсор* позволяет активно использовать несколько курсоров для одного подключения к базе данных.  
  
 *stmt*  
 Обязательный параметр, который определяет результирующий набор курсора. Любая допустимая строка запроса (синтаксис и привязка) любого строкового типа (независимо от Юникода, размера и т. д.) может использоваться в качестве допустимого типа значения *stmt* .  
  
 *scrollopt*  
 Параметр прокрутки. *scrollopt* — это необязательный параметр, для которого требуется одно из следующих входных значений **int** .  
  
|Значение|Описание|  
|-----------|-----------------|  
|0x0001|KEYSET|  
|0x0002|DYNAMIC|  
|0x0004|FORWARD_ONLY|  
|0x0008|STATIC|  
|0x10|FAST_FORWARD|  
|0x1000|PARAMETERIZED_STMT|  
|0x2000|AUTO_FETCH|  
|0x4000|AUTO_CLOSE|  
|0x8000|CHECK_ACCEPTED_TYPES|  
|0x10000|KEYSET_ACCEPTABLE|  
|0x20000|DYNAMIC_ACCEPTABLE|  
|0x40000|FORWARD_ONLY_ACCEPTABLE|  
|0x80000|STATIC_ACCEPTABLE|  
|0x100000|FAST_FORWARD_ACCEPTABLE|  
  
 Поскольку запрошенное значение не подходит для курсора, определенного аргументом *stmt*, этот параметр служит как входным, так и выходным. В таких случаях SQL Server присваивает соответствующее значение.  
  
 *ccopt*  
 Параметр управления параллелизмом. *ccopt* — это необязательный параметр, для которого требуется одно из следующих входных значений **int** .  
  
|Значение|Описание|  
|-----------|-----------------|  
|0x0001|READ_ONLY|  
|0x0002|SCROLL_LOCKS (прежнее название — LOCKCC)|  
|0x0004|**Оптимистичный** (ранее известный как опткк)|  
|0x0008|OPTIMISTIC (прежнее название — OPTCCVAL)|  
|0x2000|ALLOW_DIRECT|  
|0x4000|UPDT_IN_PLACE|  
|0x8000|CHECK_ACCEPTED_OPTS|  
|0x10000|READ_ONLY_ACCEPTABLE|  
|0x20000|SCROLL_LOCKS_ACCEPTABLE|  
|0x40000|OPTIMISTIC_ACCEPTABLE|  
|0x80000|OPTIMISTIC_ACCEPTABLE|  
  
 Как и в случае с *scrollopt*, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] может переопределить запрошенные значения *ccopt* .  
  
 *количества*  
 Количество строк буфера выборки для AUTO_FETCH. Значение по умолчанию составляет 20 строк. При назначении в качестве входного значения и возвращаемого значения *ROWCOUNT* ведет себя иначе.  
  
|Как входное значение|Как возвращаемое значение|  
|--------------------|---------------------|  
|Если значение AUTO_FETCH *scrollopt* задано, то число строк, помещаемых в буфер выборки *, представляется* в единице.<br /><br /> Примечание. >0 является допустимым значением, если указано значение AUTO_FETCH, но в противном случае оно игнорируется.|Представляет количество строк в результирующем наборе, за исключением случаев, когда указано значение AUTO_FETCH *scrollopt* .|  
  
-  
  
 *баундпарам*  
 Означает использование дополнительных параметров. *баундпарам* — это необязательный параметр, который должен быть указан, если значение *scrollopt* PARAMETERIZED_STMT установлено в on.  
  
## <a name="return-code-values"></a>Значения кода возврата  
 Если не возникло ошибок, то процедура sp_cursoropen возвращает одно из следующих значений.  
  
 0  
 Процедура успешно выполнена.  
  
 0x0001  
 Ошибка во время выполнения (незначительная ошибка, недостаточная для того, чтобы создать ошибку операции).  
  
 0x0002  
 Выполняется асинхронная операция.  
  
 0x0002  
 Выполняется операция FETCH.  
  
 Объект  
 Курсор освобожден [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и недоступен.  
  
 Если возникла ошибка, то возвращаемые значения могут быть несогласованными и точность не гарантируется.  
  
 Если в качестве возвращаемого значения указан параметр *ROWCOUNT* , то выполняется следующий результирующий набор.  
  
 -1  
 Возвращается, если количество строк неизвестно или неприменимо.  
  
 -n  
 Возвращается, если используется асинхронное заполнение. Представляет число строк, помещенных в буфер выборки при указании значения AUTO_FETCH *scrollopt* .  
  
 Если используется RPC, то возвращаются следующие значения.  
  
 0  
 Процедура успешно выполнена.  
  
 1  
 Процедура завершилась ошибкой.  
  
 2  
 Курсор, управляемый набором ключей, формируется асинхронно.  
  
 16  
 Курсор FAST_FORWARD автоматически закрыт.  
  
> [!NOTE]  
>  Если процедура sp_cursoropen выполнена успешно, то отправляются возвращаемые параметры RPC и результирующий набор с данными формата TDS (0x82 & 0xA1 messages). В случае ошибки отправляется одно или несколько сообщений TDS об ошибках. В любом случае данные строки не будут возвращены, а количество *готовых* сообщений будет равно нулю. Если используется версия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ранее 7.0, то возвращаются сообщения 0xa0 и 0xa1 (стандартные для инструкции SELECT) с потоками токенов 0xa5 и 0xa4. Если используется [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] версии 7.0, то возвращается сообщение 0x81 (стандартное для инструкций SELECT) с потоками токенов 0xa5 и 0xa4.  
  
## <a name="remarks"></a>Примечания  
  
## <a name="stmt-parameter"></a>Параметр stmt  
 Если аргумент *stmt* задает выполнение хранимой процедуры, входные параметры могут быть либо определены как константы в составе строки *stmt* , либо указаны как аргументы *баундпарам* . Таким образом, объявленные переменные могут передаваться как связанные параметры.  
  
 Допустимое содержимое параметра *stmt* зависит от того, было ли *ccopt* ALLOW_DIRECT возвращаемое значение, или к остальным значениям *ccopt* , например:  
  
-   Если параметр ALLOW_DIRECT не указан, [!INCLUDE[tsql](../../includes/tsql-md.md)] необходимо использовать инструкцию SELECT или Execute, которая вызывается для хранимой процедуры, содержащей одну инструкцию SELECT. Кроме того, инструкция SELECT должна квалифицироваться как курсор, т. е. она не может содержать ключевые слова SELECT INTO или FOR BROWSE.  
  
-   Если параметр ALLOW_DIRECT задан, то результатом может быть одна или несколько инструкций [!INCLUDE[tsql](../../includes/tsql-md.md)], включая те, которые в свою очередь выполняют другие хранимые процедуры с большим количеством инструкций. Инструкции, кроме SELECT, а также любая инструкция SELECT с ключевыми словами SELECT INTO или FOR BROWSE будут просто выполнены и не приведут к созданию курсора. Это относится и к любой инструкции SELECT, включенной в пакет из нескольких инструкций. Если инструкция SELECT содержит предложения, относящиеся только к курсорам, то эти предложения пропускаются. Например, если значение *ccopt* равно 0x2002, то это запрос для:  
  
    -   курсор с блокированием прокрутки, если только одна инструкция SELECT квалифицируется как курсор, или  
  
    -   прямое выполнение инструкции, если есть несколько инструкций, одна инструкция, не являющаяся инструкцией SELECT, или инструкция SELECT, которая не квалифицируется как курсор.  
  
## <a name="scrollopt-parameter"></a>Параметр scrollopt  
 Первые пять значений *scrollopt* (КЭЙСЭЙ, DYNAMIC, FORWARD_ONLY, STATIC и FAST_FORWARD) являются взаимоисключающими.  
  
 PARAMETERIZED_STMT и CHECK_ACCEPTED_TYPES не могут быть связаны ни с одним из пяти первых значений оператором OR.  
  
 AUTO_FETCH и AUTO_CLOSE могут быть связаны оператором OR только с FAST_FORWARD.  
  
 Если CHECK_ACCEPTED_TYPES включен, по крайней мере одно из последних пяти значений *scrollopt* (KEYSET_ACCEPTABLE `,` DYNAMIC_ACCEPTABLE, FORWARD_ONLY_ACCEPTABLE, STATIC_ACCEPTABLE или FAST_FORWARD_ACCEPTABLE) также должно иметь значение ON.  
  
 Курсоры STATIC всегда открываются только для чтения. Это означает, что обновить базовую таблицу через этот курсор невозможно.  
  
## <a name="ccopt-parameter"></a>Параметр ccopt  
 Первые четыре значения *ccopt* (READ_ONLY, SCROLL_LOCKS и оба оптимистичных значения) являются взаимоисключающими.  
  
> [!NOTE]  
>  Выбор одного из первых четырех значений *ccopt* определяет, доступен ли курсор только для чтения, или если для предотвращения потерянных обновлений используются блокировки или оптимистичные методы. Если значение *ccopt* не указано, значение по умолчанию — оптимистичный.  
  
 ALLOW_DIRECT и CHECK_ACCEPTED_TYPES могут быть связаны оператором OR с любым из первых четырех значений.  
  
 Параметр UPDT_IN_PLACE может быть связан оператором OR с READ_ONLY, SCROLL_LOCKS и любым из значений OPTIMISTIC.  
  
 Если CHECK_ACCEPTED_TYPES имеет значение ON, то по крайней мере одно из последних четырех значений *ccopt* (READ_ONLY_ACCEPTABLE, SCROLL_LOCKS_ACCEPTABLE и любого из OPTIMISTIC_ACCEPTABLE значений) также должно быть равно ON.  
  
 Функции позиционированного обновления и удаления могут выполняться только в буфере выборки и только в том случае, если значение *ccopt* равно SCROLL_LOCKS или оптимистическому. Если заданное значение — SCROLL_LOCKS, то операция будет гарантированно выполнена успешно. Если задано значение OPTIMISTIC, то операция закончится ошибкой, если строка изменилась с момента последней выборки.  
  
 Причина ошибки заключается в том, что, если задано значение OPTIMISTIC, выполняется оптимистическая функция управления параллелизмом путем сравнения отметок времени или контрольных сумм, заданных в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Если какие-либо из этих строк не совпадают, то операция завершится ошибкой.  
  
 Если UPDT_IN_PLACE задано в качестве возвращаемого значения, то результаты могут быть следующими.  
  
-   Если параметр не задан во время позиционированного обновления таблицы с уникальным индексом, то курсор удаляет строку из своей рабочей таблицы и вставляет ее в конце списка ключевых столбцов, используемых курсором, т. е. изменяет эти столбцы.  
  
-   Если параметр равен ON, то курсор просто обновит ключевые столбцы в исходной строке рабочей таблицы.  
  
## <a name="bound_param-parameter"></a>Параметр bound_param  
 Имя параметра должно быть *парамдеф* , если указано значение PARAMETERIZED_STMT, в соответствии с сообщением об ошибке в коде. Если PARAMETERIZED_STMT не задан, то имя в сообщении об ошибке не указывается.  
  
## <a name="rpc-considerations"></a>Замечания по RPC  
 Входной флажок RPC RETURN_METADATA может быть установлен в 0x0001, чтобы в потоке TDS возвращались метаданные списка выбора курсора.  
  
## <a name="examples"></a>Примеры  
  
### <a name="bound_param-parameter"></a>Параметр bound_param  
 Все параметры после пятого передаются в план инструкции как входные. Первый параметр должен представлять собой строку следующего вида:  
  
 *{тип данных "имя локальной переменной"} [,... \n*  
  
 Последующие параметры используются для передачи значений, подставляемых для *имени локальной переменной* в операторе.  
  
## <a name="see-also"></a>См. также  
 [sp_cursorfetch &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-cursorfetch-transact-sql.md)   
 [Системные хранимые процедуры (Transact-SQL)](../../relational-databases/system-stored-procedures/system-stored-procedures-transact-sql.md)  
  
  
