---
title: Распространенные ошибки при использовании управляемых клиентом ключей в Azure Key Vault
description: Узнайте, как выявлять и устранять проблемы с доступом и распространенные ошибки, связанные с прозрачным шифрованием данных (TDE) и управляемыми клиентом ключами в Azure Key Vault.
ms.custom: seo-lt-2019
helpviewer_keywords:
- troublshooting, tde akv
- tde akv configuration, troubleshooting
- tde troubleshooting
author: jaszymas
ms.prod: sql
ms.technology: security
ms.reviewer: vanto
ms.topic: conceptual
ms.date: 11/06/2019
ms.author: jaszymas
monikerRange: = azuresqldb-current || = azure-sqldw-latest || = sqlallproducts-allversions
ms.openlocfilehash: 16368fe948d2cefeb052d503385c99cedfb097ff
ms.sourcegitcommit: a4ee6957708089f7d0dda15668804e325b8a240c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2020
ms.locfileid: "87899003"
---
# <a name="common-errors-for-transparent-data-encryption-with-customer-managed-keys-in-azure-key-vault"></a>Распространенные ошибки с прозрачным шифрованием данных (TDE) с использованием управляемых клиентом ключей в Azure Key Vault

[!INCLUDE[asdb-asdbmi-asa](../../../includes/applies-to-version/asdb-asdbmi-asa.md)]

В этой статье описывается, как выявить и устранить проблемы с доступом к ключу в Azure Key Vault, из-за которых база данных, настроенная на [использование прозрачного шифрования данных (TDE) с управляемыми клиентом ключами в Azure Key Vault](/azure/sql-database/transparent-data-encryption-byok-azure-sql), стала недоступной.

## <a name="introduction"></a>Введение
Если для TDE настроено использование управляемого клиентом ключа в Azure Key Vault, нужно обеспечить постоянный доступ к этому предохранителю TDE, чтобы база данных сохраняла подключение к сети.  Если логический сервер SQL Server потеряет доступ к управляемому клиентом предохранителю TDE в Azure Key Vault, база данных начнет блокировать все подключения с выводом соответствующего сообщения об ошибке, а ее состояние изменится на *Недоступна* на портале Azure.

Если проблему доступа к ключам в основном хранилище Azure Key Vault разрешить в течение первых 8 часов, база данных автоматически восстановится и подключится к сети. Это означает, что во всех сценариях с периодическими или временными сбоями в сети вмешательство пользователя не требуется и база данных автоматически подключится к сети. В большинстве случаев для устранения проблемы с доступом к ключу в основном хранилище ключей требуется вмешательство пользователя. 

Если недоступная база данных больше не нужна, вы можете сразу удалить ее, чтобы плата не начислялась. Другие действия с базой данных запрещено выполнять, пока не восстановится доступ к ключу в Azure Key Vault и база данных снова не подключится к сети. Вы также не сможете изменить на сервере параметр TDE с управляемых клиентом ключей на управляемые службой ключи, если база данных, зашифрованная с помощью управляемых клиентом ключей, недоступна. Это необходимо для защиты данных от несанкционированного доступа на период отзыва разрешений для предохранителя TDE. 

Если база данных остается недоступной дольше 8 часов, она не восстановится автоматически. Если необходимый доступ к ключу в Azure Key Vault был восстановлен по прошествии этого времени, вам нужно вручную повторно проверить доступ к ключу, чтобы база данных подключилась к сети. Для подключения базы данных к сети может потребоваться много времени (в зависимости от размера базы данных). После подключения базы данных к сети ранее настроенные значения таких параметров, как [группа отработки отказа](https://docs.microsoft.com/azure/sql-database/sql-database-auto-failover-group), журнал PITR и теги, будут **утрачены**. Поэтому рекомендуется реализовать систему отправки уведомлений с помощью [групп действий](https://docs.microsoft.com/azure/azure-monitor/platform/action-groups), которая позволит быть в курсе проблем с доступом к ключам в основным хранилище и устранять их как можно скорее. 

## <a name="common-errors-causing-databases-to-become-inaccessible"></a>Распространенные ошибки, из-за которых базы данных становятся недоступными

Большинство проблем, возникающих при использовании TDE с Key Vault, вызваны одной из следующих ошибок конфигурации:

### <a name="the-key-vault-is-unavailable-or-doesnt-exist"></a>Хранилище ключей недоступно или не существует.

- Хранилище ключей случайно удалено.
- Брандмауэр разрешает доступ к Azure Key Vault, но запрещает доступ к службам Майкрософт.
- Временная ошибка сети, которая приводит к недоступности хранилища ключей.

### <a name="no-permissions-to-access-the-key-vault-or-the-key-doesnt-exist"></a>Нет разрешения на доступ к хранилищу ключей или ключ не существует.

- Ключ случайно удален, отключен или истек его срок действия.
- Удостоверение AppId экземпляра логического сервера SQL Server случайно удалено.
- Экземпляр логического сервера SQL Server перемещен в другую подписку. Если логический сервер был перемещен в другую подписку, необходимо создать новое удостоверение AppId.
- Предоставленные для AppId разрешения использовать ключи являются недостаточными (не позволяют получать, упаковывать и распаковывать ключи).
- Разрешения для AppId экземпляра логического сервера SQL Server были отозваны.

## <a name="identify-and-resolve-common-errors"></a>Определение и исправление распространенных ошибок

В этом разделе перечислены действия по устранению распространенных ошибок.

### <a name="missing-server-identity"></a>Отсутствует идентификатор сервера

**Сообщение об ошибке**

_401 AzureKeyVaultNoServerIdentity. Удостоверение сервера неправильно настроено на сервере. Обратитесь в службу поддержки._

**Обнаружение**

Чтобы убедиться, что удостоверение было назначено экземпляру логического сервера SQL Server, используйте следующие командлет или команду:

- Azure PowerShell: [Get-AzureRMSqlServer](https://docs.microsoft.com/powershell/module/AzureRM.Sql/Get-AzureRmSqlServer?view=azurermps-6.13.0) 

- Azure CLI: [az-sql-server-show](https://docs.microsoft.com/cli/azure/sql/server?view=azure-cli-latest#az-sql-server-show)

**Исправление**

Чтобы настроить удостоверение Azure AD (AppId), используйте следующие командлет или команду для экземпляра логического SQL Server:

- Azure PowerShell: [Set-AzureRmSqlServer](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqlserver?view=azurermps-6.13.0) с параметром `-AssignIdentity`.

- Azure CLI: [az sql server update](https://docs.microsoft.com/cli/azure/sql/server?view=azure-cli-latest#az-sql-server-update) с параметром `--assign_identity`.

На портале Azure перейдите в хранилище ключей и выберите **Политики доступа**. Выполните следующие действия: 

 1. Нажмите кнопку **Добавить**, чтобы добавить AppId для сервера, созданного на предыдущем шаге. 
 1. Назначьте следующие разрешения ключей: Get, Wrap и Unwrap 

Дополнительные сведения см. в руководстве по [назначению серверу удостоверения Azure Active Directory](/azure/sql-database/transparent-data-encryption-byok-azure-sql-configure#assign-an-azure-ad-identity-to-your-server).

> [!IMPORTANT]
> Если экземпляр логического сервера SQL Server был перемещен в другой клиент после начальной настройки TDE с Key Vault, шаг настройки удостоверения Azure AD следует повторить, чтобы создать новый идентификатор AppId. Затем добавьте AppId в хранилище ключей и назначьте правильные разрешения для ключа. 
>

### <a name="missing-key-vault"></a>Отсутствующее хранилище ключей

**Сообщение об ошибке**

_503 AzureKeyVaultConnectionFailed. Операцию не удалось завершить на сервере, так как не удалось подключиться к Azure Key Vault._

**Обнаружение**

Чтобы определить URI ключа и хранилище ключей, сделайте следующее:

1. Чтобы получить URI ключа на определенном экземпляре логического сервера SQL Server, используйте следующие командлет или команду:

    - Azure PowerShell: [Get-AzureRmSqlServerKeyVaultKey](https://docs.microsoft.com/powershell/module/azurerm.sql/get-azurermsqlserverkeyvaultkey?view=azurermps-6.13.0)

    - Azure CLI: [az-sql-server-tde-key-show](https://docs.microsoft.com/cli/azure/sql/server/tde-key?view=azure-cli-latest#az-sql-server-tde-key-show) 

1. Используйте URI ключа для идентификации хранилища ключей:

    - Azure PowerShell: можно изучить свойства переменной $MyServerKeyVaultKey, чтобы получить сведения о хранилище ключей.

    - Azure CLI: проверьте полученное средство защиты шифрования сервера на наличие сведений о хранилище ключей.

**Исправление**

Убедитесь, что хранилище ключей доступно:

- Убедитесь, что хранилище ключей доступно и что экземпляр логического сервера SQL Server имеет к нему доступ.
- Если хранилище ключей защищено брандмауэром, убедитесь, что установлен флажок, разрешающий службам Майкрософт доступ к хранилищу ключей.
- Если хранилище ключей было случайно удалено, настройку следует повторить с самого начала.


### <a name="missing-key"></a>Отсутствует ключ

**Сообщения об ошибках**

_404 ServerKeyNotFound. Запрашиваемый ключ сервера не найден в текущей подписке._ 

_409 ServerKeyDoesNotExists. Ключ сервера не существует._

**Обнаружение**

Чтобы определить URI ключа и хранилище ключей, сделайте следующее:

- Чтобы получить URI ключа, добавленного к экземпляру логического сервера SQL Server, используйте следующие командлет или команду в [отсутствующем хранилище ключей](#missing-key-vault): Эти команды возвращают список ключей.

**Исправление**

Убедитесь, что средство защиты TDE присутствует в Key Vault:

1. Определите хранилище ключей и перейдите к нему на портале Azure.
1. Убедитесь, что ключ, определенный по URI ключа, присутствует.

### <a name="missing-permissions"></a>Отсутствуют разрешения

**Сообщение об ошибке**

_401 AzureKeyVaultMissingPermissions. У сервера отсутствуют необходимые разрешения для Azure Key Vault._

**Обнаружение**

Чтобы определить URI ключа и хранилище ключей, сделайте следующее: 

- Чтобы определить хранилище ключей, которое использует экземпляр логического сервера SQL Server, используйте следующие командлет или команду в [отсутствующем хранилище ключей](#missing-key-vault).

**Исправление**

Убедитесь, что экземпляр логического сервера SQL Server имеет разрешения в хранилище ключей и необходимые разрешения для доступа к ключу.

- На портале Azure перейдите в хранилище ключей и выберите **Политики доступа**. Найдите AppId экземпляра логического сервера SQL Server.  
- Если удостоверение AppId присутствует, убедитесь, что оно имеет следующие основные разрешения: Get, Wrap и Unwrap.
- Если AppId отсутствует, добавьте его с помощью кнопки **Добавить**. 

## <a name="getting-tde-status-from-the-activity-log"></a>Получение состояния TDE из журнала действий

Чтобы обеспечить мониторинг состояния базы данных в связи с проблемами с доступом к ключам в Azure Key Vault, в [журнал действий](https://docs.microsoft.com/azure/service-health/alerts-activity-log-service-notifications) будут заноситься следующие события по идентификатору ресурса, основанного на URL-адресе Azure Resource Manager, а также подписке, группе ресурсов, имени сервера и имени базы данных. 

**Событие, когда служба теряет доступ к ключу в Azure Key Vault**

Имя события: MakeDatabaseInaccessible 

Состояние: Запущено 

Описание. База данных потеряла доступ к ключу в хранилище ключей Azure и теперь недоступна: <error message>   

 

**Событие, когда начинается 8-часовой период ожидания для самостоятельного восстановления** 

Имя события: MakeDatabaseInaccessible 

Состояние: InProgress 

Описание. База данных ожидает, что пользователь попытается повторно установить доступ к ключу в Azure Key Vault в течение 8 часов.   

 

**Событие, когда база данных автоматически подключается к сети**

Имя события: MakeDatabaseAccessible 

Состояние: Выполнено 

Описание. Восстановлен доступ базы данных к ключу в Azure Key Vault, и теперь база данных подключена к сети. 

 

**Событие, когда проблема не была разрешена в течение 8 часов и доступ к ключу в Azure Key Vault нужно проверить вручную** 

Имя события: MakeDatabaseInaccessible 

Состояние: Выполнено 

Описание. База данных недоступна и ожидает, чтобы пользователем были устранены ошибки в Azure Key Vault и восстановлен доступ к ключу в Azure Key Vault с помощью повторной проверки ключа. 

 

**Событие, когда база данных подключается к сети после повторной проверки ключа вручную**

Имя события: MakeDatabaseAccessible 

Состояние: Выполнено 

Описание. Восстановлен доступ базы данных к ключу в Azure Key Vault, и теперь база данных подключена к сети. 

 

**Событие, когда повторная проверка доступа к ключу в Azure Key Vault прошла успешно и база данных подключилась к сети**

Имя события: MakeDatabaseAccessible 

Состояние: Запущено 

Описание. Начато восстановление доступа базы данных к ключу в Azure Key Vault. 

 

**Событие, когда повторная проверка доступа к ключу в Azure Key Vault завершилась ошибкой**

Имя события: MakeDatabaseAccessible 

Состояние: Ошибка 

Описание. Не удалось восстановить доступ базы данных к ключу в Azure Key Vault. 


## <a name="next-steps"></a>Дальнейшие действия

- См. дополнительные сведения о [работоспособности ресурсов Azure](https://docs.microsoft.com/azure/service-health/resource-health-overview).
- Настройте [группы действий](https://docs.microsoft.com/azure/azure-monitor/platform/action-groups), чтобы получать уведомления и оповещения на основе ваших предпочтений, например по электронной почте, в виде SMS, push-уведомлений или голосовых сообщений, с использованием приложения логики, веб-перехватчика, ITSM или runbook службы автоматизации. 


