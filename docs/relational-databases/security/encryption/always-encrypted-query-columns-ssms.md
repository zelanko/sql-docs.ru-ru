---
title: Выполнение запросов к столбцам с помощью Always Encrypted с использованием SQL Server Management Studio | Документация Майкрософт
description: Узнайте, как запрашивать столбцы в Always Encrypted с использованием SQL Server Management Studio. Извлечение зашифрованных данных или текстовых значений, хранящихся в зашифрованных столбцах.
ms.custom: ''
ms.date: 10/31/2019
ms.prod: sql
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
helpviewer_keywords:
- Always Encrypted, configure with SSMS
ms.assetid: 29816a41-f105-4414-8be1-070675d62e84
author: jaszymas
ms.author: jaszymas
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: 37ac7271be5090f17db16f67968df6eca138856d
ms.sourcegitcommit: 22e97435c8b692f7612c4a6d3fe9e9baeaecbb94
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2020
ms.locfileid: "92679031"
---
# <a name="query-columns-using-always-encrypted-with-sql-server-management-studio"></a>Выполнение запросов к столбцам с помощью Always Encrypted с использованием SQL Server Management Studio
[!INCLUDE [SQL Server Azure SQL Database](../../../includes/applies-to-version/sql-asdb.md)]

В этой статье описывается выполнение запросов к столбцам, зашифрованным с помощью [Always Encrypted](../../../relational-databases/security/encryption/always-encrypted-database-engine.md), с использованием [SQL Server Management Studio (SSMS)](../../../ssms/download-sql-server-management-studio-ssms.md). С помощью SSMS вы можете выполнять следующие задачи:
- извлечение значений зашифрованных данных, хранящихся в зашифрованных столбцах; 
- извлечение значений открытого текста, хранящихся в зашифрованных столбцах;   
- отправка значений открытого текста, предназначенных для зашифрованных столбцов (например, в инструкциях `INSERT` или `UPDATE` и в инструкциях `SELECT` в виде параметра поиска в предложениях `WHERE`).

## <a name="retrieving-ciphertext-values-stored-in-encrypted-columns"></a>Извлечение зашифрованных данных, хранящихся в зашифрованных столбцах    
Выполнение запросов SELECT для извлечения данных в виде зашифрованного текста, хранящихся в зашифрованных столбцах (без расшифровки данных), не требует доступа к главным ключам столбцов, защищающих данные. Чтобы извлечь значения в виде зашифрованного текста в среде SSMS сделайте следующее.

1. Убедитесь, что у вас есть доступ к метаданным о ключах, защищающих столбцы, к которым выполняется запрос. Хотя доступ к фактическим главным ключам столбцов не нужен, для просмотра объектов метаданных главного ключа столбца и ключа шифрования столбцов в базе данных необходимы разрешения уровня базы данных. Дополнительные сведения см. в разделе [Разрешения для выполнения запросов к зашифрованным столбцам](#permissions-for-querying-encrypted-columns) ниже.
1. Отключите функцию Always Encrypted, применяемую для подключения к базе данных, в окне редактора запросов, где будет выполнен запрос `SELECT` для извлечения значений открытого текста. См. раздел [Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных](#en-dis) ниже.     
1. Выполните запрос `SELECT`. Любые данные, полученные из зашифрованных столбцов, возвращаются в виде двоичных (зашифрованных) значений.   

### <a name="example"></a>Пример
Предположим, что `SSN` — это зашифрованный столбец в таблице `Patients` . В этом случае если функция Always Encrypted, применяемая для подключения к базе данных, отключена, то выполнив приведенный ниже запрос, вы получите двоичные значения зашифрованных данных.   

![Снимок экрана: запрос SELECT [SSN] FROM [dbo].[Patients] и его результаты, представленные в виде двоичных зашифрованных значений.](../../../relational-databases/security/encryption/media/always-encrypted-ciphertext.png)
 
## <a name="retrieving-plaintext-values-stored-in-encrypted-columns"></a>Извлечение значений открытого текста, хранящихся в зашифрованных столбцах    
Чтобы извлечь значения открытого текста из зашифрованного столбца (а затем расшифровать их), сделайте следующее:   
1. Убедитесь, что у вас есть доступ к главным ключам столбцов и метаданным о ключах, защищающих столбцы, к которым выполняется запрос. Дополнительные сведения см. в разделе [Разрешения для выполнения запросов к зашифрованным столбцам](#permissions-for-querying-encrypted-columns) ниже.
1.  Убедитесь, что вы включили функцию Always Encrypted, применяемую для подключения к базе данных, в окне редактора запросов, где будет выполняться запрос `SELECT` для извлечения и расшифровки данных. Он указывает поставщику данных .NET Framework для SQL Server (используемому средой SSMS) расшифровать зашифрованные столбцы в результирующем наборе запроса. См. раздел [Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных](#en-dis) ниже.
1.  Выполните запрос `SELECT`. Все данные, полученные из зашифрованных столбцов, возвращаются в виде значений открытого текста исходных типов данных.
 
### <a name="example"></a>Пример
Предположим, что SSN — это зашифрованный столбец `char(11)` в таблице `Patients` . В этом случае, если функция Always Encrypted, применяемая для подключения к базе данных, включена, и при этом у вас есть доступ к главному ключу, настроенному для столбца `SSN` , приведенный ниже запрос вернет значения открытого текста.   

![Снимок экрана: запрос SELECT [SSN] FROM [Clinic].[dbo].[Patients] и его результаты, представленные в виде обычных текстовых значений.](../../../relational-databases/security/encryption/media/always-encrypted-plaintext.png)
 
## <a name="sending-plaintext-values-targeting-encrypted-columns"></a>Отправка значений открытого текста, предназначенных для зашифрованных столбцов       
Чтобы выполнить запрос на отправку значения в зашифрованный столбец, например запрос на вставку, обновление или фильтрацию значений, хранящихся в зашифрованном столбце, сделайте следующее:

1. Убедитесь, что у вас есть доступ к главным ключам столбцов и метаданным для ключей, защищающих столбцы, к которым выполняется запрос. Дополнительные сведения см. в разделе [Разрешения для выполнения запросов к зашифрованным столбцам](#permissions-for-querying-encrypted-columns) ниже.
1.  Убедитесь, что вы включили функцию Always Encrypted, применяемую для подключения к базе данных, в окне редактора запросов, где будет выполняться запрос `SELECT` для извлечения и расшифровки данных. Он указывает поставщику данных .NET Framework для SQL Server (используемому средой SSMS) расшифровать зашифрованные столбцы в результирующем наборе запроса. См. раздел [Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных](#en-dis) ниже.
1. Включите параметризацию для Always Encrypted в окне редактора запросов. (Требуются службы SSMS версии не ниже 17.0.) Объявите переменную Transact-SQL и инициализируйте ее, используя значение, которое нужно отправить (вставить, обновить или использовать для фильтрации) в базу данных. Дополнительные сведения см. в разделе [Параметризация для Always Encrypted](#param) ниже.

1. Выполните запрос, чтобы отправить значение переменной Transact-SQL в базу данных. SQL Server Management Studio преобразует эту переменную в параметр запроса, значение которого шифруется перед отправкой в базу данных.   

### <a name="example"></a>Пример
Предположим, что `SSN` — это зашифрованный столбец `char(11)` в таблице `Patients` . В этом случае если функция Always Encrypted, применяемая для подключения к базе данных, включена, в окне редактора запросов включена параметризация для Always Encrypted и при этом у вас есть доступ к главному ключу, настроенному для столбца `'795-73-9838'` , то приведенный ниже скрипт произведет попытку найти строку, содержащую значение `LastName` в столбце SSN, и вернет значение столбца `SSN` .   

![Снимок экрана: запрос DECLARE @SSN CHAR(11) = '795-73-9838' SELECT [LastName] FROM [dbo].[Patients] WHERE [SSN] = @SSN и его результаты.](../../../relational-databases/security/encryption/media/always-encrypted-patients.png)

## <a name="permissions-for-querying-encrypted-columns"></a>Разрешения для выполнения запросов к зашифрованным столбцам

Чтобы выполнять любые запросы к зашифрованным столбцам, в том числе запросы на извлечение зашифрованных данных, в базе данных необходимо иметь разрешения `VIEW ANY COLUMN MASTER KEY DEFINITION` и `VIEW ANY COLUMN ENCRYPTION KEY DEFINITION` .

Помимо указанных выше разрешений, чтобы расшифровать любые результаты и зашифровать параметры запроса (созданные в процессе параметризации переменных Transact-SQL), также требуется доступ к главному ключу столбца, который используется для защиты целевых столбцов.

- **Хранилище сертификатов — локальный компьютер** : требуется доступ на чтение (`Read`) к сертификату, который используется в качестве главного ключа столбца, либо необходимо быть администратором компьютера.   
- **Azure Key Vault** — требуются разрешения `get`, `unwrapKey` и `verify` для хранилища, содержащего главный ключ столбца.
- **Поставщик хранилища ключей (KSP)**  — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и KSP.   
- **Поставщик служб шифрования (CSP)**  — необходимые разрешения и учетные данные, которые могут быть запрошены при использовании хранилища ключей или ключа, зависят от конфигурации хранилища и CSP.

Дополнительные сведения см. в разделе [Create and Store Column Master Keys (Always Encrypted)](../../../relational-databases/security/encryption/create-and-store-column-master-keys-always-encrypted.md)(Создание и хранение главных ключей столбцов (постоянное шифрование)).

## <a name="enabling-and-disabling-always-encrypted-for-a-database-connection"></a><a name="en-dis"></a> Включение и отключение функции Always Encrypted, применяемой для подключения к базе данных   
При подключении к базе данных в среде SSMS можно включить или отключить функцию Always Encrypted, применяемую для подключения к базе данных. По умолчанию функция Always Encrypted отключена. 

После включения функции Always Encrypted, применяемой для подключения к базе данных, поставщик данных .NET Framework для SQL Server, используемый в SQL Server Management Studio, получает установку на прозрачное выполнение следующих действий:   
-   расшифровка любых значений, полученных из зашифрованных столбцов и возращенных в результатах запроса;   
-   шифрование значений параметризованных переменных Transact-SQL, предназначенных для зашифрованных столбцов базы данных.   

Если функция Always Encrypted, применяемая для подключения к базе данных, не включена, поставщик данных .NET Framework для SQL Server, используемый средой SSMS, не будет пытаться зашифровать параметры запроса или расшифровать результаты.

Always Encrypted можно включить или отключить при создании подключения или изменении существующего подключения в диалоговом окне **Соединение с сервером** . 

Чтобы включить или отключить Always Encrypted, выполните следующие действия.
1. Откройте диалоговое окно **Соединение с сервером** (см. статью [Подключение к экземпляру SQL Server](../../../ssms/quickstarts/connect-query-sql-server.md#connect-to-a-sql-server-instance)).
1. Щелкните **Параметры >>** .
1. Если используется SSMS 18 или более поздние версии:
    1. Выберите вкладку **Always Encrypted** .
    1. Чтобы включить Always Encrypted, щелкните **Включить Always Encrypted (шифрование столбца)** . Чтобы отключить Always Encrypted, снимите флажок **Включить Always Encrypted (шифрование столбца)** .
    1. Если вы используете [!INCLUDE [sssqlv15-md](../../../includes/sssqlv15-md.md)] и для экземпляра SQL Server настроен безопасный анклав, можно указать URL-адрес аттестации анклава. Если ваш экземпляр SQL Server не использует безопасный анклав, поле **URL-адрес аттестации анклава** следует оставить пустым. Дополнительные сведения см. в статье [Always Encrypted с безопасными анклавами](always-encrypted-enclaves.md).
1. Если используется SSMS 17 или более ранние версии:
    1. Выберите вкладку **Дополнительные свойства** .
    1. Чтобы включить Always Encrypted, введите `Column Encryption Setting = Enabled`. Чтобы отключить Always Encrypted, укажите `Column Encryption Setting = Disabled` или удалите **параметр шифрования столбца** на вкладке **Дополнительные свойства** (значение по умолчанию — **Отключено** ).   
 1. Нажмите кнопку **Соединить** .

> [!TIP]
> Чтобы включить или отключить функцию Always Encrypted в текущем окне редактора запросов, сделайте следующее:   
> 1.    Щелкните правой кнопкой мыши в любом месте окна редактора запросов.
> 2.    Выберите **Соединение** > **Изменить соединение** . В окне редактора запросов откроется диалоговое окно **Соединение с сервером** для текущего подключения. 
> 2.    Включите или отключите Always Encrypted, выполнив описанные выше действия, и нажмите кнопку **Подключить** .  
   
## <a name="parameterization-for-always-encrypted"></a><a name="param"></a>Параметризация для Always Encrypted   
 
Параметризация для Always Encrypted — это функция в SQL Server Management Studio, которая автоматически преобразует переменные Transact-SQL в параметры запросов (экземпляры [класса SqlParameter](/dotnet/api/system.data.sqlclient.sqlparameter)). (Требуются службы SSMS версии не ниже 17.0.) Это позволяет основному поставщику данных .NET Framework для SQL Server определять данные, предназначенные для зашифрованных столбцов, и шифровать эти данные перед отправкой в базу данных. 
  
Без параметризации поставщик данных .NET Framework передает все инструкции, созданные в редакторе запросов, в виде непараметризованных запросов. Если запрос содержит литералы или переменные Transact-SQL, предназначенные для зашифрованных столбцов, поставщик данных .NET Framework для SQL Server не сможет определить и зашифровать их перед отправкой запроса в базу данных. В результате этого из-за несоответствия типов (между переменной Transact-SQ литерала открытого текста и зашифрованным столбцом) запрос завершится сбоем. Например, если столбец `SSN` зашифрован, без параметризации следующий запрос завершится сбоем.   

```sql
DECLARE @SSN NCHAR(11) = '795-73-9838'
SELECT * FROM [dbo].[Patients]
WHERE [SSN] = @SSN
```

### <a name="enabling-and-disabling-parameterization-for-always-encrypted"></a>Включение и отключение параметризации для Always Encrypted

По умолчанию параметризация для Always Encrypted отключена.

Чтобы включить или отключить параметризацию для Always Encrypted в текущем окне редактора запросов, выполните следующие действия:

1. В главном меню выберите **Запрос** .
2. Щелкните **Параметры запроса...** .
3. Выберите **Выполнение** > **Дополнительно** .
4. Установите или снимите флажок **Включить определение параметров для Always Encrypted** .
5. Нажмите кнопку **ОК** .

Чтобы включить или отключить параметризацию для Always Encrypted в будущих окнах редактора запросов, выполните следующие действия:

1. В главном меню выберите **Средства** .
2. Выберите **Параметры** .
3. Выберите **Выполнение запроса** > **SQL Server** > **Дополнительно** .
4. Установите или снимите флажок **Включить определение параметров для Always Encrypted** .
5. Нажмите кнопку **ОК** .

При выполнении запроса в окне редактора запросов с включенной функцией Always Encrypted, применяемой для подключения к базе данных, но с отключенной параметризацией появится запрос на включение этой возможности.

> [!NOTE]
> Параметризация для Always Encrypted работает только в окнах редактора запросов, использующих подключения к базе данных с включенной функцией Always Encrypted (см. раздел [Включение и отключение параметризации для Always Encrypted](#enabling-and-disabling-parameterization-for-always-encrypted)). Если эта функция отключена в окне редактора запросов, параметризация переменных Transact-SQL не выполняется.

### <a name="how-parameterization-for-always-encrypted-works"></a>Принципы работы параметризации для Always Encrypted

Если в окне редактора запросов включена и функция Always Encrypted, применяемая для подключения к базе данных, и параметризация для Always Encrypted, SQL Server Management Studio произведет попытку параметризовать переменные Transact-SQL, соответствующие следующим требованиям.

- Эти переменные объявлены и инициализированы в одной инструкции (встроенная инициализация). Параметризация переменных, объявленных с использованием разных инструкций `SET`, не выполняется.
- Эти переменные инициализированы с использованием одного литерала. Параметризация переменных, инициализированных с использованием выражений, в том числе любых операторов и функций, не выполняется.

Ниже приведены примеры переменных, которые параметризуются в SQL Server Management Studio.

```sql
DECLARE @SSN char(11) = '795-73-9838';
   
DECLARE @BirthDate date = '19990104';
DECLARE @Salary money = $30000;
```

Вот некоторые примеры переменных, параметризация которых не выполняется в SQL Server Management Studio.

```sql
DECLARE @Name nvarchar(50); --Initialization separate from declaration
SET @Name = 'Abel';

DECLARE @StartDate date = GETDATE(); -- a function used instead of a literal

DECLARE @NewSalary money = @Salary * 1.1; -- an expression used instead of a literal
```
 
Параметризация происходит успешно в следующих случаях:   
- тип литерала, используемый для инициализации переменной, параметризация которой выполняется, должен совпадать с типом в объявлении переменной;   
- если в качестве объявленного типа переменной используется тип даты или времени, переменную нужно инициализировать, используя строку в одном из следующих [совместимых с ISO 8601 форматов](../../../t-sql/functions/cast-and-convert-transact-sql.md#date-and-time-styles).    

Ниже приведены примеры объявлений переменных Transact-SQL, которые приводят к ошибкам параметризации переменных.   
```sql
DECLARE @BirthDate date = '01/04/1999' -- unsupported date format   
   
DECLARE @Number int = 1.1 -- the type of the literal does not match the type of the variable   
```
SQL Server Management Studio использует технологию Intellisense, чтобы предоставлять сведения о том, для каких переменных можно определить параметры, а для каких эта операция завершится сбоем (с указанием причины).   

Объявление переменной, для которой можно определить параметры, подчеркивается линией в редакторе запросов. Если навести указатель мыши на подчеркнутую инструкцию объявления, отобразится результат параметризации, в том числе значения основных свойств результирующего объекта [SqlParameter](/dotnet/api/system.data.sqlclient.sqlparameter) (с которым сопоставляется переменная): [SqlDbType](/dotnet/api/system.data.sqlclient.sqlparameter.sqldbtype), [Size](/dotnet/api/system.data.sqlclient.sqlparameter.size), [Precision](/dotnet/api/system.data.sqlclient.sqlparameter.precision), [Scale](/dotnet/api/system.data.sqlclient.sqlparameter.scale), [SqlValue](/dotnet/api/system.data.sqlclient.sqlparameter.sqlvalue). Кроме того, в представлении **Список ошибок** на вкладке **Предупреждение** можно просмотреть полный список всех параметризованных переменных. Чтобы открыть представление **Список ошибок** , выберите в главном меню **Представление** , а затем щелкните **Список ошибок** .    

Если попытка определить параметры переменной в SQL Server Management Studio завершилась сбоем, объявление переменной будет помечено знаком ошибки. Если навести указатель мыши на помеченную инструкцию выражения, отобразятся результаты ошибки. Полный список ошибок параметризации для всех переменных можно просмотреть в представлении **Список ошибок** на вкладке **Ошибка** . Чтобы открыть представление **Список ошибок** , выберите в главном меню **Представление** , а затем щелкните **Список ошибок** .   

На снимке экрана ниже приведены примеры шести объявлений переменных. Параметризация первых трех переменных в SQL Server Management Studio выполнена успешно. Три последние переменные не соответствуют необходимым требованиям. Поэтому они не были параметризованы в SQL Server Management Studio (их объявления не отмечены).

![Снимок экрана: пример шести объявлений переменных, из которых три успешно параметризованы, а три вызвали сбой, а также связанные предупреждающие сообщения.](../../../relational-databases/security/encryption/media/always-encrypted-parameter-warnings.png)
 
В приведенном ниже примере две переменные соответствуют требованиям, необходимым для параметризации, но этот процесс завершился сбоем, так как их инициализация выполнена неправильно.    
 
![Снимок экрана: пример двух объявлений переменных, которые в итоге вызвали сбой, а также связанные сообщения об ошибках.](../../../relational-databases/security/encryption/media/always-encrypted-error.png)
 
> [!NOTE]
> Функция Always Encrypted поддерживает ограниченное подмножество преобразований типов, поэтому во многих случаях необходимо, чтобы тип данных в переменной Transact-SQL совпадал с типом целевого столбца базы данных, для которого она применяется. Например, предположим, что столбец `SSN` в таблице `Patients` — это столбец `char(11)`. В этом случае приведенный ниже запрос завершится сбоем, так как тип переменной `@SSN` ( `nchar(11)`) не совпадает с типом столбца.   

```sql
DECLARE @SSN nchar(11) = '795-73-9838'
SELECT * FROM [dbo].[Patients]
WHERE [SSN] = @SSN;
```

```output
Msg 402, Level 16, State 2, Line 5   
The data types char(11) encrypted with (encryption_type = 'DETERMINISTIC', 
encryption_algorithm_name = 'AEAD_AES_256_CBC_HMAC_SHA_256', column_encryption_key_name = 'CEK_Auto1', 
column_encryption_key_database_name = 'Clinic') collation_name = 'Latin1_General_BIN2' 
and nchar(11) encrypted with (encryption_type = 'DETERMINISTIC', 
encryption_algorithm_name = 'AEAD_AES_256_CBC_HMAC_SHA_256', column_encryption_key_name = 'CEK_Auto1', 
column_encryption_key_database_name = 'Clinic') are incompatible in the equal to operator.
```

> [!NOTE]
> Если параметризация отключена, весь запрос, в том числе преобразования типов, обрабатывается в SQL Server или Базе данных SQL Azure, а если эта функция включена, часть преобразований типов выполняется на платформе .NET Framework в SQL Server Management Studio. Из-за различия между типами систем .NET Framework и SQL Server (например, разная точность некоторых типов, таких как float) результаты, полученные после выполнения запроса с включенной и отключенной функцией параметризации, могут отличаться. 

## <a name="next-steps"></a>Next Steps
- [Разработка приложений с помощью Always Encrypted](always-encrypted-client-development.md)


## <a name="see-also"></a>См. также:
- [Always Encrypted](../../../relational-databases/security/encryption/always-encrypted-database-engine.md)