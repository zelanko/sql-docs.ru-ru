---
title: Планирование аттестации службы защиты узла
description: Планирование аттестации службы защиты узла для SQL Server Always Encrypted с безопасными анклавами.
ms.custom: ''
ms.date: 10/12/2019
ms.prod: sql
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
author: rpsqrd
ms.author: ryanpu
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: d774df3329c6c9e49e9e1bd9a86dbeaf30ac5765
ms.sourcegitcommit: b2e81cb349eecacee91cd3766410ffb3677ad7e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2020
ms.locfileid: "74317957"
---
# <a name="plan-for-host-guardian-service-attestation"></a>Планирование аттестации службы защиты узла

[!INCLUDE [tsql-appliesto-ssver15-xxxx-xxxx-xxx-winonly](../../../includes/tsql-appliesto-ssver15-xxxx-xxxx-xxx-winonly.md)]

При использовании [Always Encrypted с безопасными анклавами](always-encrypted-enclaves.md) необходимо, чтобы в рамках процесса [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] клиентское приложение обращалось к доверенному анклаву. Если речь идет об анклаве безопасности на основе виртуализации (VBS), это требование предполагает проверку допустимости кода в анклаве и подлинности компьютера, на котором размещается [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)]. В процессе удаленной аттестации эта задача реализуется за счет ввода третьей стороны, которая может проверять подлинность (и при необходимости конфигурацию) компьютера [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)]. Прежде чем [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] сможет использовать анклав для выполнения запроса, он должен предоставить службе аттестации сведения об операционной среде для получения сертификата работоспособности. Затем этот сертификат отправляется клиенту для независимой проверки подлинности в службе аттестации. После того как клиент установит отношение доверия с сертификатом работоспособности, он будет обращаться к надежному анклаву VBS и создаст запрос, который будет использовать этот анклав.

Роль службы защиты узла (HGS) в Windows Server 2019 предоставляет возможности удаленной аттестации для Always Encrypted с анклавами VBS.
В этой статье описываются действия, выполняемые перед развертыванием, и требования к использованию Always Encrypted с анклавами VBS и аттестацией HGS.

## <a name="architecture-overview"></a>Обзор архитектуры

Служба защиты узла (HGS) — это кластеризованная веб-служба, работающая в Windows Server 2019.
В типичном сценарии развертывания будут поддерживаться 1–3 сервера HGS, как минимум один компьютер с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] и компьютер, на котором работают клиентское приложение или средства, такие как SQL Server Management Studio.
Так как служба HGS отвечает за определение доверенных компьютеров с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], ей требуется как физическая, так и логическая изоляция от защищаемого экземпляра [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)].
Если доступ к службе HGS и компьютеру [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] имеют одни и те же администраторы, они могут настроить службу аттестации так, чтобы на компьютере злоумышленника работал [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], способствуя, таким образом, компрометации анклава VBS.

### <a name="hgs-domain"></a>Домен HGS

В ходе установки HGS автоматически создается домен Active Directory для серверов HGS, ресурсов отказоустойчивого кластера и учетных записей администраторов.

Компьютер с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] не обязательно должен входить в домен, но если это так, то домен должен быть отличным от используемого сервером HGS.

### <a name="high-availability"></a>Высокий уровень доступности

Функция HGS автоматически устанавливает и настраивает отказоустойчивый кластер.
Для обеспечения высокой доступности в рабочей среде рекомендуется использовать три сервера HGS. Сведения об определении кворума кластера и информацию об альтернативных конфигурациях, включая кластеры двух узлов с внешним следящим сервером, см. в [документации по отказоустойчивому кластеру](https://docs.microsoft.com/windows-server/failover-clustering/manage-cluster-quorum).

Между узлами HGS не требуется создавать общее хранилище. Копия базы данных аттестации хранится на каждом сервере HGS и автоматически реплицируется по сети службой кластеров.

### <a name="network-connectivity"></a>Сетевое подключение

Клиент SQL и [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] должны иметь возможность взаимодействовать со службой HGS по протоколу HTTP.
Настройте HGS с помощью сертификата TLS для шифрования всех данных, передаваемых между клиентом SQL и HGS, а также между SQL Server и HGS.
Такая конфигурация помогает обеспечить защиту от атак типа "злоумышленник в середине" и гарантирует связь с правильным сервером HGS.

В целях обеспечения синхронизации базы данных службы аттестации сервера HGS требуют установить подключение между каждым узлом в кластере. В сценарии отказоустойчивости рекомендуется подключить узлы HGS к одной сети для связи с кластером и использовать отдельную сеть для взаимодействия других клиентов с HGS.

### <a name="attestation-modes"></a>Режимы аттестации

Когда компьютер с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] пытается пройти аттестацию с помощью HGS, он сначала запрашивает HGS о способе аттестации.
HGS поддерживает два режима аттестации, используемых с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)].

| Режим аттестации | Объяснение |
| ---------------- | ------- |
| TPM | Аттестация доверенного платформенного модуля (TPM) обеспечивает надежную гарантию идентификации и целостности компьютера, проходящего аттестацию с помощью HGS. Для этого на компьютерах с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] должен быть установлен TPM версии 2.0. Каждая микросхема доверенного платформенного модуля имеет уникальный и неизменяемый идентификатор (ключ подтверждения), который можно использовать для проверки подлинности конкретного компьютера. Кроме того, модули TPM измеряют процесс загрузки компьютера, сохраняя хэши чувствительных к безопасности измерений в регистрах управления платформой (PCR), которые могут быть считаны, но не изменены операционной системой. Эти измерения используются во время аттестации для криптографического доказательства заявленной конфигурации безопасности компьютера. |
| Ключ узла | Аттестация ключа узла — это упрощенная форма аттестации для проверки подлинности компьютера только с помощью пары асимметричных ключей. Закрытый ключ хранится на компьютере с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], а открытый ключ предоставляется службе HGS. Конфигурация безопасности компьютера не оценивается, и для компьютера с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] не требуется микросхема TPM 2.0. Необходимо защитить закрытый ключ, установленный на компьютере [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], так как любой пользователь, получающий этот ключ, может олицетворить законный компьютер [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] и анклав VBS, работающий в [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)]. |

Ниже приведены общие рекомендации.

- Для **физических рабочих серверов** мы рекомендуем использовать аттестацию TPM по причине обеспечиваемых ею дополнительных гарантий.
- Для **виртуальных рабочих серверов** мы рекомендуем использовать аттестацию ключа узла, так как в большинстве виртуальных машин виртуальные модули TPM или безопасная загрузка недоступны. Если вы используете виртуальную машину с повышенным уровнем безопасности, например [локальную экранированную виртуальную машину](https://aka.ms/shieldedvms), можно выбрать режим TPM. Во всех виртуализованных развертываниях процесс аттестации анализирует только среду виртуальной машины, но не ее базовую платформу виртуализации.
- В **сценариях разработки и тестирования** рекомендуется использовать аттестацию ключа узла, так как ее проще настроить.

### <a name="trust-model"></a>Модель доверия

В модели доверия анклава VBS зашифрованные запросы и данные проходят оценку в программном анклаве, чтобы защитить его из ОС узла.
Доступ к анклаву защищается гипервизором по такому же принципу, когда две виртуальные машины, работающие на одном компьютере, не могут получить доступ к памяти друг друга.
Чтобы установить отношение доверия между клиентом и допустимым экземпляром VBS, необходимо использовать аттестацию на основе TPM, формирующую аппаратный уровень доверия на компьютере [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)].
Измерения доверенного платформенного модуля, выполненные во время процесса загрузки, включают уникальный ключ удостоверения экземпляра VBS, гарантирующий, что сертификат работоспособности действителен только на этом конкретном компьютере.
Кроме того, если доверенный платформенный модуль доступен на компьютере с VBS, TPM защищает закрытую часть ключа удостоверения VBS, исключая попытки олицетворения этого экземпляра VBS.

В режиме аттестации TPM необходимо включить функцию безопасной загрузки, гарантирующую загрузку законного и подписанного корпорацией Майкрософт загрузчика и исключающую перехват процесса загрузки низкоуровневой оболочки программами rootkit.
Кроме того, по умолчанию требуется устройство IOMMU, запрещающее всем устройствам с прямым доступом к памяти проверять или изменять память анклава.

Для работы всех этих средств защиты предполагается, что компьютер с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] является физическим компьютером.
После виртуализации компьютера с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] вы не сможете гарантировать, что память виртуальной машины защищена от проверок со стороны низкоуровневой оболочки или администратора низкоуровневой оболочки. Администратор низкоуровневой оболочки может, например, создать дамп памяти виртуальной машины и получить доступ к текстовой версии запроса и данным в анклаве.
Аналогично, даже если в виртуальной машине есть виртуальный доверенный платформенный модуль, он может измерять только состояние и целостность операционной системы виртуальной машины и среды загрузки.
Он не может измерять состояние низкоуровневой оболочки, управляющей виртуальной машиной.

Однако даже после виртуализации [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] анклав будет защищен от атак, исходящих из операционной системы виртуальной машины.
Если вы доверяете низкоуровневой оболочке или поставщику облачных услуг и опасаетесь атак со стороны администратора базы данных и администратора ОС, направленных на конфиденциальные данные, виртуализованный экземпляр [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] может стать подходящим решением.

Кроме того, аттестация ключа узла сохраняет свою ценность в ситуациях, когда модуль TPM 2.0 не установлен на компьютере с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], или в сценариях разработки и тестирования, где безопасность не является приоритетом.
Вы по-прежнему можете использовать многие из упомянутых выше функций безопасности, включая безопасную загрузку и модуль TPM 1.2, чтобы повысить уровень защиты VBS и операционной системы в целом.
Однако поскольку в рамках аттестации узла ключа служба HGS не может проверить, что эти параметры включены на компьютере, клиенту не гарантируется, что узел действительно использует все доступные средства защиты.

## <a name="prerequisites"></a>Предварительные требования

### <a name="hgs-server-prerequisites"></a>Необходимые компоненты для сервера HGS

Компьютер с ролью службы защиты узла, должны соответствовать следующим требованиям.

| Компонент | Требование |
| --------- | ----------- |
| Операционная система | Windows Server 2019, выпуск Standard или Datacenter |
| ЦП | 2 ядра (минимум), 4 ядра (рекомендуется) |
| ОЗУ | 8 ГБ (минимум) |
| Сетевые карты | Рекомендуются две сетевые карты со статическими IP-адресами (одна для трафика кластера и одна для службы HGS) |

HGS — это роль, использующая ресурсы ЦП, которые необходимы для действий, требующих шифрования и расшифровки.
Использование современных процессоров с возможностями ускорения шифрования повысит производительность HGS.
Требования к хранению данных аттестации минимальны: от 10 КБ до 1 МБ на каждый проходящий аттестацию компьютер.

Компьютер HGS не должен быть присоединен к домену перед началом работы.

### <a name="include-ssnoversion-mdincludesssnoversion-mdmd-computer-prerequisites"></a>Предварительные требования к компьютеру [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)]

Компьютер с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] должен соответствовать [требованиям для установки SQL Server](../../../sql-server/install/hardware-and-software-requirements-for-installing-sql-server.md) и [требованиям к оборудованию Hyper-V](https://docs.microsoft.com/virtualization/hyper-v-on-windows/reference/hyper-v-requirements#hardware-requirements).

Предъявляются следующие требования.

- [!INCLUDE [sssqlv15-md](../../../includes/sssqlv15-md.md)] или более поздней версии
- Windows 10 Корпоративная (версия 1809) или более поздние версии или выпуск Windows Server 2019 Datacenter. Другие выпуски Windows 10 и Windows Server не поддерживают аттестацию с помощью HGS.
- Поддержка ЦП для технологий виртуализации:
  - Intel VT-x с Extended Page Tables.
  - AMD-V с Rapid Virtualization Indexing.
  - Если [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] работает на виртуальной машине, низкоуровневая оболочка и физический ЦП должны предоставлять возможности вложенной виртуализации. Сведения о гарантиях, доступных при выполнении анклавов VBS на виртуальной машине, см. в разделе о [модели доверия](#trust-model).
    - В Hyper-V 2016 или более поздней версии [включите расширения вложенной виртуализации на процессоре виртуальной машины](https://docs.microsoft.com/virtualization/hyper-v-on-windows/user-guide/nested-virtualization#configure-nested-virtualization).
    - В Azure выберите размер виртуальной машины, поддерживающий вложенную виртуализацию. Вложенную виртуализацию поддерживают все виртуальные машины серии v3, например Dv3 и Ev3. См. раздел [Create a nesting capable Azure VM](/azure/virtual-machines/windows/nested-virtualization#create-a-nesting-capable-azure-vm) (Создание виртуальной машины Azure с поддержкой вложения).
    - В VMWare vSphere 6.7 или более поздней версии включите для виртуальной машины поддержку безопасности на основе виртуализации, как описано в [документации VMware](https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-C2E78F3E-9DE2-44DB-9B0A-11440800AADD.html).
    - Другие низкоуровневые оболочки и общедоступные облака могут поддерживать возможности вложенной виртуализации, позволяющие использовать Always Encrypted с анклавами VBS. Просмотрите сведения о совместимости и инструкции по настройке в документации по своему решению для виртуализации.
- Если вы планируете выполнить аттестацию TPM, для работы на сервере потребуется микросхема TPM 2.0 ред. 1.16. В настоящее время аттестация HGS не работает с микросхемами TPM 2.0 ред. 1.38. Кроме того, доверенный платформенный модуль должен иметь допустимый сертификат ключа подтверждения.

## <a name="devtest-environment-considerations"></a>Рекомендации для среды разработки и тестирования

Если вы используете Always Encrypted с анклавами VBS в среде разработки или тестирования и вам не требуется высокий уровень доступности или надежная защита компьютера с [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], воспользуйтесь одной или всеми приведенными ниже рекомендациями для упрощенного развертывания.

- Разверните только один узел HGS. Несмотря на то, что HGS устанавливает отказоустойчивый кластер, добавлять дополнительные узлы не нужно, если высокий уровень доступности не является приоритетным фактором.
- Для упрощения процесса установки вместо режима TPM используйте режим ключа узла.
- Выполните виртуализацию HGS и (или) [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)] для сохранения физических ресурсов.
- Запустите SSMS или другие средства для настройки Always Encrypted с безопасными анклавами на том же компьютере, где работает [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)]. В этом случае главные ключи столбцов останутся на том же компьютере, что и [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)], поэтому это не следует делать в рабочей среде.

## <a name="next-steps"></a>Дальнейшие действия

- [Развертывание службы защиты узла для [!INCLUDE [ssnoversion-md](../../../includes/ssnoversion-md.md)]](./always-encrypted-enclaves-host-guardian-service-deploy.md)
