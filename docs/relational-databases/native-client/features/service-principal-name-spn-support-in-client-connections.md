---
title: "Поддержка имени участника-службы (SPN) в клиентских соединениях | Документы Microsoft"
ms.custom: 
ms.date: 08/08/2016
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.service: 
ms.component: native-client|features
ms.reviewer: 
ms.suite: sql
ms.technology: 
ms.tgt_pltfrm: 
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client, SPNs
- ODBC, SPNs
- OLE DB, SPNs
- SPNs [SQL Server]
ms.assetid: 96598c69-ce9a-4090-aacb-d546591e8af7
caps.latest.revision: "31"
author: MightyPen
ms.author: genemi
manager: craigg
ms.workload: On Demand
ms.openlocfilehash: fe0670bbb967a10d2d14750f2a32a321cc912fce
ms.sourcegitcommit: 9e6a029456f4a8daddb396bc45d7874a43a47b45
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/25/2018
---
# <a name="service-principal-name-spn-support-in-client-connections"></a>Поддержка имени участника-службы в клиентских соединениях
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]
[!INCLUDE[SNAC_Deprecated](../../../includes/snac-deprecated.md)]

  Начиная с версии [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)], поддержка имен участников-служб (SPN) была расширена для поддержки взаимной проверки подлинности по всем протоколам. В предыдущих версиях [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], имена участников-служб поддерживались только для протокола Kerberos по протоколу TCP при по умолчанию имени участника-службы для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляр был зарегистрирован с помощью Active Directory.  
  
 Имена участников-служб используются протоколом проверки подлинности для определения учетной записи, в котором [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] запускается экземпляр. Если учетная запись экземпляра известна, то можно использовать проверку подлинности Kerberos для взаимной проверки подлинности клиентом и сервером. Если учетная запись экземпляра неизвестна, то используется только проверка подлинности NTLM, которая обеспечивает проверку подлинности клиента сервером. В настоящее время [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] собственный клиент выполняет преобразование проверки подлинности, получая имя участника-службы из экземпляра имени и свойств сетевого подключения. [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]попытаются зарегистрировать имена участников-служб при запуске, или они могут быть зарегистрированы вручную. Однако регистрация завершится ошибкой, если учетная запись, которая пытается зарегистрировать имена участников-служб, не имеет достаточных прав доступа.  
  
 Учетные записи домена и компьютера автоматически регистрируются в Active Directory. Их можно использовать в качестве имен участников-служб, или же администраторы могут определить собственные имена участников-служб. [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Безопасная проверка подлинности стала более управляемой и надежной благодаря возможности клиента напрямую указать имя участника-службы для использования.  
  
> [!NOTE]  
>  Указанное клиентским приложением имя участника-службы используется только в том случае, если соединение устанавливается с использованием встроенной безопасности Windows.  
  
> [!TIP]  
>  **[!INCLUDE[msCoName](../../../includes/msconame-md.md)] диспетчер конфигурации Kerberos для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]** — это диагностическое средство, которое помогает расследовать проблемы Kerberos со связью при использовании [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в разделе [Диспетчер конфигурации Microsoft Kerberos для SQL Server](http://www.microsoft.com/download/details.aspx?id=39046).  
  
 Дополнительные сведения о протоколе Kerberos см. в следующих статьях.  
  
-   [Дополнение технической Kerberos для Windows](http://go.microsoft.com/fwlink/?LinkId=101449)  
  
-   [Microsoft Kerberos](http://go.microsoft.com/fwlink/?LinkID=100758)  
  
## <a name="usage"></a>Использование  
 В следующей таблице описаны наиболее типичные сценарии, в которых клиентские приложения могут включить безопасную проверку подлинности.  
  
|Сценарий|Описание|  
|--------------|-----------------|  
|Приложение прежней версии не указывает имя участника-службы.|Этот сценарий совместимости гарантирует, что не будет изменений в работе приложений, разработанных для предыдущих версий [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Если имя участника-службы не указано, то приложение использует сформированные имена участников-служб и ничего не знает об используемом методе проверки подлинности.|  
|Клиентское приложение, использующее текущую версию [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] собственный клиент указывает имени участника-службы в строке соединения как учетную запись пользователя или компьютера домена, имени участника-службы для конкретного экземпляра или определяемой пользователем строкой.|Ключевое слово **ServerSPN** может быть указано в строке поставщика, инициализации или соединения, для следующих целей.<br /><br /> — Укажите учетную запись, используемую [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра для подключения. Это упрощает доступ к проверке подлинности Kerberos. Если имеется центр распространения ключей Kerberos (KDC) и указана верная учетная запись, то проверка подлинности Kerberos будет предпочтительнее, чем NTLM. KDC обычно размещается на том же компьютере, что и контроллер домена.<br /><br /> -Указать имя участника-службы для учетной записи службы поиска [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра. Для каждого [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляр два создаются по умолчанию имена участников-служб, который может использоваться для этой цели. Однако эти ключи не обязательно будут созданы в Active Directory, поэтому в такой ситуации проверка подлинности Kerberos не гарантирована.<br /><br /> -Указать имя участника-службы, который будет использоваться для поиска учетной записи службы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра. Это может быть любая определенная пользователем строка, сопоставляемая с учетной записью службы. В этом случае ключ должен быть вручную зарегистрирован в центре распространения ключей и удовлетворять правилам для определенных пользователем имен участников-служб.<br /><br /> Ключевое слово **FailoverPartnerSPN** указывает имя партнера-службы для сервера-партнера по обеспечению отработки отказа. Ранг учетной записи и ключевые значения Active Directory те же, что и значения, которые можно указать для основного сервера.|  
|Приложение ODBC указывает имя партнера-службы как атрибут соединения для основного сервера или сервера-партнера по обеспечению отработки отказа.|Атрибут соединения **SQL_COPT_SS_SERVER_SPN** может быть использован для указания имени участника-службы для соединения с основным сервером.<br /><br /> Атрибут соединения **SQL_COPT_SS_FAILOVER_PARTNER_SPN** может быть использован для указания имени партнера-службы для сервера-партнера по обеспечению отработки отказа.|  
|Приложение OLE DB указывает имя партнера-службы как свойство инициализации источника данных для основного сервера или сервера-партнера по обеспечению отработки отказа.|Свойство соединения **SSPROP_INIT_SERVER_SPN** в наборе свойств **DBPROPSET_SQLSERVERDBINIT** может быть использовано для указания имени участника-службы для соединения.<br /><br /> Свойство соединения **SSPROP_INIT_FAILOVER_PARTNER_SPN** в **DBPROPSET_SQLSERVERDBINIT** может быть использовано для указания имени партнера-службы для сервера-партнера по обеспечению отработки отказа.|  
|Пользователь указывает имя партнера-службы для сервера или сервера-партнера по обеспечению отработки отказа в имени источника данных (DSN) ODBC.|Имя участника-службы может быть указано в DSN ODBC через диалоговые окна настройки DSN.|  
|Пользователь указывает имя партнера-службы для сервера или сервера-партнера по обеспечению отработки отказа в диалоговом окне **Связь данных** или **Имя входа** OLE DB.|Имя участника-службы может быть указано в диалоговом окне **Связь данных** или **Имя входа** . Диалоговое окно **Имя входа** может использоваться с ODBC или OLE DB.|  
|Приложение ODBC определяет метод проверки подлинности, используемый для установления соединения.|Если соединение было установлено успешно, то приложение может запросить атрибут соединения **SQL_COPT_SS_INTEGRATED_AUTHENTICATION_METHOD** , чтобы определить, какой именно метод проверки подлинности будет использоваться. Эти значения включают **NTLM** , **Kerberos**и другие.|  
|Приложение OLE DB определяет метод проверки подлинности, используемый при установлении соединения.|Если соединение было установлено успешно, то приложение может запросить свойство соединения **SSPROP_AUTHENTICATION_METHOD** в наборе свойств **DBPROPSET_SQLSERVERDATASOURCEINFO** для определения метода проверки подлинности, который будет использоваться. Эти значения включают **NTLM** , **Kerberos**и другие.|  
  
## <a name="failover"></a>Отработка отказа  
 Имена участников-служб не хранятся в кэше отработки отказа и поэтому не могут передаваться между соединениями. Имена участников-служб будут использоваться при всех попытках установления соединения с основным и резервным сервером при указании атрибутов или строки соединения.  
  
## <a name="connection-pooling"></a>Организация пулов соединений  
 Приложение должно учитывать, что указание имени участника-службы в некоторых, но не всех строках соединения может привести к фрагментации пула.  
  
 Приложение может программным способом указывать имена участников-служб как атрибуты соединения, а не как ключевые слова в строке соединения. Это помогает управлять фрагментацией пула соединений.  
  
 Приложение должно учитывать, что имя участника-службы в строке соединения может быть отменено назначением соответствующих атрибутов соединения, но строки соединения, используемые при организации пула соединений, будут использовать значения строк соединения для объединения в пул.  
  
## <a name="down-level-server-behavior"></a>Работа сервера низкого уровня  
 Поведение нового соединения реализуется клиентом, поэтому оно не зависит от версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
## <a name="linked-servers-and-delegation"></a>Связанные серверы и делегирование  
 При создании связанных серверов,  **@provstr**  параметр [sp_addlinkedserver](../../../relational-databases/system-stored-procedures/sp-addlinkedserver-transact-sql.md) может использоваться для указания сервера и резервным имена участников-служб. Такой подход имеет те же преимущества, что и при указании имен субъектов-служб в строках соединения клиента: проще и надежнее установить соединения, использующие проверку подлинности Kerberos.  
  
 Делегирование со связанными серверами требует проверки подлинности Kerberos.  
  
## <a name="management-aspects-of-spns-specified-by-applications"></a>Аспекты управления именами участников-служб, указываемыми приложениями  
 При выборе способа задания имени участника-службы: в приложении (через строку соединений) или программно (через свойства соединений вместо имени участника-службы по умолчанию, сформированного поставщиком) следует учитывать следующие факторы.  
  
-   Безопасность. Раскрывает ли указанное имя субъекта-службы конфиденциальные сведения?  
  
-   Надежность: Чтобы разрешить использование имен участников-служб по умолчанию, учетная запись службы, которая [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] запущен экземпляр должен иметь достаточные права для обновления Active Directory в центре распространения КЛЮЧЕЙ.  
  
-   Удобство и прозрачность расположения: как будет имена участников-служб приложения работать некорректно, если перемещение базы данных на другой [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра? Это относится как к основному серверу, так и его партнеру по обеспечению отработки отказа при зеркальном отображении базы данных. Если при смене сервера потребуется замена имен участников-служб, как это повлияет на приложения? Будут ли изменения управляемыми?  
  
## <a name="specifying-the-spn"></a>Указание имени участника-службы  
 Имя участника-службы может быть задано как через код, так и через диалоговые окна. В данном разделе рассматривается задание имени участника-службы.  
  
 Максимальная длина для имени участника-службы — 260 символов.  
  
 В именах участников-служб в атрибутах или строке соединения применяется следующий синтаксис.  
  
|Синтаксис|Описание|  
|------------|-----------------|  
|MSSQLSvc/*fqdn*|Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол, отличный от TCP.<br /><br /> *fqdn* — полное имя домена.|  
|MSSQLSvc/*fqdn*:*port*|Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол TCP.<br /><br /> *port* — номер порта TCP.|  
|MSSQLSvc/*fqdn*:*InstanceName*|Сформированное поставщиком имя участника-службы (по умолчанию) для именованного экземпляра, когда используется протокол, отличный от TCP.<br /><br /> *InstanceName* — [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] имя экземпляра.|  
|HOST/*fqdn*<br /><br /> HOST/*MachineName*|Имя участника-службы, сопоставляемое со встроенной учетной записью компьютера, зарегистрированной в Windows автоматически.|  
|*Username*@*Domain*|Прямое указание учетной записи домена.<br /><br /> *Username* — имя учетной записи пользователя Windows.<br /><br /> *Domain* — имя домена Windows или полное имя домена.|  
|*MachineName*$@*Domain*|Прямое указание учетной записи компьютера<br /><br /> (если сервер, с которым выполняется соединение, работает с учетными записями LOCAL SYSTEM или NETWORK SERVICE, то для проверки подлинности Kerberos **ServerSPN** может указываться в формате *MachineName*$@*Domain* ).|  
|*KDCKey*/*MachineName*|Заданное пользователем имя участника-службы.<br /><br /> *KDCKey* — алфавитно-цифровая строка, соответствующая правилам для ключей KDC.|  
  
## <a name="odbc-and-ole-db-syntax-supporting-spns"></a>Синтаксис ODBC и OLE DB для поддержки имен участников-служб  
 Сведения о синтаксисе см. в следующих разделах.  
  
-   [Имена участника-службы &#40; Имена участников-служб &#41; в клиентских подключений &#40; ODBC &#41;](../../../relational-databases/native-client/odbc/service-principal-names-spns-in-client-connections-odbc.md)  
  
-   [Имена участника-службы &#40; Имена участников-служб &#41; в клиентских подключений &#40; OLE DB &#41;](../../../relational-databases/native-client/ole-db/service-principal-names-spns-in-client-connections-ole-db.md)  
  
 Дополнительные сведения об образцах приложений, которые демонстрируют эту функцию, см. в разделе [Образцы программирования для данных SQL Server](http://msftdpprodsamples.codeplex.com/).  
  
## <a name="see-also"></a>См. также  
 [Компоненты SQL Server Native Client](../../../relational-databases/native-client/features/sql-server-native-client-features.md)  
[Регистрация имени участника-службы для соединений Kerberos](../../../database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections.md)  
  
