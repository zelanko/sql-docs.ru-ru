---
title: Руководство по архитектуре страниц и экстентов | Документация Майкрософт
ms.custom: ''
ms.date: 10/21/2016
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.service: ''
ms.component: relational-databases-misc
ms.reviewer: ''
ms.suite: sql
ms.technology:
- database-engine
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- page and extent architecture guide
- guide, page and extent architecture
ms.assetid: 83a4aa90-1c10-4de6-956b-7c3cd464c2d2
caps.latest.revision: 2
author: rothja
ms.author: jroth
manager: craigg
ms.workload: Inactive
monikerRange: '>= aps-pdw-2016 || = azuresqldb-current || = azure-sqldw-latest || >= sql-server-2016 || = sqlallproducts-allversions'
ms.openlocfilehash: 76c3411535c32c4d921ed464a877868b9600c9af
ms.sourcegitcommit: 7a6df3fd5bea9282ecdeffa94d13ea1da6def80a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="pages-and-extents-architecture-guide"></a>Руководство по архитектуре страниц и экстентов
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

Страница — основная единица хранения данных в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. Экстент — это набор из 8 физически непрерывных страниц. Экстенты помогают эффективно управлять страницами. В этом руководстве описаны структуры данных, используемые для управления страницами и экстентами во всех версиях SQL Server. Понимание архитектуры страниц и экстентов важно для проектирования и разработки эффективных баз данных.

## <a name="pages-and-extents"></a>Страницы и экстенты

Основной единицей хранилища данных в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] является страница. Место на диске, предоставляемое для размещения файла данных (файл MDF или NDF) в базе данных, логически разделяется на страницы с непрерывным перечислением от 0 до n. Дисковые операции ввода-вывода выполняются на уровне страницы. Это означает, что SQL Server считывает или записывает целые страницы данных.

Экстент — это коллекция, состоящая из восьми физически непрерывных страниц; они используются для эффективного управления страницами. Все страницы хранятся в экстентах.

### <a name="pages"></a>Страницы

В [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] размер страницы составляет 8 КБ. Это значит, что в одном мегабайте базы данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] содержится 128 страниц. Каждая страница начинается с 96-байтового заголовка, который используется для хранения системных данных о странице. Эти данные включают номер страницы, тип страницы, объем свободного места на странице и идентификатор единицы распределения объекта, которому принадлежит страница.

В следующей таблице представлены типы страниц, используемые в файлах данных базы данных SQL Server.

|Тип страницы | Содержание |
|-------|-------|
|Data |Строки со всеми данными, за исключением типов text, ntext, image, nvarchar(max), varchar(max), varbinary(max) и xml, если для текста в строке установлено значение ON. |
|Индекс |Содержимое индекса. |
|Текст/изображение |Типы данных больших объектов: text, ntext, image, nvarchar(max), varchar(max), varbinary(max) и данные xml. <br> Столбцы переменной длины, когда размер строки данных превышает 8 КБ: varchar, nvarchar, varbinary и sql_variant. |
|Глобальная карта распределения, общая глобальная карта распределения |Сведения о том, размещены ли экстенты. |
|Свободное место на страницах (PFS) |Сведения о размещении страниц и доступном на них свободном месте. |
|Карта распределения индекса |Сведения об экстентах, используемых таблицей или индексом для единицы распределения. |
|Схема массовых изменений |Сведения об экстентах, измененных массовыми операциями со времени последнего выполнения инструкции BACKUP LOG для единицы распределения. |
|Карта изменений для разностной резервной копии|Сведения об экстентах, измененных с момента последнего выполнения инструкции BACKUP DATABASE для единицы распределения. |

> [!NOTE]
> Файлы журнала не содержат страниц, в них содержится последовательность записей журнала.

Строки данных заносятся на страницу последовательно, сразу же после заголовка. Таблица смещения строк начинается в конце страницы; каждая таблица смещения строк содержит одну запись для каждой строки на странице. Каждая запись регистрирует, насколько далеко от начала страницы находится первый байт строки. Записи в таблице смещения строк находятся в обратном порядке относительно последовательности строк на странице.

![page_architecture](../relational-databases/media/page-architecture.gif)

#### <a name="large-row-support"></a>Поддержка больших строк  

Строка не может разделить страницу на части, однако часть строки может быть перемещена на другую страницу, чтобы строка действительно была очень большой. Максимальный объем данных и служебного кода, содержащихся в одной строке на странице, составляет 8 060 байт (8 КБ). Однако сюда не включены данные, хранимые в типе страницы «Текст/изображение». 

Это ограничение смягчается для таблиц, содержащих столбцы varchar, nvarchar, varbinary или sql_variant. Когда общий размер строк всех фиксированных и переменных столбцов в таблице превышает предел в 8 060 байт, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] динамически перемещает один или более столбцов переменной длины на страницы в единице распределения ROW_OVERFLOW_DATA, начиная со столбца с наибольшей шириной. 

Это действие выполняется всегда, когда в результате операций вставки или обновления общий размер строки выходит за предел в 8 060 байт. Когда происходит перемещение столбца на страницу в единице распределения ROW_OVERFLOW_DATA, 24-байтовый указатель на исходной странице в единице распределения IN_ROW_DATA сохраняется. Если при последующей выполняемой операции размер строк уменьшается, SQL Server динамически перемещает столбцы обратно на исходную страницу данных. 

### <a name="extents"></a>Экстенты 

Экстенты являются основными единицами организации пространства. Экстент состоит из восьми непрерывных страниц или 64 КБ. Это означает, что в одном мегабайте базы данных SQL Server содержится 16 экстентов.

Для эффективного распределения места [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не размещает целые экстенты в таблицы с небольшим объемом данных. В [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] есть два типа экстентов. 

* **Однородные** экстенты принадлежат одному объекту, и все восемь страниц экстента может использовать только этот владеющий объект.
* **Смешанные** экстенты могут находиться в общем пользовании максимум у восьми объектов. Каждая из восьми страниц в экстенте может находиться во владении разных объектов.

Новая таблица или индекс — это обычно страницы, выделенные из смешанных экстентов. При увеличении размера таблицы или индекса до восьми страниц эти таблица или индекс переходят на использование однородных экстентов для последовательных единиц распределения. При создании индекса для существующей таблицы, в которой содержится достаточно строк, чтобы сформировать восемь страниц в индексе, все единицы распределения для индекса находятся в однородных экстентах.

![Экстенты](../relational-databases/media/extents.gif)

## <a name="managing-extent-allocations-and-free-space"></a>Управление размещением экстента и свободным местом 

Структуры данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], управляющие размещением экстента и отслеживанием свободного места, обладают относительно простой структурой. Это позволяет получить следующие преимущества: 

* Сведения о свободном месте плотно упакованы, поэтому эти данные содержат относительно небольшое количество страниц.   
  Это приводит к увеличению скорости из-за уменьшения необходимых операций чтения диска для получения сведений о размещении. Также увеличивается вероятность того, что страницы размещения будут оставаться в памяти и повторных операций чтения не потребуется. 

* Большая часть сведений о размещении не связана по цепочке друг с другом. Это упрощает управление сведениями о размещении.    
  Каждое действие по размещению или освобождению страницы может выполняться быстро. Это сокращает состязание между одновременными задачами размещения и освобождения страниц. 

### <a name="managing-extent-allocations"></a>Управление размещением экстента

[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] использует два типа карт распределения для записи размещения экстентов. 

- **Глобальная карта распределения (GAM)**   
  На GAM-страницах записано, какие экстенты были размещены. В каждой карте GAM содержится 64 000 экстентов или почти 4 ГБ данных. В карте GAM приходится по одному биту на каждый экстент в покрываемом им интервале. Если бит равен 1, то экстент свободен; если бит равен 0, то экстент размещен. 

- **Общая глобальная карта распределения (SGAM)**   
  На SGAM-страницах записано, какие экстенты в текущий момент используются в качестве смешанных экстентов и имеют как минимум одну неиспользуемую страницу. В каждой карте SGAM содержится 64 000 экстентов или почти 4 ГБ данных. В карте SGAM приходится по одному биту на каждый экстент в покрываемом им интервале. Если бит равен 1, то экстент используется как смешанный экстент и имеет свободную страницу. Если бит равен 0, то экстент не используется как смешанный экстент, или он является смешанным экстентом, но все его страницы используются. 

Каждый экстент обладает следующими наборами битовых шаблонов в картах GAM и SGAM, основанными на его текущем использовании. 

|Текущее использование экстента | Настройка битов карты GAM | Настройка битов карты SGAM |
|---------|----------|------| 
|Свободно, в текущий момент не используется |1 |0 |
|Однородный экстент или заполненный смешанный экстент |0 |0 |
|Смешанный экстент со свободными страницами |0 |1 |
 
Это дает простые алгоритмы управления экстентами страниц. 
-   Для выделения однородного экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] производит на карте GAM поиск бита 1 и заменяет его на бит 0. 
-   Для поиска смешанного экстента со свободными страницами компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] производит поиск на карте SGAM бита 1. 
-   Для выделения смешанного экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] производит на карте GAM поиск бита 1, заменяет его на бит 0, а затем устанавливает значение соответствующего бита на карте SGAM равным 1. 
-   Для освобождения экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] устанавливает бит GAM равным 1, а соответствующий бит SGAM равным 0. Внутренние алгоритмы, которые на самом деле используются компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], более сложны, чем это описано в данном подразделе, так как компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] распределяет данные в базе данных равномерно. Однако даже настоящие алгоритмы упрощаются из-за того, что отпадает необходимость управления цепочками сведений о размещении экстентов.

### <a name="tracking-free-space"></a>Отслеживание свободного места

Страницы **Page Free Space (PFS)** записывают состояние размещения каждой страницы, информацию о том, была ли размещена конкретная страница, а также количество свободного места на каждой странице. В PFS на каждую страницу приходится по одному байту, хранящему информацию о том, была ли страница размещена или нет, а если была — то пустая она, или ее заполнение находится в промежутке от 1 до 50 процентов, от 51 до 80 процентов, от 81 до 95 процентов или от 96 до 100 процентов.

После размещения экстента на объект ядро СУБД использует PFS-страницы для записи информации о том, какие страницы в экстенте размещены, а какие свободны. Эти сведения используются ядром СУБД при размещении новой страницы. Количеством свободного места на странице можно управлять только в случае кучи и страниц Text/Image. Это используется при поиске ядром СУБД страницы, имеющей свободное место, которого достаточно для сохранения в ней новой добавляемой строки. Для индексов не требуется, чтобы отслеживалось свободное место на странице, так как место, в которое будет вставляться новая строка, назначается значениями ключа индекса.

PFS-страница является первой страницей в файле данных после страницы заголовка файла (страница с ИД 1). За ней следует страница GAM (страница с ИД 2), а затем — страница SGAM (страница с ИД 3). После первой PFS-страницы находится PFS-страница размером примерно 8 000 страниц. После первой GAM-страницы на странице 2 находится другая GAM-страница с 64 000 экстентов, и другая SGAM-страница с 64 000 экстентов находится после первой SGAM-страницы на странице 3. На следующей иллюстрации показана последовательность страниц, используемая компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] для выделения экстентов и управления ими.

![manage_extents](../relational-databases/media/manage-extents.gif)

## <a name="managing-space-used-by-objects"></a>Управление дисковым пространством, занятым объектами 

Страница **карты распределения индекса (Index Allocation Map, IAM)** сопоставляет экстенты в 4-гигабайтном фрагменте файла базы данных с единицей размещения, использующей этот фрагмент. Единица распределения может иметь один из трех типов.

- IN_ROW_DATA   
    Содержит секцию кучи или индекса.

- LOB_DATA   
   Содержит типы данных больших объектов (LOB), таких как xml, varbinary(max) и varchar(max).

- ROW_OVERFLOW_DATA   
   Содержит данные переменной длины, которые хранятся в столбцах varchar, nvarchar, varbinary или sql_variant и превышают допустимый размер строки — 8060 байт. 

В каждой секции кучи или индекса содержится по крайней мере одна единица распределения IN_ROW_DATA. Кроме того, в зависимости от схемы кучи или индекса, там могут содержаться единицы распределения LOB_DATA или ROW_OVERFLOW_DATA. Дополнительные сведения о единицах распределения см. в разделе "Организация таблиц и индексов".

IAM-страница охватывает в файле диапазон 4 ГБ, то есть столько же, сколько и GAM- или SGAM-страница. Если в единице распределения содержатся экстенты из более чем одного файла или фрагмент файла размером более 4 ГБ, то несколько IAM-страниц будут объединены в IAM-цепочку. Таким образом, каждая единица распределения содержит как минимум одну IAM-страницу для каждого из файлов, в которых содержатся ее экстенты. Для файла может существовать несколько IAM-страниц, если размер экстентов файла, назначенного единице распределения, превышает объем, который может быть записан в одной IAM-странице. 

![iam_pages](../relational-databases/media/iam-pages.gif)

IAM-страницы для каждой единицы распределения выделяются по необходимости и располагаются в файле в случайном порядке. Системное представление sys.system_internals_allocation_units указывает на первую IAM-страницу единицы распределения. Все IAM-страницы, относящиеся к одной единице распределения, объединяются в цепочку.

> [!IMPORTANT]
> Системное представление sys.system_internals_allocation_units предназначено только для внутреннего использования и может быть изменено. Совместимость не гарантируется.

![iam_chain](../relational-databases/media/iam-chain.gif)
 
IAM-страницы, связанные в цепочки для единиц распределения IAM-страница имеет заголовок, который отображает первый экстент из диапазона, сопоставленного с IAM-страницей. IAM-страница также имеет большую битовую карту, в которой каждый бит представляет экстент. Первый бит схемы представляет первый экстент диапазона, второй бит — второй экстент и т. д. Если бит равен 0, то соответствующий ему экстент не привязан к единице распределения, которой принадлежит IAM-страница. Если он равен 1, то соответствующий ему экстент привязан к единице распределения, которой принадлежит IAM-страница.

Когда требуется вставить новую строку, но на текущей странице нет свободного места, компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] через IAM- и PFS-страницу ищет страницу для выделения или (для страниц кучи или текста и изображения) страницу, в которой достаточно места для хранения строки данных. Используя IAM-страницы, компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] находит экстенты, привязанные к единице распределения. Для каждого экстента компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] просматривает PFS-страницы, чтобы определить наличие доступных страниц. Огромное число страниц данных содержатся в сравнительно небольшом числе IAM- и PFS-страниц. Это означает, что IAM- и PFS-страницы обычно находятся в памяти буферного пула SQL Server и поиск в них осуществляется очень быстро. Для индексов место вставки новой строки определяется ключом индекса. В этом случае описанный ранее процесс поиска не производится.

Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] размещает новый экстент для единицы распределения только в том случае, когда в существующем экстенте невозможно быстро найти страницу, в которой достаточно места для вставляемой строки. 

<a name="ProportionalFill"></a> [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] распределяет экстенты для файловой группы, используя **алгоритм распределения с пропорциональным заполнением**. Если файловая группа состоит из двух файлов и в одном из них свободного места вдвое больше, чем в другом, то во втором файле будет размещаться по одной странице на каждые две страницы в первом. Это означает, что процент заполнения для каждого из файлов в группе будет примерно одинаковым. 

## <a name="tracking-modified-extents"></a>Отслеживание измененных экстентов 

[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] использует две структуры внутренних данных, чтобы отслеживать экстенты, измененные операциями массового копирования, и экстенты, измененные со времени последнего полного резервного копирования. Эти структуры данных существенно ускоряют разностные резервные копии. Они также ускоряют операции записи в журнал массового копирования, если база данных использует модель восстановления с неполным протоколированием. Подобно страницам глобальной карты распределения (GAM) и общей общей глобальной карты распределения (SGAM), эти структуры являются битовыми картами, в которых каждый бит представляет один экстент. 

- **Схема разностных изменений (Differential Changed Map, DCM)**   
   Эта схема отслеживает экстенты, которые были изменены со времени последнего выполнения инструкции `BACKUP DATABASE`. Если бит экстента равен 1, с момента последнего выполнения `BACKUP DATABASE` экстент был изменен. Если бит равен 0, то экстент не был изменен. Чтобы определить, какие экстенты были изменены, разностные резервные копии считывают только страницы DCM. Это существенно сокращает количество страниц, которые должна просмотреть разностная резервная копия. Количество времени, которое затрачивает разностная резервная копия, пропорционально количеству экстентов, измененных со времени последнего выполнения инструкции BACKUP DATABASE, а не размеру всей базы данных. 

- **Схема массовых изменений (Bulk Changed Map, BCM)**   
   Эта схема отслеживает экстенты, измененные операциями с неполным протоколированием со времени последнего выполнения инструкции `BACKUP LOG`. Если бит экстента равен 1, после последнего выполнения `BACKUP LOG` экстент был изменен операцией неполного протоколирования. Если бит равен 0, то экстент не был изменен операциями с неполным протоколированием. Несмотря на то, что страницы BCM существуют во всех базах данных, они соответствуют только в том случае, если база данных использует модель восстановления с неполным протоколированием. В этой модели восстановления при выполнении инструкции `BACKUP LOG` процесс резервного копирования проверяет схемы BCM на наличие измененных экстентов. Затем она включает в себя экстенты из резервной копии журнала. Это позволяет восстановиться операциям с неполным протоколированием, если база данных восстанавливается из резервной копии журнала и последовательности резервных копий журнала транзакции. Страницы BCM в базе данных, которая использует простую модель восстановления, не соответствуют, потому что не произведена запись в журнал ни одной операции с неполным протоколированием. Они не соответствуют базе данных, которая использует модель полного восстановления, потому что эта модель восстановления принимает операции с неполным протоколированием за операции с полным протоколированием. 

Интервал между DCM- и BCM-страницами равен интервалу между GAM- и SGAM-страницами — 64 000 экстентов. DCM- и BCM-страницы расположены за GAM- и SGAM-страницами в физическом файле:

![special_page_order](../relational-databases/media/special-page-order.gif)
 
