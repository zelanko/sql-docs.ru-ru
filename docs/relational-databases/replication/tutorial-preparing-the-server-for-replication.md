---
title: Руководство. Подготовка SQL Server к репликации (издатель, распространитель, подписчик) | Документация Майкрософт
ms.custom: ''
ms.date: 04/02/2018
ms.prod: sql
ms.prod_service: database-engine
ms.reviewer: ''
ms.technology: replication
ms.topic: quickstart
helpviewer_keywords:
- replication [SQL Server], tutorials
ms.assetid: ce30a095-2975-4387-9377-94a461ac78ee
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: beb0c68b86521ce9a5b3463e8c959970297519fe
ms.sourcegitcommit: 5e838bdf705136f34d4d8b622740b0e643cb8d96
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2019
ms.locfileid: "69653824"
---
# <a name="tutorial-prepare-sql-server-for-replication-publisher-distributor-subscriber"></a>Руководство. Подготовка SQL Server к репликации (издатель, распространитель, подписчик)
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]
Перед тем как настраивать топологию репликации, важно предусмотреть средства безопасности. В этом руководстве объясняется, как лучше защитить топологию репликации. Также из него вы узнаете, как настроить распространение, которое является первым этапом репликации данных. В первую очередь необходимо пройти именно этот учебник.  
  
> [!NOTE]  
> Чтобы обеспечить безопасную репликацию данных между серверами, выполните все рекомендации, приведенные в статье [Рекомендации по защите репликации](../../relational-databases/replication/security/replication-security-best-practices.md).  
  
## <a name="what-you-will-learn"></a>Новые знания  
В этом учебнике описывается, как подготовить сервер для безопасного выполнения репликации с минимальным числом привилегий.  

В этом учебнике рассматривается следующее.
> [!div class="checklist"]
> * создание учетных записей Windows для репликации;
> * подготовка папки моментальных снимков;
> * настройка распространения.

## <a name="prerequisites"></a>предварительные требования
Это руководство предназначено для пользователей, знакомых с основными операциями с базами данных, но имеющих ограниченный опыт работы с репликацией. 

Для работы с этим руководством требуется SQL Server, среда SQL Server Management Studio (SSMS) и база данных AdventureWorks.  
  
- На сервере-издателе (источник) установите следующее:  
  
   - Любой выпуск [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], кроме SQL Server Express или SQL Server Compact. Эти выпуски не могут быть издателями репликации.   
   - Образец базы данных [!INCLUDE[ssSampleDBUserInputNonLocal](../../includes/sssampledbuserinputnonlocal-md.md)] . В целях повышения безопасности образцы баз данных по умолчанию не устанавливаются.  
  
- На сервере-подписчике (целевом) установите любой выпуск [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], кроме [!INCLUDE[ssEW](../../includes/ssew-md.md)]. [!INCLUDE[ssEW](../../includes/ssew-md.md)] не может быть подписчиком при репликации транзакций.  
  
- Установите [SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).
- Установите выпуск [SQL Server 2017 Developer Edition](https://www.microsoft.com/sql-server/sql-server-downloads).
- Скачайте [пример базы данных AdventureWorks](https://github.com/Microsoft/sql-server-samples/releases). См. дополнительные сведения о [восстановлении базы данных в среде SSMS](https://docs.microsoft.com/sql/relational-databases/backup-restore/restore-a-database-backup-using-ssms). 
    
>[!NOTE]
> - Репликация не поддерживается в экземплярах SQL Server, которые отличаются друг от друга больше, чем на две версии. См. дополнительные сведения о [поддерживаемых версиях SQL Server в топологии репликации](https://blogs.msdn.microsoft.com/repltalk/2016/08/12/suppported-sql-server-versions-in-replication-topology/).
> - В среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] необходимо подключиться к издателю и подписчику с помощью имени входа, которое является членом предопределенной роли сервера **sysadmin**. Дополнительные сведения о роли см. в статье [Роли уровня сервера](https://docs.microsoft.com/sql/relational-databases/security/authentication-access/server-level-roles).  


**На изучение этого руководства потребуется примерно 30 минут**
  
## <a name="create-windows-accounts-for-replication"></a>Создание учетных записей Windows для репликации
В рамках этого раздела создаются учетные записи Windows для запуска агентов репликации. На локальном сервере создаются отдельные учетные записи Windows для следующих агентов:  
  
|Агент|Местоположение|Имя учетной записи|  
|---------|------------|----------------|  
|агент моментальных снимков|Издатель|<*имя_компьютера*>\repl_snapshot|  
|Агент чтения журнала.|Издатель|<*имя_компьютера*>\repl_logreader|  
|Агент распространителя|Издатель и подписчик|<*имя_компьютера*>\repl_distribution|  
|Агент слияния.|Издатель и подписчик|<*имя_компьютера*>\repl_merge|  
  
> [!NOTE]  
> В руководствах по репликации издатель и распространитель совместно используют один экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (NODE1\SQL2016). Подписчик размещается на удаленном экземпляре (NODE2\SQL2016). Издатель и подписчик могут совместно использовать один и тот же экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], но это необязательно. Если издатель и подписчик совместно используют один и тот же экземпляр, то не требуется выполнять шаги по созданию учетных записей на подписчике.  

### <a name="create-local-windows-accounts-for-replication-agents-at-the-publisher"></a>Создание локальных учетных записей Windows для агентов репликации на издателе
  
1. Откройте на издателе оснастку **Управление компьютером** из папки **Администрирование** на панели управления.  
  
2. В оснастке **Служебные программы**разверните узел **Локальные пользователи и группы**.  
  
3. Щелкните правой кнопкой мыши значок **Пользователи**, а затем выберите **Новый пользователь**.  
     
4. Введите **repl_snapshot** в поле **Имя пользователя**, укажите пароль и другие необходимые сведения, а затем нажмите кнопку **Создать**, чтобы создать учетную запись repl_snapshot: 

   ![Диалоговое окно "Новый пользователь"](media/tutorial-preparing-the-server-for-replication/newuser.png)
  
5. Повторите предыдущий шаг, чтобы создать учетные записи repl_logreader, repl_distribution и repl_merge:  
 
   ![Список пользователей репликации](media/tutorial-preparing-the-server-for-replication/replusers.png)
  
6. Выберите **Закрыть**.  
  
### <a name="create-local-windows-accounts-for-replication-agents-at-the-subscriber"></a>Создание локальных учетных записей Windows для агентов репликации на подписчике  
  
1. Откройте на подписчике оснастку **Управление компьютером** из папки **Администрирование** на панели управления.  
  
2. В оснастке **Служебные программы**разверните узел **Локальные пользователи и группы**.  
  
3. Щелкните правой кнопкой мыши значок **Пользователи**, а затем выберите **Новый пользователь**.  
  
4. Введите **repl_distribution** в поле **Имя пользователя**, укажите пароль и другие необходимые сведения, затем нажмите **Создать**, чтобы создать учетную запись repl_distribution.  
  
5. Повторите предыдущий шаг, чтобы создать учетную запись repl_merge.  
  
6. Выберите **Закрыть**.  

Дополнительные сведения см. в статье [Обзор агентов репликации](../../relational-databases/replication/agents/replication-agents-overview.md).  

## <a name="prepare-the-snapshot-folder"></a>Подготовка папки моментальных снимков
Из этого раздела вы узнаете, как настроить папку моментальных снимков для создания и хранения моментального снимка публикации. 

### <a name="create-a-share-for-the-snapshot-folder-and-assign-permissions"></a>Создание ресурса для папки моментальных снимков и настройка разрешений  
  
1. В проводнике перейдите к папке данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Путь по умолчанию — «C:\Program Files\Microsoft SQL Server\MSSQL.X\MSSQL\Data».  
  
2. Создайте папку с именем **repldata**.  
  
3. Щелкните правой кнопкой мыши папку и выберите команду **Свойства**.  
  
   A. В диалоговом окне **Свойства repldata** на вкладке **Общий доступ** щелкните **Открыть общий доступ**.  
  
   Б. В диалоговом окне **Расширенная настройка общего доступа** выберите **Share this Folder** (Открыть общий доступ к этой папке) и щелкните **Разрешения**.  

   ![Выбранные элементы для предоставления общего доступа к папке repldata](media/tutorial-preparing-the-server-for-replication/repldata.png)

6. В диалоговом окне **Разрешения для ресурса repldata** выберите **Добавить**. В поле **выбора пользователя, компьютеров, учетной записи службы или групп** введите имя учетной записи агента моментальных снимков, созданной ранее, в формате <*имя_компьютера_издателя>* > **\repl_snapshot**. Выберите **Проверить имена** и нажмите кнопку **ОК**.  

   ![Выбранные элементы для добавления разрешений на общий доступ](media/tutorial-preparing-the-server-for-replication/addshareperms.png)

7. Повторите шаг 6 и добавьте две другие учетные записи, созданные ранее: <*имя_компьютера_издателя>* > **\repl_merge** и <*имя_компьютера_издателя>* > **\repl_distribution**.

8. Добавив три учетные записи, назначьте следующие разрешения:      
   - repl_distribution: **Чтение**  
   - repl_merge: **Чтение**  
   - repl_snapshot: **полный доступ**    

   ![Разрешения на общий доступ для каждой учетной записи](media/tutorial-preparing-the-server-for-replication/sharedpermissions.png)

9. После настройки разрешений на общий доступ нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **разрешений для repldata**. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Расширенная настройка общего доступа**. 

10. В диалоговом окне **свойств repldata** откройте вкладку **Безопасность** и выберите **Изменить**:  

    ![Кнопка "Изменить" на вкладке "Безопасность"](media/tutorial-preparing-the-server-for-replication/editsecurity.png)   

11. В диалоговом окне **Разрешения для ресурса repldata** выберите **Добавить**. В поле **выбора пользователя, компьютеров, учетных записей служб или групп** введите имя учетной записи агента моментальных снимков, созданной ранее, в формате <*имя_компьютера_издателя>* > **\repl_snapshot**. Выберите **Проверить имена** и нажмите кнопку **ОК**.  

    ![Выбранные элементы для добавления разрешений безопасности](media/tutorial-preparing-the-server-for-replication/addsecuritypermissions.png)

  
12. Повторите предыдущий шаг, чтобы добавить разрешения для агента распространения в формате <*имя_компьютера_издателя>* > **\repl_distribution** и для агента слияния в формате <*имя_компьютера_издателя>* > **\repl_merge**.  
    
  
13. Убедитесь, что следующие разрешения допустимы:  
  
    - repl_distribution: **Чтение**
    - repl_merge: **Чтение**
    - repl_snapshot: **полный доступ**   
 
    ![Пользовательские разрешения на доступ к данным репликации](media/tutorial-preparing-the-server-for-replication/replpermissions.png) 

14. Снова откройте вкладку **Общий доступ** и запишите значение параметра **Сетевой путь** для общей папки. Этот путь понадобится позже, когда вы будете настраивать папку моментальных снимков.  

    ![Сетевой путь на вкладке "Общий доступ"](media/tutorial-replicating-data-between-continuously-connected-servers/networkpath.png)

15. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Свойства repldata**. 
 
Дополнительные сведения см. в статье [Организация безопасности папки моментальных снимков](../../relational-databases/replication/security/secure-the-snapshot-folder.md).  
  

## <a name="configure-distribution"></a>Настройка распространения
В рамках этого раздела вы настроите распространение на издателе и установите необходимые разрешения для баз данных публикации и распространителя. Если распространитель уже настроен, перед тем как приступить к этому разделу, отключите публикацию и распространение. Не следует этого делать, если нужно сохранить существующую топологию репликации, особенно в рабочей среде.   
  
В этом руководстве не рассматривается настройка издателя с удаленным распространителем.  

### <a name="configure-distribution-at-the-publisher"></a>Настройка распространителя на издателе  
  
1. Подключитесь к издателю в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], а затем раскройте узел сервера.  
  
2. Щелкните правой кнопкой мыши папку **Репликация** и выберите пункт **Настройка распространения**:  

   ![Команда "Настройка распространения" в контекстном меню](media/tutorial-preparing-the-server-for-replication/configuredistribution.png)
  
   > [!NOTE]  
   > Если подключение к [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] установлено с помощью **localhost**, а не фактического имени сервера, на экране появится предупреждение о том, что [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не может подключиться к **localhost**. В диалоговом окне предупреждения нажмите кнопку **ОК**. В диалоговом окне **Connect to Server** (Соединение с сервером) измените значение в поле **Имя сервера** с **localhost** на имя своего сервера. В этом случае выберите **Подключиться**.  
  
   Запустится мастер настройки распространителя.  
  
3. На странице **Распространитель** выберите <*имя_сервера*>  **, который будет выступать в качестве собственного распространителя. SQL Server создаст базу данных распространителя и журнал**. Выберите **Далее**.  

   ![Параметр, который позволяет серверу выступать в качестве собственного распространителя](media/tutorial-preparing-the-server-for-replication/serverdistributor.png)
  
4. Если агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не запущен, на странице **запуска агента** [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выберите параметр **настройки автоматического запуска службы агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** . Выберите **Далее**.  

     
5. Введите путь \\\\<*имя_компьютера_издателя>* > **\repldata** в текстовое поле **Папка моментальных снимков** и нажмите кнопку **Далее**. Этот путь должен соответствовать значению параметра **Сетевой путь** для папки свойств repldata, которое вы записали ранее после настройки свойств общей папки. 

   ![Сравнение сетевых путей в диалоговом окне свойств repldata в мастере настройки распространителя](media/tutorial-preparing-the-server-for-replication/repldatasnapshot.png)
  
6. Примите значения по умолчанию на оставшихся страницах мастера.  
    
   ![Последняя страница мастера](media/tutorial-preparing-the-server-for-replication/distributionwizarddefaults.png)
  
7. Чтобы включить распространение, нажмите кнопку **Готово**. 

При настройке распространителя может отображаться приведенное ниже сообщение об ошибке. Оно указывает на то, что учетная запись, которая использовалась для запуска агента SQL Server, не имеет разрешений администратора системы. В этом случае вам необходимо вручную запустить агент SQL Server, предоставить соответствующие разрешения существующей учетной записи либо использовать другую учетную запись для агента SQL Server. 

![Сообщение об ошибке настройки агента SQL Server](media/tutorial-preparing-the-server-for-replication/startingagenterror.png)

Если экземпляр SQL Server Management Studio запущен с правами администратора, вы можете вручную запустить из него агент SQL.  
    
![Выбор пункта "Запустить" в контекстном меню для агента в SSMS](media/tutorial-preparing-the-server-for-replication/ssmsstartagent.png) 

>[!NOTE]
> Если признаков запуска агента SQL не наблюдается, щелкните правой кнопкой мыши агент SQL Server в среде SSMS и выберите пункт **Обновить**. Если агент по-прежнему остановлен, запустите его вручную с помощью диспетчера конфигурации SQL Server.    
  
## <a name="set-database-permissions"></a>Установка разрешений базы данных  
  
1. В среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] разверните узел **Безопасность**, щелкните правой кнопкой мыши **Имена входа**, а затем выберите пункт **Создать имя входа**:  

   ![Команда "Создать имя входа" в контекстном меню](media/tutorial-preparing-the-server-for-replication/newlogin.png)
  
2. На странице **Общие** выберите **Найти**. Введите <*имя_компьютера_издателя>* > **\repl_snapshot** в поле **Enter the object name to select** (Введите имя объекта), выберите **Проверить имена** и нажмите кнопку **ОК**.  

   ![Выбранные элементы для ввода имени объекта](media/tutorial-preparing-the-server-for-replication/addsnapshotlogin.png)
  
3. На странице **Сопоставление пользователей** в списке **Users mapped to this login** (Пользователи, сопоставленные с этим именем входа) выберите **distribution** и базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)].  
  
   В разделе "Список членства в роли базы данных" выберите роль **db_owner** для имени входа в обеих базах данных.  

   ![Выбор баз данных и их роли](media/tutorial-preparing-the-server-for-replication/dbowner.png)
  
4. Нажмите кнопку **ОК**, чтобы создать имя входа.  
  
5. Повторите шаги с 1 по 4, чтобы создать имена входа для других локальных учетных записей (repl_distribution, repl_logreader и repl_merge). Эти имена входа должны быть сопоставлены с пользователями, которые являются членами предопределенной роли базы данных **db_owner** в базах данных **распространителя** и **AdventureWorks**.  

   ![Просмотр всех четырех учетных записей в обозревателе объектов](media/tutorial-preparing-the-server-for-replication/usersinssms.png)
   
  
Дополнительные сведения см. в разделе:
- [Настройка распространителя](../../relational-databases/replication/configure-distribution.md) 
- [Модель безопасности агента репликации](../../relational-databases/replication/security/replication-agent-security-model.md)  

## <a name="next-steps"></a>Следующие шаги
Вы успешно подготовили сервер для репликации. В следующей статье вы ознакомитесь с настройкой репликации транзакций: 

> [!div class="nextstepaction"]
> [Учебник. Настройка репликации между двумя полностью подключенными серверами (репликация транзакций)](tutorial-replicating-data-between-continuously-connected-servers.md)

  
  
