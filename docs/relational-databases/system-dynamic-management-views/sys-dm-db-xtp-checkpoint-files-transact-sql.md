---
title: sys. dm_db_xtp_checkpoint_files (Transact-SQL) | Документация Майкрософт
description: Отображает сведения о файлах контрольных точек, включая размер файла, физическое расположение и идентификатор транзакции. Узнайте, как это представление отличается для версий SQL Server.
ms.date: 03/20/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.custom: ''
ms.technology: in-memory-oltp
ms.topic: language-reference
f1_keywords:
- dm_db_xtp_checkpoint_files
- sys.dm_db_xtp_checkpoint_files_TSQL
- dm_db_xtp_checkpoint_files_TSQL
- sys.dm_db_xtp_checkpoint_files
dev_langs:
- TSQL
helpviewer_keywords:
- sys.dm_db_xtp_checkpoint_files dynamic management view
ms.assetid: ac8e6333-7a9f-478a-b446-5602283e81c9
author: CarlRabeler
ms.author: carlrab
monikerRange: =azure-sqldw-latest||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: a4c4579fa8c2b891644e462ffd896e67862be8ca
ms.sourcegitcommit: 039fb38c583019b3fd06894160568387a19ba04e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2020
ms.locfileid: "87442594"
---
# <a name="sysdm_db_xtp_checkpoint_files-transact-sql"></a>sys.dm_db_xtp_checkpoint_files (Transact-SQL)
[!INCLUDE[sql-asdb-asdbmi](../../includes/applies-to-version/sql-asdb-asdbmi.md)]

  Отображает сведения о файлах контрольных точек, включая размер файла, физическое местоположение и идентификатор транзакции.  
  
> **Примечание.** Для текущей контрольной точки, которая не закрыта, столбец State в параметре s `ys.dm_db_xtp_checkpoint_files` будет находиться в разделе Создание новых файлов. Контрольная точка автоматически закрывается при наличии достаточного роста журнала транзакций с момента последней контрольной точки или при выполнении `CHECKPOINT` команды ([Checkpoint &#40;TRANSACT-SQL&#41;](../../t-sql/language-elements/checkpoint-transact-sql.md)).  
  
 Оптимизированная для памяти файловая группа внутренне использует файлы только для добавления, чтобы сохранять вставленные и удаленные строки для таблиц в памяти. Существует два типа файлов. Файл данных содержит вставленные строки, а разностный файл содержит ссылки на удаленные строки. 
  
 [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]существенно отличается от более поздних версий и обсуждается ниже в разделе [SQL Server 2014](#bkmk_2014).  
  
 Дополнительные сведения см. в статье [Создание и управление хранилищем для оптимизированных для памяти объектов](../../relational-databases/in-memory-oltp/creating-and-managing-storage-for-memory-optimized-objects.md).  
  
##  <a name="sssql15-and-later"></a><a name="bkmk_2016"></a> [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] и более поздние версии   
 В следующей таблице описаны столбцы `sys.dm_db_xtp_checkpoint_files` , начиная с **[!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]** .  
  
|Имя столбца|Тип|Описание|  
|-----------------|----------|-----------------|  
|container_id|**int**|Идентификатор контейнера (представленного в виде файла с типом FILESTREAM в таблице sys.database_files), частью которого является файл данных или разностный файл. Соединяет с file_id в [sys. database_files &#40;&#41;Transact-SQL ](../../relational-databases/system-catalog-views/sys-database-files-transact-sql.md).|  
|container_guid|**uniqueidentifier**|Идентификатор GUID контейнера, в состав которого входит корневой, разностный файл данных. Объединяется с file_guid в таблице sys. database_files.|  
|checkpoint_file_id|**uniqueidentifier**|Идентификатор GUID файла контрольных точек.|  
|relative_file_path|**nvarchar(256)**|Путь к файлу относительно контейнера, с которым он сопоставлен.|  
|file_type|**smallint**|-1 для бесплатной<br /><br /> 0 для файла данных.<br /><br /> 1 для РАЗНОСТного файла.<br /><br /> 2 — КОРНЕВой файл<br /><br /> 3 для файла больших данных|  
|file_type_desc|**nvarchar(60)**|FREE — все файлы, поддерживаемые как свободные, доступны для выделения. Свободные файлы могут иметь разный размер в зависимости от ожидаемых требований системы. Максимальный размер — 1 ГБ.<br /><br /> Файлы данных содержат строки, которые были вставлены в оптимизированные для памяти таблицы.<br /><br /> РАЗНОСТные разностные файлы содержат ссылки на строки в файлах данных, которые были удалены.<br /><br /> КОРНЕВые корневые файлы содержат системные метаданные для оптимизированных для памяти и скомпилированных в собственном файле объектов.<br /><br /> БОЛЬШИЕ данные. большие файлы данных содержат значения, вставленные в столбцы (n) varchar (max) и varbinary (max), а также сегменты столбцов, которые являются частью индексов columnstore в таблицах, оптимизированных для памяти.|  
|internal_storage_slot|**int**|Индекс файла в массиве внутреннего хранилища. NULL для ROOT или для состояния, отличного от 1.|  
|checkpoint_pair_file_id|**uniqueidentifier**|Соответствующие данные или РАЗНОСТный файл. NULL для ROOT.|  
|file_size_in_bytes|**bigint**|Размер файла на диске.|  
|file_size_used_in_bytes|**bigint**|Для пар файлов контрольных точек, заполнение которых все еще выполняется, этот столбец будет обновляться после каждой следующей контрольной точки.|  
|logical_row_count|**bigint**|Для данных — число вставленных строк.<br /><br /> Для изменений — число строк, удаленных после учета для Drop Table.<br /><br /> Для корневого, NULL.|  
|state|**smallint**|0 — СОЗДАНО ПРЕДВАРИТЕЛЬНО<br /><br /> 1 — В ПРОЦЕССЕ СОЗДАНИЯ<br /><br /> 2 — ACTIVE<br /><br /> 3. ЦЕЛЬ СЛИЯНИЯ<br /><br /> 8-ОЖИДАНИЕ УСЕЧЕНИЯ ЖУРНАЛА|  
|state_desc|**nvarchar(60)**|Предварительно создано — количество файлов контрольных точек заранее выделено, чтобы свести или исключить все ожидания выделения новых файлов при выполнении транзакций. Эти файлы могут иметь разный размер в зависимости от предполагаемых потребностей рабочей нагрузки, но они не содержат данных. Это дополнительная нагрузка на хранилище в базах данных с MEMORY_OPTIMIZED_DATA файловой группой.<br /><br /> В разделе Создание — эти файлы контрольных точек находятся в процессе разработки, то есть они заполняются на основе записей журнала, созданных базой данных, и еще не являются частью контрольной точки.<br /><br /> ACTIVE — содержит строки inserted/Deleted из предыдущих закрытых контрольных точек. Они содержат содержимое таблиц, считанных областью в память, перед применением активной части журнала транзакций при перезапуске базы данных. Мы предполагаем, что размер этих файлов контрольных точек будет примерно вдвое меньше размера оптимизированных для памяти таблиц в памяти, предполагая, что операция слияния выполняется с транзакционной рабочей нагрузкой.<br /><br /> Целевой объект MERGE — цель операций слияния. Эти файлы контрольных точек хранят консолидированные строки данных из исходных файлов, которые были определены политикой слияния. После установки слияния MERGE TARGET переходит в состояние ACTIVE.<br /><br /> ОЖИДАНИе УСЕЧЕНИЯ журнала. После установки слияния и CFP целевого объекта слияния является частью устойчивой контрольной точки, файлы контрольных точек источника слияния переходят в это состояние. Файлы в этом состоянии необходимы для корректной работы базы данных с таблицей, оптимизированной для памяти.  Например, чтобы выполнить восстановление от устойчивой контрольной точки, чтобы вернуться назад во времени.|  
|lower_bound_tsn|**bigint**|Нижняя граница транзакции в файле; NULL, если состояние не в (1, 3).|  
|upper_bound_tsn|**bigint**|Верхняя граница транзакции в файле; NULL, если состояние не в (1, 3).|  
|begin_checkpoint_id|**bigint**|Идентификатор начальной контрольной точки.|  
|end_checkpoint_id|**bigint**|Идентификатор конечной контрольной точки.|  
|last_updated_checkpoint_id|**bigint**|Идентификатор последней контрольной точки, которая обновила этот файл.|  
|encryption_status|**smallint**|0, 1, 2|  
|encryption_status_desc|**nvarchar(60)**|0 => УНЕНКРТПТЕД<br /><br /> 1 => ЗАШИФРОВАНО КЛЮЧОМ 1<br /><br /> 2 => ЗАШИФРОВАНО КЛЮЧОМ 2. Допустимо только для активных файлов.|  
  
##  <a name="sssql14"></a><a name="bkmk_2014"></a> [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]  
 В следующей таблице описаны столбцы для `sys.dm_db_xtp_checkpoint_files` **[!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]** .  
  
|Имя столбца|Тип|Описание|  
|-----------------|----------|-----------------|  
|container_id|**int**|Идентификатор контейнера (представленного в виде файла с типом FILESTREAM в таблице sys.database_files), частью которого является файл данных или разностный файл. Соединяет с file_id в [sys. database_files &#40;&#41;Transact-SQL ](../../relational-databases/system-catalog-views/sys-database-files-transact-sql.md).|  
|container_guid|**uniqueidentifier**|Идентификатор GUID контейнера, частью которого является файл данных или разностный файл.|  
|checkpoint_file_id|**GUID**|Идентификатор файла данных или разностного файла.|  
|relative_file_path|**nvarchar(256)**|Путь к файлу данных или разностному файлу относительно расположения контейнера.|  
|file_type|**tinyint**|0 для файла данных.<br /><br /> 1 для разностного файла.<br /><br /> Значение NULL, если столбцу состояния задано значение 7.|  
|file_type_desc|**nvarchar(60)**|Тип файла: DATA_FILE, DELTA_FILE или NULL, если для столбца State задано значение 7.|  
|internal_storage_slot|**int**|Индекс файла в массиве внутреннего хранилища. Значение NULL, если столбцу состояния задано значение, отличное от 2 или 3.|  
|checkpoint_pair_file_id|**uniqueidentifier**|Соответствующий файл данных или разностный файл.|  
|file_size_in_bytes|**bigint**|Используемый размер файла. Значение NULL, если столбцу состояния задано значение 5, 6 или 7.|  
|file_size_used_in_bytes|**bigint**|Используемый размер файла задействованного файла. Значение NULL, если столбцу состояния задано значение 5, 6 или 7.<br /><br /> Для пар файлов контрольных точек, заполнение которых все еще выполняется, этот столбец будет обновляться после каждой следующей контрольной точки.|  
|inserted_row_count|**bigint**|Число строк в файле данных.|  
|deleted_row_count|**bigint**|Число удаленных строк в разностном файле.|  
|drop_table_deleted_row_count|**bigint**|Количество строк в файле данных, затронутых операцией удаления таблицы. Относится к файлам данных, когда столбец состояния имеет значение 1.<br /><br /> Показывает количество строк, которые удалены из удаленных таблиц. Статистика drop_table_deleted_row_count компилируется после завершения сборки мусора строк удаленных таблиц из памяти и достижения контрольной точки. Если перезапустить [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] до того, как статистика удаленных таблиц появится в этом столбце, статистика будет обновлена в рамках восстановления. В процессе восстановления строки из удаленных таблиц не загружаются. Статистика по удаленным таблицам компилируется на стадии загрузки и отображается в этом столбце по завершении восстановления.|  
|state|**int**|0 — СОЗДАНО ПРЕДВАРИТЕЛЬНО<br /><br /> 1 — В ПРОЦЕССЕ СОЗДАНИЯ<br /><br /> 2 — ACTIVE<br /><br /> 3. ЦЕЛЬ СЛИЯНИЯ<br /><br /> 4 — ОБЪЕДИНЕННЫЙ ИСТОЧНИК<br /><br /> 5 — ТРЕБУЕТСЯ ДЛЯ РЕЗЕРВНОГО КОПИРОВАНИЯ И ВЫСОКОЙ ДОСТУПНОСТИ<br /><br /> 6 — ПЕРЕХОД НА ЗАХОРОНЕНИЕ<br /><br /> 7 — ЗАХОРОНЕНИЕ|  
|state_desc|**nvarchar(60)**|Предварительно СОЗДАНный — небольшой набор пар файлов данных и разностного файла, также известный как пары файлов контрольных точек (пары файлов), выделяется заранее, чтобы свести или исключить все ожидания выделения новых файлов при выполнении транзакций. Это полноценные файлы данных размером 128 МБ и разностные файлы размером 8 МБ, но без данных. Число пар файлов соответствует числу логических процессоров или планировщиков (по одному на ядро, без максимального значения), но не менее 8. Это фиксированное пространство хранения в базах данных с таблицами, оптимизированными для памяти.<br /><br /> В разделе Строительство-набор пары файлов, в котором хранятся недавно вставленные и, возможно, удаленные строки данных с момента последней контрольной точки.<br /><br /> ACTIVE — файлы в этом состоянии содержат вставленные и удаленные строки из ближайших предыдущих закрытых контрольных точек. Эти пары файлов содержат все обаятельные вставленные и удаленные строки, которые необходимы, прежде чем будет применена активная часть журнала транзакций после перезапуска базы данных. Размер этих CFP будет приблизительно в два раза больше размера оптимизированных для памяти таблиц в памяти при условии, что операция объединения выполняется в настоящий момент с транзакционной рабочей нагрузкой.<br /><br /> Целевой объект MERGE — CFP хранит объединенные строки данных из CFP, которые были определены политикой слияния. После установки слияния MERGE TARGET переходит в состояние ACTIVE.<br /><br /> ОБЪЕДИНЕНный источник — после установки операции слияния исходные пары файлов помечаются как ОБЪЕДИНЕНный источник. Обратите внимание, что средство оценки политики слияния может определять несколько слияний, а CFP может участвовать только в одной операции слияния.<br /><br /> ТРЕБУЕТСЯ для резервного копирования и высокой доступности. После установки слияния и CFP целевого объекта слияния является частью устойчивой контрольной точки, источник слияния пары файлов переход в это состояние. Находящиеся в этом состоянии CFP необходимы для правильности работы базы данных с оптимизированной для памяти таблицы.  Например, чтобы выполнить восстановление от устойчивой контрольной точки, чтобы вернуться назад во времени. Пару файлов можно отметить для сборки мусора после того, как точка усечения журнала выходит из диапазона транзакций.<br /><br /> В ПЕРЕХОДе к отметке полного удаления эти пары файлов не требуются для модуля выполняющейся в памяти OLTP и могут быть собраны сборщиком мусора. Это состояние указывает, что эти CFP ожидают, чтобы фоновый поток перевел их в следующее состояние, которым является состояние TOMBSTONE.<br /><br /> ЗАХОРОНЕНие — эти пары файлов ожидают сбора мусора сборщиком мусора FILESTREAM. ([sp_filestream_force_garbage_collection &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/filestream-and-filetable-sp-filestream-force-garbage-collection.md))|  
|lower_bound_tsn|**bigint**|Нижняя граница транзакций, содержащихся в файле. Значение NULL, если столбец состояния имеет значение, отличное от 2, 3 или 4.|  
|upper_bound_tsn|**bigint**|Верхняя граница транзакций, содержащихся в файле. Значение NULL, если столбец состояния имеет значение, отличное от 2, 3 или 4.|  
|last_backup_page_count|**int**|Количество логических страниц, которое определяется при последнем резервном копировании. Применяется, когда столбцу состояния задается значение 2, 3, 4 или 5. Значение NULL, если количество страниц неизвестно.|  
|delta_watermark_tsn|**int**|Транзакция последней контрольной точки, которая выполнила запись в этот разностный файл. Это знак разностного файла.|  
|last_checkpoint_recovery_lsn|**nvarchar (23)**|Регистрационный номер транзакции в журнале восстановления последней контрольной точки, которой все еще требуется файл.|  
|tombstone_operation_lsn|**nvarchar (23)**|Файл будет удален после того, как tombstone_operation_lsn оказывается позади регистрационного номера транзакции в журнале усечения журнала.|  
|logical_deletion_log_block_id|**bigint**|Относится только к состоянию 5.|  
  
## <a name="permissions"></a>Разрешения  
 Необходимо разрешение `VIEW DATABASE STATE` на сервере.  
  
## <a name="use-cases"></a>Варианты использования  
 Вы можете оценить объем хранилища, используемый выполняющейся в памяти OLTP, следующим образом:  
  
```  
-- total storage used by In-Memory OLTP  
SELECT SUM (file_size_in_bytes)/(1024*1024) as file_size_in_MB  
FROM sys.dm_db_xtp_checkpoint_files  
```  
  
  
Чтобы просмотреть распределение использования хранилища по состоянию и типу файлов, выполните следующий запрос:
  
```  
SELECT state_desc  
 , file_type_desc  
 , COUNT(*) AS [count]  
 , SUM(file_size_in_bytes) / 1024 / 1024 AS [on-disk size MB]   
FROM sys.dm_db_xtp_checkpoint_files  
GROUP BY state, state_desc, file_type, file_type_desc  
ORDER BY state, file_type  
```  
  

  
## <a name="see-also"></a>См. также:  
 [Оптимизированные для памяти динамические административные представления таблиц &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/memory-optimized-table-dynamic-management-views-transact-sql.md)  
  
  
