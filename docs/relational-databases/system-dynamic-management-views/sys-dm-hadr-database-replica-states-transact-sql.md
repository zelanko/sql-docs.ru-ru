---
title: sys.dm_hadr_database_replica_states (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 06/26/2018
ms.prod: sql
ms.reviewer: ''
ms.technology: system-objects
ms.topic: language-reference
f1_keywords:
- sys.dm_hadr_database_states_TSQL
- sys.dm_hadr_database_states
- dm_hadr_database_states
- dm_hadr_database_states_TSQL
dev_langs:
- TSQL
helpviewer_keywords:
- Availability Groups [SQL Server], monitoring
- sys.dm_hadr_database_replica_states dynamic management view
ms.assetid: 1a17b0c9-2535-4f3d-8013-cd0a6d08f773
author: MikeRayMSFT
ms.author: mikeray
manager: craigg
ms.openlocfilehash: 94c9258ff71454134c5ff2023e174a0811d7afe6
ms.sourcegitcommit: ca038f1ef180e4e1b27910bbc5d87822cd1ed176
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2018
ms.locfileid: "52159092"
---
# <a name="sysdmhadrdatabasereplicastates-transact-sql"></a>sys.dm_hadr_database_replica_states (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2012-xxxx-xxxx-xxx-md](../../includes/tsql-appliesto-ss2012-xxxx-xxxx-xxx-md.md)]

  Возвращает строку для каждой базы данных, участвующих в группе доступности Always On, для которого в локальном экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] размещается реплика доступности. Это динамическое административное представление предоставляет сведения о состоянии первичной и вторичной реплик. На вторичной реплике это представление возвращает по строке для каждой из баз данных-получателей на экземпляре сервера. На первичной реплике это представление возвращает по строке для каждой из баз данных-источников и по дополнительной строке для соответствующих баз данных-получателей.  
  
> [!IMPORTANT]
> В зависимости от действия и состояний более высоких уровней, информация о состоянии базы данных может быть недоступной или устаревшей. Кроме того, эти значения имеют смысл только в локальном контексте. Например, в первичной реплике, а значение **last_hardened_lsn** столбца отражает сведения о заданной базы данных-получателя, доступной на первичную реплику, значение, которое не фактический зафиксированный номер LSN в настоящее время возможно вторичной реплики.  
   
|Имя столбца|Тип данных|Описание (в основной реплике)|  
|-----------------|---------------|----------------------------------------|  
|**database_id**|**int**|Идентификатор базы данных, который является уникальным в рамках экземпляра SQL Server. Это то же значение, как показано в [sys.databases](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md) представления каталога.|  
|**group_id**|**uniqueidentifier**|Идентификатор группы доступности, к которой принадлежит база данных.|  
|**replica_id**|**uniqueidentifier**|Идентификатор реплики доступности в группе доступности.|  
|**group_database_id**|**uniqueidentifier**|Идентификатор базы данных из группы доступности. Этот идентификатор совпадает на всех репликах, к которым присоединена эта база данных.|  
|**is_local**|**bit**|Является ли база данных доступности локальной. Может принимать одно из следующих значений:<br /><br /> 0 = база данных не локальна по отношению к экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].<br /><br /> 1 = база данных локальна по отношению к экземпляру сервера.|  
|**is_primary_replica**|**bit**|Возвращает 1, если реплика является первичной, либо 0, если она вторична.<br /><br />**Применимо к**: с [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] до [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].|  
|**synchronization_state**|**tinyint**|Состояние перемещения данных, один из следующих значений.<br /><br /> 0 = нет синхронизации. Для базы данных-источника указывает, что база данных не готова к синхронизации своего журнала транзакций с соответствующими базами данных-получателями. Для базы данных-получателя указывает, что на базе данных не запущена синхронизация журнала из-за проблем с соединением, синхронизация приостановлена или же база данных находится в переходных состояниях во время запуска или переключения ролей.<br /><br /> 1 = идет процесс синхронизации. Для базы данных-источника указывает, что база данных готова принимать запросы на просмотр от базы данных-получателя. Для базы данных-получателя указывает, что происходит активное перемещение данных.<br /><br /> 2 = Synchronized. Состояние базы данных-источника отображается как «SYNCHRONIZED» (вместо «SYNCHRONIZING»). Состояние базы данных-получателя с синхронной фиксацией отображается как «SYNCHRONIZED» в том случае, когда с точки зрения локального кэша база данных готова к отработке отказа и находится в процессе синхронизации.<br /><br /> 3 = Возврат. Обозначает этап процесса отката, в котором база данных-получатель активно получает страницы с базы данных-источника.<br />**Предупреждение:** В случае, когда база данных во вторичной реплике находится в состоянии «REVERTING», принудительная отработка отказа на вторичную реплику приведет к состоянию, в котором база данных не сможет быть запущена в качестве источника. Нужно будет установить повторное соединение базы данных в качестве базы данных-получателя или применить новые записи журнала из резервной копии журнала.<br /><br /> 4 = инициализация. Обозначает этап процесса отката, на котором журнал транзакций, по которому базе данных-получателю необходимо устранить вплоть до номера LSN, который доставляется и фиксируется на вторичной реплике.<br />**Предупреждение:** Когда базу данных во вторичной реплике находится в состоянии INITIALIZING, принудительная отработка отказа на вторичную реплику оставляет базу данных в состоянии, в котором не сможет быть запущена как базы данных-источника. Нужно будет установить повторное соединение базы данных в качестве базы данных-получателя или применить новые записи журнала из резервной копии журнала.|  
|**synchronization_state_desc**|**nvarchar(60)**|Одно из следующих описаний состояния перемещения файла.<br /><br /> NOT SYNCHRONIZING<br /><br /> SYNCHRONIZING<br /><br /> SYNCHRONIZED<br /><br /> REVERTING<br /><br /> INITIALIZING|  
|**is_commit_participant**|**bit**|0 = фиксация транзакции не синхронизирована по отношению к этой базе данных.<br /><br /> 1 = фиксация транзакции синхронизирована по отношению к этой базе данных.<br /><br /> Для баз данных в реплике доступности асинхронной фиксации это значение всегда равно 0.<br /><br /> Что касается базы данных в реплике доступности с синхронной фиксацией, то данное значение является точным только в базе данных-источнике.|  
|**synchronization_health**|**tinyint**|Отражает пересечение состояния синхронизации базы данных, которая присоединена к группе доступности в реплике доступности и режима доступности реплики доступности (режим синхронной или асинхронной фиксации), один из следующие значения.<br /><br /> 0 = неработоспособна. **Synchronization_state** базы данных равно 0 (NOT SYNCHRONIZING).<br /><br /> 1 = частично работоспособна. База данных в реплике доступности синхронной фиксации считается частично исправной Если **synchronization_state** равно 1 (SYNCHRONIZING).<br /><br /> 2 — работоспособное состояние. Базу данных на реплике доступности синхронной фиксации считается исправной, если **synchronization_state** равно 2 (SYNCHRONIZED), а также базу данных на реплике доступности асинхронной фиксации считается исправной, если **synchronization_state** равно 1 (SYNCHRONIZING).|  
|**synchronization_health_desc**|**nvarchar(60)**|Описание **synchronization_health** базы данных доступности.<br /><br /> NOT_HEALTHY<br /><br /> PARTIALLY_HEALTHY<br /><br /> HEALTHY|  
|**database_state**|**tinyint**|0 = В сети<br /><br /> 1 = Восстановление из копии<br /><br /> 2 = Восстановление<br /><br /> 3 = В ожидании восстановления<br /><br /> 4 = Подозрительное состояние<br /><br /> 5 = Тревога<br /><br /> 6 = В автономном режиме<br /><br /> **Примечание.** Совпадение с кодом **состояние** столбца в представлении каталога sys.databases.|  
|**database_state_desc**|**nvarchar(60)**|Описание **database_state** реплики доступности.<br /><br /> ONLINE<br /><br /> RESTORING<br /><br /> RECOVERING<br /><br /> RECOVERY_PENDING<br /><br /> SUSPECT<br /><br /> EMERGENCY<br /><br /> OFFLINE<br /><br /> **Примечание.** Совпадение с кодом **state_desc** столбца в представлении каталога sys.databases.|  
|**is_suspended**|**bit**|Состояние базы данных. Может принимать одно из следующих значений:<br /><br /> 0 = возобновлено;<br /><br /> 1 = приостановлено.|  
|**suspend_reason**|**tinyint**|Если база данных приостановлена, то причина состояния приостановки. Может принимать одно из следующих значений:<br /><br /> 0 = В результате действий пользователя<br /><br /> 1 = Приостановлена партнером<br /><br /> 2 = Повтор<br /><br /> 3 = Захват<br /><br /> 4 = Применение<br /><br /> 5 = Перезапуск<br /><br /> 6 = Отмена<br /><br /> 7 = Повторная проверка<br /><br /> 8 = Ошибка в вычислении точки синхронизации вторичной реплики|  
|**suspend_reason_desc**|**nvarchar(60)**|Описание причины приостановки базы данных. Может принимать одно из следующих значений:<br /><br /> SUSPEND_FROM_USER = пользователь вручную приостановил движение данных.<br /><br /> SUSPEND_FROM_PARTNER = реплика базы данных приостановлена после принудительного перехода на другой ресурс.<br /><br /> SUSPEND_FROM_REDO = произошла ошибка на стадии повтора.<br /><br /> SUSPEND_FROM_APPLY = произошла ошибка при записи журнала в файл (см. журнал ошибок).<br /><br /> SUSPEND_FROM_CAPTURE = произошла ошибка при перехвате журнала на первичной реплике.<br /><br /> SUSPEND_FROM_RESTART = реплика базы данных приостановлена, прежде чем произошел перезапуск базы данных (см. журнал ошибок).<br /><br /> SUSPEND_FROM_UNDO = произошла ошибка на этапе отката (см. журнал ошибок).<br /><br /> SUSPEND_FROM_REVALIDATION = при повторном подключении обнаружено несоответствие изменений журнала (см. журнал ошибок).<br /><br /> SUSPEND_FROM_XRF_UPDATE = не удалось найти общую временную точку (см. журнал ошибок).|  
|**recovery_lsn**|**numeric(25,0)**|На первичной реплике окончание журнала транзакций до того, как база данных-источник запишет новые записи журнала после восстановления или перехода на другой ресурс. Применительно к конкретной базе данных-получателю, если это значение меньше текущего зафиксированного номера LSN (last_hardened_lsn), то recovery_lsn представляет собой значение, до достижения которого потребовалось бы провести повторную синхронизацию этой базы данных-получателя (т. е. восстановление и повторную инициализацию). Если это значение больше текущего зафиксированного номера LSN или равно ему, повторная синхронизация была бы ненужной и не произошла бы.<br /><br /> **recovery_lsn** соответствует Идентификатору блока журнала, дополненному нулями. Это не фактический регистрационный номер транзакции в журнале (номер LSN). Сведения о том, как это значение является производным, см. в разделе [основные сведения о значениях столбца LSN](#LSNcolumns)далее в этом разделе.|  
|**truncation_lsn**|**numeric(25,0)**|В первичной реплике, применительно к базе данных-источнику, соответствует минимальному номеру LSN для усечения журнала среди всех соответствующих баз данных-получателей. В случае блокировки усечения журнала (например в ходе резервного копирования) данный номер LSN может быть выше локального номера LSN для усечения.<br /><br /> Соответствует точке усечения для заданной базы данных-получателя.<br /><br /> **truncation_lsn** соответствует Идентификатору блока журнала, дополненному нулями. Это не фактический регистрационный номер транзакции в журнале.|  
|**last_sent_lsn**|**numeric(25,0)**|Идентификатор блока журнала, указывающий точку, вплоть до которой все блоки журнала были отправлены источником. Это идентификатор следующего блока, который будет отправлен, а не идентификатор последнего, уже отправленного блока.<br /><br /> **last_sent_lsn** соответствует Идентификатору блока журнала, дополненному нулями, это не фактический регистрационный номер.|  
|**last_sent_time**|**datetime**|Время отправки последнего блока журнала.|  
|**last_received_lsn**|**numeric(25,0)**|Идентификатор блока журнала, указывающий точку, вплоть до которой все блоки журнала были получены вторичной репликой, на которой размещена эта база данных-получатель.<br /><br /> **last_received_lsn** соответствует Идентификатору блока журнала, дополненному нулями. Это не фактический регистрационный номер транзакции в журнале.|  
|**last_received_time**|**datetime**|Отметка времени, когда идентификатор блока журнала в последнем сообщении был прочитан вторичной репликой.|  
|**last_hardened_lsn**|**numeric(25,0)**|Начало блока журнала, содержащего журнальные записи последнего зафиксированного номера LSN на базе данных-получателе.<br /><br /> В базе данных-источнике с асинхронной фиксацией или в базе данных с синхронной фиксацией, настроенной в режиме «задержки», значение равно NULL. Для других синхронной фиксации баз данных-источников **last_hardened_lsn** соответствует минимальному зафиксированный номер LSN среди всех баз данных-получателя.<br /><br /> **Примечание: last_hardened_lsn** соответствует Идентификатору блока журнала, дополненному нулями. Это не фактический регистрационный номер транзакции в журнале. Дополнительные сведения см. в разделе [основные сведения о значениях столбца LSN](#LSNcolumns)далее в этом разделе.|  
|**last_hardened_time**|**datetime**|На базу данных-получатель, время идентификатора блока журнала для последнего зафиксированного номера LSN (**last_hardened_lsn**). В базе данных-источнике соответствует времени минимального фиксированного номера LSN.|  
|**last_redone_lsn**|**numeric(25,0)**|Фактический регистрационный номер транзакции последней записи в журнале, повторенной в базе данных-получателе. **last_redone_lsn** — всегда меньше, чем **last_hardened_lsn**.|  
|**last_redone_time**|**datetime**|Время повторения последней записи на базе данных-получателе.|  
|**log_send_queue_size**|**bigint**|Объем записей журнала базы данных-источника, еще не отправленных базам данных-получателям, в килобайтах (КБ).|  
|**log_send_rate**|**bigint**|Средняя скорость, с которой данные экземпляра, отправленного первичной реплики во время последнего активного периода, в килобайтах (КБ) в секунду.|  
|**redo_queue_size**|**bigint**|Число записей журнала в файлах журналов вторичной реплики, которые еще не были выполнены повторно, в килобайтах (КБ).|  
|**redo_rate**|**bigint**|Средняя скорость, с которой записи журнала повторного выполнения этой базы данных-получателя, в килобайтах (КБ) / с.|  
|**filestream_send_rate**|**bigint**|Скорость, с которой файлы FILESTREAM передаются на вторичную реплику, в килобайтах (КБ)/сек.|  
|**end_of_log_lsn**|**numeric(25,0)**|Номер LSN конца локального журнала. Фактический номер LSN, соответствующий последней записи журнала в кэше журнала на базах данных источника и получателя. В первичной реплике вторичные строки отображают номер LSN конца журнала из последних сообщений о ходе выполнения, переданных вторичными репликами на первичную.<br /><br /> **end_of_log_lsn** соответствует Идентификатору блока журнала, дополненному нулями. Это не фактический регистрационный номер транзакции в журнале. Дополнительные сведения см. в разделе [основные сведения о значениях столбца LSN](#LSNcolumns)далее в этом разделе.|  
|**last_commit_lsn**|**numeric(25,0)**|Фактический регистрационный номер транзакции в журнале, соответствующий последней записи фиксации в журнале транзакций.<br /><br /> На базе данных-источнике он соответствует последней обработанной записи фиксации. Строки для баз данных-получателей показывают последовательный номер транзакции в журнале, переданный вторичной репликой в первичную.<br /><br /> На вторичной реплике это последняя запись фиксации, которая была повторена.|  
|**last_commit_time**|**datetime**|Время, соответствующее последней записи фиксации.<br /><br /> На базе данных-получателе это время совпадает со временем на базе данных-источнике.<br /><br /> На первичной реплике в строках каждой из баз данных-получателей отображается время, возвращенное первичной реплике с вторичной реплики, на которой размещена соответствующая база данных-получатель. Разница во времени между строке базы данных источника и заданной базы данных получателя представляет приблизительно целевую точку восстановления (RPO), при условии, что процесс отслеживания отстает и что ход выполнения были передала на первичную реплику вторичной репликой.|  
|**low_water_mark_for_ghosts**|**bigint**|Непрерывно возрастающее число для базы данных, указывающее метку низкого уровня, которая используется задачей очистки фантомных записей в базе данных-источнике. Если это число с течением времени не увеличивается, то задача очистки фантомных записей, вероятно, не выполняется. Чтобы определить, какие из фантомных строк необходимо очистить, первичная реплика использует минимальное значение данного столбца в этой базе данных по всем репликам доступности (включая первичную реплику).|  
|**secondary_lag_seconds**|**bigint**|Число секунд, вторичная реплика отстает от первичной реплики во время синхронизации.<br /><br />**Применимо к**: с [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] до [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].|  
  
##  <a name="LSNcolumns"></a> Основные сведения о значениях столбца LSN  
 Значения **end_of_log_lsn**, **last_hardened_lsn**, **last_received_lsn**, **last_sent_lsn**, **восстановления _lsn**, и **truncation_lsn** столбцы не являются фактические номера LSN (LSN). Вместо этого каждое из данных значений представляет идентификатор блока журнала, дополненный нулями.  
  
 **end_of_log_lsn**, **last_hardened_lsn**, и **recovery_lsn** являются номера LSN записи на диск. Например **last_hardened_lsn** указывает на начало следующего блока после блоков, которые уже находятся на диске.  Поэтому любой LSN < значения **last_hardened_lsn** находится на диске.  Номера LSN, которые >= этого значения, не записаны на диск.  
  
 Из номеров LSN, возвращенный **sys.dm_hadr_database_replica_states**, только **last_redone_lsn** является реальным номером LSN.  
  
## <a name="security"></a>безопасность  
  
### <a name="permissions"></a>Разрешения  
 необходимо разрешение VIEW SERVER STATE на сервере.  
  
## <a name="see-also"></a>См. также  
 [Группы доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/always-on-availability-groups-sql-server.md)   
 [Отслеживание групп доступности (Transact-SQL)](../../database-engine/availability-groups/windows/monitor-availability-groups-transact-sql.md)  
  
  
