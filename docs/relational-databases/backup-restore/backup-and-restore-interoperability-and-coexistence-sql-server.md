---
title: 'Резервное копирование и восстановление: взаимодействие компонентов'
description: В этой статье описываются функции резервного копирования и восстановления в SQL Server, включая запуск базы данных, оперативное восстановление и отключенные индексы, а также зеркальное отображение базы данных.
ms.custom: seo-lt-2019
ms.date: 12/17/2019
ms.prod: sql
ms.prod_service: backup-restore
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- file restores [SQL Server], related features
- restoring [SQL Server], files
- restoring files [SQL Server], related features
- backups [SQL Server], files or filegroups
- file backups [SQL Server], related features
ms.assetid: 69f212b8-edcd-4c5d-8a8a-679ced33c128
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 3dcf1473fc92ba69d68f9aae9d871540e2604b52
ms.sourcegitcommit: da88320c474c1c9124574f90d549c50ee3387b4c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2020
ms.locfileid: "85737827"
---
# <a name="backup-and-restore-interoperability-and-coexistence-sql-server"></a>Резервное копирование и восстановление. Взаимодействие и сосуществование (SQL Server)
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

  В этом разделе описываются вопросы резервного копирования и восстановления для нескольких функций [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]. Это восстановление файлов и запуск базы данных, оперативное восстановление и отключенные индексы, зеркальное отображение базы данных, поэтапное восстановление и полнотекстовые индексы.  
  
 **В этом разделе.**  
  
-   [Восстановление файлов и запуск базы данных](#FileRestoreAndDbStartup)  
  
-   [Восстановление в сети и отключенные индексы](#OnlineRestoreAndDisabledIndexes)  
  
-   [Резервное копирование и восстановление базы данных при зеркальном отображении](#DbMandBnR)  
  
-   [Поэтапное восстановление и полнотекстовые индексы](#PiecemealAndFTIndexes)  
  
-   [Резервное копирование, восстановление и сжатие файлов](#FileBnRandCompression)  
  
-   [Связанные задачи](#RelatedTasks)  
  
##  <a name="file-restore-and-database-startup"></a><a name="FileRestoreAndDbStartup"></a> Восстановление файлов и запуск базы данных  
 Этот раздел относится только к базам данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , содержащим несколько файловых групп.  
  
> [!NOTE]  
>  При запуске баз данных восстанавливаются и переводятся в режим «в сети» только те файловые группы, чьи файлы были в этом режиме при закрытии базы.  
  
 Если во время запуска базы данных возникает проблема, восстановление завершается ошибкой, а база данных помечается как подозрительная (SUSPECT). Если проблема касается только отдельных файлов, администратор базы данных может перевести их в режим «вне сети»и попытаться перезапустить базу данных. Для перевода файла в режим «вне сети» можно выполнить следующую инструкцию [ALTER DATABASE](../../t-sql/statements/alter-database-transact-sql.md) :  
  
 ALTER DATABASE *имя_базы_данных* MODIFY FILE (NAME **='***имя_файла***'** , OFFLINE)  
  
 Если запуск пройдет успешно, то любая файловая группа, содержащая файлы в режиме «вне сети», также будет находиться в режиме «вне сети».  
  
##  <a name="online-restore-and-disabled-indexes"></a><a name="OnlineRestoreAndDisabledIndexes"></a> Восстановление в сети и отключенные индексы  
 Этот раздел относится только к базам данных, содержащим несколько файловых групп и (в случае простой модели восстановления) хотя бы одну файловую группу только для чтения.  
  
 В этих случаях, если база данных находится в режиме «в сети», индекс может быть создан, удален, включен или отключен только в том случае, если все файловые группы, содержащие любую часть индекса, находятся в режиме «в сети».  
  
 Сведения о восстановлении файловых групп вне сети см. в разделе [Восстановление в сети (SQL Server)](../../relational-databases/backup-restore/online-restore-sql-server.md).  
  
##  <a name="database-mirroring-and-backup-and-restore"></a><a name="DbMandBnR"></a> Резервное копирование и восстановление базы данных при зеркальном отображении  
 Этот раздел относится только к тем базам данных, которые используют модель полного восстановления и содержат несколько файловых групп.  
  
> [!NOTE]  
>  В следующих версиях Microsoft [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]возможность зеркального отображения базы данных будет исключена. Избегайте использования этого компонента в новых разработках и запланируйте изменение существующих приложений, в которых он применяется. Используйте вместо этого [!INCLUDE[ssHADR](../../includes/sshadr-md.md)].  
  
 Зеркальное отображение базы данных — это решение, нацеленное на повышение ее доступности. Зеркальное отображение каждой базы данных осуществляется отдельно и работает только с теми базами данных, которые используют модель полного восстановления. Дополнительные сведения см. в разделе [Зеркальное отображение базы данных (SQL Server)](../../database-engine/database-mirroring/database-mirroring-sql-server.md).  
  
> [!NOTE]  
>  Для распространения копий подмножества файловых групп в базе данных используется репликация: реплицируются только те объекты в файловых группах, которые необходимо копировать на другие серверы. Дополнительные сведения о репликации см. в разделе [Репликация SQL Server](../../relational-databases/replication/sql-server-replication.md).  
  
### <a name="creating-the-mirror-database"></a>Создание зеркальной базы данных  
 Зеркальная база данных создается посредством восстановления с параметром WITH NORECOVERY резервных копий основной базы данных на зеркальном сервере. При восстановлении базы данных должно сохраняться ее имя. Дополнительные сведения см. в статье [Prepare a Mirror Database for Mirroring &#40;SQL Server&#41;](../../database-engine/database-mirroring/prepare-a-mirror-database-for-mirroring-sql-server.md).  
  
 Зеркальная база данных может быть создана при использовании последовательности поэтапного восстановления, если она поддерживается. Однако зеркальное отображение не может быть начато до тех пор, пока не будут восстановлены все файловые группы (и, как правило, резервные копии журналов), чтобы привести состояние зеркальной базы данных как можно ближе к основной. Дополнительные сведения см. в разделе [Поэтапное восстановление (SQL Server)](../../relational-databases/backup-restore/piecemeal-restores-sql-server.md).  
  
### <a name="restrictions-on-backup-and-restore-during-mirroring"></a>Ограничения на резервное копирование и восстановление в процессе зеркального отображения  
 Во время активного сеанса зеркального отображения базы данных применяются следующие ограничения.  
  
-   Резервное копирование и восстановление зеркальной базы данных недопустимо.  
  
-   Резервное копирование основной базы данных допустимо, а операция BACKUP LOG WITH NORECOVERY недопустима.  
  
-   Восстановление основной базы данных недопустимо.  
  
##  <a name="piecemeal-restore-and-full-text-indexes"></a><a name="PiecemealAndFTIndexes"></a> Поэтапное восстановление и полнотекстовые индексы  
 Сведения в этом разделе относятся только к базам данных, содержащим несколько файловых групп, а в случае простой модели базы данных — только к файловым группам только для чтения.  
  
 Полнотекстовые индексы хранятся в файловых группах базы данных и могут быть затронуты поэтапным восстановлением. Если полнотекстовый индекс расположен в той же файловой группе, что и какие-либо связанные с ним табличные данные, поэтапное восстановление работает предсказуемым образом.  
  
> [!NOTE]  
>  Чтобы просмотреть идентификатор файловой группы, содержащей полнотекстовый индекс, выберите столбец data_space_id представления [sys.fulltext_indexes](../../relational-databases/system-catalog-views/sys-fulltext-indexes-transact-sql.md).  
  
### <a name="full-text-indexes-and-tables-in-separate-filegroups"></a>Полнотекстовые индексы и таблицы в разных файловых группах  
 Если полнотекстовый индекс расположен в другой файловой группе, отдельно от всех связанных с ним табличных данных, поведение поэтапного восстановления зависит от того, какие файловые группы восстанавливаются и переводятся в режим «в сети» первыми.  
  
-   Если файловая группа, содержащая полнотекстовый индекс, восстанавливается и переводится в режим «в сети» перед файловыми группами, содержащими связанные табличные данные, после перевода индекса в режим «в сети» полнотекстовый поиск работает предсказуемым образом.  
  
-   Напротив, если файловая группа, содержащая табличные данные, восстанавливается и переводится в режим «в сети» раньше файловой группы, содержащей полнотекстовый индекс, это может оказать влияние на работу полнотекстового поиска. Это происходит из-за сбоя до перевода индекса в режим инструкций [!INCLUDE[tsql](../../includes/tsql-md.md)] «в сети», которые инициируют заполнение, перестраивают или реорганизуют каталог. К таким инструкциям относятся CREATE FULLTEXT INDEX, ALTER FULLTEXT INDEX, DROP FULLTEXT INDEX и ALTER FULLTEXT CATALOG.  
  
     В этом случае важны следующие факторы.  
  
    -   Если полнотекстовый индекс поддерживает отслеживание изменений, пользовательская DML-инструкция будет завершаться с ошибкой до тех пор, пока файловая группа с индексом не будет переведена в режим «в сети». Операция удаления будет также завершаться с ошибкой до перевода файловой группы индекса в режим «в сети».  
  
    -   Независимо от отслеживания изменений, полнотекстовые запросы будут завершаться ошибкой, поскольку индекс недоступен. При попытке выполнить полнотекстовый запрос, если файловая группа с полнотекстовым индексом находится в режиме «вне сети», будет возвращена ошибка.  
  
    -   Функции состояния (например, FULLTEXTCATALOGPROPERTY) выполняются успешно в тех случаях, когда они не пытаются получить доступ к полнотекстовому индексу. Например, обращение к любым полнотекстовым метаданным в сети будет выполнено успешно, а выполнение функций **uniquekeycount, itemcount** завершится ошибкой.  
  
     После того как файловая группа с полнотекстовым индексом восстановлена и переведена в режим «в сети», данные индекса и табличные данные являются согласованными.  
  
 После перевода файловой группы базовой таблицы и файловой группы полнотекстового индекса в режим «в сети» приостановленное полнотекстовое заполнение восстанавливается.  
  
##  <a name="file-backup-and-restore-and-compression"></a><a name="FileBnRandCompression"></a> Резервное копирование, восстановление и сжатие файлов  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] поддерживает сжатие данных в файловой системе NTFS для файловых групп, доступных только для чтения, и баз данных, доступных только для чтения.  
  
 В файловых группах только для чтения поддерживается восстановление сжатых файлов NTFS. Такие группы файлов архивируются и восстанавливаются точно так же, как любые другие файловые группы только для чтения, за некоторым исключением.  
  
-   Восстановление файла для чтения и записи (включая основные файлы и файлы журналов базы данных для чтения и записи) в том, где используется сжатие, выполнить невозможно.  
  
-   Разрешается восстанавливать базу данных только для чтения в том со сжатием.  
  
> [!NOTE]  
>  Файлы журнала или доступные для чтения и записи базы данных ни в коем случае не следует размещать в файловых системах со сжатием.  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
  
-   [Подготовка зеркальной базы данных к зеркальному отображению (SQL Server)](../../database-engine/database-mirroring/prepare-a-mirror-database-for-mirroring-sql-server.md)  
  
-   [Создание резервных копий и восстановление полнотекстовых каталогов и индексов](../../relational-databases/search/back-up-and-restore-full-text-catalogs-and-indexes.md)  
  
## <a name="see-also"></a>См. также:  
 [Резервное копирование и восстановление баз данных SQL Server](../../relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases.md)   
 [Создание резервной копии и восстановление из копий реплицируемых баз данных](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md)   
[Активные вторичные реплики: резервное копирование во вторичных репликах \(группы доступности Always On\)](../../database-engine/availability-groups/windows/active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md)  
  
  
